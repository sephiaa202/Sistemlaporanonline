<html lang=id><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>Daily Operator Report - Web Local App v4.0</title><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js></script><script src=https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Konfigurasi Worker PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script><style>body{font-family:Inter,'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background-color:#f8f9fa;color:#212529;line-height:1.6}.container{width:95%;max-width:1400px;margin:30px auto;background:#fff;padding:30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}h1{text-align:center;color:#0d6efd;border-bottom:3px solid #0d6efd;padding-bottom:15px;margin-bottom:30px;font-weight:700}h2{color:#212529;font-weight:600}h3{color:#495057;font-weight:600}.tabs{display:flex;margin-bottom:25px;border-bottom:1px solid #e9ecef;gap:10px;overflow-x:auto}.tab-button{padding:14px 25px;cursor:pointer;border:none;background:0 0;font-size:15px;font-weight:600;color:#6c757d;transition:all .3s ease;border-radius:8px 8px 0 0;white-space:nowrap}.tab-button.active{color:#0d6efd;border-bottom:3px solid #0d6efd;background-color:#f0f7ff}.tab-button:hover{background-color:#e9ecef}.tab-button.triputra-tab{color:#6f42c1}.tab-button.triputra-tab.active{background-color:#f5f0ff;color:#6f42c1!important;border-bottom:3px solid #6f42c1}.tab-button.availability-tab{color:#dc3545}.tab-button.availability-tab.active{background-color:#fff0f0;color:#dc3545!important;border-bottom:3px solid #dc3545}.tab-content{display:none;padding:15px 0}.tab-content.active{display:block;animation:fadeIn .3s ease-in-out}.table-input-container{overflow-x:auto;max-height:65vh;border:1px solid #e9ecef;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.03)}#batchReportForm table,#triputraBatchForm table{width:100%;border-collapse:collapse;min-width:1800px;background:#fff}td,th{border:1px solid #e9ecef;padding:10px 8px;text-align:center;vertical-align:middle;font-size:13px}th{background-color:#212529;color:#fff;position:sticky;top:0;z-index:10;font-weight:600}tr:nth-child(even){background-color:#f8f9fa}tr.row-error{background-color:#fde8e9!important;border:2px solid #dc3545}tr.row-error input,tr.row-error select{border:2px solid #dc3545!important;background-color:#fff8f8}.holiday-row{background-color:#ffebee!important}input[type=date],input[type=number],input[type=text],input[type=time],select{width:95%;padding:8px;border:1px solid #ced4da;border-radius:6px;box-sizing:border-box;font-size:13px;transition:border-color .2s,box-shadow .2s}input:focus,select:focus{border-color:#0d6efd;box-shadow:0 0 0 2px rgba(13,110,253,.25);outline:0}.add-row-btn,.submit-btn{background-color:#198754;color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin-top:15px;transition:background-color .3s,transform .1s;box-shadow:0 2px 5px rgba(0,0,0,.1)}.submit-btn{background-color:#0d6efd}.add-row-btn:hover{background-color:#157347;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}.submit-btn:hover{background-color:#0b5ed7;transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,.15)}.file-upload-container{position:relative;overflow:hidden;display:inline-block;cursor:pointer;border:1px solid #0d6efd;border-radius:6px;background-color:#e6f7ff;padding:6px 10px;transition:background-color .2s}.file-upload-container:hover{background-color:#c9e6ff}.file-upload-container input[type=file]{position:absolute;left:0;top:0;opacity:0;cursor:pointer}.upload-label{font-size:11px;color:#0d6efd;font-weight:600}.file-preview-wrapper{width:40px;height:40px;margin:5px auto 0;border:2px solid #0d6efd;border-radius:4px;overflow:hidden;display:flex;align-items:center;justify-content:center;background-color:#fff;box-shadow:0 1px 3px rgba(0,0,0,.1)}.file-preview-mini{width:100%;height:100%;object-fit:cover;display:block}.excel-import-section{display:flex;align-items:center;gap:20px;padding:20px;margin-bottom:25px;border:1px solid #0d6efd;border-radius:10px;background-color:#f0f7ff}.excel-import-section input[type=file]{max-width:350px;padding:10px;border:1px solid #0d6efd;border-radius:6px;background-color:#fff;font-size:13px}.excel-import-section button{background-color:#0d6efd;color:#fff;border:none;padding:10px 18px;border-radius:6px;cursor:pointer;font-weight:600;transition:background-color .2s}.excel-import-section button:hover{background-color:#0b5ed7}.filter-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:25px;padding:20px;background-color:#f1f3f5;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.05)}.filter-controls label{display:block;margin-bottom:6px;font-weight:600;color:#495057;font-size:13px}.filter-controls button,.filter-controls input,.filter-controls select{padding:10px;border-radius:6px;border:1px solid #ced4da;font-size:13px}.reset-filter-btn{background-color:#6c757d;color:#fff;font-weight:600}.reset-filter-btn:hover{background-color:#5a6268}.kpi-cards{display:flex;flex-wrap:wrap;justify-content:space-between;gap:20px;margin-bottom:30px}.kpi-card{flex:1;min-width:250px;padding:20px;border-radius:12px;background:#fff;border-left:6px solid #0d6efd;box-shadow:0 5px 15px rgba(0,0,0,.1)}.kpi-card h4{margin-top:0;color:#0d6efd;font-size:15px;border-bottom:1px solid #e9ecef;padding-bottom:5px}.kpi-card p{margin-bottom:0;font-size:28px;font-weight:700;color:#343a40}#chartContainer{min-height:450px;margin-bottom:30px;padding:20px;background-color:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}.pie-mode{max-width:600px;margin-left:auto;margin-right:auto}.report-table-container{overflow-x:auto;max-height:75vh;border:1px solid #e9ecef;border-radius:8px;background:#fff}#availabilityReportTable,#dailyReportTable,#triputraAccumulationTable,#triputraReportTable{width:100%;border-collapse:collapse;font-size:12px;min-width:1400px;margin-bottom:0}#dailyReportTable caption{caption-side:top;text-align:left;font-size:14px;font-weight:600;padding:8px;color:#0d6efd}#availabilityReportTable th{background-color:#dc3545}.landscape-mode{min-width:3000px}.hm-cell-landscape{width:50px;font-size:11px;font-weight:600}.holiday-column{background-color:#fde8e9!important;color:#dc3545!important}th.holiday-column{background-color:#dc3545!important;color:#fff!important}.total-hm-periode-cell{background-color:#198754!important;color:#fff;font-weight:700;font-size:13px;min-width:100px;width:100px}.report-photo-cell{width:150px;padding:5px!important;display:flex;justify-content:space-around;align-items:center}.report-photo-cell img{width:35px;height:35px;object-fit:cover;border:1px solid #ced4da;border-radius:4px;cursor:pointer}.report-photo-cell img:hover{transform:scale(1.1)}.hm-high{background-color:#d1e7dd;font-weight:700}.hm-low{background-color:#f8d7da}.action-column button{padding:4px 8px;margin:2px;font-size:11px;border-radius:4px;border:none;cursor:pointer;transition:background-color .2s}.edit-report-button{background-color:#ffc107;color:#212529}.edit-report-button:hover{background-color:#e0a800}.delete-report-button{background-color:#dc3545;color:#fff}.delete-report-button:hover{background-color:#b02a37}.triputra-action-column{width:100px;min-width:100px}.solar-stock-card{background:#f7f3ff;border-left:6px solid #6f42c1;padding:25px;border-radius:12px;margin-bottom:25px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 10px rgba(0,0,0,.05)}.solar-stock-value{font-size:2.5rem;font-weight:700;color:#6f42c1}.stock-btn{background-color:#6f42c1;color:#fff;padding:10px 18px;border:none;border-radius:6px;cursor:pointer;font-weight:700;margin-left:8px;transition:background-color .2s}.stock-btn:hover{background-color:#5a32a3}.triputra-charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:30px}.tri-chart-box{background:#fff;padding:20px;border-radius:12px;border:1px solid #dee2e6;height:310px;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.05)}.stock-history-table{width:100%;font-size:13px;border-collapse:collapse}.stock-history-table th{background-color:#6f42c1;color:#fff}.MA-high{background-color:#d4edda;font-weight:700;color:#155724}.MA-low{background-color:#f8d7da;font-weight:700;color:#721c24}.PA-high{background-color:#e2f0fb;font-weight:700;color:#004085}.PA-low{background-color:#fff3cd;font-weight:700;color:#856404}.backup-restore-box{padding:20px;border:1px dashed #6c757d;border-radius:10px;margin-bottom:20px;background-color:#f9f9f9}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6)}.modal-content{background-color:#fff;margin:8% auto;padding:30px;border:none;width:90%;max-width:650px;border-radius:12px;position:relative;box-shadow:0 8px 25px rgba(0,0,0,.2)}.modal-content-lg{max-width:950px}.close-btn{color:#888;float:right;font-size:32px;font-weight:700;position:absolute;top:15px;right:25px;cursor:pointer;z-index:1001;transition:color .2s}.close-btn:hover{color:#333}#imageZoomModal .modal-content{background:0 0;border:none;box-shadow:none;max-width:90%;height:auto}#zoomedImage{width:100%;height:auto;max-height:85vh;object-fit:contain;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.6)}#imageZoomModal .close-btn{color:#fff;text-shadow:0 0 5px #000;opacity:1}.edit-form-group{margin-bottom:15px}.edit-form-group label{font-weight:600;display:block;margin-bottom:5px;color:#343a40}#unitList{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;max-height:65vh;overflow-y:auto;padding:10px}.master-unit-item{border:1px solid #e9ecef!important;padding:20px!important;border-left:5px solid #198754!important;border-radius:8px;background-color:#fefefe;box-shadow:0 1px 5px rgba(0,0,0,.05)}.master-unit-item .view-mode{display:flex;justify-content:space-between;align-items:center}.master-unit-item .view-mode span{font-size:14px}.master-item-actions{margin-top:15px}@media print{@page{size:A4 landscape;margin:5mm}body{font-family:Inter,sans-serif;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;background-color:#fff}#export_format,#toast-container,.action-column,.add-row-btn,.container>h1,.delete-row-btn,.excel-import-section,.filter-controls,.hide-on-print,.kpi-cards,.modal,.photo-column-header,.report-photo-cell,.solar-stock-card,.submit-btn,.tabs,.upload-label,button{display:none!important}#analisa_ketersediaan:not(.active),#input:not(.active),#laporan:not(.active),#laporan_triputra:not(.active),#master_data:not(.active){display:none!important}#input table td,#input table th:nth-child(1),#input table thead{display:none!important}.tab-content{display:none!important}.tab-content.active{display:block!important}body.print-table-only #laporan #chartContainer{display:none!important}body.print-chart-only #laporan #tableSection{display:none!important}body.print-ma-pa #analisa_ketersediaan{display:block!important}body.print-ma-pa #print-header h2:after{content:" Analisa Ketersediaan Alat (MA/PA)";display:block;font-size:18px;color:#dc3545;margin-top:5px}body.print-triputra #laporan_triputra{display:block!important}body.print-triputra.print-chart-only #laporan_triputra #triputraTableSection{display:none!important}body.print-triputra.print-table-only #laporan_triputra .triputra-charts-grid{display:none!important}#print-header{display:block!important;text-align:center;margin-bottom:20px;border-bottom:2px solid #212529;padding-bottom:10px}#print-header h2{margin:0;color:#212529;font-size:24px;text-transform:uppercase}#print-header p{margin:5px 0 0 0;font-size:14px;color:#333}#availabilityReportTable,#chartContainer,#tableSection,#triputraAccumulationTable,#triputraChartContainer,#triputraTableSection,.report-table-container{overflow:visible!important;max-height:none!important;display:block!important;width:100%!important}#laporan_triputra .triputra-charts-grid{display:grid!important}#laporan_triputra .tri-chart-box{height:300px!important}#laporan_triputra #box-trend{height:350px!important}body.print-ma-pa #analisa_ketersediaan h2,body.print-ma-pa #analisa_ketersediaan p:not(#avail-periode-info){display:none!important}.holiday-row{background-color:#fde8e9!important;-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}#dailyReportTable caption{display:block!important;caption-side:top;text-align:left;font-size:10px;font-weight:700;margin-bottom:5px}table{width:100%!important;min-width:100%!important;font-size:8.5px;border-collapse:collapse;page-break-inside:auto}#dailyReportTable.detailed td,#dailyReportTable.detailed th{padding:4px 2px}#dailyReportTable.detailed .col-date-report{width:80px!important;min-width:80px!important;max-width:80px!important;overflow:visible;white-space:nowrap}#dailyReportTable.detailed .col-hm-report,#dailyReportTable.detailed .col-jam-op-report,#dailyReportTable.detailed .col-kategori-keterangan-report,#dailyReportTable.detailed .col-solar-report,#dailyReportTable.detailed .col-time-report,#dailyReportTable.detailed .col-total-jam-report{width:55px!important;min-width:55px!important;max-width:55px!important;overflow:hidden}#dailyReportTable.detailed .col-unit-report{width:90px!important;min-width:90px!important}#dailyReportTable.detailed .col-op-report{width:75px!important;min-width:75px!important}#dailyReportTable.detailed .col-sektor-report{width:85px!important;min-width:85px!important}#dailyReportTable.detailed .report-keterangan{min-width:100px!important;white-space:normal}.landscape-mode{min-width:100%!important}th{background-color:#212529!important;color:#fff!important;border:1px solid #000;padding:6px 4px;font-size:9px}td{border:1px solid #ccc;padding:3px 2px;color:#000;white-space:nowrap}tr:nth-child(even){background-color:#f7f7f7!important}.group-total-row td,.group-total-row th{background-color:#e9ecef!important;font-weight:700}.hm-cell-landscape{width:30px!important}.total-hm-periode-cell{background-color:#198754!important;color:#fff!important;-webkit-print-color-adjust:exact}}#toast-container{position:fixed;top:20px;right:20px;z-index:9999}.toast{background-color:#fff;color:#343a40;padding:15px 20px;margin-bottom:12px;border-radius:8px;box-shadow:0 6px 15px rgba(0,0,0,.1);display:flex;align-items:center;min-width:350px;animation:slideIn .4s ease-out forwards;opacity:0;border-left:6px solid #0d6efd;border:1px solid #e9ecef}.toast.success{border-left-color:#198754}.toast.error{border-left-color:#dc3545}.toast.info{border-left-color:#0dcaf0}.toast.warning{border-left-color:#ffc107}.toast-icon{margin-right:15px;font-size:22px}.toast-content{flex:1}.toast-title{font-weight:700;font-size:15px;margin-bottom:3px;display:block}.toast-message{font-size:13px;color:#6c757d}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0}}.text-left{text-align:left!important}.text-right{text-align:right!important}/* CSS TAMBAHAN UNTUK SAVE IMAGE & LAYOUT */
    body.taking-screenshot .hide-on-print,
    body.taking-screenshot .filter-controls,
    body.taking-screenshot .tabs,
    body.taking-screenshot .action-column,
    body.taking-screenshot .add-row-btn,
    body.taking-screenshot .submit-btn,
    body.taking-screenshot button,
    body.taking-screenshot .excel-import-section,
    body.taking-screenshot .triputra-action-column,
    body.taking-screenshot #toast-container {
        display: none !important;
    }

    body.taking-screenshot .container {
        width: 100% !important;
        max-width: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 10px !important;
        border: none !important;
        background-color: white !important;
    }
    
    body.taking-screenshot {
        background-color: white !important;
    }
    /* === UI/UX TRACKING MODERN (Green Theme) === */

/* Container Utama */
.tracking-modal-body {
    padding: 10px;
    font-family: 'Inter', sans-serif;
    color: #334155;
}

/* Header Info Dokumen */
.doc-info-card {
    background: #f0fdf4; /* Hijau sangat muda */
    border: 1px solid #bbf7d0;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.doc-id { font-size: 1.2rem; font-weight: 700; color: #15803d; margin: 0; }
.doc-meta { font-size: 0.85rem; color: #64748b; margin-top: 4px; }

/* --- STEPPER HORIZONTAL (CORE) --- */
.stepper-wrapper {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    position: relative;
}

/* Garis Background (Gray) */
.stepper-wrapper::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    width: 100%;
    height: 3px;
    background: #e2e8f0;
    z-index: 1;
}

/* Garis Progress (Hijau) - Diatur lewat JS width-nya */
.progress-line-fill {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    height: 3px;
    background: #10b981; /* Emerald 500 */
    z-index: 1;
    transition: width 0.4s ease;
}

.step-item {
    position: relative;
    z-index: 2;
    text-align: center;
    width: 20%; /* Bagi rata 4-5 step */
}

/* Lingkaran Ikon */
.step-circle {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #cbd5e1; /* Gray border default */
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px auto;
    transition: all 0.3s ease;
    font-size: 18px;
    color: #94a3b8;
}

/* STATUS: COMPLETED (Lewat) */
.step-item.completed .step-circle {
    background: #10b981;
    border-color: #10b981;
    color: #fff;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
}

/* STATUS: ACTIVE (Sedang di sini) */
.step-item.active .step-circle {
    background: #fff;
    border-color: #10b981;
    color: #10b981;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
}

/* STATUS: ERROR/REJECT (X Merah) */
.step-item.error .step-circle {
    background: #ef4444;
    border-color: #ef4444;
    color: #fff;
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
}

/* Label di bawah circle */
.step-label {
    font-size: 11px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 2px;
}
.step-date {
    font-size: 10px;
    color: #94a3b8;
}
.step-item.active .step-label { color: #10b981; }
.step-item.error .step-label { color: #ef4444; }

/* Status Final Text */
.final-status-text {
    text-align: center;
    margin-top: 30px;
    font-size: 14px;
    font-weight: 600;
    padding: 10px;
    border-radius: 8px;
    background-color: #f8fafc;
}
.status-success { color: #10b981; background: #ecfdf5; }
.status-danger { color: #ef4444; background: #fef2f2; }
.status-process { color: #f59e0b; background: #fffbeb; }

/* Sejarah Log (Minimalis di bawah) */
.history-log-section {
    margin-top: 30px;
    border-top: 1px dashed #e2e8f0;
    padding-top: 20px;
}
.history-title { font-size: 12px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; }
.history-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f1f5f9;
    font-size: 12px;
}
/* --- LAYOUT BARU INPUT DASHBOARD --- */
.input-dashboard-wrapper {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    align-items: stretch;
}

.dashboard-main {
    flex: 2; /* Mengambil porsi lebih lebar (Input Cepat) */
    min-width: 400px;
}

.dashboard-sidebar {
    flex: 1; /* Mengambil porsi lebih sempit (Tools Upload) */
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Kotak Compact agar hemat tempat */
.compact-tool-box {
    padding: 12px 15px;
    border-radius: 8px;
    background-color: #fff;
    border: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    transition: transform 0.2s;
}

.compact-tool-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
}

.compact-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.compact-title {
    font-size: 13px;
    font-weight: 700;
    margin: 0;
}

.compact-desc {
    font-size: 11px;
    color: #666;
    margin: 0;
    line-height: 1.3;
}

/* Override style khusus Fast Entry agar pas di grid */
.fast-entry-box {
    height: 100%; /* Agar tinggi sama dengan sidebar */
    margin-bottom: 0 !important;
}


@media print {
    /* 1. SETUP KERTAS & MARGIN AMAN */
    @page {
        size: A4 landscape;
        /* Margin atas agak besar untuk memberi ruang judul */
        margin: 15mm 10mm 10mm 10mm; 
    }

    body {
        background-color: white !important;
        font-family: Arial, sans-serif !important;
        color: black !important;
        font-size: 9pt !important;
        /* Reset margin body */
        margin: 0 !important;
        padding: 0 !important;
    }

    /* 2. SEMBUNYIKAN SEMUA ELEMEN TERLEBIH DAHULU */
    body * {
        visibility: hidden;
        height: 0; /* Lipat elemen yang tersembunyi agar tidak makan tempat */
    }

    /* 3. TAMPILKAN HEADER JUDUL (FLOW NORMAL) */
    #print-header, #print-header * {
        visibility: visible !important;
        display: block !important;
        position: static !important;
        width: 100% !important;
        text-align: center !important;
        height: auto !important;
    }

    #print-header {
        /* Jarak total dari Header ke Tabel */
        margin-bottom: 10px !important; 
    }

    /* Styling Judul Utama */
    #print-header h2 {
        font-size: 20pt !important;
        margin: 0 !important;
        text-transform: uppercase;
        font-weight: bold;
        color: black !important;
        
        /* Membuat Garis Bawah (-----) */
        border-bottom: 3px double black !important; 
        padding-bottom: 10px !important; /* Jarak tulisan ke garis */
        margin-bottom: 15px !important;  /* Jarak garis ke tulisan Periode */
    }

    /* Styling Sub-Judul (Periode) - INI YANG DITURUNKAN */
    #print-periode-info {
        font-size: 11pt !important;
        font-weight: bold;
        color: #333 !important;
        
        margin-top: 5px !important;    /* Turunkan sedikit dari garis judul */
        margin-bottom: 5px !important; /* Jarak sempit ke Tabel */
        display: block !important;
    }
    /* 4. TAMPILKAN KONTEN TABEL (FLOW NORMAL DI BAWAH JUDUL) */
    
    /* Container Tab Aktif */
    .tab-content.active {
        visibility: visible !important;
        display: block !important;
        position: relative !important; /* PENTING: Jangan absolute, agar tidak menimpa judul */
        width: 100% !important;
        height: auto !important;
        margin: 0 !important;
        padding: 0 !important;
        top: auto !important;
        left: auto !important;
    }

    /* Paksa semua isi di dalam tab aktif terlihat */
    .tab-content.active * {
        visibility: visible !important;
        height: auto !important;
    }

    /* Spesifik untuk Laporan Harian: Sembunyikan judul H3 bawaan HTML yang double */
    #tableSection h3 { display: none !important; }


    /* 5. STRUKTUR TABEL RAPI */
    .report-table-container {
        display: block !important;
        width: 100% !important;
        border: none !important;
        overflow: visible !important;
    }

    table {
        width: 100% !important;
        border-collapse: collapse !important;
        /* Pastikan tidak ada margin aneh yang mendorong ke atas */
        margin-top: 0 !important; 
    }

    /* Header Kolom Tabel (TH) */
    th {
        background-color: #d3d3d3 !important; /* Abu hemat tinta */
        color: black !important;
        border: 1px solid black !important; /* Garis tegas */
        padding: 6px 4px !important;
        font-size: 9pt !important;
        text-align: center !important;
        vertical-align: middle !important;
        position: static !important; /* Wajib static */
        white-space: normal !important;
    }

    /* Data Sel Tabel (TD) */
    td {
        border: 1px solid black !important;
        padding: 5px 4px !important;
        font-size: 9pt !important;
        vertical-align: middle !important;
        color: black !important;
    }

    /* 6. SEMBUNYIKAN ELEMEN PENGGANGGU LAINNYA */
    .action-column, .filter-controls, .kpi-cards, .add-row-btn, 
    .submit-btn, .edit-report-button, .delete-report-button,
    button, .solar-stock-card, .hide-on-print,
    #chartContainer, .report-checkbox, .report-photo-cell img { width: 30px; height: 30px; }
    
    /* Jika ingin foto tetap tampil kecil, hapus .report-photo-cell dari list display:none diatas */
    /* dan gunakan css ini: */
    /* .report-photo-cell img { width: 30px; height: 30px; } */
}
</style><div class=container><div style=display:none id=print-header><h2>Laporan Harian Operasi (DOR)</h2><p id=print-periode-info>Periode: (21-01-2025 - 20-01-2025)</div><h1>Daily Operator Report PT ADHIE USAHA MANDIRI</h1><div class="tabs">
    <button class="tab-button active" data-tab="input">
        <span>‚ûï</span> <span class="tab-text">Input Laporan Batch</span>
    </button>
    
    <button class="tab-button" data-tab="laporan">
        <span>üìä</span> <span class="tab-text">Data & Laporan Harian</span>
    </button>
    
    <button class="tab-button availability-tab" onclick="window.fetchAvailabilityData()" data-tab="analisa_ketersediaan">
        <span>üìà</span> <span class="tab-text">Analisa Ketersediaan (MA/PA)</span>
    </button>
    
    <button class="tab-button triputra-tab" data-tab="laporan_triputra">
        <span>üè≠</span> <span class="tab-text">Laporan Khusus Triputra</span>
    </button>
    
    <button class="tab-button" onclick="window.fetchAttendanceData()" data-tab="absensi">
        <span>üìã</span> <span class="tab-text">Rekap Absensi</span>
    </button>

    <button class="tab-button" onclick="window.loadCleanlinessView()" data-tab="penilaian_kebersihan" style="color: #d63384;">
    <span>üßπ</span> <span class="tab-text">Penilaian Kebersihan</span>
    </button>
    
    <button class="tab-button" onclick="window.loadTrackingView()" data-tab="tracking_ba" style="color: #d63384;">
        <span>üìë</span> <span class="tab-text">Tracking BA & Invoice</span>
    </button>
    
    <button class="tab-button" onclick="window.loadFuelData()" data-tab="fuel_tracking" style="color: #fd7e14;">
        <span>‚õΩ</span> <span class="tab-text">Fuel Control</span>
    </button>
    
    <button class="tab-button" onclick="window.loadGAView()" data-tab="general_affair" style="color: #20c997;">
        <span>üè¢</span> <span class="tab-text">General Affair</span>
    </button>
    
    <button class="tab-button" onclick="window.openMasterDataModal()" data-tab="master_data">
        <span>‚öôÔ∏è</span> <span class="tab-text">Kelola Unit & Master Data</span>
    </button>
</div><div class="tab-content active" id="input">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <p style="margin: 0;">Input data laporan harian (DOR). Tekan tombol <strong>Tambah Baris</strong> di bawah tabel untuk entri manual.</p>
    </div>

    <div class="input-dashboard-wrapper">
        
       <div class="fast-entry-box" style="background: #e6f7ff; border: 1px solid #0d6efd; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
    <h4 style="margin-top: 0; color: #0d6efd; display: flex; align-items: center; gap: 10px; font-size: 15px; margin-bottom: 15px;">
        ‚ö° Input Cepat & Update Foto
        <span style="font-size: 10px; font-weight: normal; color: #555; background: #fff; padding: 2px 8px; border-radius: 10px; border: 1px solid #ccc;">
            Smart Merge
        </span>
    </h4>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: flex-start; margin-bottom: 10px;">
        <div>
            <label style="font-size: 11px; font-weight: bold; display:block; margin-bottom:4px;">Tanggal</label>
            <input type="date" id="fast_tanggal" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; box-sizing: border-box;">
        </div>
        <div>
            <label style="font-size: 11px; font-weight: bold; display:block; margin-bottom:4px;">Unit / Alat</label>
            <select id="fast_unit" class="input-unit" onchange="window.updateFastEntryPreview(this)" style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; box-sizing: border-box;"></select>
        </div>
        <div>
            <label style="font-size: 11px; font-weight: bold; display:block; margin-bottom:4px;">HM Akhir</label>
            <input type="number" id="fast_hm_akhir" placeholder="HM..." style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; font-size: 12px; box-sizing: border-box;">
            <div id="fast_hm_info" style="font-size: 10px; color: #198754; margin-top: 3px; min-height: 15px; line-height: 1.2;"></div>
        </div>
        <div>
            <label style="font-size: 11px; font-weight: bold; display:block; margin-bottom:4px;">Keterangan</label>
            <input type="text" id="fast_keterangan" list="keteranganDatalist" placeholder="Opsional..." style="width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; box-sizing: border-box;">
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; align-items: end; background: #fff; padding: 10px; border-radius: 8px; border: 1px dashed #ccc;">
        <div>
            <label style="font-size: 10px; font-weight: bold; color: #666;">üì∏ Timesheet</label>
            <input type="file" id="fast_foto_timesheet" accept="image/*" capture="camera" style="width: 100%; font-size: 10px;">
        </div>
        <div>
            <label style="font-size: 10px; font-weight: bold; color: #666;">üì∏ HM Awal</label>
            <input type="file" id="fast_foto_awal" accept="image/*" capture="camera" style="width: 100%; font-size: 10px;">
        </div>
        <div>
            <label style="font-size: 10px; font-weight: bold; color: #666;">üì∏ HM Akhir</label>
            <input type="file" id="fast_foto_akhir" accept="image/*" capture="camera" style="width: 100%; font-size: 10px;">
        </div>
        <div style="align-self: center;">
            <button type="button" onclick="window.processSmartFastEntry()" style="width: 100%; background-color: #0d6efd; color: white; border: none; padding: 8px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; font-size: 12px;">
                ‚¨áÔ∏è Proses
            </button>
        </div>
    </div>
</div>

        <div class="dashboard-sidebar">
            
            <div class="compact-tool-box" style="border-left: 4px solid #0d6efd; background-color: #f0f7ff;">
                <div class="compact-header">
                    <h5 class="compact-title" style="color: #0d6efd;">üìä Import Excel</h5>
                    <button onclick="window.handleExcelImport()" type="button" style="background-color: #0d6efd; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Upload</button>
                </div>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls" style="font-size: 10px; width: 100%;">
            </div>

            <div class="compact-tool-box" style="border-left: 4px solid #198754; background-color: #d1e7dd;">
                <div class="compact-header">
                    <h5 class="compact-title" style="color: #0f5132;">üìÇ Upload Folder Unit</h5>
                    <button type="button" onclick="document.getElementById('folderInput').click()" style="background-color: #198754; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Pilih Folder</button>
                </div>
                <p class="compact-desc">Scan folder Unit berisi foto (Nama file: Tgl + Tipe). Auto-detect Unit dari nama folder.</p>
                <input type="file" id="folderInput" webkitdirectory directory multiple style="display: none;" onchange="window.processSmartFolderUpload(this)">
                <div id="folderUploadLog" style="font-size: 9px; color: #333; max-height: 50px; overflow-y: auto; display: none; margin-top:5px;"></div>
            </div>

            <div class="compact-tool-box" style="border-left: 4px solid #ffc107; background-color: #fff3cd;">
                <div class="compact-header">
                    <h5 class="compact-title" style="color: #856404;">üìÅ Bulk Upload (File)</h5>
                    <button type="button" onclick="document.getElementById('bulkUploadModal').style.display='block'" style="background-color: #ffc107; color: #000; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: bold;">Buka Menu</button>
                </div>
                <p class="compact-desc">Upload banyak foto sekaligus berdasarkan format nama file: <strong>UNIT_TGL_TIPE.jpg</strong></p>
            </div>

        </div>
    </div>
    <form id="batchReportForm">
        <div class="table-input-container">
            <table>
                <thead>
                    <tr>
                        <th class="col-action" rowspan="2" style="width: 60px; text-align:center; vertical-align: middle;">
                            <input type="checkbox" id="selectAllInput" onclick="window.toggleSelectAllInput(this)" title="Pilih Semua">
                        </th>
                        <th class="col-date" rowspan="2">Tanggal</th>
                        <th class="col-unit" rowspan="2">Unit/Alat</th>
                        <th class="col-op" rowspan="2">Operator</th>
                        <th class="col-model" rowspan="2">Model Unit</th>
                        <th class="col-sektor" rowspan="2">Sektor Kerja</th>
                        <th colspan="2">Jam Kerja (Opsional)</th>
                        <th class="col-file photo-column-header" rowspan="2">Foto Timesheet</th>
                        <th colspan="3">Hour Meter (HM)</th>
                        <th class="col-file photo-column-header" rowspan="2">Foto HM Akhir</th>
                        <th class="col-solar" rowspan="2">Total Solar (Ltr)</th>
                        <th class="col-keterangan" rowspan="2">Keterangan</th>
                    </tr>
                    <tr>
                        <th class="col-time">Masuk</th>
                        <th class="col-time">Keluar</th>
                        <th class="col-hm">HM Awal</th>
                        <th class="col-file photo-column-header">Foto HM Awal</th>
                        <th class="col-hm">HM Akhir</th>
                    </tr>
                </thead>
                <tbody id="reportInputBody"></tbody>
            </table>
        </div>
        
        <div style="margin-top:20px; text-align:right;">
            <button type="button" onclick="window.deleteSelectedInputRows()" style="background-color: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 600; margin-right: 10px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                üóëÔ∏è Hapus Terpilih
            </button>
            <button class="add-row-btn" onclick="window.addRow()" type="button">‚ûï Tambah Baris</button> 
            <button class="submit-btn" type="submit">üíæ Simpan Laporan Batch</button>
        </div>
    </form>

    <datalist id="operatorDatalist">
        <option value="ANUGERAH"><option value="BOBI"><option value="DEDI"><option value="ELIA"><option value="ERNES"><option value="FADIL"><option value="GIANTO"><option value="GIVEN RANDE"><option value="HAKIM"><option value="HANSYAH"><option value="PAULUS"><option value="RIAN"><option value="ROGER"><option value="ROLAND"><option value="SETIO PAMBUDI"><option value="SISWANTO"><option value="SURIANSYAH"><option value="SURYANDI"><option value="VALENTINO">
    </datalist>
</div>
</form><datalist id=operatorDatalist><option value=ANUGERAH><option value=BOBI><option value=DEDI><option value=ELIA><option value=ERNES><option value=FADIL><option value=GIANTO><option value="GIVEN RANDE"><option value=HAKIM><option value=HANSYAH><option value=PAULUS><option value=RIAN><option value=ROGER><option value=ROLAND><option value="SETIO PAMBUDI"><option value=SISWANTO><option value=SURIANSYAH><option value=SURYANDI><option value=VALENTINO></datalist></div><div class="tab-content both"id=laporan><h3 style=color:#0d6efd;margin-bottom:10px class=hide-on-print>Filter & Ringkasan Laporan</h3><div class=filter-controls><div><label for=period_select>Periode:</label> <select onchange=window.handlePeriodChange() id=period_select><option value=calendar_monthly>Periode Kalender (Tgl 1 - Akhir)<option value=custom_monthly_21_20>Periode Akuntansi (Tgl 21 - Tgl 20)<option value=weekly>7 Hari Terakhir</select></div><div><label for=filter_month>Bulan/Rentang:</label> <select onchange=window.fetchReportData() id=filter_month multiple size=6><option value=11,0,2024,2025>Desember 2024 (21) - Januari 2025 (20)<option value=0,1,2025,2025>Januari 2025 (21) - Februari 2025 (20)<option value=1,2,2025,2025>Februari 2025 (21) - Maret 2025 (20)<option value=2,3,2025,2025>Maret 2025 (21) - April 2025 (20)<option value=3,4,2025,2025>April 2025 (21) - Mei 2025 (20)<option value=4,5,2025,2025>Mei 2025 (21) - Juni 2025 (20)<option value=5,6,2025,2025>Juni 2025 (21) - Juli 2025 (20)<option value=6,7,2025,2025>Juli 2025 (21) - Agustus 2025 (20)<option value=7,8,2025,2025>Agustus 2025 (21) - September 2025 (20)<option value=8,9,2025,2025>September 2025 (21) - Oktober 2025 (20)<option value=9,10,2025,2025>Oktober 2025 (21) - November 2025 (20)<option value=10,11,2025,2025>November 2025 (21) - Desember 2025 (20)</select></div><div><label for=filter_year>Tahun:</label> <select onchange=window.handleYearChange() id=filter_year><option value=2025>2025<option value=2024>2024<option value=2023>2023<option value=2022>2022<option value=2021>2021</select></div><div><label for=filter_unit>Filter Unit:</label> <select onchange=window.fetchReportData() id=filter_unit><option value=all>-- Semua Unit --<option value="AUM 03A">AUM 03A<option value="AUM 05A">AUM 05A<option value="AUM 17">AUM 17<option value="AUM 24">AUM 24<option value="AUM 25">AUM 25<option value="AUM 29">AUM 29<option value="AUM 31">AUM 31<option value="AUM 32">AUM 32<option value="AUM 33">AUM 33<option value="AUM 40">AUM 40<option value="AUM 41">AUM 41<option value="AUM 42">AUM 42<option value="AUM 43">AUM 43<option value="AUM 45">AUM 45<option value="AUM 46">AUM 46<option value="AUM 53">AUM 53<option value="AUM 54">AUM 54<option value="AUM 63">AUM 63<option value="AUM 64">AUM 64<option value="AUM 65">AUM 65<option value="AUM 68">AUM 68</select></div><div><label for=filter_sektor>Filter Sektor (Klasifikasi):</label> <select onchange=window.fetchReportData() id=filter_sektor><option value=all>-- Semua Sektor --<option value=IHM>IHM<option value=KWL>KWL<option value=TRIPUTRA>TRIPUTRA</select></div><div><label for=report_view>Tampilan Tabel:</label> <select onchange=window.fetchReportData() id=report_view><option value=detailed>Detail Per Baris (Tanggal)<option value=summary_unit>Ringkasan per Unit<option value=summary_operator>Ringkasan per Operator<option value=landscape_unit>Landscape (HM Harian) per Unit<option value=landscape_operator>Landscape (HM Harian) per Operator</select></div><div><label for=chart_type_select>Jenis Grafik:</label> <select onchange=window.fetchReportData() id=chart_type_select><option value=bar>Bar (Default)<option value=line>Garis (Tren)<option value=doughnut_hm>Pie (Distribusi HM)<option value=doughnut_solar>Pie (Distribusi Solar)</select></div><div><label for=display_view>Tampilan Data:</label> <select onchange=window.handleDisplayView() id=display_view><option value=both>Grafik & Tabel<option value=chart_only>Grafik Saja<option value=table_only>Tabel Saja</select></div><div><label for=show_photos>Kolom Foto:</label> <select onchange=window.togglePhotoColumn() id=show_photos><option value=hide>Sembunyikan<option value=show selected>Tampilkan</select></div><div>
    <label for="export_format">Export/Cetak:</label> 
    <select onchange="window.handleExport()" id="export_format">
        <option value="">-- Pilih Export --</option>
        
        <optgroup label="üí∞ Payroll / Gaji">
            <option value="export_payroll">Export Gaji (Per Operator)</option>
        </optgroup>

        <optgroup label="üìä Data Laporan">
            <option value="csv">Export ke XLSX (Data Mentah)</option>
        </optgroup>
        
        <optgroup label="üñ®Ô∏è Cetak PDF">
            <option value="print_chart">Hanya Grafik</option>
            <option value="print_table">Hanya Tabel</option>
            <option value="print_both">Grafik & Tabel (Full)</option>
        </optgroup>

        <optgroup label="üíæ Simpan Gambar (JPG)">
            <option value="save_img_chart">Hanya Grafik</option>
            <option value="save_img_table">Hanya Tabel</option>
            <option value="save_img_both">Grafik & Tabel (Full)</option>
        </optgroup>
    </select>
</div><button onclick="window.refreshAndFixData(this)" class="refresh-btn" style="background-color:#0dcaf0; color:#fff; font-weight:600; transition: all 0.3s;">
    üîÑ Muat Ulang & Perbaiki Data
</button><button class=reset-filter-btn onclick=window.resetReportFilters()>üßπ Reset Filter</button></div><div class=kpi-cards><div class=kpi-card><h4>Total Jam Operasi (HM)</h4><p id=total_hm_bulan>0 HM</div><div class=kpi-card style=border-left-color:#ffc107><h4 style=color:#ffc107>Total Konsumsi Solar</h4><p id=total_solar_bulan>0 Liter</div><div class=kpi-card style=border-left-color:#198754><h4 style=color:#198754>Total Jam Kerja Timesheet</h4><p id=total_work_hour_bulan>0 Jam</div></div><p style=font-style:italic;text-align:center;color:#555 id=periode-info class=hide-on-print>Periode: (21-01-2025 - 20-01-2025)<div style=display:block id=chartContainer><p style=text-align:center;margin-top:150px;color:#dc3545>‚ùå **Tidak ada data laporan** yang tersedia untuk filter/periode ini.</div><div style=display:block id=tableSection><hr style="border:0;border-top:3px dashed #ced4da;margin:30px 0"><h3 style=color:#0d6efd;margin-top:10px>Tabel Data Laporan</h3><button onclick="window.deleteSelectedReports()" 
                style="background-color: #dc3545; color: #fff; font-weight: 600; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px;">
            <span>üóëÔ∏è</span> Hapus Terpilih
        </button>
    </div><div class=report-table-container><table id=dailyReportTable class=detailed><caption style="font-weight:700;padding:10px 0;color:#0d6efd">Tabel Data Laporan - **Periode: (21-01-2025 - 20-01-2025)**<thead><tr><th class=action-column rowspan=2 style=width:100px;min-width:100px>Aksi<th class="text-left col-date-report"rowspan=2>Tanggal <button class=sort-button onclick='window.handleSort("tanggal")'id=sort-btn-tanggal title="Urutan: desc">‚Üì</button><th class="text-left col-unit-report"rowspan=2>Unit/Alat <button class=sort-button onclick='window.handleSort("unit")'id=sort-btn-unit title=Sort></button><th class="text-left col-op-report"rowspan=2>Operator <button class=sort-button onclick='window.handleSort("operator")'id=sort-btn-operator title=Sort></button><th class="text-left col-sektor-report"rowspan=2>Sektor Kerja <button class=sort-button onclick='window.handleSort("sektor")'id=sort-btn-sektor title=Sort></button><th colspan=3>Hour Meter (HM)<th colspan=3>Timesheet / Jam Kerja<th class=col-solar-report rowspan=2>‚õΩ Solar (Ltr) <button class=sort-button onclick='window.handleSort("total_solar")'id=sort-btn-total_solar title=Sort></button><th class=col-kategori-keterangan-report rowspan=2>KATEGORI<th class=photo-column-header rowspan=2 style=display:table-cell>Foto<th class="text-left keterangan-column-header"rowspan=2 style=width:100px;max-width:100px>Keterangan<tr><th class=col-hm-report>HM Awal<th class=col-hm-report>HM Akhir<th class=col-jam-op-report>Jam Operasi <button class=sort-button onclick='window.handleSort("jam_operasi")'id=sort-btn-jam_operasi title=Sort></button><th class=col-time-report>Jam Masuk<th class=col-time-report>Jam Keluar<th class=col-total-jam-report>Total Jam Kerja<tbody></table></div></div></div><div class=tab-content id=analisa_ketersediaan><h2 style="color:#dc3545;border-bottom:3px solid #dc3545">‚öôÔ∏è Analisa Ketersediaan Alat (MA & PA)</h2><p style=color:#555;font-style:italic>Perhitungan didasarkan pada **Total Jam Kerja Timesheet** (TJK) sebagai jam operasi rencana (Potential Hours), di mana minimnya TJK dihitung sebagai waktu yang hilang karena Breakdown/Idle. Rumus di bagian bawah halaman.<div class=filter-controls style="background-color:#fce8e9;border:1px solid #dc3545"><div><label for=avail_period_select>Periode Tampilan:</label> <select onchange='window.updateMonthRange(this.value,"avail_")'id=avail_period_select><option value=calendar_monthly>Periode Kalender (Tgl 1 - Akhir)<option value=custom_monthly_21_20>Periode Akuntansi (Tgl 21 - Tgl 20)<option value=weekly>7 Hari Terakhir</select></div><div><label for=avail_filter_month>Bulan/Rentang (Pilih Multiple):</label> <select onchange=window.fetchAvailabilityData() id=avail_filter_month multiple size=6><option value=11,0,2024,2025>Desember 2024 (21) - Januari 2025 (20)<option value=0,1,2025,2025>Januari 2025 (21) - Februari 2025 (20)<option value=1,2,2025,2025>Februari 2025 (21) - Maret 2025 (20)<option value=2,3,2025,2025>Maret 2025 (21) - April 2025 (20)<option value=3,4,2025,2025>April 2025 (21) - Mei 2025 (20)<option value=4,5,2025,2025>Mei 2025 (21) - Juni 2025 (20)<option value=5,6,2025,2025>Juni 2025 (21) - Juli 2025 (20)<option value=6,7,2025,2025>Juli 2025 (21) - Agustus 2025 (20)<option value=7,8,2025,2025>Agustus 2025 (21) - September 2025 (20)<option value=8,9,2025,2025>September 2025 (21) - Oktober 2025 (20)<option value=9,10,2025,2025>Oktober 2025 (21) - November 2025 (20)<option value=10,11,2025,2025>November 2025 (21) - Desember 2025 (20)</select></div><div><label for=avail_filter_year>Tahun:</label> <select onchange='window.updateMonthRange(document.getElementById("avail_period_select").value,"avail_")'id=avail_filter_year><option value=2025>2025<option value=2024>2024<option value=2023>2023<option value=2022>2022<option value=2021>2021</select></div><div><label for=avail_filter_sektor>Filter Sektor (Klasifikasi):</label> <select onchange=window.fetchAvailabilityData() id=avail_filter_sektor><option value=all>-- Semua Sektor --<option value=IHM>IHM<option value=KWL>KWL<option value=TRIPUTRA>TRIPUTRA</select></div><div><label for=avail_group_by>Tampilkan Grup:</label> <select onchange=window.fetchAvailabilityData() id=avail_group_by><option value=unit>Unit<option value=operator>Operator</select></div><div><label for=avail_target_hour>Target Jam Kerja/Hari:</label> <input type=number id=avail_target_hour step=0.5 onchange=window.fetchAvailabilityData() value=12></div><div><label for=avail_export_format>Export/Cetak:</label> <select onchange=window.handleAvailabilityExport() id=avail_export_format><option value="">-- Pilih --<option value=csv>Export ke XLSX (Excel)<option value="save_image_jpg">Simpan sebagai Gambar (JPG)</option><option value=print_table>Cetak Tabel (PDF)</select></div><button onclick=window.fetchAvailabilityData() style=background-color:#dc3545;color:#fff;font-weight:600>üîÑ Hitung Ulang Analisa</button><button onclick="window.exportAnnualAvailabilityExcel()" style="background-color: #198754; color: #fff; font-weight: 600; margin-top: 10px; width: 100%;">
    üìä Export Laporan Tahunan (Jan-Des)
</button></div><p style=font-style:italic;text-align:center;color:#555;margin-bottom:20px id=avail-periode-info>Periode Analisa: -<div class=report-table-container><table id="availabilityReportTable">
    <thead>
        <tr>
            <th rowspan="2" style="width: 150px;">Unit/Operator</th>
            <th colspan="2">Jam Rencana (PH)</th>
            <th colspan="3">Kategori Waktu Hilang (Smart Detect)</th>
            <th rowspan="2" style="width: 100px;">Jam Operasi (Act)</th>
            <th rowspan="2" style="width: 80px;">MA (%)</th>
            <th rowspan="2" style="width: 80px;">PA (%)</th>
        </tr>
        <tr>
            <th>Hari Kerja</th>
            <th>Total PH</th>
            <th style="background:#f8d7da; color:#721c24;">Breakdown (M)</th>
            <th style="background:#e2f0fb; color:#004085;">Cuaca (P)</th>
            <th style="background:#fff3cd; color:#856404;">Idle Lain (P)</th>
        </tr>
    </thead>
    <tbody id="availabilityReportBody">
        <tr>
            <td colspan="9" style="text-align:center;">Silakan pilih periode dan klik tombol "Hitung Ulang Analisa".</td>
        </tr>
    </tbody>
    <tfoot id="availabilityReportFoot" style="font-weight:700;background:#f0f0f0"></tfoot>
</table></div><div id="smartAnalysisContainer" style="display:none; margin-top: 25px; padding: 20px; background-color: #f0f7ff; border-radius: 10px; border-left: 6px solid #0d6efd; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
    <h3 style="margin-top: 0; color: #0d6efd; font-size: 16px;">ü§ñ Analisa Cerdas & Rekomendasi Sistem:</h3>
    <div id="smartAnalysisContent" style="font-size: 14px; line-height: 1.6; color: #333;">
        </div>
</div><hr style="margin:30px 0"><p style=font-size:.9em;color:#777>**Rumus:** * **TJK Rencana (PH - Potential Hours):** Hari Kerja Efektif x Target Jam/Hari (misal 12 Jam). * **Jam Operasi:** Total HM Actual. * **Breakdown (M - Maintenance Hours):** Jam kerja hilang akibat kategori 'BREAKDOWN'. * **Idle/Tunggu (P - Personnel/Process Hours):** Jam kerja hilang akibat kategori 'CUACA', 'NO OPERATOR', 'MENUNGGU SPAREPART', 'PERINTAH PENGAWAS'. * **MA (Mechanical Availability):** $\frac{Jam\ Operasi + Jam\ Idle}{PH} \times 100\%$ * **PA (Physical Availability):** $\frac{Jam\ Operasi}{PH - Jam\ Breakdown} \times 100\%$</div><div class=tab-content id=laporan_triputra><h2 style="color:#6f42c1;border-bottom:3px solid #6f42c1">üè≠ Laporan Operasional Sektor Triputra</h2><div class="hide-on-print filter-controls"style="background-color:#f7f3ff;border:1px solid #6f42c1"><div><label for=trp_period_select>Periode:</label> <select onchange=window.handleTriputraPeriodChange() id=trp_period_select><option value=calendar_monthly>Periode Kalender (Tgl 1 - Akhir)<option value=custom_monthly_21_20>Periode Akuntansi (Tgl 21 - Tgl 20)<option value=weekly>7 Hari Terakhir</select></div><div>
    <label for="trp_filter_operator">Filter Operator (AUM 24,25,65):</label>
    <select onchange="window.fetchTriputraData()" id="trp_filter_operator">
        <option value="all">-- Semua Operator --</option>
    </select>
</div><div><label for=trp_filter_month>Bulan/Rentang (Pilih Multiple):</label> <select onchange=window.fetchTriputraData() id=trp_filter_month multiple size=6><option value=11,0,2024,2025>Desember 2024 (21) - Januari 2025 (20)<option value=0,1,2025,2025>Januari 2025 (21) - Februari 2025 (20)<option value=1,2,2025,2025>Februari 2025 (21) - Maret 2025 (20)<option value=2,3,2025,2025>Maret 2025 (21) - April 2025 (20)<option value=3,4,2025,2025>April 2025 (21) - Mei 2025 (20)<option value=4,5,2025,2025>Mei 2025 (21) - Juni 2025 (20)<option value=5,6,2025,2025>Juni 2025 (21) - Juli 2025 (20)<option value=6,7,2025,2025>Juli 2025 (21) - Agustus 2025 (20)<option value=7,8,2025,2025>Agustus 2025 (21) - September 2025 (20)<option value=8,9,2025,2025>September 2025 (21) - Oktober 2025 (20)<option value=9,10,2025,2025>Oktober 2025 (21) - November 2025 (20)<option value=10,11,2025,2025>November 2025 (21) - Desember 2025 (20)</select></div><div><label for=trp_filter_year>Tahun:</label> <select onchange=window.handleTriputraYearChange() id=trp_filter_year><option value=2025>2025<option value=2024>2024<option value=2023>2023<option value=2022>2022<option value=2021>2021</select></div><div><label for=trp_data_category>Tampilkan Laporan:</label> <select onchange=window.fetchTriputraData() id=trp_data_category><option value=all>-- Semua Data --<option value=hm>Laporan HM<option value=solar>Laporan Solar<option value=pencapaian>Laporan Pencapaian Titik</select></div><div><label for=trp_report_view>Tampilan Tabel:</label> <select onchange=window.fetchTriputraData() id=trp_report_view><option value=list>Daftar Detail (List)<option value=landscape>Landscape Matriks (Unit vs Tanggal)</select></div><div><label for=trp_chart_type>Tampilan Grafik:</label> <select onchange=window.fetchTriputraData() id=trp_chart_type><option value=dashboard>Dashboard Lengkap (Default)<option value=composition>Komposisi Unit (Pie)<option value=trend>Tren Fokus (Line Only)<option value=comparison>Perbandingan Unit (Bar Only)</select></div><div><label for=trp_target_val>Target Per Unit/Hari (Titik):</label> <input type=number id=trp_target_val onchange=window.fetchTriputraData() value=120></div><div><label for=trp_export_format>Export/Cetak:</label> <select onchange="window.handleTriputraExport()" id="trp_export_format">
    <option value="">-- Pilih Export --</option>
    <option value="csv">Export ke Excel (XLSX)</option>
    
    <optgroup label="üñ®Ô∏è Cetak PDF">
        <option value="print_chart">Hanya Grafik</option>
        <option value="print_table">Hanya Tabel</option>
        <option value="print_both">Cetak Semua</option>
    </optgroup>

    <optgroup label="üíæ Simpan Gambar (JPG)">
        <option value="save_img_chart">Hanya Grafik</option>
        <option value="save_img_table">Hanya Tabel</option>
        <option value="save_img_both">Grafik & Tabel (Full)</option>
    </optgroup>
</select>
<div style="display:flex; align-items:center; padding-top:20px;">
        <input type="checkbox" id="trp_hide_ops" checked onchange="window.fetchTriputraData()" style="width:20px; height:20px; margin-right:10px;">
        <label for="trp_hide_ops" style="cursor:pointer; color:#6f42c1; font-weight:bold;">Sembunyikan Unit Operasional (LV/Sarana)</label>
    </div>
</div><button onclick=window.fetchTriputraData() style=background-color:#6f42c1;color:#fff;font-weight:600>üîÑ Terapkan Filter</button></div><p style=font-style:italic;text-align:center;color:#555;margin-bottom:20px id=trp-periode-info class=hide-on-print>Periode: -<div class="hide-on-print solar-stock-card"><div><h4>‚õΩ Sisa Stok Solar (Triputra)</h4><p style=margin:0;font-size:.9rem;color:#666>Stok ini otomatis berkurang saat laporan disimpan.</div><div style=display:flex;align-items:center;gap:15px><div class=solar-stock-value><span id=triputra_stock_display>4.059</span> <span style=font-size:1.2rem>Liter</span></div><div><button class=stock-btn onclick=window.editTriputraSolarStock()>‚úèÔ∏è Update</button> <button class=stock-btn onclick=window.viewStockHistory() style=background-color:#0dcaf0>üìú Riwayat</button></div></div></div><div class=triputra-charts-grid id=triputraChartsContainer><div class=tri-chart-box id=box-target><canvas id=triChartTarget></canvas></div><div class=tri-chart-box id=box-hm><canvas id=triChartHM></canvas></div><div class=tri-chart-box id=box-solar><canvas id=triChartSolar></canvas></div><div class=tri-chart-box style=grid-column:1/-1;width:100% id=box-trend><canvas id=triChartTrend></canvas></div></div><div class="hide-on-print" style="margin-top: 30px; background: #fff; border: 1px solid #dee2e6; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
    <div class="hide-on-print" style="background: #fff3cd; border: 1px solid #ffecb5; padding: 15px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
    <h4 style="margin-top: 0; color: #856404; font-size: 14px; display: flex; align-items: center; gap: 8px;">
        üõª Input Solar Operasional / Sarana (LV, Genset, DT Support)
        <span style="font-size: 10px; font-weight: normal; background: #fff; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc;">
            Mengurangi Stok Tanpa Mengganggu Data Produksi
        </span>
    </h4>
    
    <form id="saranaFuelForm" onsubmit="window.saveSaranaFuel(event)" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 1; min-width: 120px;">
            <label style="font-size: 11px; font-weight: bold; color: #856404;">Tanggal</label>
            <input type="date" id="sarana_date" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        
        <div style="flex: 2; min-width: 200px;">
            <label style="font-size: 11px; font-weight: bold; color: #856404;">Nama Unit / Kendaraan</label>
            <input type="text" id="sarana_unit" placeholder="Cth: Hilux KT 1234, Genset, Pajero..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div style="flex: 1; min-width: 120px;">
            <label style="font-size: 11px; font-weight: bold; color: #856404;">Driver / PIC</label>
            <input type="text" id="sarana_pic" list="operatorDatalist" placeholder="Nama..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div style="flex: 1; min-width: 100px;">
            <label style="font-size: 11px; font-weight: bold; color: #dc3545;">Jumlah (Liter)</label>
            <input type="number" id="sarana_liter" step="0.1" min="0.1" placeholder="0.0" required style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 4px; font-weight: bold;">
        </div>

        <div style="flex: 0 0 auto;">
            <button type="submit" style="background-color: #ffc107; color: #000; font-weight: bold; border: none; padding: 9px 20px; border-radius: 6px; cursor: pointer; height: 35px;">
                üíæ Simpan & Kurangi Stok
            </button>
        </div>
    </form>
</div>
<div class="hide-on-print" style="margin-top: 20px;">
    <h5 style="color: #856404; border-bottom: 2px solid #ffecb5; padding-bottom: 5px;">üìã Riwayat Pengisian Sarana (Periode Ini)</h5>
    <div class="report-table-container" style="max-height: 300px; overflow-y: auto;">
        <table id="saranaReportTable" style="font-size: 12px; width: 100%;">
            <thead style="position: sticky; top: 0; z-index: 5;">
                <tr style="background-color: #ffecb5; color: #856404;">
                    <th style="width: 100px;">Aksi</th>
                    <th>Tanggal</th>
                    <th>Unit / Sarana</th>
                    <th>Driver / PIC</th>
                    <th>Jumlah (Liter)</th>
                </tr>
            </thead>
            <tbody id="saranaReportBody">
                </tbody>
        </table>
    </div>
</div>

<div class="modal" id="editSaranaModal" style="display: none; z-index: 10050;">
    <div class="modal-content" style="max-width: 400px; border-top: 5px solid #ffc107;">
        <span class="close-btn" onclick="document.getElementById('editSaranaModal').style.display='none'">√ó</span>
        <h3 style="color: #856404; margin-top: 0;">‚úèÔ∏è Edit Solar Sarana</h3>
        
        <input type="hidden" id="edit_sarana_id">
        <input type="hidden" id="edit_sarana_old_solar">

        <div class="edit-form-group">
            <label>Tanggal:</label>
            <input type="date" id="edit_sarana_date" style="width: 100%; padding: 8px;">
        </div>
        <div class="edit-form-group">
            <label>Unit / Kendaraan:</label>
            <input type="text" id="edit_sarana_unit" style="width: 100%; padding: 8px;">
        </div>
        <div class="edit-form-group">
            <label>Driver / PIC:</label>
            <input type="text" id="edit_sarana_pic" style="width: 100%; padding: 8px;">
        </div>
        <div class="edit-form-group">
            <label>Jumlah Solar (Liter):</label>
            <input type="number" id="edit_sarana_solar" step="0.1" style="width: 100%; padding: 8px; font-weight: bold; color: #d63384;">
        </div>

        <button onclick="window.saveSaranaEdit()" style="width: 100%; background-color: #ffc107; color: #000; font-weight: bold; border: none; padding: 12px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
            üíæ Simpan Perubahan
        </button>
    </div>
</div>
    <h3 style="margin-top: 0; color: #198754; display: flex; align-items: center; gap: 10px;">
        üí∞ Kalkulator Pendapatan Titik (Harian)
        <button type="button" onclick="document.getElementById('payrollSettings').style.display = document.getElementById('payrollSettings').style.display === 'none' ? 'grid' : 'none'" style="font-size: 11px; padding: 5px 10px; background: #e9ecef; border: 1px solid #ccc; cursor: pointer; color: #333; border-radius: 4px;">‚öôÔ∏è Tampilkan Setting</button>
    </h3>

    <div id="payrollSettings" style="display: none; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #198754;">
        <div>
            <label style="font-size:11px; font-weight:bold; color:#198754;">Batas Tier 1 (Bawah)</label>
            <input type="number" id="pay_limit_1" value="89" style="width:100%; padding: 5px; border:1px solid #ccc; border-radius:4px;">
            <small style="color:#666;">Cth: 0 - 89</small>
        </div>
        <div>
            <label style="font-size:11px; font-weight:bold; color:#198754;">Rate Tier 1 (Rp)</label>
            <input type="number" id="pay_rate_1" value="1000" style="width:100%; padding: 5px; border:1px solid #ccc; border-radius:4px;">
        </div>
        
        <div>
            <label style="font-size:11px; font-weight:bold; color:#d63384;">Batas Tier 2 (Tengah)</label>
            <input type="number" id="pay_limit_2" value="120" style="width:100%; padding: 5px; border:1px solid #ccc; border-radius:4px;">
            <small style="color:#666;">Cth: 90 - 120</small>
        </div>
        <div>
            <label style="font-size:11px; font-weight:bold; color:#d63384;">Rate Tier 2 (Rp)</label>
            <input type="number" id="pay_rate_2" value="2000" style="width:100%; padding: 5px; border:1px solid #ccc; border-radius:4px;">
        </div>

        <div>
            <label style="font-size:11px; font-weight:bold; color:#0d6efd;">Rate Tier 3 (Atas > 120)</label>
            <input type="number" id="pay_rate_3" value="2500" style="width:100%; padding: 5px; border:1px solid #ccc; border-radius:4px;">
            <small style="color:#666;">Untuk sisa di atas batas Tier 2</small>
        </div>

        <div style="grid-column: 1 / -1; text-align: right; border-top: 1px solid #ddd; padding-top: 10px; margin-top: 5px;">
            <button type="button" onclick="window.savePayrollSettings()" style="background-color: #198754; color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                üíæ Simpan Setting Permanen
            </button>
        </div>
    </div>

    <div id="payrollModal" class="modal" style="display: none; z-index: 10002;">
    <div class="modal-content" style="max-width: 450px;">
        <span class="close-btn" onclick="document.getElementById('payrollModal').style.display='none'">√ó</span>
        <h2 style="color: #198754; border-bottom: 2px solid #198754;">üí∞ Export Gaji Operator</h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="font-size:12px; margin-bottom:10px; color:#555;">
                Silakan atur tarif harian. <br>
                <b>*Uang Lembur otomatis Rp 15.000 jika HM ‚â• 10.</b>
            </p>

            <div class="edit-form-group">
                <label>Uang Makan (Rp):</label>
                <input type="number" id="rate_uang_makan" value="50000" placeholder="50000">
            </div>
            
            <div class="edit-form-group">
                <label>Uang Transport (Rp):</label>
                <input type="number" id="rate_uang_transport" value="12000" placeholder="12000">
            </div>
        </div>

        <button onclick="window.processPayrollExport()" class="submit-btn" style="width: 100%; background-color: #198754;">
            üì• Download Excel Gaji
        </button>
    </div>
</div>

   <div style="margin-bottom: 15px; padding: 10px; background-color: #e3f2fd; border-radius: 6px; border: 1px solid #90caf9;">
        <label style="font-size: 12px; font-weight: bold; color: #0d47a1;">Filter Tampilan Nama:</label>
        <select id="pay_filter_name" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onchange="window.calculateTriputraPayroll()">
            <option value="all">-- Tampilkan Semua Operator --</option>
        </select>
        <small style="font-size: 10px; color: #666;">*Pilih nama untuk melihat rincian gaji satu orang saja.</small>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button onclick="window.calculateTriputraPayroll()" style="background-color: #198754; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; flex: 1;">
        ‚ö° Hitung / Refresh Pendapatan
    </button>
    
    <button onclick="window.exportPayrollExcel()" style="background-color: #0d6efd; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer;">
        üì• Export View Ini
    </button>

    <button onclick="window.exportTriputraPayrollAllSheets()" style="background-color: #6f42c1; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px;">
        üìë Export All (Multi-Sheet)
    </button>
</div>

    <div class="report-table-container">
        <table id="payrollTable" style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead>
                <tr style="background-color: #198754; color: white;">
                    <th style="padding: 8px; border: 1px solid #ddd;">Tanggal</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Unit</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Operator</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Total Titik</th>
                    <th style="padding: 8px; border: 1px solid #ddd; background-color: #146c43;">Rincian Perhitungan</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Total Pendapatan (Rp)</th>
                </tr>
            </thead>
            <tbody id="payrollBody">
                <tr><td colspan="6" style="text-align:center; padding:10px;">Klik tombol "Hitung Pendapatan" untuk melihat hasil.</td></tr>
            </tbody>
            <tfoot id="payrollFoot" style="font-weight:bold; background-color:#e9ecef;"></tfoot>
        </table>
    </div>
</div><hr style="margin:30px 0"><h3 style=color:#6f42c1;margin-top:10px>Tabel Akumulasi Per Unit (Periode)</h3><div class=report-table-container><table id=triputraAccumulationTable><thead><tr><th style=background-color:#6f42c1;width:200px>Unit<th style=background-color:#6f42c1;width:100px>Hari Operasi<th style=background-color:#6f42c1;width:150px>Total HM<th style=background-color:#6f42c1;width:150px>Total Solar (Ltr)<th style=background-color:#6f42c1;width:150px>Total Titik<th style=background-color:#6f42c1;width:150px>Rasio Solar/HM (Avg)<th style=background-color:#6f42c1;width:150px>Rasio Titik/HM (Avg)<tbody id=triputraAccumulationBody></table></div><hr style="margin:30px 0"><h3 style=color:#6f42c1;margin-top:10px>Tabel Data Laporan Detail</h3><div class=report-table-container id=triputraTableSection><table id=triputraReportTable><thead><tr><th class=triputra-action-column style=background-color:#6f42c1>Aksi<th style=background-color:#6f42c1>Tanggal<th style=background-color:#6f42c1>Unit<th style=background-color:#6f42c1>Operator<th class=col-hm-trp style=background-color:#6f42c1>HM Operasi<th class=col-solar-trp style=background-color:#6f42c1>Solar (Ltr)<th class=col-titik-trp style=background-color:#6f42c1>Pencapaian Titik<th class=col-rasio-trp style=background-color:#6f42c1>Rasio Solar/HM<tbody id=triputraReportBody><tfoot id=triputraReportFoot style=font-weight:700;background:#e9ecef></table></div><div class=hide-on-print style="margin-top:40px;background:#fff;padding:20px;border:1px solid #ddd;border-radius:10px;margin-bottom:30px;box-shadow:0 2px 5px rgba(0,0,0,.05)"><h4 style="margin-top:0;color:#6f42c1;border-bottom:2px solid #f3e5f5;padding-bottom:10px">‚ûï Input Harian Khusus Triputra</h4><form id=triputraBatchForm><div class=table-input-container style=max-height:40vh><table><thead><tr><th style=background-color:#6f42c1 rowspan=2>Aksi<th style=background-color:#6f42c1 rowspan=2>Tanggal<th style=background-color:#6f42c1 rowspan=2>Unit<th style=background-color:#6f42c1 rowspan=2>Operator<th style=background-color:#6f42c1 rowspan=2>Pencapaian Titik<th style=background-color:#6f42c1 colspan=2>Hour Meter (HM)<th style=background-color:#6f42c1 rowspan=2>Pemakaian Solar (Ltr)<th style=background-color:#6f42c1 rowspan=2>Keterangan<tr><th style=background-color:#5a32a3>HM Awal<th style=background-color:#5a32a3>HM Akhir<tbody id=triputraInputBody><tr id=trp-row-1><td><button class=delete-row-btn onclick='document.getElementById("trp-row-1").remove()'type=button>‚ùå</button><td><input type=date class=trp-tanggal required value=2025-12-05><td><select required class="input-unit trp-unit"><option value="">-- Pilih Unit --<option value="AUM 03A">AUM 03A<option value="AUM 05A">AUM 05A<option value="AUM 17">AUM 17<option value="AUM 24">AUM 24<option value="AUM 25">AUM 25<option value="AUM 29">AUM 29<option value="AUM 31">AUM 31<option value="AUM 32">AUM 32<option value="AUM 33">AUM 33<option value="AUM 40">AUM 40<option value="AUM 41">AUM 41<option value="AUM 42">AUM 42<option value="AUM 43">AUM 43<option value="AUM 45">AUM 45<option value="AUM 46">AUM 46<option value="AUM 53">AUM 53<option value="AUM 54">AUM 54<option value="AUM 63">AUM 63<option value="AUM 64">AUM 64<option value="AUM 65">AUM 65<option value="AUM 68">AUM 68</select><td><input class=trp-operator placeholder=Operator list=operatorDatalist required><td><input type=number class=trp-pencapaian placeholder="Jml Titik"min=0 required step=1><td><input type=number class=trp-hm-awal placeholder=Awal min=0 required><td><input type=number class=trp-hm-akhir placeholder=Akhir min=0 required><td><input type=number class=trp-solar placeholder=Liter min=0 required step=0.1><td><input class=trp-keterangan placeholder=Ket...></table></div><div style=margin-top:20px;text-align:right><button class=add-row-btn onclick=window.addTriputraRow() style=background-color:#6f42c1 type=button>‚ûï Tambah Baris Triputra</button> <button class=submit-btn style=background-color:#4a2c85 type=submit>üíæ Simpan & Kurangi Solar</button></div></form></div></div><div class="tab-content" id="absensi">
    <h2 style="color: #6f42c1; border-bottom: 3px solid #6f42c1;">üìã Rekap Absensi Operator (Otomatis)</h2>
    <p style="color:#555; font-style:italic;">Data absensi digenerate otomatis berdasarkan Laporan Harian & Keterangan. <br>
    <strong>Kode:</strong> H=Hadir, SBD=Breakdown, SH=Standby Hujan, Stb=Standby Pengawas, I=Izin, PC=Pulang Cepat, X=Resign, A=Alpha/Tanpa Keterangan.</p>
    
    <div class="filter-controls" style="background-color: #f3e5f5; border: 1px solid #6f42c1;">
    <div>
        <label for="abs_period_select">Periode:</label>
        <select onchange="window.updateMonthRange(this.value, 'abs_'); window.fetchAttendanceData();" id="abs_period_select">
            <option value="calendar_monthly">Periode Kalender (Tgl 1 - Akhir)</option>
            <option value="custom_monthly_21_20" selected>Periode Akuntansi (Tgl 21 - Tgl 20)</option>
        </select>
    </div>

    <div>
        <label for="abs_filter_month">Bulan/Rentang:</label>
        <select onchange="window.fetchAttendanceData()" id="abs_filter_month" multiple size="6">
            </select>
    </div>

    <div>
        <label for="abs_filter_sektor">Filter Sektor:</label>
        <select onchange="window.fetchAttendanceData()" id="abs_filter_sektor">
            <option value="all">-- Semua Sektor --</option>
            <option value="TRIPUTRA">TRIPUTRA</option>
            <option value="KWL">KWL</option>
            <option value="IHM">IHM</option>
        </select>
    </div>

    <div>
        <label for="abs_filter_year">Tahun:</label>
        <select onchange="window.updateMonthRange(document.getElementById('abs_period_select').value, 'abs_'); window.fetchAttendanceData();" id="abs_filter_year">
            </select>
    </div>

    <button onclick="window.fetchAttendanceData()" style="background-color: #6f42c1; color: #fff;">üîÑ Refresh Absensi</button>
    <button onclick="window.exportAttendanceExcel()" style="background-color: #198754; color: #fff;">üìä Export Excel</button>
</div>

 <div id="longLeaveModal" class="modal" style="display: none; z-index: 10050;">
    <div class="modal-content" style="max-width: 400px; border-top: 5px solid #ffc107;">
        <span class="close-btn" onclick="document.getElementById('longLeaveModal').style.display='none'">√ó</span>
        <h3 style="color: #856404; margin-top: 0;">üìÖ Input Absen Panjang</h3>
        <p style="font-size:12px; color:#666; margin-bottom:15px;">Fitur ini akan membuat data laporan kosong (HM 0) secara otomatis agar status di Rekap Absensi berubah.</p>
        
        <div class="edit-form-group">
            <label>Nama Operator:</label>
            <input type="text" id="leave_operator" list="operatorDatalist" placeholder="Cth: GIANTO" style="width: 100%; padding: 8px; border:1px solid #ccc;">
        </div>

        <div style="display:flex; gap:10px;">
            <div class="edit-form-group" style="flex:1;">
                <label>Dari Tanggal:</label>
                <input type="date" id="leave_start_date" style="width: 100%; padding: 8px; border:1px solid #ccc;">
            </div>
            <div class="edit-form-group" style="flex:1;">
                <label>Sampai Tanggal:</label>
                <input type="date" id="leave_end_date" style="width: 100%; padding: 8px; border:1px solid #ccc;">
            </div>
        </div>

        <div class="edit-form-group">
            <label>Status / Keterangan:</label>
            <select id="leave_reason" style="width: 100%; padding: 8px; border:1px solid #ccc;">
                <option value="IJIN">IJIN</option>
                <option value="SAKIT">SAKIT</option>
                <option value="CUTI">CUTI</option>
                <option value="ALPA">ALPA / MANGKIR</option>
                <option value="OFF">OFF (ROSTER)</option>
            </select>
        </div>

        <button onclick="window.processLongLeave()" style="width: 100%; background-color: #ffc107; color: #000; font-weight: bold; border: none; padding: 12px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
            üíæ Simpan Absensi
        </button>
    </div>
</div>

    <div class="filter-controls" style="background-color: #f3e5f5; border: 1px solid #6f42c1;">
    <button onclick="document.getElementById('longLeaveModal').style.display='block'" style="background-color: #ffc107; color: #000; font-weight:bold; border: 1px solid #e0a800;">
        üìÖ Input Ijin/Sakit Panjang
    </button>
</div>
    <div class="report-table-container">
        <table id="attendanceTable" class="landscape-mode">
            <thead>
                </thead>
            <tbody id="attendanceBody">
                </tbody>
        </table>
    </div>
</div>

<div class="tab-content" id="penilaian_kebersihan">
    <div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #d63384; padding-bottom: 10px;">
        <h2 style="color: #d63384; margin: 0;">PENILAIAN KEBERSIHAN OPERATOR</h2>
        <h4 style="margin: 5px 0; color: #555;">PROJECT IHM KALTIM</h4>
    </div>

    <div class="filter-controls" style="background-color: #fff0f6; border: 1px solid #d63384;">
    <div>
        <label>Periode:</label>
        <select id="clean_period_select" onchange="window.loadCleanlinessView()">
            <option value="custom_monthly_21_20">Periode Akuntansi (Tgl 21 - Tgl 20)</option>
        </select>
    </div>
    <div>
        <label>Bulan/Tahun:</label>
        <select id="clean_filter_month" onchange="window.loadCleanlinessView()"></select>
        <select id="clean_filter_year" onchange="window.loadCleanlinessView()"></select>
    </div>
    <div>
        <label>Filter Sektor:</label>
        <select id="clean_filter_sektor" onchange="window.loadCleanlinessView()">
            <option value="all">-- Semua Sektor --</option>
        </select>
    </div>
    
    <button onclick="window.loadCleanlinessView()" style="background-color: #6f42c1; color: white;">üîÑ Refresh</button>
    <button onclick="window.saveCleanlinessDataManual()" style="background-color: #d63384; color: white; font-weight:bold; border: 2px solid #ad1457;">üíæ SIMPAN PERUBAHAN</button>
    <button onclick="window.exportCleanlinessExcel()" style="background-color: #198754; color: white;">üìä Export Excel</button>
</div>

    <div class="report-table-container" style="max-height: 75vh;">
        <table id="cleanlinessTable" style="width: 100%; border-collapse: collapse; font-size: 11px;">
            <thead style="position: sticky; top: 0; z-index: 10;">
                </thead>
            <tbody id="cleanlinessBody">
                </tbody>
        </table>
    </div>
    
    <div style="margin-top: 15px; font-size: 12px; color: #555;">
        <strong>Keterangan Skoring:</strong><br>
        ‚Ä¢ Nilai 0 - 5 (0 = Buruk/Tidak Hadir, 5 = Sangat Baik).<br>
        ‚Ä¢ Jika HM = 0, Nilai otomatis 0 (Merah Muda).<br>
        ‚Ä¢ Bonus: < 150 (Rp 0), 151-250 (Rp 100k), 251-300 (Rp 150k), 301-350 (Rp 200k), > 350 (Rp 250k).
    </div>
</div>

<div class="tab-content" id="tracking_ba">
    <div id="tracking-print-header" style="display: none; border-bottom: 2px solid black; margin-bottom: 20px;">
        <h2 style="margin: 0;">LAPORAN TRACKING BA & INVOICE</h2>
        <p style="margin: 5px 0;">PT ADHIE USAHA MANDIRI - BRANCH KALTIM</p>
    </div>

    <h2 class="hide-on-print" style="color: #d63384; border-bottom: 3px solid #d63384;">üìë Tracking Status BA ke Invoice</h2>

    <div class="kpi-cards hide-on-print">
        <div class="kpi-card" style="border-left-color: #0dcaf0;">
            <h4 style="color: #0dcaf0;">Total Dokumen</h4>
            <p id="track_total_active">0</p>
        </div>
        <div class="kpi-card" style="border-left-color: #198754;">
            <h4 style="color: #198754;">Siap Invoice (Ready)</h4>
            <p id="track_ready">0</p>
        </div>
        <div class="kpi-card" style="border-left-color: #d63384; background-color: #fff0f6;">
            <h4 style="color: #d63384;">üí∞ Total Estimasi Dana</h4>
            <p id="track_total_amount" style="font-size: 24px;">Rp 0</p>
        </div>
    </div>

    <div class="hide-on-print" style="background-color: #f8f9fa; padding: 20px; border-radius: 10px; border: 1px solid #dee2e6; margin-bottom: 25px;">
    <h4 style="margin-top: 0; color: #d63384;">‚ûï Input Tracking Baru</h4>
    <form id="trackingForm" onsubmit="window.handleTrackingSubmit(event)" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: start;">
        
        <div>
            <label style="font-weight: 600; font-size: 12px;">Periode</label>
            <input type="text" id="track_period" placeholder="Cth: Jan 2025" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div>
            <label style="font-weight: 600; font-size: 12px;">Nomor BA / Invoice</label>
            <input type="text" id="track_no_ba" placeholder="No. Dokumen..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div style="grid-column: span 2;">
            <label style="font-weight: 600; font-size: 12px;">Unit (Bisa Banyak)</label>
            <div style="display: flex; gap: 5px;">
                <select id="track_unit_select" onchange="window.previewSector(this)" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </select>
                <button type="button" onclick="window.addUnitToField()" style="background: #198754; color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer;">‚ûï Tambah</button>
            </div>
            <input type="text" id="track_unit_final" placeholder="Unit akan muncul di sini..." required readonly style="width: 100%; margin-top: 5px; padding: 8px; background: #e9ecef; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div>
            <label style="font-weight: 600; font-size: 12px;">Sektor</label>
            <input type="text" id="track_sektor" readonly style="width: 100%; padding: 8px; background: #e9ecef; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div>
            <label style="font-weight: 600; font-size: 12px;">Tanggal Terima</label>
            <input type="date" id="track_date" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div>
            <label style="font-weight: 600; font-size: 12px;">Estimasi Nilai (Rp)</label>
            <input type="number" id="track_amount" placeholder="0" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div style="align-self: center;">
            <button type="submit" class="submit-btn" style="background-color: #d63384; width: 100%; height: 38px;">üíæ Simpan Data</button>
        </div>
    </form>
</div>

    <div class="filter-controls hide-on-print" style="background-color: #fff; border: 1px solid #ddd;">
        <div>
            <label>Cari:</label>
            <input type="text" id="search_ba" onkeyup="window.renderTrackingTable()" placeholder="No BA / Unit...">
        </div>
        <div>
            <label>Filter Status:</label>
            <select id="filter_status_ba" onchange="window.renderTrackingTable()"></select>
        </div>
        <button onclick="window.handleTrackingPrint()" style="background-color: #6c757d; color: white;">üñ®Ô∏è Cetak PDF (Tabel Saja)</button>
    </div>

    <div class="report-table-container" id="trackingTableContainer">
        <table id="trackingTable" style="width: 100%; font-size: 12px;">
            <thead>
                <tr style="background-color: #d63384; color: white;">
                    <th class="action-column" style="width: 80px;">Aksi</th>
                    <th style="width: 120px;">Periode</th> <th>No. BA / Invoice</th>
                    <th style="width: 80px;">Unit</th>
                    <th style="width: 100px;">Sektor</th>
                    <th style="width: 100px;">Nilai (Rp)</th> <th style="width: 90px;">Tgl Terima</th>
                    <th style="width: 60px;">Durasi</th>
                    <th style="width: 150px;">Status Terakhir</th>
                    <th>Keterangan</th>
                </tr>
            </thead>
            <tbody id="trackingBody"></tbody>
            <tfoot id="trackingFooter"></tfoot>
        </table>
    </div>
</div>
</div><div class="modal" id="bulkUploadModal" style="display: none; z-index: 9999;">
    <div class="modal-content" style="max-width: 700px; position: relative;">
        <span class="close-btn" onclick="document.getElementById('bulkUploadModal').style.display='none'" style="font-size: 28px; cursor: pointer; position: absolute; right: 20px; top: 10px;">&times;</span>
        
        <h2 style="color: #ffc107; border-bottom: 2px solid #ffc107; padding-bottom: 10px; margin-top: 0;">üìÅ Upload Foto Massal</h2>
        
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-bottom: 20px;">
            <strong style="color: #856404;">üìú Format Nama File: KODEUNIT_TANGGAL_TIPE.jpg</strong>
            <ul style="font-size: 12px; color: #856404; padding-left: 20px; margin: 5px 0;">
                <li>Pemisah: Garis bawah <code>_</code> atau Spasi</li>
                <li>Tanggal: <code>DDMMYYYY</code> (10122025) atau <code>YYYY-MM-DD</code></li>
                <li>Tipe: <code>AWAL</code>, <code>AKHIR</code>, <code>TS</code></li>
            </ul>
        </div>

        <div style="text-align: center; margin-bottom: 20px; padding: 20px; border: 2px dashed #ced4da; border-radius: 10px; background: #f8f9fa;">
            <input type="file" id="bulkPhotoInput" multiple accept="image/*" style="display: none;" onchange="window.handleBulkFilesSelect(this)">
            
            <button type="button" onclick="document.getElementById('bulkPhotoInput').click()" style="background-color: #0d6efd; color: white; padding: 12px 25px; border-radius: 50px; font-size: 14px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(13, 110, 253, 0.2);">
                üìÇ Klik Disini Untuk Pilih Foto
            </button>
            
            <p id="bulkFileCount" style="margin-top: 15px; font-weight: bold; color: #333; min-height: 20px;"></p>
        </div>

        <div id="bulkLogConsole" style="height: 150px; overflow-y: auto; background: #212529; color: #00ff00; padding: 10px; font-family: monospace; font-size: 11px; border-radius: 6px; border: 1px solid #000; margin-bottom: 15px;">
            > Menunggu file...
        </div>

       <button type="button" onclick="window.processBulkPhotos()" id="btnProcessBulk" style="width: 100%; background-color: #198754; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; display: none; font-size: 16px;">
            ‚ñ∂Ô∏è Mulai Proses Upload
        </button>
    </div> </div> <div class="tab-content" id="fuel_tracking">
    <h2 style="color: #fd7e14; border-bottom: 3px solid #fd7e14;">‚õΩ Manajemen & Kontrol Bahan Bakar</h2>
    
    <div class="kpi-cards hide-on-print">
        <div class="kpi-card" style="border-left-color: #fd7e14;">
            <h4 style="color: #fd7e14;">Total Pengisian (Liter)</h4>
            <p id="kpi_fuel_total">0 L</p>
        </div>
        <div class="kpi-card" style="border-left-color: #20c997;">
            <h4 style="color: #20c997;">Total Transaksi</h4>
            <p id="kpi_fuel_count">0</p>
        </div>
        <div class="kpi-card" style="border-left-color: #0d6efd;">
            <h4 style="color: #0d6efd;">Unit Terbanyak</h4>
            <p id="kpi_fuel_top_unit" style="font-size: 18px;">-</p>
        </div>
    </div>

    <div class="hide-on-print" style="margin-bottom: 25px; background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
        <h4 style="margin-top: 0; color: #fd7e14; border-bottom: 2px solid #fff3cd; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
            üìä Dashboard Analisa Bahan Bakar
            <select id="fuel_chart_type" onchange="window.renderFuelTable()" style="font-size: 12px; padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="total">Total Volume per Unit</option>
                <option value="ratio">Rata-rata Rasio (L/Km)</option>
                <option value="trend">Tren Harian</option>
            </select>
        </h4>
        <div style="height: 300px; position: relative;">
            <canvas id="fuelMainChart"></canvas>
        </div>
    </div>

    <div class="hide-on-print" style="background: #fff5eb; padding: 20px; border-radius: 10px; border: 1px solid #ffe8cc; margin-bottom: 30px;">
        <h4 style="margin-top: 0; color: #fd7e14;">‚ûï Input Transaksi BBM</h4>
       <form id="fuelForm" onsubmit="window.saveFuelTransaction(event)">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div>
            <label style="font-weight: bold; font-size: 12px;">Tanggal</label>
            <input type="date" id="fuel_date" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>

        <div>
            <label style="font-weight: bold; font-size: 12px;">Unit / Kendaraan</label>
            <input type="text" id="fuel_unit" list="masterUnitListFuel" placeholder="Pilih atau Ketik Manual..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" onchange="window.updateOperatorAndSektor(this)">
            <datalist id="masterUnitListFuel"></datalist>
        </div>

        <div>
            <label style="font-weight: bold; font-size: 12px;">No. Polisi (Opsional)</label>
            <input type="text" id="fuel_nopol" placeholder="KT xxxx XX" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-transform: uppercase;">
        </div>

        <div>
            <label style="font-weight: bold; font-size: 12px;">Fuelman / Driver</label>
            <input type="text" id="fuel_pic" list="operatorDatalist" required placeholder="Nama PIC..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        
        <div>
            <label style="font-weight: bold; font-size: 12px;">Lokasi Pengisian</label>
            <input type="text" id="fuel_location" list="fuelLocList" placeholder="Cth: Gudang, SPBU..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <datalist id="fuelLocList">
                <option value="Main Warehouse"><option value="Fuel Truck 01"><option value="SPBU"><option value="Workshop">
            </datalist>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div>
            <label style="font-weight: bold; font-size: 12px;">KM/HM Awal</label>
            <input type="number" id="fuel_km_awal" step="0.1" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div>
            <label style="font-weight: bold; font-size: 12px;">KM/HM Akhir</label>
            <input type="number" id="fuel_km_akhir" step="0.1" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        </div>
        <div>
            <label style="font-weight: bold; font-size: 12px; color: #d63384;">Volume (Liter)</label>
            <input type="number" id="fuel_qty" step="0.01" required placeholder="0.00" style="width: 100%; padding: 8px; border: 2px solid #fd7e14; border-radius: 4px; font-weight: bold;">
        </div>
    </div>

    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1; text-align: center;">
            <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üì∏ Foto KM Awal</label>
            <input type="file" id="img_km_start" accept="image/*" capture="camera" style="font-size: 10px;">
        </div>
        <div style="flex: 1; text-align: center;">
            <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üì∏ Foto KM Akhir</label>
            <input type="file" id="img_km_end" accept="image/*" capture="camera" style="font-size: 10px;">
        </div>
        <div style="flex: 1; text-align: center;">
            <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üì∏ Bukti/Struk</label>
            <input type="file" id="img_receipt" accept="image/*" capture="camera" style="font-size: 10px;">
        </div>
    </div>

    <button type="submit" class="submit-btn" style="width: 100%; background-color: #fd7e14;">üíæ Simpan Data BBM</button>
</form>
    </div>

    <div class="filter-controls hide-on-print" style="
    background-color: #fff; 
    border: 1px solid #dee2e6; 
    border-radius: 8px; 
    padding: 15px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
">
    <div style="flex: 0 0 auto;">
        <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #495057;">Tahun</label>
        <select id="fuel_filter_year" onchange="window.renderFuelTable()" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; background-color: #fff; cursor: pointer;">
            </select>
    </div>

    <div id="fuel_month_box" style="display: flex; gap: 5px; align-items: flex-end;">
        <div>
            <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #495057;">Dari Bulan</label>
            <select id="fuel_filter_month_start" onchange="window.renderFuelTable()" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; cursor: pointer;">
                <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option>
                <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
                <option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option>
                <option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
            </select>
        </div>
        <div style="padding-bottom: 8px; font-size: 12px; color: #666;">s/d</div>
        <div>
            <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #495057;">Sampai Bulan</label>
            <select id="fuel_filter_month_end" onchange="window.renderFuelTable()" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; cursor: pointer;">
                <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option>
                <option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option>
                <option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option>
                <option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
            </select>
        </div>
    </div>

    <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #495057;">Cari Unit / Driver / Nopol</label>
        <div style="position: relative;">
            <input type="text" id="fuel_search" placeholder="üîç Ketik kata kunci..." onkeyup="window.renderFuelTable()" 
            style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px;">
        </div>
    </div>

    <div style="display: flex; gap: 8px;">
        <button onclick="window.printFuelReport()" style="
            background-color: #343a40; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; 
            font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;">
            üñ®Ô∏è PDF
        </button>
        <button onclick="window.exportFuelExcel()" style="
            background-color: #198754; color: #fff; border: none; padding: 8px 15px; border-radius: 6px; 
            font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;">
            üì• Excel
        </button>
    </div>
</div>
<div id="editFuelModal" class="modal" style="display: none; z-index: 9999;">
    <div id="fuel-print-area" style="display: none;"></div>
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-btn" onclick="document.getElementById('editFuelModal').style.display='none'">√ó</span>
            <h2 style="color: #ffc107; border-bottom: 2px solid #ffc107; padding-bottom: 10px;">‚úèÔ∏è Edit Data BBM</h2>
            
            <input type="hidden" id="edit_fuel_id">
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="font-weight: bold; font-size: 11px;">Tanggal</label>
                    <input type="date" id="edit_fuel_date" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px;">Unit</label>
                    <input type="text" id="edit_fuel_unit" list="masterUnitListFuel" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px;">No. Polisi</label>
                    <input type="text" id="edit_fuel_nopol" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px;">Driver/PIC</label>
                    <input type="text" id="edit_fuel_pic" list="operatorDatalist" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px;">Lokasi</label>
                    <input type="text" id="edit_fuel_location" list="fuelLocList" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; background: #fff3cd; padding: 10px; border-radius: 8px;">
                <div>
                    <label style="font-weight: bold; font-size: 11px;">KM Awal</label>
                    <input type="number" id="edit_fuel_km_awal" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px;">KM Akhir</label>
                    <input type="number" id="edit_fuel_km_akhir" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 11px; color: #d63384;">Volume (Liter)</label>
                    <input type="number" id="edit_fuel_qty" step="0.01" style="width: 100%; padding: 8px; border: 2px solid #ffc107; border-radius: 4px; font-weight: bold;">
                </div>
            </div>

            <div style="display:flex; gap:10px; justify-content: space-between; margin-bottom: 15px;">
                <div style="text-align:center; border:1px dashed #ccc; padding:5px; flex:1;">
                    <label style="font-size:10px; font-weight:bold;">üì∏ Update KM Awal</label>
                    <img id="prev_edit_start" src="" style="width:50px; height:50px; object-fit:cover; display:block; margin:5px auto; background:#eee;">
                    <input type="file" id="edit_img_start" style="font-size:9px; width:100%;">
                </div>
                <div style="text-align:center; border:1px dashed #ccc; padding:5px; flex:1;">
                    <label style="font-size:10px; font-weight:bold;">üì∏ Update KM Akhir</label>
                    <img id="prev_edit_end" src="" style="width:50px; height:50px; object-fit:cover; display:block; margin:5px auto; background:#eee;">
                    <input type="file" id="edit_img_end" style="font-size:9px; width:100%;">
                </div>
                <div style="text-align:center; border:1px dashed #ccc; padding:5px; flex:1;">
                    <label style="font-size:10px; font-weight:bold;">üì∏ Update Struk</label>
                    <img id="prev_edit_receipt" src="" style="width:50px; height:50px; object-fit:cover; display:block; margin:5px auto; background:#eee;">
                    <input type="file" id="edit_img_receipt" style="font-size:9px; width:100%;">
                </div>
            </div>

            <button onclick="window.saveFuelEdit()" style="width: 100%; background-color: #ffc107; color: #000; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">
                üíæ Simpan Perubahan
            </button>
        </div>
    </div>

    <div class="report-table-container">
        <table id="fuelTable" style="width: 100%; font-size: 12px;">
            <thead>
                <tr style="background-color: #fd7e14; color: white;">
                    <th class="action-column">Aksi</th>
                    <th>Tanggal</th>
                    <th>Unit</th>
                    <th>Driver/Fuelman</th>
                    <th>Lokasi</th>
                    <th>KM/HM</th>
                    <th>Volume (L)</th>
                    <th>Bukti Foto</th>
                </tr>
            </thead>
            <tbody id="fuelBody"></tbody>
        </table>
    </div>
        </div>
    </div>
</div>
<div class="tab-content" id="general_affair">
    <h2 style="color: #20c997; border-bottom: 3px solid #20c997;">üè¢ Dashboard General Affair</h2>

    <div class="kpi-cards hide-on-print">
        <div class="kpi-card" style="border-left-color: #dc3545;">
            <h4 style="color: #dc3545;">Dokumen Expired (< 30 Hari)</h4>
            <p id="ga_kpi_expired">0</p>
        </div>
        <div class="kpi-card" style="border-left-color: #ffc107;">
            <h4 style="color: #ffc107;">Tiket Perbaikan Pending</h4>
            <p id="ga_kpi_maintenance">0</p>
        </div>
        <div class="kpi-card" style="border-left-color: #0d6efd;">
            <h4 style="color: #0d6efd;">Permintaan Barang Baru</h4>
            <p id="ga_kpi_request">0</p>
        </div>
    </div>

    <div class="hide-on-print" style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
        <button class="ga-sub-tab-btn active" onclick="window.switchGATab('docs')">üìÑ Legalitas Kendaraan</button>
        <button class="ga-sub-tab-btn" onclick="window.switchGATab('maint')">üîß Maintenance Fasilitas</button>
        <button class="ga-sub-tab-btn" onclick="window.switchGATab('req')">üì¶ Purchase Request</button>
        <button class="ga-sub-tab-btn" onclick="window.switchGATab('payment')">üí∏ Request Payment</button>
    </div>

    <div id="ga_section_docs" class="ga-section">
        <div style="background: #e6fffa; padding: 20px; border-radius: 10px; border: 1px solid #20c997; margin-bottom: 20px;" class="hide-on-print">
            <h4 style="margin-top: 0; color: #0ca678;">‚ûï Input Data Legalitas (STNK/KIR/Izin)</h4>
            <form onsubmit="window.saveGADoc(event)" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Unit / Nopol</label>
                    <input type="text" id="ga_doc_unit" list="masterUnitListFuel" placeholder="Pilih Unit..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Jenis Dokumen</label>
                    <select id="ga_doc_type" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="STNK Tahunan">STNK Tahunan</option>
                        <option value="STNK 5 Tahun">STNK 5 Tahun (Plat)</option>
                        <option value="KIR">KIR / Uji Berkala</option>
                        <option value="Izin Masuk Site">Izin Masuk Site</option>
                        <option value="Asuransi">Asuransi</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Tanggal Expired</label>
                    <input type="date" id="ga_doc_date" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Foto Dokumen</label>
                    <input type="file" id="ga_doc_photo" accept="image/*" style="font-size: 10px;">
                </div>
                <button type="submit" class="submit-btn" style="background-color: #20c997; height: 38px;">Simpan</button>
            </form>
        </div>

        <div class="report-table-container">
            <table id="gaDocsTable" style="width: 100%; font-size: 12px;">
                <thead>
                    <tr style="background-color: #20c997; color: white;">
                        <th class="action-column">Aksi</th>
                        <th>Unit / Nopol</th>
                        <th>Jenis Dokumen</th>
                        <th>Tanggal Expired</th>
                        <th>Sisa Hari</th>
                        <th>Status</th>
                        <th>Foto</th>
                    </tr>
                </thead>
                <tbody id="gaDocsBody"></tbody>
            </table>
        </div>
    </div>

<div id="ga_section_maint" class="ga-section" style="display: none;">
    
    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffc107; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);" class="hide-on-print">
        <h4 style="margin-top: 0; color: #856404; border-bottom: 1px dashed #856404; padding-bottom: 10px;">
            üîß Buat Tiket Perbaikan (Work Order)
        </h4>
        <form onsubmit="window.saveGAMaint(event)">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 10px;">
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">Kategori</label>
                    <select id="ga_maint_cat" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white;">
                        <option value="Listrik/Elektrikal">‚ö° Listrik / Lampu</option>
                        <option value="AC/Pendingin">‚ùÑÔ∏è AC / Pendingin</option>
                        <option value="Plumbing/Air">üö∞ Air / Pipa (Plumbing)</option>
                        <option value="Sipil/Bangunan">üß± Sipil (Pintu/Atap/Lantai)</option>
                        <option value="Furniture">ü™ë Furniture / Inventaris</option>
                        <option value="Lainnya">üîß Lainnya</option>
                    </select>
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">Prioritas</label>
                    <select id="ga_maint_prio" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white;">
                        <option value="Low">üü¢ Low (Bisa Ditunda)</option>
                        <option value="Medium" selected>üü° Medium (Normal)</option>
                        <option value="High">üî¥ High (Segera)</option>
                        <option value="Critical">üî• Critical (Darurat)</option>
                    </select>
                </div>

                <div style="flex: 2; min-width: 200px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">Lokasi Detail</label>
                    <input type="text" id="ga_maint_loc" placeholder="Cth: Mess A Kamar 05, Kantor Admin..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>

            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 3; min-width: 300px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">Deskripsi Kerusakan</label>
                    <input type="text" id="ga_maint_desc" placeholder="Jelaskan kerusakan..." required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold; color: #555;">Pelapor</label>
                    <input type="text" id="ga_maint_pelapor" list="operatorDatalist" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>

                <button type="submit" class="submit-btn" style="background-color: #ffc107; color: black; font-weight:bold; height: 38px; min-width: 120px; border: 1px solid #e0a800;">
                    + Buat Tiket
                </button>
            </div>
        </form>
    </div>

    <div class="report-table-container">
        <table id="gaMaintTable" style="width: 100%; font-size: 12px;">
            <thead>
                <tr style="background-color: #ffc107; color: black;">
                    <th class="action-column" style="width: 100px;">Aksi</th>
                    <th style="width: 90px;">Tgl Lapor</th>
                    <th>Prioritas</th>
                    <th>Kategori</th>
                    <th>Lokasi & Masalah</th>
                    <th>Pelapor</th>
                    <th>Status</th>
                    <th>Tgl Selesai</th>
                </tr>
            </thead>
            <tbody id="gaMaintBody"></tbody>
        </table>
    </div>
</div>
<div id="ga_section_req" class="ga-section" style="display: none;">
    
    <div style="background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e9ecef; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <h2 style="margin-top: 0; color: #055160; border-bottom: 1px dashed #0dcaf0; padding-bottom: 10px;">
            üìù Form Permintaan Barang (Multi-Item)
        </h2>

        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #055160;">
            <h4 style="margin:0 0 10px 0; color:#333;">1. Data Header (Berlaku untuk semua item dibawah)</h4>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Tanggal Request</label>
                    <input type="date" id="pr_date" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Pemohon / Divisi</label>
                    <input type="text" id="pr_requester" list="operatorDatalist" placeholder="Nama Pemohon" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Kategori Utama</label>
                    <select id="pr_category" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="Sparepart">‚öôÔ∏è Sparepart</option>
                        <option value="ATK">üìé ATK</option>
                        <option value="Asset">üíª Aset</option>
                        <option value="Konsumsi">‚òï Konsumsi</option>
                        <option value="Lainnya">üì¶ Lainnya</option>
                    </select>
                </div>
                <div style="flex: 1; min-width: 150px;">
                    <label style="font-size: 11px; font-weight: bold;">Prioritas</label>
                    <select id="pr_priority" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="Normal">üü¢ Normal</option>
                        <option value="Urgent">üî¥ Urgent</option>
                    </select>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 11px; font-weight: bold;">Justifikasi / Keterangan Tambahan (Akan muncul di Footer Print)</label>
                <textarea id="pr_global_note" rows="2" placeholder="Contoh: Stok bulanan gudang / Urgent unit breakdown..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
            </div>
        </div>

        <div style="background-color: #e3fafa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b6effb;">
            <h4 style="margin:0 0 10px 0; color:#055160;">2. Input Detail Barang</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 2; min-width: 200px;">
                    <label style="font-size: 11px; font-weight: bold;">Nama Barang</label>
                    <input type="text" id="temp_item_name" placeholder="Contoh: Filter Oli" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 2; min-width: 200px;">
                    <label style="font-size: 11px; font-weight: bold;">Spesifikasi / Part Number</label>
                    <input type="text" id="temp_item_spec" placeholder="P/N: 123-456 atau Merk" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 80px;">
                    <label style="font-size: 11px; font-weight: bold;">Qty</label>
                    <input type="number" id="temp_item_qty" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 80px;">
                    <label style="font-size: 11px; font-weight: bold;">Satuan</label>
                    <input type="text" id="temp_item_unit" placeholder="Pcs" list="satuanList" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div style="flex: 1; min-width: 120px;">
                    <label style="font-size: 11px; font-weight: bold;">Est. Harga (@)</label>
                    <input type="number" id="temp_item_price" placeholder="Rp" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
                <div>
                    <button type="button" onclick="window.addItemToTempPR()" style="background-color: #0dcaf0; color: black; font-weight:bold; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; height: 35px;">
                        + Tambah ke List
                    </button>
                </div>
            </div>
        </div>
<div id="pr-print-area" class="pr-print-container" style="display: none;">
    
    <div class="ut-header-wrapper">
        <div class="ut-logo-box">
            <img id="pr_print_logo" src="" alt="LOGO" style="max-height: 60px; max-width: 100%; object-fit: contain;">
            <div id="pr_print_logo_placeholder" style="font-size:10px; color:#999; border:1px dashed #ccc; padding:5px;">[LOGO]</div>
        </div>
        
        <div class="ut-title-box">
            <h1 class="ut-title-main">PURCHASE REQUEST</h1>
            <div class="ut-title-sub">PERMINTAAN PENGADAAN BARANG/JASA</div>
            <div style="font-size:9px; margin-top:5px;">PT ADHIE USAHA MANDIRI - GENERAL AFFAIRS</div>
        </div>

        <div class="ut-meta-box">
            <table class="ut-meta-table">
                <tr>
                    <td class="ut-label">No. Dok</td>
                    <td style="font-weight:bold; color:red;" id="print_pr_id">PR-2025-XXXX</td>
                </tr>
                <tr>
                    <td class="ut-label">Tanggal</td>
                    <td id="print_pr_date">-</td>
                </tr>
                <tr>
                    <td class="ut-label">Halaman</td>
                    <td>1 dari 1</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="ut-info-grid">
        <div class="ut-info-col">
            <div class="info-row">
                <span class="info-label">Pemohon (User)</span>: <span class="info-val" id="print_pr_user">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Departemen</span>: <span class="info-val" id="print_pr_dept">General Affair</span>
            </div>
        </div>
        <div class="ut-info-col">
            <div class="info-row">
                <span class="info-label">Prioritas</span>: <span class="info-val" id="print_pr_prio">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Kategori</span>: <span class="info-val" id="print_pr_category">-</span>
            </div>
        </div>
    </div>

    <table class="ut-table">
        <thead>
            <tr>
                <th style="width: 5%;">NO</th>
                <th style="width: 25%;">NAMA BARANG / JASA</th>
                <th style="width: 25%;">SPESIFIKASI / PART NO.</th>
                <th style="width: 7%;">QTY</th>
                <th style="width: 8%;">SAT</th>
                <th style="width: 15%;">HARGA (@)</th>
                <th style="width: 15%;">TOTAL (RP)</th>
            </tr>
        </thead>
        <tbody id="print_pr_body">
            </tbody>
        <tfoot id="print_pr_footer" style="display:none;">
            <tr>
                <td colspan="6" style="text-align: right; font-weight: bold; background-color: #f0f0f0;">GRAND TOTAL:</td>
                <td id="print_pr_grand_total" style="text-align: right; font-weight: bold; background-color: #e6f0ff;">-</td>
            </tr>
        </tfoot>
    </table>

    <div class="ut-notes-box">
        <div class="ut-notes-header">JUSTIFIKASI / KETERANGAN TAMBAHAN:</div>
        <div id="print_pr_desc" style="font-size: 10pt; padding-left: 5px;">-</div>
    </div>

    <table class="ut-approval-table">
        <tr>
            <td class="appr-title">DIAJUKAN OLEH</td>
            <td class="appr-title">DIPERIKSA OLEH</td>
            <td class="appr-title">DIVERIFIKASI OLEH</td>
            <td class="appr-title">DISETUJUI OLEH</td>
        </tr>
        <tr>
            <td class="appr-box">
                <span class="appr-name" id="sig_requester_name">.................</span>
                <span class="appr-date">User / Requester</span>
            </td>
            <td class="appr-box">
                <span class="appr-name">(.................)</span>
                <span class="appr-date">Dept. Head</span>
            </td>
            <td class="appr-box">
                <span class="appr-name">(.................)</span>
                <span class="appr-date">Logistik / Purchasing</span>
            </td>
            <td class="appr-box">
                <span class="appr-name">Adhie Ardiansyah</span>
                <span class="appr-date">Direktur Utama</span>
            </td>
        </tr>
    </table>

    <div class="doc-footer">
        <span>Form No: AUM-GA-PR-001 | Rev: 02 (Multi-Item)</span>
        <span>Dicetak pada: <span id="print_timestamp"></span></span>
    </div>
</div>
        <div style="margin-bottom: 20px;">
            <h4 style="margin:0 0 5px 0;">Daftar Barang (Preview Sebelum Simpan):</h4>
            <table style="width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #ccc;">
                <thead style="background-color: #343a40; color: white;">
                    <tr>
                        <th style="padding: 8px; width: 5%;">No</th>
                        <th style="width: 25%;">Nama Barang</th>
                        <th style="width: 20%;">Spesifikasi</th>
                        <th style="width: 10%;">Qty</th>
                        <th style="width: 15%;">Harga (@)</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 10%;">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tempPRBody">
                    <tr><td colspan="7" style="text-align:center; padding:10px; color:#999;">Belum ada barang ditambahkan. Isi form diatas lalu klik tombol <b>+ Tambah ke List</b>.</td></tr>
                </tbody>
            </table>
        </div>

        <div style="text-align: right;">
            <button type="button" onclick="window.saveGAReqMulti()" style="background-color: #198754; color: white; font-weight:bold; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                üíæ SIMPAN & BUAT NOMOR PR
            </button>
        </div>
    </div>

    <h3 style="color: #055160; border-bottom: 2px solid #055160; padding-bottom: 5px;">üìÇ Riwayat Purchase Request</h3>
    <div class="report-table-container">
    <table id="gaReqTable" style="width: 100%; font-size: 12px;">
        <thead>
            <tr style="background-color: #055160; color: white;">
                <th class="action-column" style="width:140px;">Aksi</th>
                <th>No. PR</th>
                <th>Tgl Request</th>
                <th>Pemohon</th>
                <th>Detail Item</th>
                <th>Total Estimasi</th>
                <th>Prioritas</th>
                <th>Status</th>
                <th>Tgl Disetujui</th> </tr>
        </thead>
        <tbody id="gaReqBody"></tbody>
    </table>
</div>
</div><div id="ga_section_payment" class="ga-section" style="display: none;">
    <div style="background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e9ecef; margin-bottom: 25px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üìë Payment Tracking Automation</h3>
            <div style="display:flex; gap:10px;">
                <input type="file" id="payment_pdf_upload" accept="application/pdf" style="display: none;" onchange="window.processPaymentPDF(this)">
                <button onclick="document.getElementById('payment_pdf_upload').click()" style="background: #0d6efd; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                    üìÑ + Upload PDF Request
                </button>
            </div>
        </div>
    </div>
<div id="manualInputModal" class="modal" style="display:none; z-index: 10001; background: rgba(0,0,0,0.5);">
    <div class="modal-content" style="max-width: 500px; padding: 25px; border-radius: 12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; color:#2c3e50;">üìù Verifikasi Data Pembayaran</h3>
            <span onclick="closeManualModal()" style="cursor:pointer; font-size:24px;">&times;</span>
        </div>

<div class="kpi-cards hide-on-print" style="margin-bottom: 20px; margin-top: 15px;">
    <div class="kpi-card" style="border-left-color: #ffc107; background-color: #fffbf0;">
        <h4 style="color: #856404; font-size: 14px; border-bottom: 1px dashed #ccc;">‚è≥ Total Outstanding (Pending)</h4>
        <p id="pay_kpi_unpaid" style="font-size: 24px; color: #333;">Rp 0</p>
    </div>

    <div class="kpi-card" style="border-left-color: #198754; background-color: #f0fff4;">
        <h4 style="color: #155724; font-size: 14px; border-bottom: 1px dashed #ccc;">‚úÖ Total Terbayar (Paid)</h4>
        <p id="pay_kpi_paid" style="font-size: 24px; color: #333;">Rp 0</p>
    </div>

    <div class="kpi-card" style="border-left-color: #dc3545; background-color: #fff5f5;">
        <h4 style="color: #721c24; font-size: 14px; border-bottom: 1px dashed #ccc;">‚ö†Ô∏è Jatuh Tempo (< 3 Hari)</h4>
        <p id="pay_kpi_due" style="font-size: 24px; color: #dc3545;">0</p>
    </div>
</div>

        <datalist id="bank_list">
            <option value="BCA">BANK CENTRAL ASIA</option>
            <option value="MANDIRI">BANK MANDIRI</option>
            <option value="BNI">BANK NEGARA INDONESIA</option>
            <option value="BRI">BANK RAKYAT INDONESIA</option>
            <option value="CIMB NIAGA">BANK CIMB NIAGA</option>
            <option value="DANAMON">BANK DANAMON</option>
            <option value="PERMATA">BANK PERMATA</option>
            <option value="BSI">BANK SYARIAH INDONESIA</option>
            <option value="BTN">BANK TABUNGAN NEGARA</option>
            <option value="PANIN">BANK PANIN</option>
            <option value="OCBC NISP">BANK OCBC NISP</option>
            <option value="UOB">BANK UOB INDONESIA</option>
            <option value="MAYBANK">BANK MAYBANK</option>
            <option value="MEGA">BANK MEGA</option>
            <option value="SINARMAS">BANK SINARMAS</option>
            <option value="BPD KALTIM">BANK KALTIMTARA</option>
        </datalist>

        <form onsubmit="window.saveManualInput(event)">
            <input type="hidden" id="temp_evidence_data">
            <input type="hidden" id="temp_filename">

            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Tanggal Request</label>
                <input type="date" id="inp_date" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Nama Penerima (Vendor)</label>
                <input type="text" id="inp_vendor" placeholder="Nama Vendor / Penerima" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Nama Bank</label>
                    <input type="text" id="inp_bank_name" list="bank_list" placeholder="Pilih / Ketik Bank" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; text-transform: uppercase;">
                </div>
                <div style="flex: 1;">
                    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">No. Rekening</label>
                    <input type="text" id="inp_rek_no" placeholder="Nomor Rekening" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Tujuan / Keterangan</label>
                <textarea id="inp_desc" placeholder="Keterangan pembayaran..." rows="2" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;"></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Nominal (Rp)</label>
                <input type="text" id="inp_nominal" placeholder="0" oninput="formatRupiahInput(this)" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-weight:bold; font-size:16px; color:#2c3e50;">
            </div>

            <div id="evidence_status" style="margin-bottom: 20px; font-size: 11px; color: #198754; background: #e8f5e9; padding: 8px; border-radius: 4px; display: none;"></div>

            <div style="display:flex; gap:10px;">
                <button type="button" onclick="closeManualModal()" style="flex:1; padding:12px; border:none; background:#eee; color:#333; border-radius:6px; cursor:pointer; font-weight:bold;">Batal</button>
                <button type="submit" style="flex:1; padding:12px; border:none; background:#0d6efd; color:white; border-radius:6px; cursor:pointer; font-weight:bold;">üíæ Simpan Data</button>
            </div>
        </form>
    </div>
</div>    <div style="display:flex; gap:10px;">
    <button onclick="window.printUnpaidReport()" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">
        üñ®Ô∏è Tagihan
    </button>

    <button onclick="window.openManualEntry()" style="background: #ffc107; color: black; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">
        ‚úçÔ∏è Input Manual
    </button>

    <input type="file" id="payment_pdf_upload" accept="application/pdf" style="display: none;" onchange="window.processPaymentPDF(this)">
    <button onclick="document.getElementById('payment_pdf_upload').click()" style="background: #0d6efd; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">
        üìÑ Upload PDF
    </button>
</div>

    <div class="report-table-container">
        <table id="trackingPaymentTable" style="width: 100%; font-size: 11px; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #343a40; color: white;">
                    <th style="padding:10px;">Tgl Request</th>
                    <th>Jatuh Tempo</th>
                    <th>Penerima (Vendor)</th>
                    <th>Bank & Rekening</th>
                    <th>Keterangan</th>
                    <th>Bukti</th>
                    <th style="text-align: right;">Nominal (IDR)</th>
                    <th style="text-align: center;">Status</th>
                    <th style="text-align: center;">Aksi</th>
                </tr>
            </thead>
            <tbody id="trackingPaymentBody">
                </tbody>
        </table>
    </div>
</div>

<div id="pdfEvidenceModal" class="modal" style="display:none; z-index: 10000;">
    <div class="modal-content" style="max-width:800px;">
        <span class="close-btn" onclick="document.getElementById('pdfEvidenceModal').style.display='none'">&times;</span>
        <h3>üìÇ Bukti Lampiran</h3>
        <div id="evidenceContainer" style="overflow-y:auto; max-height:70vh;"></div>
    </div>
</div><div id="unpaidPrintArea" style="display:none;"></div>
</div><div class=modal id=masterDataModal><div class="modal-content modal-content-lg"><span class=close-btn onclick='document.getElementById("masterDataModal").style.display="none"'>√ó</span><h2>‚öôÔ∏è Kelola Master Unit</h2><p>Master Unit digunakan untuk menyimpan data Unit, Operator Default, Model, dan Sektor agar pengisian laporan lebih cepat.<div style="background: #e0f7fa; border: 1px solid #00acc1; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
    <h4 style="margin-top: 0; color: #006064; display: flex; align-items: center; gap: 10px;">
        üíæ Status Penyimpanan Memori
        <button onclick="window.checkStorage()" style="font-size: 10px; padding: 4px 8px; background: #fff; border: 1px solid #00acc1; color: #00acc1; cursor: pointer; border-radius: 4px;">Refresh</button>
    </h4>
    
    <div style="display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #333;">
        <span id="storageUsedDisplay">Menghitung...</span>
        <span id="storageQuotaDisplay">...</span>
    </div>

    <div style="width: 100%; height: 20px; background-color: #b2ebf2; border-radius: 10px; overflow: hidden; border: 1px solid #80deea;">
        <div id="storageProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00bcd4, #006064); transition: width 1s ease-in-out;"></div>
    </div>
    
    <p style="font-size: 11px; color: #555; margin: 5px 0 0 0;">
        *Data ini tersimpan di browser perangkat Anda (IndexedDB). Jika memori hampir penuh, harap lakukan Backup dan hapus data lama.
    </p>
</div><div class=backup-restore-box><h4 style=margin-top:0;color:#0d6efd>üíæ Backup & Restore Data (Semua Halaman)</h4><p style=font-size:.9em;margin-bottom:15px;color:#555>Simpan data lengkap (Laporan Harian, Triputra, dan Master Unit) ke file JSON. Gunakan fitur ini untuk transfer data antar perangkat atau sebagai cadangan.</p><button class=submit-btn onclick=window.exportAllData() style=background-color:#198754>‚¨áÔ∏è Export/Backup Semua Data</button><div style=margin-top:15px;display:flex;align-items:center;gap:15px><input type=file id=importAllFileInput accept=.json style=flex:1> <button class=submit-btn onclick=window.importAllData() style=background-color:#dc3545>‚¨ÜÔ∏è Import/Restore Data</button></div></div><div style="margin-top: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
    <h4 style="margin-top:0; color:#856404;">üõ†Ô∏è Koreksi Nama Operator (Manual)</h4>
    <p style="font-size: 0.9em; color: #666; margin-bottom:10px;">Pilih nama yang salah dari daftar, lalu ketik nama yang benar. Sistem akan mengubahnya di semua laporan.</p>
    
    <div style="display: flex; gap: 10px; align-items: flex-end;">
        <div style="flex: 1;">
            <label style="font-size:12px; font-weight:bold;">Nama Lama (Salah):</label>
            <select id="fix_old_name" style="width:100%; padding:8px;" onchange="document.getElementById('fix_new_name').value = this.value">
                <option value="">-- Pilih Nama --</option>
            </select>
        </div>
        <div style="flex: 1;">
            <label style="font-size:12px; font-weight:bold;">Ubah Menjadi (Benar):</label>
            <input type="text" id="fix_new_name" placeholder="Ketik Nama Baru (UPPERCASE)" style="width:100%; padding:8px;">
        </div>
        <div>
            <button class="submit-btn" onclick="window.executeNameCorrection()" style="background-color: #fd7e14; margin-top:0;">
                ‚ö° Ganti Nama
            </button>
        </div>
    </div>
</div>

<div class=master-tab-container><div class=master-tabs><button class=tab-button style=color:#198754 data-master-tab=add_unit>‚ûï Tambah Unit Baru</button> <button class="tab-button active"data-master-tab=view_units>üìù Daftar Unit Terdaftar</button></div><div class=master-tab-content style=display:none;padding-top:20px id=add_unit><h4 style=color:#198754>Tambah Unit Baru</h4><div class=edit-form-group><label for=newUnitKey>Kode Unit (Wajib):</label> <input required id=newUnitKey placeholder="Cth: EXCA-01, DUMP-05"></div><div class=edit-form-group><label for=defaultOperator>Operator Default:</label> <input required id=defaultOperator placeholder="Cth: ANDI M."></div><div class=edit-form-group><label for=defaultModel>Model Unit Default:</label> <input required id=defaultModel placeholder="Cth: CAT 320D"></div><div class=edit-form-group><label for=defaultSektor>Sektor Kerja Default:</label> <input required id=defaultSektor list=sektorDatalist placeholder="Cth: PIT A, HAULING ROAD"></div><button class=add-row-btn onclick=window.saveMasterUnit() style=background-color:#198754>üíæ Simpan Unit</button></div><div class=master-tab-content style=padding-top:20px id=view_units><h4>Daftar Unit & Data Default</h4><div id=unitList></div></div></div></div></div><div id="imageZoomModal" class="modal" style="display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(2px);">
    
    <div class="modal-content" style="
        background-color: #fefefe;
        margin: 5% auto; /* Jarak dari atas */
        padding: 0;
        border: 1px solid #888;
        width: 90%; 
        max-width: 500px; /* Lebar maksimal card */
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        position: relative;
        animation: slideDown 0.3s ease-out;
    ">
        
        <div style="
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 12px 12px 0 0;
        ">
            <span style="font-size: 16px; font-weight: bold; color: #333; display: flex; align-items: center; gap: 8px;">
                üñºÔ∏è Detail Foto
            </span>
            <span onclick="document.getElementById('imageZoomModal').style.display='none'" 
                  style="
                    color: #aaa;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    line-height: 1;
                    transition: 0.2s;
                  " 
                  onmouseover="this.style.color='#dc3545'" 
                  onmouseout="this.style.color='#aaa'">
                &times;
            </span>
        </div>

        <div style="padding: 20px; text-align: center; background-color: #f8f9fa;">
            <img id="zoomedImage" src="" alt="Preview" style="
                width: 100%;
                height: auto;
                max-height: 60vh; /* Agar tidak terlalu panjang di HP */
                object-fit: contain;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            ">
        </div>

        <div style="
            padding: 15px;
            border-top: 1px solid #eee;
            text-align: center;
            background: #fff;
            border-radius: 0 0 12px 12px;
        ">
            <button onclick="document.getElementById('imageZoomModal').style.display='none'" 
                    style="
                        background-color: #dc3545; 
                        color: white; 
                        padding: 12px 0; 
                        width: 100%; 
                        border: none; 
                        border-radius: 8px; 
                        font-weight: bold; 
                        font-size: 14px; 
                        cursor: pointer; 
                        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
                        transition: background 0.2s;
                    "
                    onmouseover="this.style.backgroundColor='#bb2d3b'"
                    onmouseout="this.style.backgroundColor='#dc3545'">
                TUTUP
            </button>
        </div>

    </div>
</div>

<style>
@keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* === CSS GENERAL AFFAIR === */
.ga-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.ga-sub-tab-btn {
    padding: 10px 20px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    color: #6c757d;
    transition: all 0.2s;
    margin-right: 10px;
}

.ga-sub-tab-btn.active {
    background-color: #20c997;
    color: white;
    border-color: #20c997;
    box-shadow: 0 4px 6px rgba(32, 201, 151, 0.2);
}

.ga-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
}
.ga-open { background: #e2e3e5; color: #383d41; }
.ga-process { background: #fff3cd; color: #856404; }
.ga-done { background: #d1e7dd; color: #0f5132; }

/* Expiry Dates */
.exp-safe { color: #198754; font-weight: bold; }
.exp-warn { color: #fd7e14; font-weight: bold; background: #fff3cd; padding: 2px 5px; border-radius: 4px;}
.exp-danger { color: #dc3545; font-weight: bold; background: #f8d7da; padding: 2px 5px; border-radius: 4px; animation: pulse 2s infinite; }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

/* === CSS KHUSUS HALAMAN PAYMENT REQUEST === */
/* === CSS PAYMENT REQUEST (FIXED & PRINT PERFECT) === */
/* === CSS PAYMENT REQUEST (HIGH PRECISION & DRAGGABLE SIG) === */
/* === CSS PAYMENT REQUEST (PRESISI A4 & WYSIWYG) === */
/* === CSS PAYMENT REQUEST (PRECISION A4) === */
.payment-paper-container {
    background-color: #525659;
    padding: 30px;
    display: flex;
    justify-content: center;
    overflow: auto;
}

.a4-page {
    background-color: white;
    width: 210mm;
    min-height: 297mm;
    padding: 10mm 15mm; /* Margin standar surat */
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    font-family: 'Arial', sans-serif; /* Font standar dokumen korporat */
    color: black;
    position: relative;
    box-sizing: border-box;
}

/* TABLE LAYOUT UTAMA (Form Atas) */
.form-layout-table {
    width: 100%;
    border-collapse: collapse;
    border: none;
    font-size: 11px;
    margin-bottom: 5px;
}
.form-layout-table td {
    padding: 2px 0;
    vertical-align: bottom; /* Agar input menempel di garis bawah */
}

/* Kolom Kiri */
.col-num { width: 20px; font-weight: normal; }
.col-label { width: 140px; }
.col-sep { width: 15px; text-align: center; }
.col-input { width: 280px; }

/* Kolom Kanan */
.col-spacer { width: 30px; } /* Jarak antar kolom kiri dan kanan */
.col-num-r { width: 20px; }
.col-label-r { width: 110px; }
.col-sep-r { width: 10px; text-align: center; }
.col-input-r { width: 150px; }

/* INPUT STYLING (Layar vs Cetak) */
.inp-line {
    width: 100%;
    border: none;
    border-bottom: 1px solid black; /* Garis bawah tegas */
    background: #fdfdfd; /* Sedikit beda agar tahu ini input */
    font-family: 'Arial';
    font-size: 11px;
    font-weight: bold;
    padding: 0 2px;
    outline: none;
}
.inp-line:focus { background: #e8f0fe; }

/* TAX SECTION (Kanan Bawah Form) */
.tax-row { display: flex; align-items: center; justify-content: flex-end; margin-top: 4px; }
.chk-box {
    width: 12px; height: 12px; border: 1px solid black; margin: 0 5px;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    font-size: 10px; font-weight: bold;
}
.chk-box.checked::after { content: '‚úì'; }

/* MAIN TABLE (Deskripsi) */
.main-table {
    width: 100%;
    border-collapse: collapse;
    border: 2px solid black; /* Border luar tebal */
    font-size: 10px;
    margin-top: 5px;
}
.main-table th {
    border: 1px solid black;
    padding: 5px;
    text-align: center;
    font-weight: bold;
    background: #fff; /* Polos */
}
.main-table td {
    border: 1px solid black;
    height: 20px; /* Tinggi baris fix */
    padding: 0 4px;
    vertical-align: middle;
}

/* Inputs Inside Table */
.tbl-inp {
    width: 100%; height: 100%;
    border: none; background: transparent;
    font-family: 'Arial'; font-size: 10px; outline: none;
}

/* Footer Total */
.row-total td { font-weight: bold; background-color: #eee; }

/* SIGNATURE (DRAGGABLE) */
.sig-canvas {
    position: relative;
    width: 100%;
    height: 180px;
    margin-top: 20px;
    /* border: 1px dashed #ccc; */ /* Aktifkan jika mau lihat batas area */
}
.sig-item {
    position: absolute;
    width: 130px;
    text-align: center;
    cursor: grab;
    padding: 5px;
    background: transparent;
}
.sig-item:active { cursor: grabbing; border: 1px dashed blue; }
.sig-role { font-size: 10px; margin-bottom: 50px; pointer-events: none; }
.sig-name-inp {
    width: 100%; text-align: center; font-weight: bold; font-size: 10px;
    border: none; border-bottom: 1px solid transparent; background: transparent;
}
.sig-name-inp:focus { border-bottom: 1px dotted blue; }
.sig-line { border-bottom: 1px solid black; width: 100%; height: 1px; }
.sig-del {
    position: absolute; top: -5px; right: -5px; width: 15px; height: 15px;
    background: red; color: white; font-size: 10px; border-radius: 50%;
    cursor: pointer; display: none; align-items: center; justify-content: center;
}
.sig-item:hover .sig-del { display: flex; }

/* HEADER & LOGO */
.header-grid { display: flex; justify-content: space-between; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 15px; }
.logo-area { width: 100px; height: 50px; cursor: pointer; position: relative; border: 1px dashed transparent; }
.logo-area:hover { border-color: #ccc; }
.logo-area img { max-width: 100%; max-height: 100%; object-fit: contain; }
.header-title { text-align: center; flex: 1; }
.header-title h1 { margin: 0; text-decoration: underline; font-size: 18px; text-transform: uppercase; }
.header-box { border: 1px solid black; padding: 5px; width: 150px; font-size: 9px; font-style: italic; text-align: center; }

/* PRINT SETTINGS (SAMA PERSIS) */
@media print {
    body * { visibility: hidden; }
    #ga_section_payment, #ga_section_payment * { visibility: visible; }
    #ga_section_payment { position: absolute; top: 0; left: 0; width: 100%; margin: 0; padding: 0; }
    
    .hide-on-print { display: none !important; }
    .payment-paper-container { background: white; padding: 0; margin: 0; }
    .a4-page { width: 100%; margin: 0; padding: 0; box-shadow: none; height: auto; }
    
    /* HILANGKAN KOTAK/GARIS INPUT SAAT CETAK */
    .inp-line { border-bottom: none !important; background: transparent !important; padding: 0; margin: 0;}
    .tbl-inp { border: none !important; }
    .sig-del { display: none !important; }
    .logo-area { border: none !important; }
    
    /* Paksa Background Warna (untuk total) */
    .row-total td { background-color: #eee !important; -webkit-print-color-adjust: exact; }
    
    /* Input Placeholders hide */
    ::placeholder { color: transparent; }
}

/* === CSS TRACKING PAYMENT DASHBOARD === */
.kpi-card-mini {
    flex: 1;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.kpi-label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
.kpi-val { font-size: 20px; font-weight: 800; color: #333; }

/* Status Badges */
.badge-pay { padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; display: inline-block; min-width: 60px; text-align: center;}
.badge-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
.badge-proses { background: #cff4fc; color: #055160; border: 1px solid #b6effb; }
.badge-paid { background: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }

/* Table Styling */
#trackingPaymentTable td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}
#trackingPaymentTable tr:hover { background-color: #f8f9fa; }

/* === CSS KHUSUS PRINT FORM PR (CORPORATE STYLE) === */
/* === STYLE CETAK FORM PR (STANDARD UNITED TRACTORS/ASTRA) === */
/* ================================================================= */
/* === CSS CETAK PURCHASE REQUEST (PORTRAIT BLUE CORPORATE) === */
/* ================================================================= */

/* ================================================================= */
/* === CSS CETAK PR STYLE UNITED TRACTORS / ASTRA (ISO STANDARD) === */
/* ================================================================= */

.pr-print-container {
    font-family: 'Arial Narrow', 'Arial', sans-serif; /* Font standar industri */
    color: #000;
    background: white;
    font-size: 10pt; /* Ukuran font standar dokumen resmi */
    width: 100%;
    max-width: 210mm;
    margin: 0 auto;
    box-sizing: border-box;
}

/* --- HEADER DENGAN BORDER TEBAL (STYLE ISO) --- */
.ut-header-wrapper {
    display: flex;
    border: 2px solid #000; /* Border luar tebal */
    margin-bottom: 10px;
}

.ut-logo-box {
    width: 20%;
    border-right: 1px solid #000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;
}

.ut-title-box {
    width: 50%;
    text-align: center;
    border-right: 1px solid #000;
    padding: 5px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.ut-title-main {
    font-size: 20px;
    font-weight: 900;
    color: #000;
    text-transform: uppercase;
    font-family: 'Arial Black', Arial, sans-serif;
    margin: 0;
}

.ut-title-sub {
    font-size: 12px;
    font-weight: bold;
    margin-top: 2px;
    text-transform: uppercase;
}

.ut-meta-box {
    width: 30%;
    padding: 0;
    font-size: 9pt;
}

.ut-meta-table {
    width: 100%;
    border-collapse: collapse;
}
.ut-meta-table td {
    padding: 2px 5px;
    border-bottom: 1px solid #ccc;
}
.ut-meta-table tr:last-child td { border-bottom: none; }
.ut-label { font-weight: bold; width: 80px; background-color: #f0f0f0; }

/* --- INFO SECTION (GRID BOX) --- */
.ut-info-grid {
    display: flex;
    width: 100%;
    border: 1px solid #000;
    margin-bottom: 15px;
}

.ut-info-col {
    flex: 1;
    padding: 5px 10px;
    border-right: 1px solid #000;
}
.ut-info-col:last-child { border-right: none; }

.info-row { margin-bottom: 4px; }
.info-label { font-weight: bold; display: inline-block; width: 100px; font-size: 9pt; }
.info-val { border-bottom: 1px dotted #000; padding-right: 10px; }

/* --- TABEL UTAMA (STYLE KORPORAT) --- */
.ut-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 5px;
    border: 1px solid #000;
}

.ut-table th {
    background-color: #004b8d; /* Biru Astra/Corporate */
    color: white;
    font-weight: bold;
    text-transform: uppercase;
    padding: 6px 4px;
    border: 1px solid #000;
    font-size: 9pt;
    text-align: center;
    -webkit-print-color-adjust: exact;
}

.ut-table td {
    border: 1px solid #000;
    padding: 4px;
    font-size: 10pt;
    vertical-align: top;
}

/* Zebra Striping Halus */
.ut-table tr:nth-child(even) td {
    background-color: #f2f2f2;
    -webkit-print-color-adjust: exact;
}

/* --- SECTION JUSTIFIKASI --- */
.ut-notes-box {
    border: 1px solid #000;
    padding: 5px;
    margin-bottom: 15px;
    min-height: 40px;
    background-color: #fff;
}
.ut-notes-header {
    font-weight: bold;
    font-size: 9pt;
    text-decoration: underline;
    margin-bottom: 3px;
}

/* --- APPROVAL BOX (GAYA TEKNIK) --- */
.ut-approval-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #000;
    margin-top: 10px;
}

.ut-approval-table td {
    border: 1px solid #000;
    text-align: center;
    width: 25%;
    padding: 0;
}

.appr-title {
    background-color: #ffcc00; /* KUNING UT (United Tractors Yellow) */
    font-weight: bold;
    font-size: 9pt;
    padding: 4px;
    border-bottom: 1px solid #000;
    color: #000;
    -webkit-print-color-adjust: exact;
}

.appr-box {
    height: 80px; /* Ruang Tanda Tangan */
    vertical-align: bottom !important;
    padding-bottom: 5px !important;
}

.appr-name {
    font-weight: bold;
    text-decoration: underline;
    font-size: 10pt;
    display: block;
}

.appr-date {
    font-size: 8pt;
    font-style: italic;
    margin-top: 2px;
}

/* --- FOOTER HALAMAN --- */
.doc-footer {
    margin-top: 5px;
    font-size: 8pt;
    display: flex;
    justify-content: space-between;
    font-style: italic;
}

/* --- ATURAN CETAK --- */
@media print {
    @page {
        size: A4 portrait;
        margin: 10mm 12mm;
    }
    body.print-pr-mode * { visibility: hidden; }
    body.print-pr-mode #pr-print-area, 
    body.print-pr-mode #pr-print-area * { 
        visibility: visible; 
    }
    body.print-pr-mode #pr-print-area {
        position: absolute;
        top: 0; left: 0; width: 100%;
    }
}

/* --- GAYA MENU ICON ONLY (EXPAND ON HOVER/ACTIVE) --- */

.tab-button {
    display: flex;              /* Agar icon dan teks sejajar */
    align-items: center;        /* Tengah vertikal */
    gap: 0;                     /* Gap diatur lewat transisi padding nanti */
    overflow: hidden;           /* Sembunyikan teks yang meluber saat mengecil */
    transition: all 0.4s ease;  /* Animasi halus */
    padding: 14px 15px;         /* Padding standar */
}

/* Pengaturan Teks (Default: Sembunyi) */
.tab-button .tab-text {
    max-width: 0;               /* Lebar 0 = hilang */
    opacity: 0;                 /* Transparan */
    white-space: nowrap;        /* Teks dilarang turun baris */
    margin-left: 0;
    transition: all 0.4s ease;  /* Animasi perubahan lebar & transparansi */
    font-size: 14px;            /* Ukuran font */
}

/* Kondisi: Saat Hover ATAU Saat Aktif -> Tampilkan Teks */
.tab-button:hover .tab-text,
.tab-button.active .tab-text {
    max-width: 250px;           /* Beri ruang cukup agar teks muncul */
    opacity: 1;                 /* Teks terlihat */
    margin-left: 10px;          /* Beri jarak antara icon dan teks */
}

/* Pastikan tombol tidak loncat */
.tabs {
    gap: 5px; /* Jarak antar tombol */
}

</style><div class=modal id=stockHistoryModal><div class=modal-content><span class=close-btn onclick='document.getElementById("stockHistoryModal").style.display="none"'>√ó</span><h2>üìú Riwayat Perubahan Stok Solar</h2><div style="max-height:450px;overflow-y:auto;padding:10px;border:1px solid #e9ecef;border-radius:8px"><table class=stock-history-table border=1><thead><tr><th>Waktu<th>Aktivitas<th>Perubahan<th>Stok Akhir<tbody id=stockHistoryBody></table></div></div></div><div class="modal" id="trackingModal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-btn" onclick="document.getElementById('trackingModal').style.display='none'">√ó</span>
        <h2 style="color: #d63384;">Update Data Utama</h2>
        <input type="hidden" id="edit_track_id">
        
        <div class="edit-form-group">
            <label>Nomor BA / Invoice:</label>
            <input type="text" id="edit_track_no_ba">
        </div>

        <div class="edit-form-group">
            <label>Periode (Manual):</label>
            <input type="text" id="edit_track_period">
        </div>
        
        <div class="edit-form-group">
            <label>Estimasi Nilai (Rp):</label>
            <input type="number" id="edit_track_amount">
        </div>
        <div class="edit-form-group">
            <label>Update Status Terkini:</label>
            <select id="edit_track_status" style="width: 100%; padding: 10px;"></select>
        </div>

        <div class="edit-form-group">
            <label>Tanggal Update:</label>
            <input type="date" id="edit_track_date_update">
        </div>

        <div class="edit-form-group">
            <label>Notes:</label>
            <textarea id="edit_track_notes" rows="2"></textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="window.saveTrackingUpdate()" class="submit-btn" style="flex: 1; background-color: #198754;">üíæ Simpan Update</button>
            <button onclick="window.deleteTrackingFromModal()" class="submit-btn" style="flex: 0 0 auto; background-color: #dc3545;">üóëÔ∏è Hapus Data</button>
        </div>
    </div>
</div>

<div id="payrollExportModal" class="modal" style="display: none; z-index: 10005;">
    <div class="modal-content" style="max-width: 450px;">
        <span class="close-btn" onclick="document.getElementById('payrollExportModal').style.display='none'">√ó</span>
        <h2 style="color: #198754; border-bottom: 2px solid #198754; padding-bottom: 10px;">
            üí∞ Setting Tarif Gaji
        </h2>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
            <p style="font-size:12px; color:#555; margin-top:0;">Masukkan tarif harian yang berlaku saat ini:</p>
            
            <div class="edit-form-group">
                <label>üç± Uang Makan (per hari):</label>
                <input type="number" id="pay_rate_makan" value="50000" placeholder="Contoh: 50000">
            </div>
            
            <div class="edit-form-group">
                <label>üõµ Uang Transport (per hari):</label>
                <input type="number" id="pay_rate_transport" value="12000" placeholder="Contoh: 12000">
            </div>

            <div class="edit-form-group">
                <label>üïí Uang Lembur (HM ‚â• 10):</label>
                <input type="number" id="pay_rate_lembur" value="15000" readonly style="background-color:#e9ecef; color:#666;">
                <small style="color:#dc3545; font-size:10px;">*Otomatis terisi Rp 15.000 jika HM ‚â• 10</small>
            </div>
        </div>

        <button onclick="window.generatePayrollExcel()" class="submit-btn" style="width: 100%; background-color: #198754;">
            üì• Download Excel (.xlsx)
        </button>
    </div>
</div>

<div class=modal id=editReportModal><div class=modal-content><span class=close-btn onclick='document.getElementById("editReportModal").style.display="none"'>√ó</span><h2>‚úèÔ∏è Edit Laporan Harian</h2><input type=hidden id=editReportIndex><div style=display:flex;flex-wrap:wrap;gap:20px><div class=edit-form-group style="flex:1 1 45%"><label for=edit_tanggal>Tanggal:</label> <input type=date required id=edit_tanggal></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_unit>Unit/Alat:</label> <select id=edit_unit required></select></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_operator>Operator (UPPERCASE):</label> <input required id=edit_operator list=operatorDatalist></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_sektor>Sektor Kerja (UPPERCASE):</label> <input required id=edit_sektor list=sektorDatalist></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_time_in>Jam Masuk (Opsional):</label> <input type=time id=edit_time_in></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_time_out>Jam Keluar (Opsional):</label> <input type=time id=edit_time_out></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_hm_awal>HM Awal:</label> <input type=number required min=0 id=edit_hm_awal></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_hm_akhir>HM Akhir:</label> <input type=number required min=0 id=edit_hm_akhir></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_solar>Total Solar (Liter) (Opsional):</label> <input type=number id=edit_solar min=0 step=0.1></div><div class=edit-form-group style="flex:1 1 100%"><label for=edit_keterangan>Keterangan:</label> <input id=edit_keterangan list=keteranganDatalist></div></div><button class="submit-btn" onclick="window.saveEditedReport()" style="margin-top:20px;width:100%">
    üíæ Simpan Perubahan
</button></div></div><div class=modal id=editTriputraModal><div class=modal-content><span class=close-btn onclick='document.getElementById("editTriputraModal").style.display="none"'>√ó</span><h2>‚úèÔ∏è Edit Laporan Triputra</h2><input type=hidden id=editTriputraId> <input type=hidden id=originalTriputraSolar><div style=display:flex;flex-wrap:wrap;gap:20px><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_tanggal>Tanggal:</label> <input type=date required id=edit_trp_tanggal></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_unit>Unit/Alat:</label> <select id=edit_trp_unit required></select></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_operator>Operator (UPPERCASE):</label> <input required id=edit_trp_operator list=operatorDatalist></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_pencapaian>Pencapaian Titik:</label> <input type=number required min=0 id=edit_trp_pencapaian step=1></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_hm_awal>HM Awal:</label> <input type=number required min=0 id=edit_trp_hm_awal></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_hm_akhir>HM Akhir:</label> <input type=number required min=0 id=edit_trp_hm_akhir></div><div class=edit-form-group style="flex:1 1 45%"><label for=edit_trp_solar>Pemakaian Solar (Liter):</label> <input type=number required min=0 id=edit_trp_solar step=0.1></div><div class=edit-form-group style="flex:1 1 100%"><label for=edit_trp_keterangan>Keterangan:</label> <input id=edit_trp_keterangan placeholder=Keterangan></div></div><button class=submit-btn onclick=window.saveEditedTriputraReport() style=margin-top:20px;width:100%;background-color:#6f42c1>üíæ Simpan Perubahan Triputra</button></div></div><div class="modal" id="trackingDetailModal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <span class="close-btn" onclick="document.getElementById('trackingDetailModal').style.display='none'">√ó</span>
        
        <div style="border-bottom: 2px solid #d63384; margin-bottom: 20px; padding-bottom: 10px;">
            <h2 style="color: #d63384; margin: 0;">üì¶ Detail Tracking BA</h2>
            <p id="detail_header_info" style="margin: 5px 0 0; color: #555; font-weight: bold;"></p>
        </div>

        <div style="background: #fff0f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fcc2d7;">
            <h4 style="margin-top: 0; color: #d63384; font-size: 14px;">‚ûï Update Status Baru</h4>
            <input type="hidden" id="detail_parent_id">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; font-weight: bold;">Status:</label>
                    <select id="new_history_status" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></select>
                </div>
                <div style="width: 130px;">
                    <label style="font-size: 11px; font-weight: bold;">Tanggal:</label>
                    <input type="date" id="new_history_date" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <input type="text" id="new_history_note" placeholder="Keterangan (Opsional)..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <button onclick="window.addTrackingHistoryStep()" class="submit-btn" style="width: 100%; background-color: #d63384; padding: 8px;">Update Status</button>
        </div>

        <h4 style="margin-bottom: 15px; color: #333;">Riwayat Perjalanan Dokumen:</h4>
        <div id="timelineContainer" class="timeline-container">
            </div>
    </div>
</div><div id=toast-container></div><datalist id=sektorDatalist><option value=Terunen><option value=Senoni><option value="UK 2"><option value=KWL><option value=Triputra><option value="PIT A"><option value="HAULING ROAD"></datalist><datalist id=keteranganDatalist><option value="Breakdown - Aki Tekor"><option value="Breakdown - Filter Solar Buntu"><option value="Breakdown - Ban Bocor"><option value="Menunggu Sparepart"><option value="Cuaca - Hujan Deras"><option value="Cuaca - Kabut Tebal"><option value="No Operator"><option value="Perintah Pengawas"></datalist><script>// --- GLOBAL SETUP ---
        Chart.register(ChartDataLabels);
        // --- 1. ENGINE INDEXEDDB (CUSTOM WRAPPER) ---
const DB_NAME = 'DOR_Database_V1';
const STORE_NAME = 'app_data_store';

const idb = {
    // Membuka Koneksi Database
    open: () => {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME);
                }
            };

            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
    },

    // Simpan Data (Set Item)
    set: async (key, value) => {
        const db = await idb.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.put(value, key);
            
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
        });
    },

    // Ambil Data (Get Item)
    get: async (key) => {
        const db = await idb.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.get(key);
            
            request.onsuccess = () => resolve(request.result || null);
            request.onerror = () => reject(request.error);
        });
    },

    // Hapus Data
    delete: async (key) => {
        const db = await idb.open();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const request = store.delete(key);
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
        });
    }
};
// --- 2. FUNGSI MIGRASI DARI LOCALSTORAGE KE INDEXEDDB ---
async function migrateFromLocalStorage() {
    const keys = Object.values(ALL_LOCAL_STORAGE_KEYS);
    let migratedCount = 0;

    for (const key of keys) {
        const localData = localStorage.getItem(key);
        if (localData) {
            // Cek apakah data sudah ada di IndexedDB biar ga overwrite sembarangan
            const dbData = await idb.get(key);
            if (!dbData) {
                // Parse JSON dulu karena di DB kita simpan Object murni, bukan string
                try {
                    // Khusus TriputraStock yg disimpan bukan JSON string dulu
                    let parsedData;
                    if (key === ALL_LOCAL_STORAGE_KEYS.triputraStock) {
                        parsedData = parseFloat(localData);
                    } else {
                        parsedData = JSON.parse(localData);
                    }
                    
                    await idb.set(key, parsedData);
                    migratedCount++;
                    console.log(`Migrasi sukses: ${key}`);
                } catch (e) {
                    console.error(`Gagal migrasi key: ${key}`, e);
                }
            }
        }
    }

    if (migratedCount > 0) {
        // Opsional: Hapus localStorage setelah sukses migrasi untuk hemat memori
        // keys.forEach(key => localStorage.removeItem(key)); 
        showToast("System Update", "Database berhasil diperbarui ke versi baru (IndexedDB).", "success");
    }
}
        const defaultMasterUnits = {
            'EXCA-01': { operator_default: 'ANDI', model_default: 'CAT 320D', sektor_default: 'TERUNEN' },
            'DUMP-05': { operator_default: 'BUDI', model_default: 'HINO 500', sektor_default: 'HAULING ROAD' },
            'DOZER-02': { operator_default: 'CACA', model_default: 'KOMATSU D85', sektor_default: 'KWL' },
        };
        const defaultMasterOperators = ['ANDI', 'BUDI', 'CACA']; 
        
        const monthNames = [
            "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
            "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];
        
        // DAFTAR HARI LIBUR NASIONAL (CONTOH) - Perlu diupdate manual atau via API idealnya
        const holidays = [
            '2025-01-01', '2025-01-27', '2025-01-29', // Contoh Jan 2025
            '2025-03-29', '2025-03-31'
        ];

        window.reportsData = []; 
        window.masterUnits = {};
        window.masterOperators = []; 
        window.reportChart = null; 
        window.batchImageCache = {}; 
        window.rowIndexCounter = 0; 
        window.currentSortOrder = 'desc'; 
        window.currentSortColumn = 'tanggal';
        
        // TRIPUTRA VARS
        window.triputraData = [];
        window.triputraFuelStock = 0;
        window.triputraStockLog = []; 
        window.trpRowCounter = 0;
        window.chartHM = null; window.chartSolar = null; window.chartTarget = null; window.chartTrend = null;

        // TRACKING & LAINNYA
        window.trackingData = [];
        window.fuelData = [];
        window.cleanlinessScores = {};
        window.gaData = {
            documents: [],
            maintenance: [],
            requests: [],
            payments: []

        // --- UTILITY BARU: Format Tanggal ke DD-MM-YYYY ---
        function formatDate(isoDateString) {
            if (!isoDateString || isoDateString === '-') return '-';
            try {
                const parts = isoDateString.split('-'); // yyyy-mm-dd
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-yyyy
                }
                const date = new Date(isoDateString);
                if (!isNaN(date.getTime())) {
                     // Fallback yang lebih aman
                     const day = String(date.getDate()).padStart(2, '0');
                     const month = String(date.getMonth() + 1).padStart(2, '0');
                     const year = date.getFullYear();
                     return `${day}-${month}-${year}`;
                }
                return isoDateString; 
            } catch (e) {
                return isoDateString;
            }
        }
        
        // --- UTILITY BARU: Normalisasi Tanggal untuk Perbandingan Aman (Menghindari Timezone Issue) ---
        function getNormalizedTimestamp(isoDateString) {
            if (!isoDateString || isoDateString === '-') return null;
            try {
                // Format: YYYY-MM-DD
                const parts = isoDateString.split('-').map(Number);
                // Use Date(year, monthIndex, day) to force local midnight (0-indexed month)
                const date = new Date(parts[0], parts[1] - 1, parts[2]); 
                if (isNaN(date.getTime())) return null;
                return date.getTime(); 
            } catch (e) {
                return null;
            }
        }

        // --- Perbaikan isDateInPeriod agar menggunakan Timestamp Aman ---
        function isDateInPeriod(dateString, startString, endString) {
            const dateTs = getNormalizedTimestamp(dateString);
            const startTs = getNormalizedTimestamp(startString);
            const endTs = getNormalizedTimestamp(endString);
            
            if (!dateTs || !startTs || !endTs) return false;

            // Perform safe integer comparison
            return dateTs >= startTs && dateTs <= endTs;
        }

        // --- FUNGSI NOTIFIKASI TOAST ---
        function showToast(title, message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '‚ÑπÔ∏è';
            if (type === 'success') icon = '‚úÖ';
            if (type === 'error') icon = '‚ö†Ô∏è';
            if (type === 'warning') icon = 'üîî';


            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <span class="toast-title">${title}</span>
                    <span class="toast-message">${message}</span>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => { if(toast.parentNode) toast.remove(); }, 500);
            }, 4000);
        }

        // --- FUNGSI PEMBANTU KLASIFIKASI KETERANGAN ---
// ==========================================
// 1. LOGIKA DETEKSI KATEGORI (SUPER DETAIL)
// ==========================================
// ==========================================
// 1. LOGIKA DETEKSI KATEGORI (UPDATE: ROAD MAINT = WORKING)
// ==========================================
function getKeteranganCategory(keterangan, jamOperasi = 0) {
    if (!keterangan || typeof keterangan !== 'string') return 'LAIN-LAIN';
    
    // Normalisasi teks
    const txt = keterangan.toLowerCase().trim().replace(/[^\w\s]/gi, ' ');

    // ----------------------------------------------------------------------
    // PRIORITAS UTAMA: AKTIVITAS PEKERJAAN / ROAD MAINTENANCE (WORKING)
    // ----------------------------------------------------------------------
    // Kata-kata ini sering disalahartikan sebagai Breakdown (karena ada kata "perbaikan")
    // atau Idle. Kita harus paksa ini menjadi 'LAIN-LAIN' (Unit Ready/Bekerja).
    
    const roadWorkKeywords = [
        // Maintenance Jalan
        'perbaikan jalan', 'perbaikan jl', 'rpr jalan', 'repair jalan', 'maintenance jalan', 
        'perawatan jalan', 'road maintenance','pembuatan jl, pembuatan jalan',
        
        // Aktivitas Spesifik
        'pemadatan', 'compacting', 'padatkan',
        'griding', 'grading', 'scraping', 'scrapping', 'greade',
        'dozing', 'hampar', 'spreading', 'perataan', 'ratakan',
        'penyiraman', 'watering', 'siram jalan', // Water truck bekerja
        
        // Aktivitas Umum Lainnya (biar aman)
        'loading', 'hauling', 'dumping', 'travel', 'travelling'
    ];

    // Jika mengandung kata kerja di atas, anggap UNIT BEKERJA (Bukan BD/Idle)
    if (roadWorkKeywords.some(kw => txt.includes(kw))) {
        return 'LAIN-LAIN'; 
    }

    // --- RULE PENGECUALIAN LAIN ---
    if (txt.includes('monitor') && txt.includes('error') && jamOperasi > 7) {
        return 'LAIN-LAIN';
    }

    // ----------------------------------------------------------------------
    // PRIORITAS 2: BREAKDOWN (M - Mechanical Availability Loss)
    // ----------------------------------------------------------------------
    const breakdownKeywords = [
        // Umum (Hati-hati, kata 'perbaikan' sendirian akan tertangkap disini, 
        // tapi 'perbaikan jalan' sudah dicegat diatas)
        'rusak', 'breakdown', 'bd', 'trouble', 'masalah', 'error', 'fail', 
        'perbaikan', 'repair', 'reparasi', // Ini akan menangkap 'perbaikan mesin', 'perbaikan bucket', dll.
        'workshop', 'bengkel', 'mekanik', 'mechanic', 'tunggu part', 'waiting part', 'sparepart',
        'las', 'welding', 'retak', 'patah', 'bengkok', 'kendor', 'lepas', 'copot',
        
        // Engine, Hidrolik, Elektrik, Ban, dll...
        'engine', 'mesin', 'power', 'tenaga', 'asap', 'bunyi', 'kasar', 'overheat', 'panas', 'temperatur',
        'oli', 'oil', 'bocor', 'leak', 'rembes', 'filter', 'buntu', 'sumbat', 'hose', 'selang',
        'hidrolik', 'hydraulic', 'silinder', 'cylinder', 'pompa', 'pump',
        'transmisi', 'gardan', 'steering', 'setir', 'brake', 'rem', 'blong',
        'track', 'shoe', 'link', 'roller', 'idler', 'sprocket', 'spring', 'suspensi',
        'ban', 'tyre', 'tire', 'kempes', 'pecah', 'baut roda', 'stud',
        'elektrik', 'kabel', 'short', 'korslet', 'accu', 'aki', 'baterai', 'tekor', 'start', 'dinamo',
        'lampu', 'gelap', 'panel', 'monitor', 'sensor', 'solenoid', 'ac ', 'a/c', 'blower',
        'bucket', 'blade', 'ripper', 'tooth', 'teeth', 'kuku', 'pin', 'bushing'
    ];

    if (breakdownKeywords.some(kw => txt.includes(kw))) return 'BREAKDOWN';

    // ----------------------------------------------------------------------
    // PRIORITAS 3: CUACA & ALAM (P - Physical Availability Loss)
    // ----------------------------------------------------------------------
    const weatherKeywords = [
        'hujan', 'rain', 'gerimis', 'lebat', 'badai', 'petir', 
        'licin', 'slippery', 'basah', 'becek', 'lumpur', 'mud', 'amblas', 'kepater', 'lengket',
        'kabut', 'fog', 'gelap', 'pandangan', 'visibility',
        'debu', 'dust', // Jika stop karena debu (bukan unit water truck yg kerja)
        'banjir', 'genangan'
    ];

    if (weatherKeywords.some(kw => txt.includes(kw))) return 'CUACA';

    // ----------------------------------------------------------------------
    // PRIORITAS 4: IDLE / STANDBY (P - Personnel/Process Loss)
    // ----------------------------------------------------------------------
    const idleKeywords = [
        // Fuel
        'fuel', 'solar', 'bbm', 'minyak', 'isi', 'refuel', 'tunggu fuel', 'telat', 'lambat',

        // Manpower
        'no operator', 'no op', 'tanpa operator', 'tidak ada operator',
        'sakit', 'ijin', 'izin', 'cuti', 'mangkir', 'alpha', 'absen', 'pulang',
        'makan', 'meal', 'istirahat', 'rest', 'sholat', 'jumat', 'ibadah', 'p5m', 'p2h', 'apel', 'briefing', 'safety',
        'ganti shift', 'shift change',
        
        // Operasional (Menunggu)
        'tunggu', 'wait', 'antri', 'queue', 'parkir', 'standby', 'stb', 'idle',
        'arahan', 'perintah', 'instruksi', 'pengawas', 
        'pindah', 'move', 'moving', 'mobilisasi', 'demob', 'storing',
        'lokasi', 'front', 'survey', 'pengukuran', 'patok',
        'blasting', 'peledakan', 'evakuasi', 'cek lokasi',
        
        // PENTING: Hapus 'perbaikan jalan' & 'grader' dari sini agar tidak konflik
        'cuci', 'washing', 'bersih', 'greasing' 
    ];

    if (idleKeywords.some(kw => txt.includes(kw))) return 'IDLE_LAIN';

    // Default
    if (txt.length > 2) return 'IDLE_LAIN'; 
    
    return 'LAIN-LAIN';
}
// ==========================================================================
// --- HELPER: DETEKSI TARGET MINIMUM CHARGE ---
function getUnitTarget(unitName) {
    const u = unitName ? unitName.toUpperCase() : "";
    
    // 1. Target 210 HM (Compactor, Grader, Backhoe)
    if (u.includes("VIBRO") || u.includes("COMPACTOR") || u.includes("SEM") || 
        u.includes("MG") || u.includes("GRADER") || u.includes("BHL") || u.includes("BACKHOE") ||
        u.includes("32") || u.includes("63") || u.includes("31") || u.includes("40") || u.includes("36") || u.includes("64") || u.includes("68") || u.includes("42") || u.includes("41") || 
        u.includes("33") || u.includes("45") || u.includes("46")) {
        return { type: "Alat Support (Vibro/Grader/BHL)", target: 210 };
    }

    // 2. Target 220 HM (Bulldozer & Excavator)
    if (u.includes("DOZER") || u.includes("D85") || u.includes("D65") || 
        u.includes("43") || u.includes("02")) {
        return { type: "Bulldozer", target: 220 };
    }

    // Default: Excavator (Target 220)
    return { type: "Excavator", target: 220 };
}       

// --- HELPER BARU: FORMAT NAMA UNIT SESUAI REQUEST KHUSUS ---
function getCustomUnitName(unitCode) {
    if (!unitCode) return "-";
    
    // Bersihkan input (Hapus spasi berlebih, uppercase)
    const u = unitCode.toUpperCase().trim();
    
    // Ambil Nomor Unit (Misal "AUM 29" -> "29", "AUM 05A" -> "05A")
    // Kita ambil string setelah "AUM" atau ambil angkanya saja jika format beda
    let numberPart = u.replace(/[^0-9A-Z]/g, '').replace("AUM", "").trim(); 

    // 1. KOBELCO SK-200 (AUM 17)
    if (u.includes("17")) return "EXCAVATOR KOBELCO SK-200";

    // 2. KOMATSU PC 200 (AUM 29, 30, 05A)
    if (u.includes("29") || u.includes("30") || u.includes("05")) {
        return `KOMATSU PC 200 EXC-${numberPart}`;
    }

    // 3. MOTOR GRADER (AUM 33, 45, 54) -> Liugong MG
    if (u.includes("33") || u.includes("45") || u.includes("54")) {
        return `Liugong MG-${numberPart}`;
    }

    // 4. BACKHOE LOADER (AUM 46, 36) -> NEW HOLLAND BHL
    if (u.includes("46") || u.includes("36")) {
        return `NEW HOLLAND BHL-${numberPart}`;
    }

    // 5. VIBRO LIUGONG COMPACT (AUM 31, 32) -> LIUGONG VC
    if (u.includes("31") || u.includes("32")) {
        return `LIUGONG VC-${numberPart}`;
    }

    // 6. SANY COMPACT (AUM 41, 42) -> Sany VC
    if (u.includes("41") || u.includes("42")) {
        return `Sany VC-${numberPart}`;
    }

    // 7. VIBRO COMPACT (AUM 63, 64, 68) -> VIBRO COMPACT - [No]
    if (u.includes("63") || u.includes("64") || u.includes("68")) {
        return `VIBRO COMPACT - ${numberPart}`;
    }

    // 8. BOMAG (AUM 40, 53) -> BOMAG VC
    if (u.includes("40") || u.includes("53")) {
        return `BOMAG VC-${numberPart}`;
    }

    // Default: Kembalikan nama asli jika tidak ada di daftar
    return u;
}
        // --- FUNGSI KLASIFIKASI SEKTOR ---
// ==========================================
// 2. KLASIFIKASI SEKTOR (STANDARISASI NAMA)
// ==========================================
function getSektorClassification(sektor) {
    if (!sektor || typeof sektor !== 'string') return '-';
    const cleanSektor = sektor.trim().toUpperCase();
    
    // GROUP IHM
    if (['TERUNEN', 'SENONI', 'UK 2', 'UK2', 'IHM', 'TERUNAN'].some(s => cleanSektor.includes(s))) {
        return 'IHM';
    }
    
    // GROUP KWL
    if (['KWL', 'KAWAL', 'KUAR', 'QUARRY'].some(s => cleanSektor.includes(s))) {
        return 'KWL';
    }
    
    // GROUP TRIPUTRA
    if (['TRIPUTRA', 'TRP', 'TP'].some(s => cleanSektor.includes(s))) {
        return 'TRIPUTRA';
    }
    
    // Default: Gunakan nama sektor itu sendiri jika tidak masuk klasifikasi
    return cleanSektor; 
}
        
        // --- FUNGSI PENGHITUNG HM OTOMATIS (DENGAN TOAST NOTIFIKASI) ---
        function attachAutoCalculation(rowElement) {
            const unitInput = rowElement.querySelector('.input-unit');
            const hmAwalInput = rowElement.querySelector('.input-hm-awal');
            const hmAkhirInput = rowElement.querySelector('.input-hm-akhir');

            const calculateDiff = () => {
                const hmAwal = parseFloat(hmAwalInput.value);
                const hmAkhir = parseFloat(hmAkhirInput.value);
                const unitName = unitInput.value || 'Unit Tanpa Nama';

                if (!isNaN(hmAwal) && !isNaN(hmAkhir)) {
                    if (hmAkhir >= hmAwal) {
                        const diff = Math.round(hmAkhir - hmAwal); // Dibulatkan ke integer
                        // --- PENAMBAHAN TOAST NOTIFIKASI HM TOTAL ---
                        showToast(`Prediksi HM: ${unitName}`, `HM Total: <strong>${diff} HM</strong>`, 'info');
                    } else {
                         // Hanya log, validasi ketat dilakukan di tombol submit
                        console.warn(`Peringatan: HM Akhir (${hmAkhir}) lebih kecil dari HM Awal (${hmAwal}) pada ${unitName}.`);
                    }
                }
            };
            hmAkhirInput.addEventListener('change', calculateDiff);
        }

        // --- Logika Web Storage ---
        const ALL_LOCAL_STORAGE_KEYS = {
            reports: 'DOR_ReportsData',
            masterUnits: 'DOR_MasterUnits',
            triputraData: 'DOR_TriputraData',
            triputraStock: 'DOR_TriputraStock',
            triputraStockLog: 'DOR_TriputraStockLog',
        };

async function saveMasterDataToLocalStorage() {
    try {
        await idb.set(ALL_LOCAL_STORAGE_KEYS.masterUnits, masterUnits);
    } catch (e) {
        console.error("Gagal simpan Master Unit", e);
        showToast("Error", "Gagal menyimpan Master Unit ke Database", "error");
    }
}
// --- GANTI FUNGSI LOAD DATA ---
async function loadMasterDataFromLocalStorage() {
    // 1. Jalankan Migrasi dulu (hanya berefek jika ada sisa data di localStorage)
    await migrateFromLocalStorage();

    // 2. Load Master Units
    const storedUnits = await idb.get(ALL_LOCAL_STORAGE_KEYS.masterUnits);
    const storedReports = await idb.get(ALL_LOCAL_STORAGE_KEYS.reports);
    
    if (storedUnits) {
        masterUnits = storedUnits;
    } else {
        masterUnits = defaultMasterUnits;
        await idb.set(ALL_LOCAL_STORAGE_KEYS.masterUnits, masterUnits);
    }

    // Update list operator global
    masterOperators = [...new Set(Object.values(masterUnits).map(u => u.operator_default).filter(op => op && op.trim() !== ''))].sort();
    if (masterOperators.length === 0) masterOperators = defaultMasterOperators;

    // 3. Load Reports
    if (storedReports) {
        reportsData = storedReports;
        // Pastikan tanggal diparse dengan benar (sortir)
        reportsData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
    } else {
        reportsData = [];
        await idb.set(ALL_LOCAL_STORAGE_KEYS.reports, reportsData);
    }

    // 4. Load Triputra Data
    const storedTriputra = await idb.get(ALL_LOCAL_STORAGE_KEYS.triputraData);
    const storedStock = await idb.get(ALL_LOCAL_STORAGE_KEYS.triputraStock);
    const storedStockLog = await idb.get(ALL_LOCAL_STORAGE_KEYS.triputraStockLog);
    const storedTracking = await idb.get('DOR_TrackingData'); // Load Tracking Juga

    if (storedTriputra) triputraData = storedTriputra;
    if (storedStock !== null && storedStock !== undefined) triputraFuelStock = parseFloat(storedStock);
    if (storedStockLog) triputraStockLog = storedStockLog;
    if (storedTracking) trackingData = storedTracking; // Variable global trackingData harus ada

    // Update Tampilan UI Stok
    const displayStock = document.getElementById('triputra_stock_display');
    if(displayStock) displayStock.textContent = Math.round(triputraFuelStock).toLocaleString('id-ID');
}        
async function saveReportsDataToLocalStorage() {
    reportsData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
    try {
        await idb.set(ALL_LOCAL_STORAGE_KEYS.reports, reportsData);
    } catch(e) {
        console.error("Save Error", e);
        if (e.name === 'QuotaExceededError') {
             alert("PENYIMPANAN PERANGKAT PENUH! Hapus beberapa data lama atau foto.");
        } else {
             showToast("Error", "Gagal menyimpan laporan: " + e.message, "error");
        }
    }
}
async function saveTriputraData() {
    try {
        await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraData, triputraData);
        await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraStock, triputraFuelStock); // Simpan angka langsung
        await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraStockLog, triputraStockLog);
        
        const displayStock = document.getElementById('triputra_stock_display');
        if(displayStock) displayStock.textContent = Math.round(triputraFuelStock).toLocaleString('id-ID');
    } catch (e) {
        console.error("Gagal simpan Triputra", e);
    }
}
        function logStockChange(type, changeAmount, reason) {
            triputraStockLog.unshift({
                timestamp: new Date().toLocaleString('id-ID'),
                type: type, // 'Input' or 'Usage'
                change: Math.round(changeAmount), // Dibulatkan
                finalStock: Math.round(triputraFuelStock), // Dibulatkan
                reason: reason
            });
            // Keep log size manageable (last 100 entries)
            if(triputraStockLog.length > 100) triputraStockLog.pop();
            saveTriputraData();
        }
        

        window.updateFastEntryPreview = function(selectElem) {
    const unitName = selectElem.value;
    const hmAkhirInput = document.getElementById('fast_hm_akhir');
    const infoDiv = document.getElementById('fast_hm_info');

    // Reset visual
    hmAkhirInput.value = ""; 
    infoDiv.innerHTML = "";
    
    // Default 0
    let lastHM = 0; 
    let infoText = "Unit Baru / Belum ada history (Start: 0)";

    if (unitName && typeof reportsData !== 'undefined') {
        // 1. Ambil data unit ini
        const unitHistory = reportsData.filter(r => r.unit === unitName);

        if (unitHistory.length > 0) {
            // 2. Sorting yang lebih kuat:
            // Prioritas 1: Tanggal Paling Baru
            // Prioritas 2: Jika tanggal sama, ambil HM Akhir paling besar (untuk handle double shift)
            unitHistory.sort((a, b) => {
                const dateA = new Date(a.tanggal);
                const dateB = new Date(b.tanggal);
                return dateB - dateA || parseFloat(b.hm_akhir) - parseFloat(a.hm_akhir);
            });

            // 3. Ambil data teratas
            const lastReport = unitHistory[0];
            lastHM = parseFloat(lastReport.hm_akhir) || 0;
            
            infoText = `HM Awal Otomatis: <strong>${lastHM}</strong> (Tgl ${formatDate(lastReport.tanggal)})`;
        }
    }

    // 4. SIMPAN DI ATRIBUT (Untuk referensi visual)
    hmAkhirInput.setAttribute('data-start-hm', lastHM);

    // Update Teks Info Hijau
    infoDiv.innerHTML = `<span style="font-size:11px; color:#198754;">${infoText}</span>`;
    
    // Update Placeholder
    hmAkhirInput.placeholder = `Isi di atas ${lastHM}...`;
};
        // --- FITUR BARU: BACKUP & RESTORE DATA GLOBAL ---
        window.exportAllData = function() {
            const dataToExport = {
                DOR_ReportsData: reportsData,
                DOR_MasterUnits: masterUnits,
                DOR_TriputraData: triputraData,
                DOR_TriputraStock: triputraFuelStock,
                DOR_TriputraStockLog: triputraStockLog,
                // Tambahkan semua data global yang tersimpan di localStorage
            };

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DOR_Backup_Lengkap_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Backup Sukses", "Semua data telah disimpan ke file JSON.", "success");
        }

window.importAllData = function() {
    if (!confirm("PERHATIAN: Data yang Anda impor akan **MENIMPA** semua data yang ada saat ini di Database. Lanjutkan?")) return;

    const fileInput = document.getElementById('importAllFileInput');
    const file = fileInput.files[0];

    if (!file) {
        showToast('Error', 'Pilih file JSON hasil backup terlebih dahulu.', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = async function(e) { // Tambahkan async disini
        try {
            const importedData = JSON.parse(e.target.result);

            if (!importedData.DOR_ReportsData || !importedData.DOR_MasterUnits) {
                throw new Error("Format file JSON tidak valid atau tidak lengkap.");
            }

            // 1. Simpan ke IndexedDB
            await idb.set(ALL_LOCAL_STORAGE_KEYS.reports, importedData.DOR_ReportsData);
            await idb.set(ALL_LOCAL_STORAGE_KEYS.masterUnits, importedData.DOR_MasterUnits);
            
            if (importedData.DOR_TriputraData) await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraData, importedData.DOR_TriputraData);
            if (importedData.DOR_TriputraStock) await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraStock, parseFloat(importedData.DOR_TriputraStock));
            if (importedData.DOR_TriputraStockLog) await idb.set(ALL_LOCAL_STORAGE_KEYS.triputraStockLog, importedData.DOR_TriputraStockLog);
            
            // Handle Tracking Data jika ada di backup
            // Cek nama key di backup file Anda, sesuaikan
            if (importedData.DOR_TrackingData) await idb.set('DOR_TrackingData', importedData.DOR_TrackingData);

            showToast("Restore Sukses", "Data berhasil direstore ke Database. Halaman akan dimuat ulang...", "success");
            
            // 2. Reload Halaman
            setTimeout(() => window.location.reload(), 1500); 

        } catch (error) {
            console.error('Import Error:', error);
            showToast('Error Restore', 'Gagal memproses file: ' + error.message, 'error');
        }
    };

    reader.readAsText(file);
}

        // --- Master Data dan Dropdown ---
        function updateUnitDropdown(selectElement) {
            selectElement.innerHTML = '<option value="">-- Pilih Unit --</option>';
            Object.keys(masterUnits).sort().forEach(unitKey => {
                const option = document.createElement('option');
                option.value = unitKey;
                option.textContent = unitKey;
                selectElement.appendChild(option);
            });
        }

        function updateOperatorDatalist() {
            const datalistId = 'operatorDatalist';
            let operatorDatalist = document.getElementById(datalistId);
            if (!operatorDatalist) {
                operatorDatalist = document.createElement('datalist');
                operatorDatalist.id = datalistId;
                document.body.appendChild(operatorDatalist);
            }
            operatorDatalist.innerHTML = '';
            masterOperators.forEach(opName => {
                const option = document.createElement('option');
                option.value = opName;
                operatorDatalist.appendChild(option);
            });
        }
        
        function updateFilterUnitDropdown() {
            const filterSelect = document.getElementById('filter_unit');
            const currentValue = filterSelect.value;
            
            [filterSelect].forEach(sel => {
                if(!sel) return;
                sel.innerHTML = '<option value="all">-- Semua Unit --</option>';
                Object.keys(masterUnits).sort().forEach(unitKey => {
                    const option = document.createElement('option');
                    option.value = unitKey;
                    option.textContent = unitKey;
                    sel.appendChild(option);
                });
                if (Object.keys(masterUnits).includes(currentValue)) sel.value = currentValue;
                else sel.value = 'all';
            });
        }
        
        // UPDATE FUNGSI INI AGAR DROPDOWN ABSENSI JUGA TER-UPDATE OTOMATIS
function updateFilterSektorDropdown() {
    const allSektors = reportsData.map(report => report.sektor); 
    Object.values(masterUnits).forEach(unit => {
        if (unit.sektor_default && unit.sektor_default.trim() !== '') allSektors.push(unit.sektor_default);
    });
    
    // Kumpulkan Sektor unik (sudah diklasifikasikan)
    const uniqueSektors = [...new Set(allSektors.map(getSektorClassification))].filter(s => s && s.trim() !== ""); 
    
    const filterSelect = document.getElementById('filter_sektor'); // Tab Laporan
    const availFilterSelect = document.getElementById('avail_filter_sektor'); // Tab MA/PA
    const absFilterSelect = document.getElementById('abs_filter_sektor'); // <--- TAMBAHAN: Tab Absensi
    
    [filterSelect, availFilterSelect, absFilterSelect].forEach(sel => {
        if(!sel) return;
        const currentValue = sel.value; // Simpan nilai yang sedang dipilih user
        
        sel.innerHTML = '<option value="all">-- Semua Sektor --</option>';
        uniqueSektors.sort().forEach(sektor => {
            const option = document.createElement('option');
            option.value = sektor;
            option.textContent = sektor;
            sel.appendChild(option);
        });
        
        // Kembalikan nilai yang dipilih user jika masih valid
        if (uniqueSektors.includes(currentValue)) sel.value = currentValue;
        else sel.value = 'all';
    });
}
        
        window.updateOperatorAndSektor = function(unitSelectElement) {
            const selectedUnit = unitSelectElement.value;
            const row = unitSelectElement.closest('tr') || unitSelectElement.closest('form');
            
            // Existing logic for Operator/Model/Sektor
            const operatorInput = row.querySelector('.input-operator') || row.querySelector('#edit_operator') || row.querySelector('.trp-operator');
            const modelInput = row.querySelector('.input-model'); 
            const sektorInput = row.querySelector('.input-sektor') || row.querySelector('#edit_sektor');
            
            if (selectedUnit && masterUnits[selectedUnit]) {
                const unitData = masterUnits[selectedUnit];
                if (operatorInput) operatorInput.value = unitData.operator_default || '';
                if (modelInput) modelInput.value = unitData.model_default || '';
                if (sektorInput) sektorInput.value = unitData.sektor_default || '';
            } else {
                if (operatorInput) operatorInput.value = '';
                if (modelInput) modelInput.value = '';
                if (sektorInput) sektorInput.value = '';
            }

            // NEW LOGIC: Update HM Awal Placeholder based on previous history
            const hmAwalInput = row.querySelector('.input-hm-awal');
            if (hmAwalInput && selectedUnit) {
                if (typeof reportsData !== 'undefined' && Array.isArray(reportsData)) {
                    const lastReport = reportsData.find(r => r.unit === selectedUnit);
                    if (lastReport) {
                        hmAwalInput.placeholder = `Ex: ${Math.round(lastReport.hm_akhir)}`; // Dibulatkan
                        hmAwalInput.title = `HM Akhir Terakhir: ${Math.round(lastReport.hm_akhir)} (Tgl: ${formatDate(lastReport.tanggal)})`; // Dibulatkan
                    } else {
                        hmAwalInput.placeholder = "HM Awal";
                        hmAwalInput.title = "";
                    }
                }
            }
        }

        // --- FITUR BARU: AUTO DETEKSI HM AKHIR TERAKHIR KHUSUS TRIPUTRA ---
window.updateTriputraUnitChange = function(selectElement) {
    // 1. Panggil fungsi lama agar Operator & Sektor Default tetap terisi
    if (typeof window.updateOperatorAndSektor === 'function') {
        window.updateOperatorAndSektor(selectElement);
    }

    const unit = selectElement.value;
    const row = selectElement.closest('tr');
    const hmAwalInput = row.querySelector('.trp-hm-awal');

    // Reset Placeholder jika unit dikosongkan
    if (!unit) {
        hmAwalInput.placeholder = "Awal";
        hmAwalInput.title = "";
        hmAwalInput.style.borderColor = "#ced4da"; // Reset warna border
        return;
    }

    // 2. Cari History Terakhir di database lokal (triputraData)
    // Kita filter data yang unitnya sama
    const history = triputraData.filter(d => d.unit === unit);

    if (history.length > 0) {
        // Sortir: Tanggal Terbaru paling atas -> Jika tanggal sama, ID Terbesar (inputan terakhir)
        history.sort((a, b) => {
            const dateA = new Date(a.tanggal);
            const dateB = new Date(b.tanggal);
            // Sort Date Descending || Sort ID Descending
            return dateB - dateA || (b.id > a.id ? 1 : -1); 
        });

        const lastData = history[0];
        const lastHM = parseFloat(lastData.hmAkhir);

        if (!isNaN(lastHM)) {
            // 3. Update Tampilan Placeholder (Text Samar)
            hmAwalInput.value = ""; // Kosongkan value asli agar placeholder terlihat
            hmAwalInput.placeholder = `Ex: ${lastHM}`; // <--- INI TEXT SAMARNYA
            
            // Tambahan: Tooltip saat mouse hover & Border Hijau
            hmAwalInput.title = `HM Akhir Terakhir: ${lastHM} (Tgl: ${formatDate(lastData.tanggal)})`; 
            hmAwalInput.style.borderColor = "#198754"; // Visual cue hijau
            
            // Debugging (Cek di console browser jika tidak muncul)
            // console.log(`Found history for ${unit}: HM ${lastHM}`);
        }
    } else {
        // Jika tidak ada history sama sekali
        hmAwalInput.placeholder = "Unit Baru (0)";
        hmAwalInput.title = "Belum ada riwayat input untuk unit ini";
        hmAwalInput.style.borderColor = "#ced4da";
    }
};

        // --- Master Data Modal Functions ---
        function renderMasterUnitList() {
            const unitListDiv = document.getElementById('unitList');
            unitListDiv.innerHTML = ''; 
            if (Object.keys(masterUnits).length === 0) {
                unitListDiv.innerHTML = '<p style="padding: 10px; color: #dc3545;">Belum ada Unit terdaftar. Silakan tambahkan Unit baru di tab "Tambah Unit Baru".</p>';
                return;
            }
            let html = '';
            Object.keys(masterUnits).sort().forEach(unitKey => {
                const unit = masterUnits[unitKey];
                html += `
                    <div class="master-unit-item" id="unit-item-${unitKey}">
                        <div class="view-mode">
                            <span><strong>${unitKey}</strong>: Op: ${unit.operator_default}, Model: ${unit.model_default}, Sektor: ${unit.sektor_default}</span>
                            <div>
                                <button class="action-button edit-report-button" style="background-color: #ffc107; color: #333;" onclick="window.editMasterUnit('${unitKey}')">‚úèÔ∏è Edit</button>
                                <button class="action-button delete-report-button" style="background-color: #dc3545; color: white;" onclick="window.deleteMasterUnit('${unitKey}')">‚ùå Hapus</button>
                            </div>
                        </div>
                        <div class="edit-mode" style="display: none;">
                            <div class="edit-form-group">
                                <label>Kode Unit (Tidak bisa diubah):</label>
                                <input type="text" value="${unitKey}" disabled>
                            </div>
                            <div class="edit-form-group">
                                <label for="edit_operator_${unitKey}">Operator Default:</label>
                                <input type="text" id="edit_operator_${unitKey}" value="${unit.operator_default}" placeholder="Operator Default">
                            </div>
                            <div class="edit-form-group">
                                <label for="edit_model_${unitKey}">Model Unit Default:</label>
                                <input type="text" id="edit_model_${unitKey}" value="${unit.model_default}" placeholder="Model Default">
                            </div>
                            <div class="edit-form-group">
                                <label for="edit_sektor_${unitKey}">Sektor Kerja Default:</label>
                                <input type="text" id="edit_sektor_${unitKey}" value="${unit.sektor_default}" placeholder="Sektor Default" list="sektorDatalist">
                            </div>
                            <div class="master-item-actions" style="display: flex; gap: 10px;">
                                <button class="action-button save-btn" style="background-color: #198754; color: white;" onclick="window.saveMasterUnitChanges('${unitKey}')">üíæ Simpan Perubahan</button>
                                <button class="action-button cancel-btn" style="background-color: #6c757d; color: white;" onclick="window.cancelEdit('${unitKey}')">Batal</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            unitListDiv.innerHTML = html;
        }
        
        function switchMasterTab(tabId) {
            document.querySelectorAll('.master-tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.master-tab-content').forEach(content => content.style.display = 'none');
            const button = document.querySelector(`.master-tabs button[data-master-tab="${tabId}"]`);
            if (button) button.classList.add('active');
            const content = document.getElementById(tabId);
            if (content) content.style.display = 'block';
        }

        window.openMasterDataModal = function() {
    document.getElementById('masterDataModal').style.display = 'block';
    loadMasterData();
    switchMasterTab('view_units');
    
    // TAMBAHKAN BARIS INI:
    populateNameCorrectionDropdown(); 
    window.checkStorage(); // <--- Cek memori saat modal dibuka
    // ---------------------

    loadMasterData();
    switchMasterTab('view_units');
    populateNameCorrectionDropdown(); 
}

        // Perbaikan: Ganti fungsi ini menjadi event listener handler yang benar
        function masterTabHandler(event) {
            const button = event.currentTarget; // Menggunakan currentTarget untuk elemen yang memasang listener
            const tabId = button.dataset.masterTab;

            document.querySelectorAll('#masterDataModal .master-tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#masterDataModal .master-tab-content').forEach(content => content.style.display = 'none');
            
            button.classList.add('active');
            const content = document.getElementById(tabId);
            if (content) content.style.display = 'block';
        }
        
        function loadMasterData() {
            renderMasterUnitList();
            document.querySelectorAll('#masterDataModal .master-tabs button').forEach(button => {
                // Pastikan listener lama dihapus sebelum ditambahkan yang baru
                button.removeEventListener('click', masterTabHandler);
                button.addEventListener('click', masterTabHandler);
            });
        }
        
        window.saveMasterUnit = function() {
            const unitKey = document.getElementById('newUnitKey').value.trim().toUpperCase();
            const operator = document.getElementById('defaultOperator').value.trim().toUpperCase(); 
            const model = document.getElementById('defaultModel').value.trim().toUpperCase();
            const sektor = document.getElementById('defaultSektor').value.trim().toUpperCase(); 
            
            if (unitKey === "") return alert("Kode Unit harus diisi!");
            if (operator === "" || model === "" || sektor === "") return alert("Semua kolom harus diisi.");
            if (masterUnits[unitKey]) return alert("Unit dengan kode ini sudah ada!");
            
            masterUnits[unitKey] = { operator_default: operator, model_default: model, sektor_default: sektor };
            saveMasterDataToLocalStorage();
            alert(`Berhasil menyimpan Unit baru: ${unitKey}.`);

            document.getElementById('newUnitKey').value = '';
            document.getElementById('defaultOperator').value = '';
            document.getElementById('defaultModel').value = '';
            document.getElementById('defaultSektor').value = '';
            
            loadMasterDataFromLocalStorage();
            loadMasterData();
            document.querySelectorAll('.input-unit').forEach(select => updateUnitDropdown(select));
            updateFilterUnitDropdown();
            updateFilterSektorDropdown(); 
            switchMasterTab('view_units'); 
        }

        window.editMasterUnit = function(unitKey) {
            const item = document.getElementById(`unit-item-${unitKey}`);
            item.querySelector('.view-mode').style.display = 'none';
            item.querySelector('.edit-mode').style.display = 'block';
        }

        window.cancelEdit = function(unitKey) {
            const item = document.getElementById(`unit-item-${unitKey}`);
            item.querySelector('.edit-mode').style.display = 'none';
            item.querySelector('.view-mode').style.display = 'flex';
        }

        window.saveMasterUnitChanges = function(unitKey) {
            const operator = document.getElementById(`edit_operator_${unitKey}`).value.trim().toUpperCase();
            const model = document.getElementById(`edit_model_${unitKey}`).value.trim().toUpperCase();
            const sektor = document.getElementById(`edit_sektor_${unitKey}`).value.trim().toUpperCase();

            if (operator === "" || model === "" || sektor === "") return alert("Semua kolom harus diisi.");
            
            masterUnits[unitKey].operator_default = operator;
            masterUnits[unitKey].model_default = model;
            masterUnits[unitKey].sektor_default = sektor;

            saveMasterDataToLocalStorage();
            alert(`Perubahan Unit ${unitKey} berhasil disimpan.`);
            loadMasterDataFromLocalStorage();
            loadMasterData(); 
            document.querySelectorAll('.input-unit').forEach(select => updateUnitDropdown(select));
            updateFilterUnitDropdown();
            updateFilterSektorDropdown();
        }

        window.deleteMasterUnit = function(unitKey) {
            if (confirm(`Anda yakin ingin menghapus Unit ${unitKey}?`)) {
                delete masterUnits[unitKey];
                saveMasterDataToLocalStorage();
                alert(`Unit ${unitKey} berhasil dihapus.`);
                loadMasterDataFromLocalStorage();
                loadMasterData();
                document.querySelectorAll('.input-unit').forEach(select => updateUnitDropdown(select));
                updateFilterUnitDropdown();
                updateFilterSektorDropdown();
            }
        }
        
        // --- Image Compression ---
        // --- 1. FUNGSI KOMPRESI GAMBAR (Ditingkatkan) ---
// Ganti fungsi compressImage yang lama dengan ini
// --- UPDATE: FUNGSI KOMPRESI FOTO (KUALITAS LEBIH BAIK - MAX ~300KB) ---
function compressImage(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // 1. ATUR RESOLUSI (Sangat berpengaruh ke ketajaman)
            // Sebelumnya: 400px (Kecil/Thumbnail)
            // Sekarang: 1024px (Standar HD, teks di foto terbaca jelas)
            const MAX_DIMENSION = 1024; 
            
            if (width > height) {
                if (width > MAX_DIMENSION) {
                    height *= MAX_DIMENSION / width;
                    width = MAX_DIMENSION;
                }
            } else {
                if (height > MAX_DIMENSION) {
                    width *= MAX_DIMENSION / height;
                    height = MAX_DIMENSION;
                }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // 2. ATUR KUALITAS & UKURAN FILE
            // Mulai dengan kualitas 0.7 (70%). Pada resolusi 1024px, 
            // ini biasanya menghasilkan file sekitar 150KB - 250KB (Sangat aman & Jelas).
            let quality = 0.7; 
            let dataUrl = canvas.toDataURL('image/jpeg', quality);

            // 3. PENGECEKAN UKURAN (SAFETY NET)
            // 300KB dalam base64 kira-kira panjang stringnya 400.000 karakter
            // Jika hasilnya masih di atas 300KB (misal foto sangat detail), turunkan kualitas bertahap
            while (dataUrl.length > 400000 && quality > 0.3) {
                quality -= 0.1; // Turunkan 10%
                dataUrl = canvas.toDataURL('image/jpeg', quality);
            }

            callback(dataUrl);
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}
// --- 2. FUNGSI HANDLE UPLOAD & PREVIEW (Diperbaiki) ---
window.handleImageUpload = function(event, rowId, fieldName) {
    const file = event.target.files[0];
    
    // Ambil elemen DOM untuk preview
    const previewImg = document.getElementById(`preview-${rowId}-${fieldName}`);
    const previewWrapper = document.getElementById(`wrapper-${rowId}-${fieldName}`);
    const labelSpan = document.getElementById(`label-${rowId}-${fieldName}`);

    if (!batchImageCache[rowId]) batchImageCache[rowId] = {};

    if (file) {
        // Tampilkan status loading
        if (labelSpan) labelSpan.textContent = "Memproses...";
        
        compressImage(file, function(base64String) {
            // 1. Simpan ke Cache Data (untuk nanti disimpan ke database)
            batchImageCache[rowId][fieldName] = base64String;
            
            // 2. Tampilkan Preview (Update UI Input)
            if (previewImg) {
                previewImg.src = base64String;
                previewImg.style.display = 'block';
            }
            if (previewWrapper) {
                previewWrapper.style.display = 'flex'; // Munculkan kotak preview
            }
            if (labelSpan) {
                labelSpan.textContent = "Ganti Foto";
                labelSpan.style.color = "#198754"; // Hijau
            }
        });
    } else {
        // Reset jika batal pilih file
        batchImageCache[rowId][fieldName] = 'N/A';
        if (previewImg) previewImg.src = "";
        if (previewWrapper) previewWrapper.style.display = 'none';
        if (labelSpan) {
            labelSpan.textContent = "Upload";
            labelSpan.style.color = "#0d6efd";
        }
    }
};
        
        // --- IMPROVED EXCEL IMPORT (MULTI-SHEET & SMART SCAN) ---
        window.handleExcelImport = function() {
            const fileInput = document.getElementById('excelFileInput');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Error', 'Pilih file Excel terlebih dahulu.', 'error');
                return;
            }

            // 1. Definisikan Alias Header yang lebih Komprehensif
            // Key = nama field di sistem, Value = array kemungkinan nama header di Excel
            const keywordMap = {
                tanggal: ['TANGGAL', 'DATE', 'TGL', 'HARI', 'WAKTU', 'DT'],
                unit: ['UNIT', 'CN', 'CODE', 'KODE_UNIT', 'NO_UNIT', 'EQUIPMENT', 'ALAT'],
                operator: ['OPERATOR', 'DRIVER', 'NAMA', 'OPR', 'NRP'],
                sektor: ['SEKTOR', 'LOKASI', 'LOCATION', 'PIT', 'AREA', 'SITE'],
                hm_awal: ['HM_AWAL', 'HM_START', 'START_HM', 'AWAL', 'BEGIN_HM', 'HMA'],
                hm_akhir: ['HM_AKHIR', 'HM_END', 'END_HM', 'AKHIR', 'LAST_HM', 'HMB'],
                total_solar: ['SOLAR', 'FUEL', 'BBM', 'LITER', 'FUEL_USED', 'CONSUMPTION', 'REFFUEL'],
                keterangan: ['KETERANGAN', 'REMARK', 'CATATAN', 'NOTES', 'DESC', 'ACTIVITY'],
                time_in: ['JAM_MASUK', 'TIME_IN', 'START_TIME', 'IN'],
                time_out: ['JAM_KELUAR', 'TIME_OUT', 'END_TIME', 'OUT']
            };

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Baca workbook dengan cellDates: true agar tanggal terbaca sebagai Object Date
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    let totalImported = 0;
                    let totalSkipped = 0;
                    let sheetsProcessed = 0;

                    // Bersihkan form input sebelum mengisi data baru
                    document.getElementById('reportInputBody').innerHTML = '';
                    rowIndexCounter = 0;
                    batchImageCache = {};

                    // 2. Loop Semua Sheet dalam File Excel
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        // Konversi sheet ke array of arrays (header: 1)
                        const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                        if (!rawData || rawData.length === 0) return; // Skip sheet kosong

                        // 3. Smart Scan: Cari Baris Header
                        // Kita scan max 50 baris pertama untuk mencari baris dengan kecocokan keyword terbanyak
                        let bestHeaderRowIndex = -1;
                        let maxMatches = 0;
                        let foundColumnMap = {}; // Menyimpan index kolom untuk setiap field

                        // Batasi scan sampai baris 50 atau panjang data
                        const limitRow = Math.min(rawData.length, 50);

                        for (let r = 0; r < limitRow; r++) {
                            const row = rawData[r];
                            let currentMatches = 0;
                            let tempMap = {};

                            // Cek setiap sel dalam baris ini
                            row.forEach((cellVal, colIndex) => {
                                if (!cellVal || typeof cellVal !== 'string') return;
                                
                                const cleanHeader = cellVal.trim().toUpperCase().replace(/[^A-Z0-9]/g, '_');
                                
                                // Cek apakah header ini cocok dengan keyword kita
                                Object.keys(keywordMap).forEach(fieldKey => {
                                    const keywords = keywordMap[fieldKey];
                                    // Cek exact match atau partial match (contains)
                                    const isMatch = keywords.some(k => cleanHeader === k || cleanHeader.includes(k));
                                    
                                    if (isMatch && tempMap[fieldKey] === undefined) {
                                        tempMap[fieldKey] = colIndex;
                                        currentMatches++;
                                    }
                                });
                            });

                            // Syarat minimal: Harus nemu Unit dan salah satu HM atau Tanggal agar dianggap header valid
                            if (currentMatches > maxMatches && tempMap['unit'] !== undefined && (tempMap['hm_akhir'] !== undefined || tempMap['tanggal'] !== undefined)) {
                                maxMatches = currentMatches;
                                bestHeaderRowIndex = r;
                                foundColumnMap = tempMap;
                            }
                        }

                        // Jika tidak ditemukan header yang valid di sheet ini, lanjut ke sheet berikutnya
                        if (bestHeaderRowIndex === -1) {
                            console.log(`Sheet "${sheetName}" dilewati: Tidak ditemukan header yang valid.`);
                            return; 
                        }

                        sheetsProcessed++;
                        
                        // 4. Ekstraksi Data dimulai dari baris setelah Header
                        const dataRows = rawData.slice(bestHeaderRowIndex + 1);

                        dataRows.forEach((row, idx) => {
                            // Ambil data berdasarkan map kolom yang ditemukan
                            const getVal = (field) => {
                                const colIdx = foundColumnMap[field];
                                return (colIdx !== undefined) ? row[colIdx] : undefined;
                            };

                            let unitVal = getVal('unit');
                            let hmAkhirVal = getVal('hm_akhir');

                            // Validasi minimal: Harus ada Unit dan HM Akhir (atau indikator baris data valid)
                            if (!unitVal && (hmAkhirVal === undefined || hmAkhirVal === '')) return;

                            // -- Parsing Data --
                            
                            // A. Tanggal
                            let tanggalVal = getVal('tanggal');
                            let finalDate = new Date().toISOString().substring(0, 10); // Default hari ini
                            
                            if (tanggalVal instanceof Date) {
                                // Sudah object Date (karena cellDates: true)
                                // Adjust timezone offset agar tidak mundur sehari
                                const offset = tanggalVal.getTimezoneOffset() * 60000;
                                finalDate = new Date(tanggalVal.getTime() - offset).toISOString().substring(0, 10);
                            } else if (typeof tanggalVal === 'number' && tanggalVal > 20000) {
                                // Serial Excel number (backup logic)
                                finalDate = XLSX.SSF.format('yyyy-mm-dd', tanggalVal);
                            } else if (typeof tanggalVal === 'string' && tanggalVal.trim() !== '') {
                                // String date, coba parse
                                const parsed = new Date(tanggalVal);
                                if(!isNaN(parsed)) finalDate = parsed.toISOString().substring(0, 10);
                            }

                            // B. HM & Solar (Pastikan Angka)
                            const parseNum = (v) => {
                                if (typeof v === 'number') return v;
                                if (typeof v === 'string') {
                                    v = v.replace(',', '.'); // Handle koma
                                    return parseFloat(v) || 0;
                                }
                                return 0;
                            };

                            const hmAwal = parseNum(getVal('hm_awal'));
                            const hmAkhir = parseNum(getVal('hm_akhir'));
                            const solar = parseNum(getVal('total_solar'));

                            // C. Waktu (Time In/Out) - Handle desimal Excel (0.5 = 12:00)
                            const parseTime = (v) => {
                                if (!v) return '';
                                if (typeof v === 'number') {
                                    // Excel time fraction
                                    const totalSeconds = Math.round(v * 24 * 60 * 60);
                                    const h = Math.floor(totalSeconds / 3600);
                                    const m = Math.floor((totalSeconds % 3600) / 60);
                                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                                }
                                return String(v).trim();
                            };
                            
                            // D. String Fields
                            const unit = String(unitVal || '').toUpperCase().trim();
                            const operator = String(getVal('operator') || '').toUpperCase().trim();
                            const sektor = String(getVal('sektor') || '').toUpperCase().trim();
                            const ket = String(getVal('keterangan') || '').trim();

                            // Logic Validasi Baris
                            if (unit !== "" && hmAkhir >= hmAwal) {
                                window.addRow({
                                    tanggal: finalDate,
                                    unit: unit,
                                    operator: operator,
                                    sektor: sektor,
                                    hm_awal: hmAwal,
                                    hm_akhir: hmAkhir,
                                    total_solar: solar,
                                    keterangan: ket,
                                    time_in: parseTime(getVal('time_in')),
                                    time_out: parseTime(getVal('time_out'))
                                });
                                
                                // Auto-fill default data dari Master Data jika kosong di Excel
                                const lastRowId = `row-${rowIndexCounter}`;
                                const lastRow = document.getElementById(lastRowId);
                                if(lastRow) {
                                    // Trigger logika update otomatis
                                    const unitSelect = lastRow.querySelector('.input-unit');
                                    unitSelect.value = unit; // Set unit agar updateOperatorAndSektor bisa mengambil default
                                    window.updateOperatorAndSektor(unitSelect);

                                    // Jika excel ada isinya, timpa default
                                    if(operator) lastRow.querySelector('.input-operator').value = operator;
                                    if(sektor) lastRow.querySelector('.input-sektor').value = sektor;
                                }

                                totalImported++;
                            } else {
                                totalSkipped++;
                            }
                        });
                    });

                    if (sheetsProcessed === 0) {
                        showToast('Gagal', 'Tidak ditemukan format header yang dikenali di sheet manapun.', 'error');
                    } else {
                        showToast('Import Selesai', `Sukses scan ${sheetsProcessed} sheet. ${totalImported} baris data diambil.`, 'success');
                        fileInput.value = ''; // Reset
                    }

                } catch (error) {
                    console.error('Excel Error:', error);
                    showToast('Error Critical', 'Gagal memproses file: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        };


        // --- TAMBAH BARIS ---
        window.addRow = function(initialData = {}) {
            rowIndexCounter++;
            const rowId = `row-${rowIndexCounter}`;
            const tbody = document.getElementById('reportInputBody');
            const newRow = tbody.insertRow();
            newRow.id = rowId;
            
            newRow.innerHTML = `
                <td class="col-action"><button type="button" class="delete-row-btn" onclick="window.deleteRow('${rowId}')">‚ùå</button></td>
                <td class="col-date"><input type="date" class="input-tanggal" required value="${initialData.tanggal || new Date().toISOString().substring(0, 10)}"></td>
                <td class="col-unit"><select class="input-unit" onchange="window.updateOperatorAndSektor(this)" required></select></td>
                <td class="col-op"><input type="text" class="input-operator" list="operatorDatalist" required placeholder="Operator"></td>
                <td class="col-model"><input type="text" class="input-model" required placeholder="Model Unit"></td>
                <td class="col-sektor"><input type="text" class="input-sektor" list="sektorDatalist" required placeholder="Sektor Kerja"></td>
                <td class="col-time"><input type="time" class="input-time-in" placeholder="Masuk" value="${initialData.time_in || ''}"></td>
                <td class="col-time"><input type="time" class="input-time-out" placeholder="Keluar" value="${initialData.time_out || ''}"></td>
                <td class="col-file report-photo-cell">
                    <div class="file-upload-container">
                        <input type="file" onchange="window.handleImageUpload(event, '${rowId}', 'foto_timesheet')" accept="image/*" capture="camera">
                        <span class="upload-label" id="label-${rowId}-foto_timesheet">Upload</span>
                    </div>
                    <div class="file-preview-wrapper" id="wrapper-${rowId}-foto_timesheet" style="display:none;">
                        <img id="preview-${rowId}-foto_timesheet" class="file-preview-mini" src="" alt="Preview" onclick="window.zoomImage(this.src)">
                    </div>
                </td>
                <td class="col-hm"><input type="number" class="input-hm-awal" min="0" required placeholder="HM Awal" value="${initialData.hm_awal || ''}"></td>
                <td class="col-file report-photo-cell">
                    <div class="file-upload-container">
                        <input type="file" onchange="window.handleImageUpload(event, '${rowId}', 'foto_awal')" accept="image/*" capture="camera">
                        <span class="upload-label" id="label-${rowId}-foto_awal">Upload</span>
                    </div>
                    <div class="file-preview-wrapper" id="wrapper-${rowId}-foto_awal" style="display:none;">
                        <img id="preview-${rowId}-foto_awal" class="file-preview-mini" src="" alt="Preview" onclick="window.zoomImage(this.src)">
                    </div>
                </td>
                <td class="col-hm"><input type="number" class="input-hm-akhir" min="0" required placeholder="HM Akhir" value="${initialData.hm_akhir || ''}"></td>
                <td class="col-file report-photo-cell">
                    <div class="file-upload-container">
                        <input type="file" onchange="window.handleImageUpload(event, '${rowId}', 'foto_akhir')" accept="image/*" capture="camera">
                        <span class="upload-label" id="label-${rowId}-foto_akhir">Upload</span>
                    </div>
                    <div class="file-preview-wrapper" id="wrapper-${rowId}-foto_akhir" style="display:none;">
                        <img id="preview-${rowId}-foto_akhir" class="file-preview-mini" src="" alt="Preview" onclick="window.zoomImage(this.src)">
                    </div>
                </td>
                <td class="col-solar"><input type="number" class="input-solar" min="0" step="0.1" placeholder="Liter" value="${initialData.total_solar || ''}"></td>
                <td class="col-keterangan"><input type="text" class="input-keterangan" list="keteranganDatalist" placeholder="Keterangan (Cth: Hujan 2 jam)" value="${initialData.keterangan || ''}"></td>
            `;

            updateUnitDropdown(newRow.querySelector('.input-unit'));
            updateOperatorDatalist();

            if (Object.keys(initialData).length > 0) {
                // Set value unit dan panggil updateOperatorAndSektor untuk mengisi model/operator default
                const unitSelect = newRow.querySelector('.input-unit');
                unitSelect.value = initialData.unit || ''; 
                window.updateOperatorAndSektor(unitSelect);
                
                // Override operator/sektor jika ada dari initialData (from excel import)
                newRow.querySelector('.input-operator').value = initialData.operator || masterUnits[initialData.unit]?.operator_default || '';
                newRow.querySelector('.input-sektor').value = initialData.sektor || masterUnits[initialData.unit]?.sektor_default || '';
                newRow.querySelector('.input-model').value = initialData.model || masterUnits[initialData.unit]?.model_default || '';
                
                // Set nilai lain
                newRow.querySelector('.input-tanggal').value = initialData.tanggal || new Date().toISOString().substring(0, 10);
                newRow.querySelector('.input-hm-awal').value = initialData.hm_awal;
                newRow.querySelector('.input-hm-akhir').value = initialData.hm_akhir;
                newRow.querySelector('.input-solar').value = initialData.total_solar;
                newRow.querySelector('.input-keterangan').value = initialData.keterangan;
            }
            attachAutoCalculation(newRow); 
        }
        
        window.deleteRow = function(rowId) {
            const row = document.getElementById(rowId);
            if (row) { row.remove(); delete batchImageCache[rowId]; }
        }

        // --- SAVE BATCH (IMPROVED: PARTIAL SAVE & LARGE DATA HANDLING) ---
     document.getElementById('batchReportForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // Ambil semua baris
    const rows = document.getElementById('reportInputBody').querySelectorAll('tr');
    if (rows.length === 0) return alert("Tidak ada baris laporan untuk disimpan.");
    
    // Konfirmasi jika data sangat banyak (>100 baris)
    if (rows.length > 100) {
        if (!confirm(`Anda akan menyimpan ${rows.length} baris data. Proses ini mungkin memakan waktu beberapa detik. Lanjutkan?`)) return;
    }

    const newReports = [];
    const rowsToRemove = [];
    let successCount = 0;
    let failCount = 0;
    
    // Loop setiap baris untuk validasi individual
    rows.forEach((row, i) => {
        // 1. Reset visual error sebelumnya
        row.classList.remove('row-error');
        row.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

        // 2. Ambil Value
        const rowId = row.id;
        const tanggalInput = row.querySelector('.input-tanggal');
        const unitInput = row.querySelector('.input-unit');
        const operatorInput = row.querySelector('.input-operator');
        const modelInput = row.querySelector('.input-model');
        const sektorInput = row.querySelector('.input-sektor');
        const hmAwInput = row.querySelector('.input-hm-awal');
        const hmAkhInput = row.querySelector('.input-hm-akhir');
        const solarInput = row.querySelector('.input-solar');
        const ketInput = row.querySelector('.input-keterangan');
        const timeInInput = row.querySelector('.input-time-in');
        const timeOutInput = row.querySelector('.input-time-out');

        const tanggal = tanggalInput.value;
        const unit = unitInput.value;
        const operator = operatorInput.value.trim().toUpperCase(); 
        const model = modelInput.value.trim().toUpperCase();
        const sektor = sektorInput.value.trim().toUpperCase(); 
        const hm_awal = parseFloat(hmAwInput.value);
        const hm_akhir = parseFloat(hmAkhInput.value);
        let total_solar = parseFloat(solarInput.value);
        if (isNaN(total_solar)) total_solar = 0;
        
        let isValidRow = true;

        // 3. Validasi Per Baris
        if (!tanggal) { tanggalInput.classList.add('input-error'); isValidRow = false; }
        if (!unit) { unitInput.classList.add('input-error'); isValidRow = false; }
        if (!operator) { operatorInput.classList.add('input-error'); isValidRow = false; }
        if (!sektor) { sektorInput.classList.add('input-error'); isValidRow = false; }
        if (isNaN(hm_awal)) { hmAwInput.classList.add('input-error'); isValidRow = false; }
        if (isNaN(hm_akhir)) { hmAkhInput.classList.add('input-error'); isValidRow = false; }
        
        // Validasi Logika HM
        if (!isNaN(hm_awal) && !isNaN(hm_akhir) && hm_akhir < hm_awal) {
            hmAkhInput.classList.add('input-error'); 
            hmAkhInput.title = "HM Akhir tidak boleh lebih kecil dari HM Awal";
            isValidRow = false;
        }

        // 4. Jika Valid, Masukkan ke Array Simpan
        if (isValidRow) {
            // [FIX UTAMA] HITUNG JAM OPERASI DULU SEBELUM DIGUNAKAN DI FUNGSI KATEGORI
            const jam_operasi = hm_akhir - hm_awal;

            const time_in = timeInInput.value;
            const time_out = timeOutInput.value;
            const keterangan = ketInput.value.trim();
            
            // Sekarang jam_operasi sudah ada, fungsi ini tidak akan error
            const kategori_keterangan = getKeteranganCategory(keterangan, jam_operasi);
            const klasifikasi_sektor = getSektorClassification(sektor); 

            let work_hours = 0;
            if (time_in && time_out) {
                const [h_in, m_in] = time_in.split(':').map(Number);
                const [h_out, m_out] = time_out.split(':').map(Number);
                let start_time = new Date(0, 0, 0, h_in, m_in);
                let end_time = new Date(0, 0, 0, h_out, m_out);
                if (end_time <= start_time) end_time.setDate(end_time.getDate() + 1);
                work_hours = (end_time - start_time) / (1000 * 60 * 60);
            }

            const cache = batchImageCache[rowId] || {};

            newReports.push({
                tanggal: tanggal, operator: operator, unit: unit, model: model, sektor: sektor, keterangan: keterangan,
                time_in: time_in || '-', time_out: time_out || '-',
                foto_timesheet: cache.foto_timesheet && cache.foto_timesheet.startsWith('data:image') ? cache.foto_timesheet : 'N/A',
                work_hours: work_hours, hm_awal: hm_awal,
                foto_awal: cache.foto_awal && cache.foto_awal.startsWith('data:image') ? cache.foto_awal : 'N/A',
                hm_akhir: hm_akhir,
                foto_akhir: cache.foto_akhir && cache.foto_akhir.startsWith('data:image') ? cache.foto_akhir : 'N/A',
                jam_operasi: jam_operasi, 
                total_solar: total_solar,
                kategori_keterangan: kategori_keterangan,
                klasifikasi_sektor: klasifikasi_sektor,
            });

            rowsToRemove.push(row); 
            successCount++;
        } else {
            row.classList.add('row-error');
            failCount++;
        }
    });

    // 5. Proses Penyimpanan
    if (newReports.length > 0) {
        try {
            reportsData.push(...newReports);
            saveReportsDataToLocalStorage(); 
            
            rowsToRemove.forEach(row => {
                const rowId = row.id;
                delete batchImageCache[rowId]; 
                row.remove();
            });

            window.fetchReportData();
            
            if (failCount === 0) {
                showToast('Sukses', `Berhasil menyimpan ${successCount} laporan.`, 'success');
                if (document.getElementById('reportInputBody').children.length === 0) {
                    rowIndexCounter = 0;
                    window.addRow(); 
                }
            } else {
                showToast('Penyimpanan Parsial', `${successCount} data berhasil disimpan. ${failCount} data GAGAL.`, 'warning');
                alert(`PERHATIAN: ${successCount} data berhasil disimpan.\nNamun ada ${failCount} baris yang error (ditandai merah).\nSilakan perbaiki baris yang tersisa.`);
            }

        } catch (e) {
            reportsData.splice(reportsData.length - newReports.length, newReports.length);
            alert("Terjadi kesalahan saat menyimpan: " + e.message);
        }
    } else {
        if (failCount > 0) {
            alert(`Gagal menyimpan. Ada ${failCount} baris yang error. Cek kolom merah.`);
        }
    }
});
        
        // --- Periode Logic ---
// ============================================================
// FUNGSI UPDATE TAHUN OTOMATIS (SEMUA TAB)
// ============================================================
// ============================================================
// FUNGSI UPDATE TAHUN OTOMATIS (SEMUA TAB + ABSENSI FIX)
// ============================================================
window.updateYearDropdown = function() {
    const yearSelectIds = [
        'filter_year',          // Tab Laporan Harian
        'trp_filter_year',      // Tab Triputra
        'avail_filter_year',    // Tab Analisa Ketersediaan
        'abs_filter_year',      // Tab Absensi (WAJIB ADA)
        'fuel_filter_year'      // Tab Fuel
    ];

    const currentYear = new Date().getFullYear();
    const maxYear = currentYear + 2; 
    const minYear = 2020;            

    yearSelectIds.forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;

        // Simpan nilai lama
        const currentVal = sel.value;
        sel.innerHTML = ''; // Reset

        // Khusus Fuel
        if (id === 'fuel_filter_year') {
            const optAll = document.createElement('option');
            optAll.value = 'all';
            optAll.textContent = '-- Semua Data (All Time) --';
            sel.appendChild(optAll);
        }

        // Isi Tahun
        for (let y = maxYear; y >= minYear; y--) {
            const option = document.createElement('option');
            option.value = y;
            option.textContent = y;
            sel.appendChild(option);
        }

        // Kembalikan nilai atau set default
        if (currentVal && (currentVal === 'all' || (parseInt(currentVal) >= minYear && parseInt(currentVal) <= maxYear))) {
            sel.value = currentVal;
        } else {
            if (id !== 'fuel_filter_year') sel.value = currentYear;
        }
    });
};

        function updateMonthRange(periodType, prefix='') { 
            const monthSelect = document.getElementById(`${prefix}filter_month`);
            const yearSelect = document.getElementById(`${prefix}filter_year`);
            const selectedYear = parseInt(yearSelect.value);
            
            const currentSelectedValues = Array.from(monthSelect.options)
                .filter(option => option.selected)
                .map(option => option.value);

            monthSelect.innerHTML = ''; 
            monthSelect.removeAttribute('multiple');
            monthSelect.size = 1;

            // PENAMBAHAN: Memungkinkan multi-select untuk periode bulanan di semua tab (prefix='' dan 'avail_' dan 'trp_')
            if (prefix === 'avail_' || prefix === '' || prefix === 'trp_') { 
                monthSelect.setAttribute('multiple', 'multiple');
                monthSelect.size = 6;
            }
            
            if (periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') {
                
                for (let i = 0; i < 12; i++) {
                    let text, value;
                    if (periodType === 'calendar_monthly') {
                        value = i;
                        text = `${monthNames[i]} ${selectedYear}`;
                    } else { // custom_monthly_21_20
                        const endMonthIndex = i; 
                        const endYear = selectedYear;
                        let startMonthIndex = i - 1;
                        let startYear = selectedYear;
                        if (startMonthIndex < 0) { startMonthIndex = 11; startYear = selectedYear - 1; }
                        value = `${startMonthIndex},${endMonthIndex},${startYear},${endYear}`;
                        text = `${monthNames[startMonthIndex]} ${startYear} (21) - ${monthNames[endMonthIndex]} ${endYear} (20)`;
                    }
                    const option = document.createElement('option');
                    option.value = value;
                    monthSelect.appendChild(option);
                    option.textContent = text;
                }
            } else if (periodType === 'weekly') {
                const option = document.createElement('option');
                option.value = "weekly";
                option.textContent = "7 Hari Terakhir";
                monthSelect.appendChild(option);
            }
            
            // Kembalikan pilihan multiple yang tadi terpilih
            if (monthSelect.multiple && currentSelectedValues.length > 0) {
                Array.from(monthSelect.options).forEach(option => {
                    if (currentSelectedValues.includes(option.value)) {
                        option.selected = true;
                    }
                });
            } else if (!monthSelect.multiple) {
                 // Pilih bulan saat ini jika tidak ada yang terpilih (mode single select)
                 monthSelect.value = new Date().getMonth();
            }
            
            const currentTab = document.querySelector('.tab-button.active')?.getAttribute('data-tab');
            if (prefix === '') {
                 if (currentTab === 'laporan') window.fetchReportData();
            } else if (prefix === 'trp_') {
                 if (currentTab === 'laporan_triputra') window.fetchTriputraData();
            } else if (prefix === 'avail_') {
                 if (currentTab === 'analisa_ketersediaan') window.fetchAvailabilityData();
            }
        }
        
        // Function untuk mendapatkan range tanggal dari multiple selected values
        function getMultipleReportingPeriod(periodType, prefix) {
            const monthSelect = document.getElementById(`${prefix}filter_month`);
            const selectedRanges = Array.from(monthSelect.selectedOptions).map(option => option.value);

            // Jika tidak ada yang dipilih, kembalikan periode kosong
            if (selectedRanges.length === 0 || periodType === 'weekly') {
                 return getReportingPeriod(periodType, prefix); 
             }

            let minStart = null;
            let maxEnd = null;
            let monthTextList = [];

            selectedRanges.forEach(rangeValue => {
                let start, end;
                const selectedYear = parseInt(document.getElementById(`${prefix}filter_year`).value);
                
                if (periodType === 'calendar_monthly') {
                    const selectedMonthIndex = parseInt(rangeValue);
                    start = new Date(selectedYear, selectedMonthIndex, 1);
                    end = new Date(selectedYear, selectedMonthIndex + 1, 0); 
                    monthTextList.push(monthSelect.querySelector(`option[value=\"${rangeValue}\"]`).textContent);
                    
                } else if (periodType === 'custom_monthly_21_20') {
                    const parts = rangeValue.split(',').map(Number);
                    const [startMonthIndex, endMonthIndex, startYear, endYear] = parts.length === 4 ? parts : [0, 0, selectedYear, selectedYear]; // Fallback jika format salah
                    start = new Date(startYear, startMonthIndex, 21);
                    end = new Date(endYear, endMonthIndex, 20);
                    monthTextList.push(monthSelect.querySelector(`option[value=\"${rangeValue}\"]`).textContent);
                }
                
                if (minStart === null || start < minStart) minStart = start;
                if (maxEnd === null || end > maxEnd) maxEnd = end;
            });

            if (minStart && maxEnd) {
                 minStart.setHours(12, 0, 0, 0);
                 maxEnd.setHours(12, 0, 0, 0);
                 const diffTime = Math.abs(maxEnd - minStart);
                 const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                 
                 return {
                    start: minStart, end: maxEnd,
                    start_str: minStart.toISOString().substring(0, 10),
                    end_str: maxEnd.toISOString().substring(0, 10),
                    text: monthTextList.join('; '),
                    days: diffDays,
                    raw_selected_ranges: selectedRanges 
                };
            }
            return { start: new Date(0), end: new Date(0), start_str: '-', end_str: '-', text: 'Tidak Ada Periode Dipilih', days: 0, raw_selected_ranges: [] };
        }


        window.handleYearChange = function() {
            const periodType = document.getElementById('period_select').value;
            updateMonthRange(periodType, '');
        }
        
        window.handleAvailabilityYearChange = function() {
            const periodType = document.getElementById('avail_period_select').value;
            updateMonthRange(periodType, 'avail_');
        }

        window.handlePeriodChange = function() {
            const periodType = document.getElementById('period_select').value;
            updateMonthRange(periodType, '');
        }
        
        window.handleAvailabilityPeriodChange = function() {
            const periodType = document.getElementById('avail_period_select').value;
            updateMonthRange(periodType, 'avail_');
        }

        // FUNGSI UTILITY: Perbandingan Tanggal yang Aman
        function isDateInPeriod(dateString, startString, endString) {
            const dateTs = getNormalizedTimestamp(dateString);
            const startTs = getNormalizedTimestamp(startString);
            const endTs = getNormalizedTimestamp(endString);
            
            if (!dateTs || !startTs || !endTs) return false;

            // Perform safe integer comparison
            return dateTs >= startTs && dateTs <= endTs;
        }

        // FUNGSI UTILITY: Normalisasi Tanggal ISO ke Timestamp Lokal Midnight
        function getNormalizedTimestamp(isoDateString) {
            if (!isoDateString || isoDateString === '-') return null;
            try {
                // Format: YYYY-MM-DD
                const parts = isoDateString.split('-').map(Number);
                // Use Date(year, monthIndex, day) to force local midnight (0-indexed month)
                const date = new Date(parts[0], parts[1] - 1, parts[2]); 
                if (isNaN(date.getTime())) return null;
                return date.getTime(); 
            } catch (e) {
                return null;
            }
        }


        function getReportingPeriod(periodType, prefix='') {
            const today = new Date();
            today.setHours(12, 0, 0, 0); 
            
            let tgl_awal, tgl_akhir;
            const monthSelect = document.getElementById(`${prefix}filter_month`);
            const yearSelect = document.getElementById(`${prefix}filter_year`);
            const selectedYear = parseInt(yearSelect.value);
            let monthText = monthSelect.options[monthSelect.selectedIndex]?.textContent || "";

            if (periodType === 'calendar_monthly') {
                const selectedMonthIndex = parseInt(monthSelect.value);
                tgl_awal = new Date(selectedYear, selectedMonthIndex, 1);
                tgl_akhir = new Date(selectedYear, selectedMonthIndex + 1, 0); 
            } else if (periodType === 'weekly') {
                tgl_akhir = new Date(today);
                tgl_awal = new Date(today);
                tgl_awal.setDate(tgl_awal.getDate() - 6); 
                monthText = `7 Hari Terakhir`;
            } else if (periodType === 'custom_monthly_21_20') {
                const rangeValue = monthSelect.value;
                const parts = rangeValue.split(',').map(Number);
                const [startMonthIndex, endMonthIndex, startYear, endYear] = parts.length === 4 ? parts : [0, 0, selectedYear, selectedYear];
                
                tgl_awal = new Date(startYear, startMonthIndex, 21);
                tgl_akhir = new Date(endYear, endMonthIndex, 20);
            }
            
            // Fallback jika tidak ada pilihan (khusus untuk mode single select)
            if (monthSelect.options.length === 0) {
                 return { start: new Date(0), end: new Date(0), start_str: '-', end_str: '-', text: 'Tidak Ada Periode Dipilih', days: 0 };
            }

            tgl_awal.setHours(12, 0, 0, 0);
            tgl_akhir.setHours(12, 0, 0, 0);

            const diffTime = Math.abs(tgl_akhir - tgl_awal);
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)) + 1; 

            return {
                start: tgl_awal, end: tgl_akhir,
                start_str: tgl_awal.toISOString().substring(0, 10),
                end_str: tgl_akhir.toISOString().substring(0, 10),
                text: monthText,
                days: diffDays
            };
        }
        
        // FUNGSI CEK HARI LIBUR / MINGGU (Penting untuk Availability)
        function isHolidayOrSunday(dateString) {
            const date = new Date(dateString);
            const day = date.getDay(); // 0 = Minggu
            
            if (day === 0) return true; // Hari Minggu
            if (holidays.includes(dateString)) return true; // Tanggal Merah
            
            return false;
        }
        
        // FUNGSI HITUNG HARI KERJA EFEKTIF
        function countWorkingDays(startDate, endDate) {
            let count = 0;
            let curDate = new Date(startDate);
            curDate.setHours(12,0,0,0);
            let end = new Date(endDate);
            end.setHours(12,0,0,0);

            while (curDate <= end) {
                const dateStr = curDate.toISOString().split('T')[0];
                if (!isHolidayOrSunday(dateStr)) {
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        // FUNGSI CEK HARI LIBUR / MINGGU (Khusus Triputra)
        function isHolidayOrSundayTriputra(dateString) {
            const date = new Date(dateString);
            const day = date.getDay(); // 0 = Minggu
            
            if (day === 0) return true; // Hari Minggu
            if (holidays.includes(dateString)) return true; // Tanggal Merah
            
            return false;
        }

        // FUNGSI HITUNG HARI KERJA EFEKTIF
        function countWorkingDaysTriputra(startDate, endDate) {
            let count = 0;
            let curDate = new Date(startDate);
            curDate.setHours(12,0,0,0);
            let end = new Date(endDate);
            end.setHours(12,0,0,0);

            while (curDate <= end) {
                const dateStr = curDate.toISOString().split('T')[0];
                if (!isHolidayOrSundayTriputra(dateStr)) {
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        window.resetReportFilters = function() {
            document.getElementById('period_select').value = 'custom_monthly_21_20';
            document.getElementById('filter_year').value = new Date().getFullYear();
            updateMonthRange('custom_monthly_21_20', '');
            document.getElementById('filter_month').selectedIndex = 0; 
            document.getElementById('filter_unit').value = 'all';
            document.getElementById('filter_sektor').value = 'all';
            document.getElementById('report_view').value = 'detailed'; 
            document.getElementById('display_view').value = 'both'; 
            document.getElementById('chart_type_select').value = 'bar'; 
            document.getElementById('show_photos').value = 'show'; 
            currentSortOrder = 'desc'; currentSortColumn = 'tanggal';
            window.fetchReportData();
            showToast("Filter Direset", "Filter laporan telah direset ke default.", "info");
        }

        function groupReports(reports, viewType) {
            if (viewType === 'detailed') {
                return { 
                    groupedData: reports.reduce((acc, report) => { 
                        const key = report.tanggal; 
                        if (!acc[key]) { acc[key] = []; } 
                        acc[key].push(report); 
                        return acc; 
                    }, {}), 
                    isGrouped: false, groupingKey: 'Tanggal' 
                };
            }
            const field = viewType === 'summary_unit' ? 'unit' : 'operator';
            const grouped = reports.reduce((acc, report) => {
                const key = report[field];
                if (!acc[key]) { acc[key] = []; }
                acc[key].push(report);
                return acc;
            }, {});
            return { groupedData: grouped, isGrouped: true, groupingKey: field };
        }

        // --- RENDER CHART ---
        function renderChart(groupedData, groupingKey, isGrouped) {
            const container = document.getElementById('chartContainer');
            const reportView = document.getElementById('report_view').value;
            const displayView = document.getElementById('display_view').value;
            const chartType = document.getElementById('chart_type_select').value;
            
            if (reportChart) { reportChart.destroy(); reportChart = null; }
            container.innerHTML = ''; 
            container.classList.remove('pie-mode');
            
            // Perbaikan: Jangan sembunyikan container chart jika mode landscape
            // Logika penyembunyian chart akan ditangani oleh handleDisplayView() yang memanipulasi visibility div laporan
            
            if (!groupedData || Object.keys(groupedData).length === 0) {
                container.innerHTML = '<p style="text-align: center; margin-top: 150px; color: #dc3545;">‚ùå **Tidak ada data laporan** yang tersedia untuk filter/periode ini.</p>';
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.id = 'reportChart';
            container.appendChild(canvas);

            // Pembulatan data chart
            const dataKeys = Object.keys(groupedData);
            const hmData = dataKeys.map(key => Math.round(groupedData[key].reduce((sum, r) => sum + r.jam_operasi, 0)));
            const solarData = dataKeys.map(key => Math.round(groupedData[key].reduce((sum, r) => sum + r.total_solar, 0)));

            const titleLabel = isGrouped ? `Total HM Operasi & Solar per ${groupingKey.toUpperCase()}` : `HM Operasi & Solar Harian`;
            const datalabelsOptions = {
                color: 'black', font: { weight: 'bold', size: 10 },
                formatter: (value) => Math.round(value), // Dibulatkan
                clamp: true, rotation: 0,
            };

            let config = {};
            if (chartType === 'doughnut_hm' || chartType === 'doughnut_solar') {
                if (!isGrouped) {
                    container.innerHTML = '<p style="text-align: center; margin-top: 150px; color: #dc3545;">Jenis Grafik **Pie/Donut** hanya optimal dalam mode **Ringkasan**.</p>';
                    return;
                }
                container.classList.add('pie-mode');
                const isHM = chartType === 'doughnut_hm';
                const chartData = isHM ? hmData : solarData;
                const chartLabel = isHM ? 'Distribusi Jam Operasi (HM)' : 'Distribusi Konsumsi Solar (Ltr)';
                datalabelsOptions.formatter = (value, context) => {
                    const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(0) + '%' : '0%'; // Dibulatkan
                    return `${Math.round(value)} \n (${percentage})`; // Dibulatkan
                };
                datalabelsOptions.color = 'white'; datalabelsOptions.textShadowBlur = 5; datalabelsOptions.textShadowColor = 'black';
                
                config = {
                    type: 'doughnut',
                    data: {
                        labels: dataKeys,
                        datasets: [{
                            label: chartLabel, data: chartData,
                            backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#0dcaf0', '#e83e8c', '#6c757d', '#212529', '#f8f9fa'],
                            hoverOffset: 10, borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' }, title: { display: true, text: `${chartLabel} Periode Ini` }, datalabels: datalabelsOptions } }
                };
            } else { 
                datalabelsOptions.anchor = 'end'; datalabelsOptions.align = 'top';
                config = {
                    type: chartType,
                    data: {
                        labels: dataKeys.map(formatDate), // Format tanggal di label X
                        datasets: [{
                            label: 'Jam Operasi (HM)', data: hmData, backgroundColor: chartType === 'bar' ? 'rgba(13, 110, 253, 0.7)' : 'rgba(13, 110, 253, 1)',
                            borderColor: 'rgba(13, 110, 253, 1)', borderWidth: chartType === 'bar' ? 1 : 3, yAxisID: 'yHM',
                            type: chartType, tension: 0.4, fill: chartType !== 'line',
                        }, {
                            label: 'Konsumsi Solar (Ltr)', data: solarData, backgroundColor: chartType === 'bar' ? 'rgba(255, 193, 7, 0.7)' : 'rgba(255, 193, 7, 1)',
                            borderColor: 'rgba(255, 193, 7, 1)', borderWidth: chartType === 'bar' ? 1 : 3, yAxisID: 'ySolar',
                            type: chartType, tension: 0.4, fill: chartType !== 'line',
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: titleLabel, font: { size: 16 } }, datalabels: datalabelsOptions },
                        scales: {
                            x: {
                                title: { display: true, text: isGrouped ? groupingKey.toUpperCase() : 'Tanggal'}, 
                                grid: { display: false },
                                ticks: {
                                    callback: function(value, index, values) {
                                        // Hanya tampilkan 1 dari 7 label jika data banyak
                                        return (values.length > 30 && index % 7 !== 0) ? null : this.getLabelForValue(value);
                                    }
                                }
                            },
                            yHM: { type: 'linear', position: 'left', title: { display: true, text: 'Jam Operasi (HM)', color: 'rgba(13, 110, 253, 1)'}, min: 0 },
                            ySolar: { type: 'linear', position: 'right', title: { display: true, text: 'Konsumsi Solar (Ltr)', color: 'rgba(255, 193, 7, 1)'}, min: 0, grid: { drawOnChartArea: false } }
                        }
                    }
                };
            }
            reportChart = new Chart(canvas, config);
        }
        
        function togglePhotoColumn() {
            const reportView = document.getElementById('report_view').value;
            if (reportView !== 'detailed') return; 
            const showPhotos = document.getElementById('show_photos').value === 'show';
            const table = document.getElementById('dailyReportTable');
            table.querySelectorAll('.photo-column-header').forEach(th => th.style.display = showPhotos ? 'table-cell' : 'none');
            table.querySelectorAll('.report-photo-cell').forEach(td => td.style.display = showPhotos ? 'table-cell' : 'none');
            const w = '100px';
            table.querySelectorAll('.keterangan-column-header, .report-keterangan').forEach(el => { el.style.width = w; el.style.maxWidth = w; });
        }
        
        function sortReports(reports, column, order) {
            if (document.getElementById('report_view').value !== 'detailed') return reports; 
            const isNumeric = ['jam_operasi', 'total_solar', 'tanggal'].includes(column);
            reports.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (column === 'tanggal') { valA = new Date(a.tanggal); valB = new Date(b.tanggal); }
                else if (isNumeric) { valA = parseFloat(valA); valB = parseFloat(valB); }
                else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); }
                return order === 'asc' ? (valA < valB ? -1 : 1) : (valA > valB ? -1 : 1);
            });
            return reports;
        }

        window.handleSort = function(column) {
            if (document.getElementById('report_view').value !== 'detailed') return alert("Fitur sortir hanya untuk mode Detail.");
            if (currentSortColumn === column) currentSortOrder = (currentSortOrder === 'asc') ? 'desc' : 'asc';
            else { currentSortColumn = column; currentSortOrder = 'desc'; }
            window.fetchReportData();
        }

        function updateSortButtons() {
            document.querySelectorAll('.sort-button').forEach(btn => { btn.textContent = ''; btn.title = 'Sort'; });
            const sortBtn = document.getElementById(`sort-btn-${currentSortColumn}`);
            if (sortBtn) {
                sortBtn.textContent = currentSortOrder === 'asc' ? '‚Üë' : '‚Üì';
                sortBtn.title = `Urutan: ${currentSortOrder}`;
            }
        }
        
        window.handleDisplayView = function() {
            const displayMode = document.getElementById('display_view').value;
            const laporanDiv = document.getElementById('laporan');
            const chartContainer = document.getElementById('chartContainer');
            const tableSection = document.getElementById('tableSection');

            // Reset visibility
            chartContainer.style.display = 'block';
            tableSection.style.display = 'block';
            laporanDiv.classList.remove('chart_only', 'table_only', 'both');
            
            // Set new mode
            laporanDiv.classList.add(displayMode);

            if (displayMode === 'chart_only') {
                tableSection.style.display = 'none';
            } else if (displayMode === 'table_only') {
                chartContainer.style.display = 'none';
            }

            // Re-fetch data if needed (especially for landscape which changes rendering completely)
            const reportView = document.getElementById('report_view').value;
            if (reportView.startsWith('landscape') && (displayMode === 'table_only' || displayMode === 'both')) {
                 // Di mode landscape, chart selalu disembunyikan, tetapi pastikan tabel terlihat
                 chartContainer.style.display = 'none';
                 tableSection.style.display = 'block';
            }
             // Panggil fetchReportData lagi untuk memastikan rendering tabel yang benar di mode landscape
            if (reportView.startsWith('landscape') && displayMode === 'both') {
                 window.fetchReportData();
            }
        }
        
        window.fetchReportData = function() {
            const periodType = document.getElementById('period_select').value;
            const monthSelect = document.getElementById('filter_month');
            let period;
            
            // LOGIKA BARU: Cek apakah multi-select aktif untuk periode bulanan
            if ((periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') && monthSelect.multiple) {
                 period = getMultipleReportingPeriod(periodType, '');
            } else {
                 // Gunakan logika single select/weekly yang lama
                 period = getReportingPeriod(periodType, '');
            }

            const selectedUnitFilter = document.getElementById('filter_unit').value;
            const selectedSektorFilter = document.getElementById('filter_sektor').value;
            const reportView = document.getElementById('report_view').value;
            document.getElementById('export_format').value = ""; 

            // Format tanggal untuk tampilan di halaman
            const periodInfoText = `Periode: ${period.text} (${formatDate(period.start_str)} - ${formatDate(period.end_str)})`;
            document.getElementById('periode-info').textContent = periodInfoText;
            document.getElementById('print-periode-info').textContent = periodInfoText;
            
            let filteredReports = reportsData.filter(report => isDateInPeriod(report.tanggal, period.start_str, period.end_str) );

            // Filter berdasarkan unit
            if (selectedUnitFilter !== 'all') filteredReports = filteredReports.filter(report => report.unit === selectedUnitFilter);
            
            // Filter berdasarkan klasifikasi sektor
            if (selectedSektorFilter !== 'all') filteredReports = filteredReports.filter(report => report.klasifikasi_sektor === selectedSektorFilter);

            const totalHM = filteredReports.reduce((sum, r) => sum + r.jam_operasi, 0);
            const totalSolar = filteredReports.reduce((sum, r) => sum + r.total_solar, 0);
            const totalWorkHour = filteredReports.reduce((sum, r) => sum + r.work_hours, 0);
            
            // Pembulatan KPI
            document.getElementById('total_hm_bulan').textContent = `${Math.round(totalHM)} HM`;
            document.getElementById('total_solar_bulan').textContent = `${Math.round(totalSolar)} Liter`;
            document.getElementById('total_work_hour_bulan').textContent = `${Math.round(totalWorkHour)} Jam`;

            if (reportView.startsWith('landscape')) {
                renderLandscapeReportTable(filteredReports, reportView, period, period.text); 
                // Di mode Landscape, chart selalu disembunyikan, tetapi kita tetap panggil renderChart(null) agar canvas bersih
                renderChart(null, null, false); 
                document.getElementById('show_photos').disabled = true;
                
                // PERBAIKAN: Pastikan tableSection terlihat di mode landscape
                document.getElementById('tableSection').style.display = 'block'; 
                document.getElementById('chartContainer').style.display = 'none';
            } else {
                document.getElementById('show_photos').disabled = false;
                if (reportView === 'detailed') filteredReports = sortReports(filteredReports, currentSortColumn, currentSortOrder);
                const { groupedData, isGrouped, groupingKey } = groupReports(filteredReports, reportView);
                renderChart(groupedData, groupingKey, isGrouped);
                renderReportTable(groupedData, isGrouped, groupingKey);
                updateSortButtons();
                // Pastikan visibilitas mengikuti pilihan display_view
                window.handleDisplayView(); 
            }
        }
        
        // --- FUNGSI RENDER LANDSCAPE (UPDATED: DENGAN WARNA EVENT) ---
function renderLandscapeReportTable(reports, viewType, period, periodName) {
    const table = document.getElementById('dailyReportTable');
    table.innerHTML = ''; table.classList.add('landscape-mode');
    
    if (table.caption) table.removeChild(table.caption);
    const caption = table.createCaption();
    caption.innerHTML = `
        <div style="text-align:center;">
            Laporan Total HM Operasi Harian Periode **${periodName} (${formatDate(period.start_str)} - ${formatDate(period.end_str)})**<br>
            <span style="font-size:10px; font-weight:normal;">
                Legenda: 
                <span style="background:#f8d7da; border:1px solid red; padding:0 5px;">Merah = Breakdown</span> 
                <span style="background:#cff4fc; border:1px solid blue; padding:0 5px;">Biru = Cuaca</span> 
                <span style="background:#fff3cd; border:1px solid orange; padding:0 5px;">Kuning = Idle/No Op</span>
            </span>
        </div>`;
    caption.style.fontWeight = 'bold'; caption.style.padding = '10px 0'; caption.style.color = '#0d6efd';

    const isGroupedByUnit = viewType === 'landscape_unit';
    const groupingKey = isGroupedByUnit ? 'unit' : 'operator';
    const rowLabel = isGroupedByUnit ? 'Unit/Alat' : 'Operator';
    const uniqueKeys = [...new Set(reports.map(r => r[groupingKey]))].sort();
    
    // Generate Array Tanggal
    const dates = [];
    let currentDate = new Date(period.start_str);
    currentDate.setHours(12, 0, 0, 0); 
    const endDate = new Date(period.end_str);
    endDate.setHours(12, 0, 0, 0);

    while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().substring(0, 10));
        currentDate.setDate(currentDate.getDate() + 1);
        currentDate.setHours(12, 0, 0, 0); 
    }
    
    // 1. DATA MAPPING (Termasuk Deteksi Event)
    const dailyDataMap = {}; 
    reports.forEach(report => {
        const key = report[groupingKey]; 
        const date = report.tanggal;
        
        if (!dailyDataMap[key]) dailyDataMap[key] = { min_hm_awal: Infinity, max_hm_akhir: -Infinity, daily: {} };
        
        // Update Min/Max HM untuk Total
        dailyDataMap[key].min_hm_awal = Math.min(dailyDataMap[key].min_hm_awal, report.hm_awal);
        dailyDataMap[key].max_hm_akhir = Math.max(dailyDataMap[key].max_hm_akhir, report.hm_akhir);
        
        // Inisialisasi Data Harian
        if (!dailyDataMap[key].daily[date]) {
            dailyDataMap[key].daily[date] = { 
                total_daily_hm: 0,
                hasBreakdown: false,
                hasWeather: false,
                hasIdle: false
            };
        }
        
        // Tambah HM
        dailyDataMap[key].daily[date].total_daily_hm += report.jam_operasi;

        // --- DETEKSI KATEGORI (PRIORITAS WARNA) ---
        // Gunakan kategori yang tersimpan atau deteksi cerdas
        let cat = report.kategori_keterangan;
        if (!cat || cat === '-' || cat === 'LAIN-LAIN') {
            cat = getKeteranganCategory(report.keterangan);
        }

        if (cat === 'BREAKDOWN') dailyDataMap[key].daily[date].hasBreakdown = true;
        else if (cat === 'CUACA') dailyDataMap[key].daily[date].hasWeather = true;
        else if (cat === 'IDLE_LAIN') dailyDataMap[key].daily[date].hasIdle = true;
    });

    // 2. RENDER HEADER
    let headerHTML = `<thead><tr><th class="landscape-key-column">${rowLabel}</th>`;
    let currentMonth = -1; 
    dates.forEach(date => {
        const d = new Date(date);
        const day = d.getDate();
        const month = d.getMonth();
        const isNewMonth = month !== currentMonth;
        currentMonth = month; 
        let monthInitial = (isNewMonth || day === 1) ? ` (${monthNames[month].charAt(0)})` : '';
        const transitionClass = isNewMonth ? 'month-transition' : '';
        const holidayHeaderClass = isHolidayOrSunday(date) ? 'holiday-column' : '';
        
        headerHTML += `<th class="hm-cell-landscape ${transitionClass} ${holidayHeaderClass}" title="${formatDate(date)}">${day}${monthInitial}</th>`;
    });
    headerHTML += `<th class="total-hm-periode-cell">Total HM</th></tr></thead>`;
    
    // 3. RENDER BODY
    let tableBodyHTML = '<tbody>';
    uniqueKeys.forEach(key => {
        const totalData = dailyDataMap[key];
        let rowHTML = `<tr><td class="landscape-key-column text-left">${key}</td>`;
        
        dates.forEach(date => {
            const dailyReport = totalData.daily[date];
            let cellContent = '-';
            let cellClass = '';
            let toolTip = '';

            // Cek Hari Libur (Default)
            if (isHolidayOrSunday(date)) cellClass = 'holiday-row';

            if (dailyReport) {
                cellContent = Math.round(dailyReport.total_daily_hm);
                
                // --- LOGIKA PEWARNAAN BERDASARKAN PRIORITAS ---
                // Breakdown mengalahkan segalanya (termasuk hari libur)
                if (dailyReport.hasBreakdown) {
                    cellClass = 'land-bd';
                    toolTip = 'Terdapat Breakdown pada hari ini';
                } 
                // Cuaca jika tidak ada breakdown
                else if (dailyReport.hasWeather) {
                    cellClass = 'land-weather';
                    toolTip = 'Terdapat Hambatan Cuaca';
                } 
                // Idle jika tidak ada breakdown/cuaca
                else if (dailyReport.hasIdle) {
                    cellClass = 'land-idle';
                    toolTip = 'Terdapat Idle/Standby';
                }
            }

            rowHTML += `<td class="hm-cell-landscape ${cellClass}" title="${toolTip}">${cellContent}</td>`;
        });

        // Hitung Total HM Periode
        let totalHM = (totalData.max_hm_akhir !== -Infinity && totalData.min_hm_awal !== Infinity) ? (totalData.max_hm_akhir - totalData.min_hm_awal) : 0;
        
        rowHTML += `<td class="total-hm-periode-cell">${Math.round(totalHM)}</td></tr>`;
        tableBodyHTML += rowHTML;
    });
    tableBodyHTML += '</tbody>';
    table.innerHTML = headerHTML + tableBodyHTML;
}
        
window.renderReportTable = function(groupedData, isGrouped, groupingKey) {
    const table = document.getElementById('dailyReportTable');
    table.innerHTML = ''; 
    table.classList.remove('landscape-mode'); 
    
    if (table.caption) table.removeChild(table.caption);
    
    const periodInfoText = document.getElementById('periode-info').textContent;
    const printInfo = document.getElementById('print-periode-info');
    
    if (printInfo) {
        printInfo.textContent = `Tabel Data Laporan - ${periodInfoText.replace('Periode: ', '')}`;
    }

    const headerRow = table.createTHead();
    let headerHTML = '';

    const showPhotos = document.getElementById('show_photos').value === 'show';
    const photoDisplay = showPhotos ? '' : 'display:none;';

    if (isGrouped) {
         headerHTML += `<tr><th style="width: 250px;" class="text-left">${(groupingKey === 'unit') ? 'Unit/Alat' : 'Operator'}</th><th>Total Hari</th><th>Total HM</th><th>Total Jam</th><th>Total Solar</th></tr>`;
    } else {
        // --- PERBAIKAN DISINI: MENAMBAHKAN CHECKBOX PILIH SEMUA DI HEADER ---
        headerHTML += `<tr>
            <th rowspan="2" class="action-column" style="width:80px; text-align:center;">
                Aksi<br>
                <input type="checkbox" onclick="window.toggleSelectAllReports(this)" title="Pilih Semua" style="cursor:pointer;">
            </th>
            <th rowspan="2" class="col-date-report">Tanggal</th>
            <th rowspan="2" class="col-unit-report">Unit/Alat</th>
            <th rowspan="2" class="col-op-report">Operator</th>
            <th rowspan="2" class="col-sektor-report">Sektor</th>
            <th colspan="3">HM</th><th colspan="3">Jam Kerja</th>
            <th rowspan="2" class="col-solar-report">Solar</th>
            <th rowspan="2">Kategori</th>
            <th rowspan="2" class="photo-column-header" style="${photoDisplay}; width:130px;">Dokumentasi</th>
            <th rowspan="2" class="keterangan-column-header">Keterangan</th>
        </tr>
        <tr>
            <th>Awal</th><th>Akhir</th><th>Total</th>
            <th>In</th><th>Out</th><th>Total</th>
        </tr>`;
    }
    headerRow.innerHTML = headerHTML;
    
    let tbodyHTML = 'tbody'; // ... (Lanjutan kode render body tetap sama)
    // ... Pastikan sisa kode di bawahnya tetap ada ...
    
    // (Lanjutan kode render body Anda yang lama...)
    let tbodyElement = document.createElement('tbody');
    const sortedKeys = Object.keys(groupedData).sort((a, b) => new Date(b) - new Date(a));
    
    sortedKeys.forEach(key => {
        const group = groupedData[key];
        if (isGrouped) {
            let tHM=0, tSolar=0, tWork=0;
            group.forEach(r=>{tHM+=r.jam_operasi; tSolar+=r.total_solar; tWork+=r.work_hours;});
            tbodyHTML += `<tr class="group-total-row"><td>${key}</td><td>${group.length}</td><td>${Math.round(tHM)}</td><td>${Math.round(tWork)}</td><td>${Math.round(tSolar)}</td></tr>`;
        } else {
            group.forEach(r => {
                const idx = reportsData.indexOf(r);
                const hmClass = r.jam_operasi >= 8 ? 'hm-high' : 'hm-low';
                const catStyle = r.kategori_keterangan === 'BREAKDOWN' ? 'style="background-color:#f8d7da;color:#721c24;font-weight:bold;"' : '';
                
                let photoHTML = '<span style="color:#ccc;">-</span>';
                if (r.foto_timesheet || r.foto_awal || r.foto_akhir) {
                    photoHTML = `<div class="photo-grid">`;
                    if(r.foto_timesheet && r.foto_timesheet.length > 50) photoHTML += `<img src="${r.foto_timesheet}" title="Timesheet" onclick="window.zoomImage(this.src)">`;
                    if(r.foto_awal && r.foto_awal.length > 50) photoHTML += `<img src="${r.foto_awal}" title="HM Awal" onclick="window.zoomImage(this.src)">`;
                    if(r.foto_akhir && r.foto_akhir.length > 50) photoHTML += `<img src="${r.foto_akhir}" title="HM Akhir" onclick="window.zoomImage(this.src)">`;
                    photoHTML += `</div>`;
                }

                // --- PASTIKAN CHECKBOX PER BARIS JUGA DIRENDER DISINI ---
                tbodyHTML += `<tr>
                    <td class="action-column">
                        <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                            <input type="checkbox" class="report-checkbox" value="${idx}" style="width:16px; height:16px; cursor:pointer;">
                            <button class="action-button edit-report-button" onclick="window.editReport(${idx})">‚úèÔ∏è</button>
                        </div>
                    </td>
                    <td>${formatDate(r.tanggal)}</td>
                    <td class="text-left">${r.unit}</td>
                    <td class="text-left">${r.operator}</td>
                    <td class="text-left">${r.sektor}</td>
                    <td>${r.hm_awal}</td><td>${r.hm_akhir}</td>
                    <td class="${hmClass}">${Math.round(r.jam_operasi)}</td>
                    <td>${r.time_in}</td><td>${r.time_out}</td><td>${Math.round(r.work_hours)}</td>
                    <td>${Math.round(r.total_solar)}</td>
                    <td ${catStyle}>${r.kategori_keterangan}</td>
                    <td class="report-photo-cell" style="${photoDisplay}">
                       ${photoHTML}
                    </td>
                    <td class="text-left">${r.keterangan || '-'}</td>
                </tr>`;
            });
        }
    });
    tbodyHTML += '</tbody>';
    table.innerHTML += tbodyHTML;
}
        window.deleteReport = function(index) {
            if (confirm(`Anda yakin ingin menghapus laporan ini?`)) {
                reportsData.splice(index, 1);
                saveReportsDataToLocalStorage();
                showToast("Dihapus", "Laporan berhasil dihapus.", "success");
                loadMasterDataFromLocalStorage();
                window.fetchReportData();
            }
        }

        window.editReport = function(index) {
            const report = reportsData[index]; if (!report) return;
            updateUnitDropdown(document.getElementById('edit_unit'));
            document.getElementById('editReportIndex').value = index;
            document.getElementById('edit_tanggal').value = report.tanggal;
            document.getElementById('edit_unit').value = report.unit;
            document.getElementById('edit_operator').value = report.operator;
            document.getElementById('edit_sektor').value = report.sektor;
            document.getElementById('edit_time_in').value = (report.time_in === '-' ? '' : report.time_in);
            document.getElementById('edit_time_out').value = (report.time_out === '-' ? '' : report.time_out);
            document.getElementById('edit_hm_awal').value = report.hm_awal;
            document.getElementById('edit_hm_akhir').value = report.hm_akhir;
            document.getElementById('edit_solar').value = report.total_solar;
            document.getElementById('edit_keterangan').value = report.keterangan;
            document.getElementById('editReportModal').style.display = 'block';
        }

window.saveEditedReport = function() {
    // 1. Ambil Index Data yang sedang diedit
    const index = parseInt(document.getElementById('editReportIndex').value);
    
    // 2. Ambil Value dari Input Form (PINDAHKAN KE ATAS)
    const tanggal = document.getElementById('edit_tanggal').value;
    const unit = document.getElementById('edit_unit').value;
    const operator = document.getElementById('edit_operator').value.trim().toUpperCase();
    const sektor = document.getElementById('edit_sektor').value.trim().toUpperCase();
    
    const time_in = document.getElementById('edit_time_in').value;
    const time_out = document.getElementById('edit_time_out').value;
    
    const hm_awal = parseFloat(document.getElementById('edit_hm_awal').value);
    const hm_akhir = parseFloat(document.getElementById('edit_hm_akhir').value);
    
    let total_solar = parseFloat(document.getElementById('edit_solar').value);
    if (isNaN(total_solar)) total_solar = 0;
    
    // Ambil Keterangan (PENTING: Ini harus diambil sebelum dipanggil di fungsi kategori)
    const keterangan = document.getElementById('edit_keterangan').value; 

    // 3. Validasi Input
    if (isNaN(hm_akhir) || isNaN(hm_awal)) return alert("HM Awal dan Akhir harus berupa angka.");
    if (hm_akhir < hm_awal) return alert(`HM Akhir (${hm_akhir}) tidak boleh lebih kecil dari HM Awal (${hm_awal}).`);
    if (!tanggal || !unit || !operator || !sektor) return alert("Data wajib (Tanggal, Unit, Operator, Sektor) belum lengkap.");

    // 4. Hitung Jam Operasi & Work Hours
    const jam_operasi = hm_akhir - hm_awal;

    let work_hours = 0;
    if (time_in && time_out) {
        const [h_in, m_in] = time_in.split(':').map(Number);
        const [h_out, m_out] = time_out.split(':').map(Number);
        let start_time = new Date(0, 0, 0, h_in, m_in);
        let end_time = new Date(0, 0, 0, h_out, m_out);
        if (end_time <= start_time) end_time.setDate(end_time.getDate() + 1); // Handle lintas hari
        work_hours = (end_time - start_time) / (1000 * 60 * 60);
    }

    // 5. Tentukan Kategori & Klasifikasi (SETELAH variabel jam_operasi & keterangan ada)
    const kategori_keterangan = getKeteranganCategory(keterangan, jam_operasi);
    const klasifikasi_sektor = getSektorClassification(sektor);
    
    // Ambil model unit dari master data jika ada, atau gunakan yang lama
    const model = masterUnits[unit] ? masterUnits[unit].model_default : (reportsData[index].model || "-");

    // 6. Update Data di Array Global
    reportsData[index] = { 
        ...reportsData[index], // Pertahankan data lama (seperti foto)
        tanggal, 
        unit, 
        model, 
        operator, 
        sektor, 
        klasifikasi_sektor,
        time_in: time_in || '-', 
        time_out: time_out || '-', 
        work_hours,
        hm_awal, 
        hm_akhir, 
        jam_operasi,
        total_solar, 
        keterangan,
        kategori_keterangan
    };
    
    // 7. Simpan ke LocalStorage & Refresh Tampilan
    saveReportsDataToLocalStorage();
    
    // Tutup Modal
    document.getElementById('editReportModal').style.display = 'none';
    
    showToast("Sukses", `Data ${unit} berhasil diperbarui.`, "success");
    
    // Refresh Table
    window.fetchReportData();
    
    // Refresh Analisa Ketersediaan jika tab sedang aktif
    if(document.getElementById('analisa_ketersediaan').classList.contains('active')) {
        window.fetchAvailabilityData();
    }
}

        // --- FUNGSI UTILITY UNTUK EXCEL EXPORT (DIBUTUHKAN UNTUK MULTI-SHEET LOGIC) ---
        function formatReportDataToAoA(reports, reportView, groupingKey) {
            const AoA = [];
            
            if (reportView === 'detailed') {
                
                reports.forEach(report => {
                    AoA.push([
                        formatDate(report.tanggal), report.unit, report.model, report.operator, report.sektor,
                        report.klasifikasi_sektor, report.time_in, report.time_out, Math.round(report.work_hours), // Pembulatan
                        report.hm_awal, report.hm_akhir, Math.round(report.jam_operasi), // Pembulatan
                        Math.round(report.total_solar), // Pembulatan
                        report.kategori_keterangan, report.keterangan
                    ]);
                });
                
            } else if (reportView.startsWith('summary')) {
                const groupedData = reports.reduce((acc, report) => {
                    const key = report[groupingKey];
                    if (!acc[key]) { acc[key] = { count: 0, hm: 0, work: 0, solar: 0 }; }
                    acc[key].count++;
                    acc[key].hm += report.jam_operasi;
                    acc[key].work += report.work_hours;
                    acc[key].solar += report.total_solar;
                    return acc;
                }, {});
                
                const groupingLabel = (groupingKey === 'unit') ? 'Unit/Alat' : 'Operator';
                AoA.push([groupingLabel, 'Total Hari Kerja', 'Total HM Op.', 'Total Jam Kerja', 'Total Solar (Ltr)']);
                
                Object.keys(groupedData).sort().forEach(key => {
                    const data = groupedData[key];
                    AoA.push([
                        key,
                        data.count,
                        Math.round(data.hm), // Pembulatan
                        Math.round(data.work), // Pembulatan
                        Math.round(data.solar) // Pembulatan
                    ]);
                });
                
            } else if (reportView.startsWith('landscape')) {
                 // Tidak didukung di mode AoA
                 AoA.push(["Format Landscape tidak didukung di mode Multi-Sheet/AoA. Silakan gunakan Export ke XLSX (Excel, Ber-Border) untuk format HTML."]);
            }
            
            return AoA;
        }

        // **FUNGSI BARU: Export Multi-Sheet XLSX (dengan warna header & tabel per unit)**
        function exportMultiSheetXLSX(reports, periodType) {
            const wb = XLSX.utils.book_new();
            const reportView = document.getElementById('report_view').value;
            const monthSelect = document.getElementById('filter_month');
            const selectedRanges = Array.from(monthSelect.selectedOptions).map(option => option.value);

            let hasData = false;
            const globalHeader = [
                'Tanggal', 'Unit/Alat', 'Model Unit', 'Operator', 'Sektor Kerja', 
                'Klasifikasi Sektor', 'Jam Masuk', 'Jam Keluar', 'Total Jam Kerja', 
                'HM Awal', 'HM Akhir', 'Jam Operasi', 'Total Solar (Ltr)', 
                'Kategori Keterangan', 'Keterangan'
            ];
            
            // Definisikan Style Border
            const borderStyle = {
                top: { style: "thin", color: { auto: 1 } },
                bottom: { style: "thin", color: { auto: 1 } },
                left: { style: "thin", color: { auto: 1 } },
                right: { style: "thin", color: { auto: 1 } }
            };

            // Definisikan Style Fill Hari Minggu/Libur
            const holidayFill = { fgColor: { rgb: "FDE8E9" } }; // Merah muda lembut
            
            // Logika Grup berdasarkan BULAN untuk membuat SHEETS
            selectedRanges.forEach(rangeValue => {
                const parts = rangeValue.split(',').map(Number);
                let startMonthIndex, endMonthIndex, startYear, endYear;
                
                if (periodType === 'calendar_monthly') {
                    startMonthIndex = endMonthIndex = parts[0];
                    startYear = endYear = parseInt(document.getElementById('filter_year').value);
                } else { 
                    [startMonthIndex, endMonthIndex, startYear, endYear] = parts;
                }
                
                const reportsForThisRange = reports.filter(report => {
                    let startDate = new Date(startYear, startMonthIndex, periodType === 'custom_monthly_21_20' ? 21 : 1);
                    let endDate = new Date(endYear, endMonthIndex, periodType === 'custom_monthly_21_20' ? 20 : (new Date(endYear, endMonthIndex + 1, 0)).getDate());
                    
                    startDate.setHours(12, 0, 0, 0); 
                    endDate.setHours(12, 0, 0, 0);

                    return isDateInPeriod(report.tanggal, startDate.toISOString().substring(0, 10), endDate.toISOString().substring(0, 10));
                });
                
                if (reportsForThisRange.length > 0) {
                    const sheetName = monthSelect.querySelector(`option[value="${rangeValue}"]`).textContent.replace(/\s+/g, '_').substring(0, 30);
                    
                    // Kelompokkan data bulan ini berdasarkan Unit
                    const groupedByUnit = reportsForThisRange.reduce((acc, report) => {
                        const key = report.unit;
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(report);
                        return acc;
                    }, {});

                    let wsData = [];
                    let rowCount = 0;
                    
                    // BARU: Tambahkan Judul di Awal Sheet
                    const periodText = monthSelect.querySelector(`option[value="${rangeValue}"]`).textContent;
                    wsData.push([`Laporan Harian Operasi (DOR)`]);
                    wsData.push([`Periode: ${periodText}`]);
                    wsData.push([]); 
                    rowCount += 3;

                    // Gabungkan tabel per unit dengan pemisah
                    Object.keys(groupedByUnit).sort().forEach(unitKey => {
                        const unitReports = groupedByUnit[unitKey];
                        
                        // Row 1: Header Unit
                        const unitHeaderRow = [`Laporan Unit/Model: ${unitReports[0].unit} (${unitReports[0].model})`];
                        wsData.push(unitHeaderRow);
                        rowCount++;
                        
                        wsData.push([]); // Baris Kosong 1
                        rowCount++;

                        // Row 2: Header Kolom
                        const headerStartRow = rowCount;
                        wsData.push(globalHeader); 
                        rowCount++;
                        
                        // Baris Data
                        unitReports.forEach(report => {
                            const jamOp = report.jam_operasi;
                            
                            // Tentukan warna baris: Merah Muda jika Jam Operasi < 7
                            let rowFill = (jamOp < 7.0) ? { fgColor: { rgb: "FDE8E9" } } : null; // Merah muda
                            
                            // BARU: Overwrite jika Hari Minggu/Libur (Hanya pada mode Landscape)
                            // Catatan: Pada Multi-Sheet Export ini, kita tidak tahu view mana yang ingin di-print.
                            // Kita asumsikan mode ini mengikuti logika detail/summary, jadi kita biarkan warna Hari Libur OFF kecuali HM Rendah yang ditandai.

                            if (isHolidayOrSunday(report.tanggal) && reportView.startsWith('landscape')) {
                                rowFill = holidayFill;
                            }
                            
                            wsData.push([
                                formatDate(report.tanggal), report.unit, report.model, report.operator, report.sektor,
                                report.klasifikasi_sektor, report.time_in, report.time_out, Math.round(report.work_hours), // Pembulatan
                                report.hm_awal, report.hm_akhir, Math.round(report.jam_operasi), // Pembulatan
                                Math.round(report.total_solar), // Pembulatan
                                report.kategori_keterangan, report.keterangan
                            ]);
                            rowCount++;
                        });
                        wsData.push([]); // Baris Kosong 2
                        wsData.push([]); // Baris Kosong 3 (Pemisah)
                        rowCount += 2;
                    });

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    
                    // Beri Style (Warna, Border, Merging)
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    let currentUnitHeaderRow = -1;
                    
                    // BARU: Merge Judul Awal
                    ws["!merges"] = ws["!merges"] || [];
                    ws["!merges"].push({ s: { r: 0, c: range.s.c }, e: { r: 0, c: globalHeader.length - 1 } });
                    ws["!merges"].push({ s: { r: 1, c: range.s.c }, e: { r: 1, c: globalHeader.length - 1 } });
                    
                    
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        const rowData = wsData[R];

                        // Cek apakah ini Baris Judul Laporan/Periode
                        if (R === 0 || R === 1) {
                            for (let C = range.s.c; C <= globalHeader.length - 1; ++C) {
                                  const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                                  if (!ws[cellRef]) ws[cellRef] = {t:'s', v:''}; 
                                  ws[cellRef].s = { 
                                      fill: { fgColor: { rgb: "F0F7FF" } }, // Biru muda lembut
                                      font: { bold: true, size: 12 },
                                      alignment: { wrapText: true, vertical: "center", horizontal: "left" }
                                  }; 
                            }
                        }
                        
                        // Cek apakah ini Baris Header Unit
                         else if (rowData && rowData.length > 0 && String(rowData[0]).startsWith('Laporan Unit/Model:')) {
                              currentUnitHeaderRow = R;
                              for (let C = range.s.c; C <= globalHeader.length - 1; ++C) {
                                  const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                                  if (!ws[cellRef]) ws[cellRef] = {t:'s', v:''}; 
                                  ws[cellRef].s = { 
                                      fill: { fgColor: { rgb: "FFFFE0" } }, // Kuning Muda untuk Unit Header
                                      border: borderStyle 
                                  }; 
                              }
                              // Merge baris Unit
                              ws["!merges"].push({ s: { r: R, c: range.s.c }, e: { r: R, c: globalHeader.length - 1 } });

                         } 
                         
                         // Cek apakah ini Baris Header Kolom (Baris setelah baris kosong)
                         else if (rowData && rowData[0] === 'Tanggal') {
                            for (let C = range.s.c; C < globalHeader.length; ++C) {
                                const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                                if (ws[cellRef]) {
                                    ws[cellRef].s = { 
                                        fill: { fgColor: { rgb: "404040" } }, // Abu Gelap
                                        font: { color: { rgb: "FFFFFF" }, bold: true },
                                        alignment: { wrapText: true, vertical: "center", horizontal: "center" },
                                        border: borderStyle
                                    };
                                }
                            }
                         }
                         
                         // Cek apakah ini Baris Data
                         else if (rowData && rowData.length > 1 && rowData[0] !== '') {
                            // Cek Jam Operasi (kolom 'Jam Operasi' ada di indeks 11)
                            const jamOp = parseFloat(rowData[11]);
                            
                            // BARU: Tentukan Fill (Hari Libur/Minggu atau HM Rendah)
                            const isHoliday = isHolidayOrSunday(rowData[0]); 
                            // Terapkan holidayFill hanya jika mode landscape (walaupun tidak akan sampai sini, ini untuk konsistensi)
                            let rowFill = (isHoliday && reportView.startsWith('landscape')) ? holidayFill : ((jamOp < 7.0 && !isNaN(jamOp)) ? { fgColor: { rgb: "FDE8E9" } } : null);

                            for (let C = range.s.c; C < globalHeader.length; ++C) {
                                const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                                if (ws[cellRef]) {
                                    ws[cellRef].s = { 
                                        border: borderStyle,
                                        fill: rowFill,
                                        alignment: { vertical: "center" }
                                    };
                                    // Pengecualian: kolom Keterangan (indeks 14) 
                                    if (C === 14) {
                                        ws[cellRef].s.alignment.wrapText = true;
                                    }
                                }
                            }
                         }
                    }

                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    hasData = true;
                }
            });

            if (hasData) {
                XLSX.writeFile(wb, `DOR_Export_Multi_Sheet_${new Date().toISOString().slice(0, 10)}.xlsx`);
                showToast("Export Sukses", `Berhasil membuat ${wb.SheetNames.length} sheet Excel.`, "success");
            } else {
                showToast("Gagal", "Tidak ada data yang cocok dengan filter untuk diekspor.", "error");
            }
        }
        
        function generateExcelTable(reports, reportView, periodInfo) {
            // **Logika ini hanya untuk Export CSV (Format HTML/XLS lama)**
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:8px;text-align:center;font-size:11px;}th{background-color:#212529;color:white;font-weight:bold;}.group-total-row th,.group-total-row td{background-color:#f0f8ff;font-weight:bold;}.text-left{text-align:left;}.total-hm-periode-cell{background-color:#198754;color:white;font-weight:bold;} .holiday-sunday-print { background-color: #fde8e9; }/* --- UPDATE CSS FOTO & PREVIEW --- */
.report-photo-cell {
    width: 120px !important;
    min-width: 120px;
    padding: 5px !important;
    text-align: center;
}

/* Container untuk tombol upload dan preview di Input Form */
.file-upload-container {
    margin-bottom: 5px;
    display: inline-block;
}

/* Wrapper Preview Foto (Kotak Kecil di Input) */
.file-preview-wrapper {
    width: 50px;
    height: 50px;
    margin: 0 auto;
    border: 1px solid #ccc;
    border-radius: 4px;
    overflow: hidden;
    background-color: #f8f9fa;
    display: flex; /* Penting untuk centering */
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

.file-preview-mini {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Foto di Tabel Laporan */
.photo-grid {
    display: flex;
    justify-content: center;
    gap: 5px;
}
.photo-grid img {
    width: 35px;
    height: 35px;
    object-fit: cover;
    border: 1px solid #999;
    border-radius: 3px;
    cursor: zoom-in;
    transition: transform 0.2s;
}
.photo-grid img:hover {
    transform: scale(2);
    z-index: 99;
    position: relative;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
/* ============================================== */
    /* === CSS VISUALISASI KATEGORI (RINCI BANGET) === */
    /* ============================================== */

    /* 1. Styling Sel Kategori (MA/PA & Laporan) */
    
    /* KATEGORI BREAKDOWN (Merah - Kritis) */
    /* Digunakan untuk sel yang terdeteksi kerusakan/mekanik */
    .cat-breakdown, td[style*="background-color:#f8d7da"] {
        background-color: #f8d7da !important; /* Latar Merah Muda */
        color: #721c24 !important;            /* Teks Merah Gelap */
        font-weight: bold;
        border-bottom: 1px solid #f5c6cb !important;
        position: relative;
    }
    /* Tambahkan garis tebal di kiri agar mencolok */
    .cat-breakdown::before, td[style*="background-color:#f8d7da"]::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        background-color: #dc3545; /* Garis Merah Tebal */
    }

    /* KATEGORI CUACA (Biru - Lingkungan) */
    /* Digunakan untuk Hujan/Licin */
    .cat-cuaca, td[style*="background-color:#e2f0fb"] {
        background-color: #cff4fc !important; /* Latar Biru Muda */
        color: #055160 !important;            /* Teks Biru Gelap */
        font-weight: 600;
        position: relative;
    }
    .cat-cuaca::before, td[style*="background-color:#e2f0fb"]::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        background-color: #0dcaf0; /* Garis Biru Cyan */
    }

    /* KATEGORI IDLE LAIN (Kuning - Warning) */
    /* Digunakan untuk Antri/Tunggu/No Operator */
    .cat-idle, td[style*="background-color:#fff3cd"] {
        background-color: #fff3cd !important; /* Latar Kuning Muda */
        color: #856404 !important;            /* Teks Coklat/Emas Gelap */
        font-weight: 600;
        position: relative;
    }
    .cat-idle::before, td[style*="background-color:#fff3cd"]::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        background-color: #ffc107; /* Garis Kuning Emas */
    }

    /* 2. Styling Badge Keterangan (Agar teks panjang terlihat rapi) */
    .keterangan-badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 10.5px;
        font-family: 'Consolas', 'Monaco', monospace; /* Font ala koding agar rapi */
        border-radius: 12px; /* Sudut membulat */
        background-color: #fff;
        border: 1px solid #ced4da;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        color: #495057;
        
        /* Truncate teks panjang */
        max-width: 140px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        vertical-align: middle;
        transition: all 0.2s ease;
    }

    /* Efek Hover: Tampilkan teks penuh saat mouse diarahkan */
    .keterangan-badge:hover {
        max-width: none;
        position: relative;
        z-index: 100;
        background-color: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        border-color: #0d6efd;
        cursor: help;
        transform: scale(1.05);
    }
    
    /* 3. Perbaikan Tampilan Tabel Analisa */
    #availabilityReportTable td {
        vertical-align: middle;
    }
    
    /* Highlight kolom Total Breakdown agar mata langsung tertuju ke masalah */
    #availabilityReportTable td:nth-child(4) { 
        font-size: 1.05em; /* Sedikit lebih besar */
    }/* ================================================== */
    /* === CSS KHUSUS LANDSCAPE MODE (EVENT MARKER) === */
    /* ================================================== */

    /* Prioritas 1: Breakdown (Merah) */
    .land-bd {
        background-color: #f8d7da !important;
        color: #721c24 !important;
        font-weight: bold;
        border: 2px solid #f5c6cb !important; /* Border tebal agar beda dgn hari libur */
    }

    /* Prioritas 2: Cuaca (Biru) */
    .land-weather {
        background-color: #cff4fc !important;
        color: #055160 !important;
        border: 1px solid #9eeaf9 !important;
    }

    /* Prioritas 3: Idle Lain (Kuning) */
    .land-idle {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border: 1px solid #ffe69c !important;
    }

    /* Tooltip sederhana saat hover di sel landscape */
    .hm-cell-landscape:hover {
        cursor: help;
        filter: brightness(0.95);
    }/* === CSS ABSENSI === */
    .abs-cell {
        font-weight: bold;
        font-size: 11px;
        width: 35px !important;
        text-align: center;
        cursor: default;
    }
    
    /* Warna Status */
    .st-h { background-color: #d1e7dd; color: #0f5132; } /* H - Hadir (Hijau) */
    .st-sbd { background-color: #f8d7da; color: #842029; } /* SBD - Breakdown (Merah) */
    .st-sh { background-color: #cff4fc; color: #055160; } /* SH - Hujan (Biru) */
    .st-stb { background-color: #fff3cd; color: #664d03; } /* Stb - Standby (Kuning) */
    .st-i { background-color: #cfe2ff; color: #084298; } /* I - Izin (Biru Tua) */
    .st-pc { background-color: #e2e3e5; color: #41464b; } /* PC - Pulang Cepat (Abu) */
    .st-x { background-color: #212529; color: #fff; }    /* X - Resign (Hitam) */
    .st-a { background-color: #ffffff; color: #dc3545; border: 1px dashed #dc3545; } /* A - Alpha (Putih Border Merah) *//* ========================================= */
    /* === CSS KHUSUS TABEL ABSENSI (LANDSCAPE) === */
    /* ========================================= */
    
    /* Container agar bisa di-scroll ke samping (Landscape) */
    .attendance-scroll-container {
        overflow-x: auto;
        max-width: 100%;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background: #fff;
        max-height: 75vh; /* Batasi tinggi agar header sticky jalan */
        position: relative;
    }

    #attendanceTable {
        width: max-content; /* Paksa tabel melebar sesuai konten */
        border-collapse: separate; /* Penting untuk sticky header */
        border-spacing: 0;
        min-width: 100%;
    }

    #attendanceTable th, #attendanceTable td {
        border: 1px solid #dee2e6;
        padding: 8px;
        text-align: center;
        font-size: 11px;
        vertical-align: middle;
    }

    /* Sticky Header (Tanggal di atas selalu terlihat) */
    #attendanceTable thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }

    /* Sticky Kolom Nama (Nama Karyawan diam saat geser ke kanan) */
    #attendanceTable th:first-child, 
    #attendanceTable td:first-child {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 12; /* Lebih tinggi dari sel biasa */
        border-right: 2px solid #ced4da;
        min-width: 180px;
        max-width: 180px;
        text-align: left;
        padding-left: 10px;
    }
    
    /* Fix z-index untuk header nama (pojok kiri atas) */
    #attendanceTable thead th:first-child {
        z-index: 15;
        background-color: #6f42c1 !important; /* Warna ungu Triputra/Absen */
        color: white;
    }

    /* --- WARNA KODE ABSENSI --- */
    /* === UPDATE WARNA ABSENSI === */
/* === UPDATE WARNA ABSENSI (FULL DETAILED) === */

/* 1. Hadir (Biru Muda) */
.st-h { background-color: #e3f2fd; color: #0d47a1; font-weight: bold; border: 1px solid #90caf9; }

/* 2. Breakdown & Service (Kuning) */
.st-sbd { background-color: #fff3cd; color: #856404; font-weight: bold; border: 1px solid #ffeeba; }
.st-ss  { background-color: #fff3cd; color: #856404; font-weight: bold; border: 1px solid #ffeeba; } /* Sama Kuning */

/* 3. Sakit, Izin, Pulang Cepat (Pink) */
.st-s   { background-color: #f8d7da; color: #721c24; font-weight: bold; border: 1px solid #f5c6cb; }
.st-i   { background-color: #f8d7da; color: #721c24; font-weight: bold; border: 1px solid #f5c6cb; }
.st-pc  { background-color: #f8d7da; color: #721c24; font-weight: bold; border: 1px solid #f5c6cb; }

/* 4. OFF & Cuti (Orange) */
.st-off { background-color: #fd7e14; color: #fff; font-weight: bold; border: 1px solid #e67700; }
.st-ct  { background-color: #fd7e14; color: #fff; font-weight: bold; border: 1px solid #e67700; }

/* 5. Alpha (Merah) */
.st-a   { background-color: #dc3545; color: #fff; font-weight: bold; border: 1px solid #b02a37; }

/* 6. Resign (Putih/Abu) */
.st-x   { background-color: #fff; color: #000; font-weight: bold; border: 1px solid #ced4da; }

/* 7. Standby Lain/Hujan (Default Hijau Pucat) */
.st-sh  { background-color: #d1e7dd; color: #0f5132; font-weight: bold; border: 1px solid #badbcc; }
.st-stb { background-color: #d1e7dd; color: #0f5132; font-weight: bold; border: 1px solid #badbcc; }/* === WARNA PERSENTASE KEHADIRAN === */
/* 100% - Hijau */
.pct-high { background-color: #198754; color: #fff; font-weight: bold; border: 1px solid #198754; }

/* 95% s/d 99.9% - Orange */
.pct-med { background-color: #fd7e14; color: #fff; font-weight: bold; border: 1px solid #fd7e14; }

/* < 95% - Merah */
.pct-low { background-color: #dc3545; color: #fff; font-weight: bold; border: 1px solid #dc3545; }/* [BARU] CSS UNTUK TRACKING BA */
.tracking-stepper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    padding: 5px 0;
}

.tracking-step {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background-color: #e9ecef;
    border: 2px solid #ced4da;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    color: #6c757d;
    position: relative;
    z-index: 2;
    cursor: pointer;
    transition: all 0.2s;
}

.tracking-step.active {
    background-color: #198754;
    border-color: #198754;
    color: white;
    transform: scale(1.1);
}

.tracking-step.current {
    background-color: #d63384; /* Warna Pink Utama */
    border-color: #d63384;
    color: white;
    box-shadow: 0 0 5px rgba(214, 51, 132, 0.5);
    transform: scale(1.2);
}

/* Garis penghubung */
.stepper-line {
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #ced4da;
    z-index: 1;
    transform: translateY(-50%);
}

.step-label {
    position: absolute;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    width: 70px;
    text-align: center;
    line-height: 1.1;
    color: #555;
}

.update-btn-group {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 5px;
}
/* [BARU] Warna-warni Status Tracking */
.badge-status {
    padding: 5px 10px;
    border-radius: 15px;
    font-weight: bold;
    font-size: 10px;
    display: inline-block;
    text-transform: uppercase;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Status Normal (Proses) */
.st-proses { background-color: #e2e3e5; color: #41464b; border: 1px solid #d3d6d8; }
.st-ho { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; } /* On Process HO */
.st-kirim { background-color: #fff3cd; color: #856404; border: 1px solid #ffecb5; } /* Dokumen Proses Kirim */

/* Status Sukses */
.st-ready { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; } /* Ready Kirim */
.st-done { background-color: #198754; color: #fff; border: 1px solid #198754; } /* Diterima Vendor */

/* Status Masalah/Revisi */
.st-warn { background-color: #ffc107; color: #000; border: 1px solid #d39e00; } /* Pemeriksaan Kembali */
.st-danger { background-color: #dc3545; color: #fff; border: 1px solid #b02a37; } /* Reject/Dokumen Bermasalah */
.st-retur { background-color: #fd7e14; color: #fff; border: 1px solid #fd7e14; } /* Retur */    

/* ========================================= */
/* === CSS KHUSUS TRACKING BA (TIMELINE) === */
/* ========================================= */

/* Tampilan Detail Resi (Timeline Vertikal) */
.timeline-container {
    position: relative;
    padding: 20px 0;
    margin-left: 20px;
    border-left: 2px solid #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 25px;
    padding-left: 30px;
}

/* Titik Bulat di Garis */
.timeline-dot {
    position: absolute;
    left: -9px; /* Adjust agar pas tengah garis */
    top: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #fff;
    border: 3px solid #ced4da;
    z-index: 2;
}

.timeline-item.latest .timeline-dot {
    background-color: #d63384;
    border-color: #d63384;
    box-shadow: 0 0 0 4px rgba(214, 51, 132, 0.2);
}

/* Konten Kartu Timeline */
.timeline-content {
    background-color: #fff;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    position: relative;
}

.timeline-item.latest .timeline-content {
    border-left: 4px solid #d63384;
}

.timeline-date {
    font-size: 11px;
    color: #6c757d;
    margin-bottom: 5px;
    display: block;
}

.timeline-status {
    font-size: 14px;
    font-weight: bold;
    color: #212529;
    margin-bottom: 5px;
}

.timeline-notes {
    font-size: 12px;
    color: #495057;
    background: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
    margin-top: 5px;
}

/* Tombol Aksi Kecil di Timeline */
.timeline-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    opacity: 0.6;
    transition: opacity 0.2s;
}
.timeline-content:hover .timeline-actions { opacity: 1; }

.btn-icon-small {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
}
.btn-icon-small:hover { transform: scale(1.2); }

/* === CSS PRINT KHUSUS TRACKING BA (CLEAN TABLE ONLY) === */
@media print {
    /* 1. Sembunyikan SEMUA elemen body secara default */
    body * {
        visibility: hidden;
    }

    /* 2. Tampilkan Container Tracking dan anak-anaknya */
    #tracking_ba, 
    #tracking_ba * {
        visibility: visible;
    }

    /* 3. Sembunyikan elemen UI yang mengganggu di dalam #tracking_ba */
    #tracking_ba .kpi-cards, 
    #tracking_ba .filter-controls, 
    #tracking_ba form, 
    #tracking_ba h2, /* Judul H2 bawaan tab disembunyikan, ganti pakai print-header */
    #tracking_ba p,
    #tracking_ba .action-column, /* Kolom Aksi */
    #tracking_ba button,
    #tracking_ba .hide-on-print {
        display: none !important;
    }

    /* 4. Tampilkan Header Khusus Print */
    #tracking-print-header,
    #tracking-print-header * {
        visibility: visible !important;
        display: block !important;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        text-align: center;
    }

    /* 5. Atur Posisi Tabel agar naik ke atas */
    #trackingTableContainer {
        position: absolute;
        left: 0;
        top: 100px; /* Beri jarak untuk header */
        width: 100%;
        margin: 0;
        padding: 0;
    }

    /* 6. Formatting Tabel Cetak */
    table {
        width: 100% !important;
        border-collapse: collapse !important;
        font-size: 10px !important;
        font-family: Arial, sans-serif !important;
    }
    
    th, td {
        border: 1px solid #000 !important;
        padding: 4px !important;
        color: #000 !important;
    }

    th {
        background-color: #ddd !important; /* Abu muda hemat tinta */
        -webkit-print-color-adjust: exact;
    }

    /* Hilangkan warna background baris status agar hemat tinta */
    tr {
        background-color: transparent !important;
    }
    
    /* Ubah badge status jadi teks biasa */
    .badge-status {
        border: none !important;
        background: none !important;
        padding: 0 !important;
        color: #000 !important;
        font-weight: normal !important;
    }
}
/* CSS UNTUK MODULE FUEL */
#fuel-print-area { display: none; }

/* TAMBAHKAN ATAU GANTI CSS INI DI BAGIAN STYLE */

/* Sembunyikan area print fuel secara default di layar */
#fuel-print-area { display: none; }

@media print {
    /* Saat Mode Print Fuel Aktif */
    body.print-fuel-mode {
        background-color: white !important;
        height: auto !important;
        overflow: visible !important;
    }

    /* Sembunyikan SEMUA elemen body saat mode ini aktif */
    body.print-fuel-mode * { 
        visibility: hidden; 
    }
    
    /* Hanya tampilkan area print fuel */
    body.print-fuel-mode #fuel-print-area, 
    body.print-fuel-mode #fuel-print-area * {
        visibility: visible;
    }

    body.print-fuel-mode #fuel-print-area {
        display: block !important;
        position: absolute;
        top: 0; 
        left: 0; 
        width: 100%;
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        color: #333;
    }

    /* Paksa cetak background color (agar warna biru tabel muncul) */
    body.print-fuel-mode {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    /* Hapus margin halaman default browser jika perlu */
    @page {
        margin: 10mm;
        size: A4 landscape; /* Rekomendasi Landscape untuk tabel lebar */
    }
}

</style></head><body><h2>Laporan Harian Operasi (DOR)</h2><p>${periodInfo}</p><table>`;
            
            if (reportView === 'detailed') {
                // BARU: Caption
                html += `<caption>Tabel Data Laporan - **${periodInfo.replace('Periode: ', '')}**</caption>`;
                html += `<thead><tr><th rowspan="2">Tanggal</th><th rowspan="2">Unit/Alat</th><th rowspan="2">Operator</th><th rowspan="2">Sektor Kerja (Klasifikasi)</th><th colspan="3">Hour Meter (HM)</th><th colspan="3">Timesheet / Jam Kerja</th><th rowspan="2">Total Solar (Ltr)</th><th rowspan="2">KATEGORI</th><th rowspan="2">Keterangan</th></tr><tr><th>HM Awal</th><th>HM Akhir</th><th>Jam Operasi</th><th>Jam Masuk</th><th>Jam Keluar</th><th>Total Jam</th></tr></thead><tbody>`;
                reports.forEach(report => {
                    const hmClass = report.jam_operasi >= 8 ? 'style="background-color:#d4edda;"' : 'style="background-color:#f8d7da;"';
                    const categoryCell = report.kategori_keterangan === 'BREAKDOWN' ? 'style="background-color:#f8d7da; font-weight:bold;"' : '';
                    
                    // PENANDAAN HARI MINGGU/LIBUR DIHAPUS DARI MODE DETAIL SESUAI REQUEST
                    const holidayClass = ''; 

                    // Pembulatan
                    html += `<tr ${holidayClass}><td>${formatDate(report.tanggal)}</td><td class="text-left">${report.unit} (${report.model})</td><td class="text-left">${report.operator}</td><td class="text-left">${report.sektor} (${report.klasifikasi_sektor})</td><td>${report.hm_awal}</td><td>${report.hm_akhir}</td><td ${hmClass}>${Math.round(report.jam_operasi)}</td><td>${report.time_in}</td><td>${report.time_out}</td><td>${Math.round(report.work_hours)}</td><td>${Math.round(report.total_solar)}</td><td ${categoryCell}>${report.kategori_keterangan}</td><td class="text-left">${report.keterangan || '-'}</td></tr>`;
                });
            } else if (reportView.startsWith('summary')) { 
                const { groupedData, groupingKey } = groupReports(reports, reportView); 
                const groupingLabel = (groupingKey === 'unit') ? 'Unit/Alat' : 'Operator';
                html += `<thead><tr class="group-total-row"><th class="text-left">${groupingLabel}</th><th>Total Hari</th><th>Total HM</th><th>Total Jam</th><th>Total Solar</th></tr></thead><tbody>`;
                Object.keys(groupedData).sort().forEach(groupKey => {
                    const reportsInGroup = groupedData[groupKey];
                    let groupHMAgg = 0, groupSolarAgg = 0, groupWorkHoursAgg = 0;
                    reportsInGroup.forEach(r => { groupHMAgg += r.jam_operasi; groupSolarAgg += r.total_solar; groupWorkHoursAgg += r.work_hours; });
                    // Pembulatan Summary
                    html += `<tr class="group-total-row"><td class="text-left">${groupKey}</td><td>${reportsInGroup.length}</td><td>${Math.round(groupHMAgg)}</td><td>${Math.round(groupWorkHoursAgg)}</td><td>${Math.round(groupSolarAgg)}</td></tr>`;
                });
           } else if (reportView.startsWith('landscape')) {
                const period = getReportingPeriod(document.getElementById('period_select').value);
                const isGroupedByUnit = reportView === 'landscape_unit';
                const groupingKey = isGroupedByUnit ? 'unit' : 'operator';
                const rowLabel = isGroupedByUnit ? 'Unit/Alat' : 'Operator';
                const uniqueKeys = [...new Set(reports.map(r => r[groupingKey]))].sort();
                const dates = []; let cd = new Date(period.start_str); cd.setHours(12,0,0,0);
                const endDate = new Date(period.end_str);
                endDate.setHours(12, 0, 0, 0);

                while(cd <= endDate) { dates.push(cd.toISOString().substring(0,10)); cd.setDate(cd.getDate()+1); cd.setHours(12,0,0,0); }
                
                html += `<thead><tr><th class="text-left" style="width:120px;">${rowLabel}</th>`;
                dates.forEach(d => { 
                    const holidayHeaderClass = isHolidayOrSunday(d) ? 'style="background-color:#dc3545; color:white;"' : '';
                    html += `<th style="width:50px;" ${holidayHeaderClass}>${new Date(d).getDate()}</th>`; 
                });
                html += `<th class="total-hm-periode-cell" style="width:90px;">Total HM</th></tr></thead><tbody>`;

                uniqueKeys.forEach(key => {
                    html += `<tr><td class="text-left">${key}</td>`;
                    let minHM = Infinity, maxHM = -Infinity;
                    const dailyMap = {};
                    reports.filter(r => r[groupingKey]===key).forEach(r => {
                        minHM = Math.min(minHM, r.hm_awal); maxHM = Math.max(maxHM, r.hm_akhir);
                        if(!dailyMap[r.tanggal]) dailyMap[r.tanggal] = 0;
                        dailyMap[r.tanggal] += r.jam_operasi;
                    });
                    let total = (maxHM !== -Infinity && minHM !== Infinity) ? (maxHM - minHM) : 0;
                    dates.forEach(date => { 
                        const holidayCellClass = isHolidayOrSunday(date) ? 'style="background-color:#ffebee;"' : '';
                        // Pembulatan data harian
                        const displayValue = dailyMap[date] ? Math.round(dailyMap[date]) : '-';
                        html += `<td ${holidayCellClass}>${displayValue}</td>`; 
                    });
                    // Pembulatan Total
                    html += `<td class="total-hm-periode-cell">${Math.round(total)}</td></tr>`;
                });
            }
            
            
           html += `</tbody></table></body>
            <div class="modal" id="trackingDetailModal">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <span class="close-btn" onclick="document.getElementById('trackingDetailModal').style.display='none'">√ó</span>
        
        <div style="border-bottom: 2px solid #d63384; margin-bottom: 20px; padding-bottom: 10px;">
            <h2 style="color: #d63384; margin: 0;">üì¶ Detail Tracking BA</h2>
            <p id="detail_header_info" style="margin: 5px 0 0; color: #555; font-weight: bold;"></p>
        </div>

        <div style="background: #fff0f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fcc2d7;">
            <h4 style="margin-top: 0; color: #d63384; font-size: 14px;">‚ûï Update Status Baru</h4>
            <input type="hidden" id="detail_parent_id">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div style="flex: 1;">
                    <label style="font-size: 11px; font-weight: bold;">Status:</label>
                    <select id="new_history_status" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></select>
                </div>
                <div style="width: 130px;">
                    <label style="font-size: 11px; font-weight: bold;">Tanggal:</label>
                    <input type="date" id="new_history_date" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <input type="text" id="new_history_note" placeholder="Keterangan (Opsional)..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <button onclick="window.addTrackingHistoryStep()" class="submit-btn" style="width: 100%; background-color: #d63384; padding: 8px;">Update Status</button>
        </div>

        <h4 style="margin-bottom: 15px; color: #333;">Riwayat Perjalanan Dokumen:</h4>
        <div id="timelineContainer" class="timeline-container">
            </div>
    </div>
</div>
            
            </html>`;
            return html;
        }

        function prepareForPrint(mode, tabId) {
            document.body.classList.remove('print-chart-only', 'print-table-only', 'print-both', 'print-ma-pa', 'print-triputra');
            
            // Hapus class 'active' dari SEMUA tab content, lalu tambahkan ke tab yang sedang diproses
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active'); // Pastikan tab yang benar aktif sebelum print
            
            // Tambahkan class tab spesifik
            if (tabId === 'analisa_ketersediaan') {
                document.body.classList.add('print-ma-pa');
            } else if (tabId === 'laporan_triputra') {
                document.body.classList.add('print-triputra');
            } else if (tabId === 'laporan') {
                 // Tambahkan class mode untuk tab Laporan Harian
                 if (mode === 'print_table') document.body.classList.add('print-table-only');
                 if (mode === 'print_chart') document.body.classList.add('print-chart-only');
                 if (mode === 'print_both') document.body.classList.add('print-both');
            } else if (tabId === 'input') { // Jika mencetak dari tab input (walaupun tidak direkomendasikan)
                 document.body.classList.add('print-table-only');
} else if (tabId === 'absensi') { // <--- TAMBAHAN BARU
    window.updateMonthRange(document.getElementById('abs_period_select').value, 'abs_');
    window.fetchAttendanceData();

} else if (tabId === 'tracking_ba') {
    // [BARU] Load Tracking saat tab diklik
    window.loadTrackingView();
}
            const cleanUp = () => { 
                document.body.classList.remove('print-chart-only', 'print-table-only', 'print-both', 'print-ma-pa', 'print-triputra'); 
                // Restore the active class to the correct tab after printing (since we modified it temporarily)
                document.querySelectorAll('.tabs .tab-button').forEach(btn => {
                    if (btn.dataset.tab === tabId) {
                        btn.classList.add('active');
                        document.getElementById(tabId)?.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                        document.getElementById(btn.dataset.tab)?.classList.remove('active');
                    }
                });
                window.removeEventListener('afterprint', cleanUp); 
            };
            window.addEventListener('afterprint', cleanUp);
        }

        window.handleExport = function() {
            const format = document.getElementById('export_format').value;
            const reportView = document.getElementById('report_view').value;
            if (!format) return;
            
            if (format === 'csv') {
                const periodType = document.getElementById('period_select').value;
                const monthSelect = document.getElementById('filter_month');
                let period;
                
                if ((periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') && monthSelect.multiple) {
                     // Jika mode multi-bulan dipilih, dan ada > 1 bulan terpilih
                     if (Array.from(monthSelect.selectedOptions).length > 1) {
                         // **TRIGGER MULTI-SHEET EXPORT DI SINI**
                         let filteredReports = reportsData.filter(report => report.klasifikasi_sektor === document.getElementById('filter_sektor').value || document.getElementById('filter_sektor').value === 'all');
                         
                         exportMultiSheetXLSX(filteredReports, periodType);
                         document.getElementById('export_format').value = ""; 
                         return;
                     }
                     period = getMultipleReportingPeriod(periodType, '');
                } else {
                     period = getReportingPeriod(periodType, '');
                }

                const selectedUnitFilter = document.getElementById('filter_unit').value;
                const selectedSektorFilter = document.getElementById('filter_sektor').value;
                
                let filteredReports = reportsData.filter(report => isDateInPeriod(report.tanggal, period.start_str, period.end_str));
                
                if (selectedUnitFilter !== 'all') filteredReports = filteredReports.filter(report => report.unit === selectedUnitFilter);
                if (selectedSektorFilter !== 'all') filteredReports = filteredReports.filter(report => report.klasifikasi_sektor === selectedSektorFilter); 
                
                if (filteredReports.length === 0) { showToast("Tidak Ada Data", "Tidak ada data untuk diekspor.", "error"); document.getElementById('export_format').value = ""; return; }
                if (reportView === 'detailed') filteredReports = sortReports(filteredReports, currentSortColumn, currentSortOrder);

                const excelHTML = generateExcelTable(filteredReports, reportView, `Periode: ${period.text}`);
                const blob = new Blob([excelHTML], { type: "application/vnd.ms-excel;charset=utf-8" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `Laporan_DOR_${new Date().toISOString().slice(0, 10)}.xls`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                showToast("Export Sukses", "Data diekspor ke Excel.", "success");
            } else if (format.startsWith('print_')) {
                 // *** Perbaikan Cetak ***
                // Atur header cetak berdasarkan laporan yang sedang aktif
                const period = getReportingPeriod(document.getElementById('period_select').value, '');
                document.getElementById('print-header').querySelector('h2').textContent = 'Laporan Harian Operasi (DOR)';
                document.getElementById('print-periode-info').textContent = `Periode: ${period.text}`;
                
                prepareForPrint(format, 'laporan'); // Kirim ID tab saat ini
                window.print();
            }
            document.getElementById('export_format').value = ""; 

        }


        // --- FUNGSI EKSPORT KHUSUS MA/PA (BARU) ---
        window.handleAvailabilityExport = function() {
            const format = document.getElementById('avail_export_format').value;
            if (!format) return;
            
            const periodType = document.getElementById('avail_period_select').value;
            const targetHour = parseFloat(document.getElementById('avail_target_hour').value) || 12;
            const selectedSektorFilter = document.getElementById('avail_filter_sektor').value;
            const groupBy = document.getElementById('avail_group_by').value;
            
            const periodInfo = getMultipleReportingPeriod(periodType, 'avail_');
            
            let reportsInPeriod = reportsData.filter(report => isDateInPeriod(report.tanggal, periodInfo.start_str, periodInfo.end_str));
            if (selectedSektorFilter !== 'all') {
                 reportsInPeriod = reportsInPeriod.filter(report => report.klasifikasi_sektor === selectedSektorFilter);
            }

            const workingDays = countWorkingDays(new Date(periodInfo.start_str), new Date(periodInfo.end_str));
            const potentialHoursTotal = workingDays * targetHour; 
            const availabilityData = AnalisaAvailability(reportsInPeriod, workingDays, targetHour, groupBy);

            if (availabilityData.length === 0) { showToast("Tidak Ada Data", "Tidak ada data MA/PA untuk diekspor.", "error"); document.getElementById('avail_export_format').value = ""; return; }

            if (format === 'csv') {
                const excelHTML = generateAvailabilityExcelTable(availabilityData, periodInfo.text, groupBy, potentialHoursTotal);
                const blob = new Blob([excelHTML], { type: "application/vnd.ms-excel;charset=utf-8" });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `Analisa_MAPA_${new Date().toISOString().slice(0, 10)}.xls`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                showToast("Export Sukses", "Data MA/PA diekspor ke Excel.", "success");
            } else if (format === 'print_table') {
                 // *** Perbaikan Cetak ***
                 document.getElementById('print-header').querySelector('h2').textContent = 'Analisa Ketersediaan Alat (MA/PA)';
                 document.getElementById('print-periode-info').textContent = `Periode: ${periodInfo.text}`;
                 prepareForPrint('print_table', 'analisa_ketersediaan'); // Kirim ID tab MA/PA
                 window.print();
            }
            document.getElementById('avail_export_format').value = ""; 
        }

        function generateAvailabilityExcelTable(data, periodInfoText, groupBy, totalPotentialHours) {
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:8px;text-align:center;font-size:11px;}th{background-color:#dc3545;color:white;font-weight:bold;}.text-left{text-align:left;}.MA-high{background-color:#d4edda;}.MA-low{background-color:#f8d7da;}.PA-high{background-color:#e2f0fb;}.PA-low{background-color:#fff3cd;}
/* --- TAMBAHAN UNTUK SMART CATEGORY --- */
.cat-breakdown { background-color: #f8d7da !important; color: #721c24; }.cat-cuaca { background-color: #e2f0fb !important; color: #004085; }.cat-idle { background-color: #fff3cd !important; color: #856404; }</style></head><body><h2>Analisa Ketersediaan Alat (MA & PA)</h2><p>Periode: ${periodInfoText}</p><table>`;
            
            const groupLabel = groupBy === 'unit' ? 'Unit/Alat' : 'Operator';

            html += `<thead><tr><th rowspan="2" style="width: 150px;">${groupLabel}</th><th colspan="2">Jam Rencana (PH)</th><th colspan="2">Waktu Hilang (Lost Hours)</th><th rowspan="2" style="width: 100px;">Jam Operasi (Actual HM)</th><th rowspan="2" style="width: 80px;">MA (%)</th><th rowspan="2" style="width: 80px;">PA (%)</th></tr><tr><th>Hari Kerja Efektif</th><th>TJK Rencana (Hrs)</th><th>Breakdown (M)</th><th>Idle/Tunggu (P)</th></tr></thead><tbody>`;

            let totalOp = 0, totalBD = 0, totalIdle = 0;
            const totalReportedUnits = data.length; 
            const totalPHForCalculation = totalReportedUnits * totalPotentialHours;
            
            data.forEach(item => {
                totalOp += item.jam_operasi;
                totalBD += item.jam_breakdown;
                totalIdle += item.jam_idle;

                const maClass = item.MA >= 85 ? 'MA-high' : 'MA-low';
                const paClass = item.PA >= 75 ? 'PA-high' : 'PA-low';

                // Pembulatan
                html += `<tr>
                    <td class="text-left">${item.key}</td>
                    <td>${item.days_reported} Hari</td>
                    <td>${Math.round(item.potential_hours)}</td>
                    <td>${Math.round(item.jam_breakdown)}</td>
                    <td>${Math.round(item.jam_idle)}</td>
                    <td>${Math.round(item.jam_operasi)}</td>
                    <td class="${maClass}">**${Math.round(item.MA)}%**</td>
                    <td class="${paClass}">**${Math.round(item.PA)}%**</td>
                </tr>`;
            });
            
            const totalMA_numerator = totalOp + totalIdle;
            const totalPA_denom = totalPHForCalculation - totalBD;
            
            const totalMA = totalPHForCalculation > 0 ? (totalMA_numerator / totalPHForCalculation) * 100 : 0;
            const totalPA = totalPA_denom > 0 ? (totalOp / totalPA_denom) * 100 : 0;


            const totalMAClass = totalMA >= 85 ? 'MA-high' : 'MA-low';
            const totalPAClass = totalPA >= 75 ? 'PA-high' : 'PA-low';

            // Pembulatan Footer
            html += `</tbody><tfoot><tr style="font-weight: bold; background: #e9ecef;">
                    <td style="text-align: right;">**TOTAL RATA-RATA (${totalReportedUnits} ${groupBy.toUpperCase()})**</td>
                    <td>-</td>
                    <td>**${Math.round(totalPHForCalculation)}**</td>
                    <td>**${Math.round(totalBD)}**</td>
                    <td>**${Math.round(totalIdle)}**</td>
                    <td>**${Math.round(totalOp)}**</td>
                    <td class="${totalMAClass}">**${Math.round(totalMA)}%**</td>
                    <td class="${totalPAClass}">**${Math.round(totalPA)}%**</td>
                </tr></tfoot></table></body></html>`;

            return html;
        }

        window.zoomImage = function(src) {
            document.getElementById('zoomedImage').src = src;
            document.getElementById('imageZoomModal').style.display = 'block';
        }
        
        // FUNGSI INI DIPERBAIKI (PERBAIKAN UTAMA)
        function handleTabSwitching() {
    document.querySelectorAll('.tabs .tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            if (tabId === 'master_data') return; 
            
            // 1. Reset state tab
            document.querySelectorAll('.tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 2. Aktifkan tab dan konten yang dipilih
            this.classList.add('active');
            const content = document.getElementById(tabId);
            if (content) {
                content.classList.add('active'); 
                
                // 3. Logika Load Data per Tab
                if (tabId === 'laporan') { 
                    window.fetchReportData();
                } else if (tabId === 'analisa_ketersediaan') {
                    window.updateMonthRange(document.getElementById('avail_period_select').value, 'avail_');
                    updateFilterSektorDropdown();
                    window.fetchAvailabilityData();
                } else if (tabId === 'laporan_triputra') { 
                    if(document.getElementById('trp_filter_month').options.length === 0) {
                        window.updateMonthRange(document.getElementById('trp_period_select').value, 'trp_');
                    }
                    window.fetchTriputraData();
                } else if (tabId === 'absensi') { // <--- PERBAIKAN: TAMBAHKAN BLOK INI
                    if(document.getElementById('abs_filter_month').options.length === 0) {
                         window.updateMonthRange(document.getElementById('abs_period_select').value, 'abs_');
                    }
                    window.fetchAttendanceData();
                }
            }
        });
    });
}

        // ============================================
        // === LOGIKA BARU UNTUK MA/PA (AVAILABILITY) ===
        // ============================================

        window.fetchAvailabilityData = function() {
            const periodType = document.getElementById('avail_period_select').value;
            const targetHour = parseFloat(document.getElementById('avail_target_hour').value) || 12;
            const selectedSektorFilter = document.getElementById('avail_filter_sektor').value;
            const groupBy = document.getElementById('avail_group_by').value;
            
            // Mengambil range dari multiple selection
            const periodInfo = getMultipleReportingPeriod(periodType, 'avail_');
            
            const { start_str, end_str, days, text } = periodInfo;

            document.getElementById('avail_export_format').value = ""; // Reset export field

            if (days === 0) {
                 document.getElementById('avail-periode-info').textContent = `Periode Analisa: ${text}`;
                 document.getElementById('availabilityReportBody').innerHTML = '<tr><td colspan="8">Pilih setidaknya satu periode Bulan/Rentang.</td></tr>';
                 document.getElementById('availabilityReportFoot').innerHTML = '';
                 return;
            }

            const workingDays = countWorkingDays(new Date(start_str), new Date(end_str));
            const potentialHoursTotal = workingDays * targetHour; 

            // Format tanggal untuk tampilan di halaman
            const periodInfoText = `Periode Analisa: ${text} (${formatDate(start_str)} - ${formatDate(end_str)}) | Hari Kerja Efektif: ${workingDays} | Target Jam/Hari: ${targetHour} Jam | Total Jam Rencana (PH): ${Math.round(potentialHoursTotal)} Jam`; // Pembulatan
            document.getElementById('avail-periode-info').textContent = periodInfoText;
            document.getElementById('print-periode-info').textContent = periodInfoText;


            // Filter data awal berdasarkan rentang tanggal
            let reportsInPeriod = reportsData.filter(report => isDateInPeriod(report.tanggal, start_str, end_str));
            
            // Filter berdasarkan klasifikasi sektor
            if (selectedSektorFilter !== 'all') {
                 reportsInPeriod = reportsInPeriod.filter(report => report.klasifikasi_sektor === selectedSektorFilter);
            }

            const availabilityData = AnalisaAvailability(reportsInPeriod, workingDays, targetHour, groupBy);
            renderAvailabilityTable(availabilityData, potentialHoursTotal, groupBy);
        }

        // --- FUNGSI HITUNG MA/PA (BARU & LEBIH AKURAT) ---
// --- FUNGSI HITUNG MA/PA (UPDATED: INTEGRASI SMART IDENTIFICATION) ---
function AnalisaAvailability(reports, workingDays, targetHour, groupBy) {
    const unitsData = {};
    
    // 1. Inisialisasi Data Unit
    const uniqueKeys = [...new Set(reports.map(r => r[groupBy]))].filter(k => k);
    
    uniqueKeys.forEach(key => {
        unitsData[key] = {
            jam_operasi: 0,
            jam_breakdown: 0,   // M (Maintenance)
            jam_idle_cuaca: 0,  // P (Physical Environment)
            jam_idle_lain: 0,   // P (Personnel/Process)
            days_reported: new Set()
        };
    });

    // 2. Proses Setiap Laporan
    reports.forEach(report => {
        const key = report[groupBy];
        if (!unitsData[key]) return;

        const currentData = unitsData[key];
        
        // A. Jam Operasi Aktual
        const actualHM = parseFloat(report.jam_operasi) || 0;
        currentData.jam_operasi += actualHM;
        
        // B. Hitung Loss Time (Sisa Target vs Aktual)
        // Kita anggap jika tidak mencapai target, sisanya adalah Loss Time yang harus dikategorikan
        let lossTime = Math.max(0, targetHour - actualHM);

        // C. Tentukan Penyebab Loss Time
        // Prioritas 1: Gunakan kategori yang tersimpan (jika user manual pilih)
        // Prioritas 2: Gunakan Smart Identification dari teks keterangan
        let category = report.kategori_keterangan;
        
        // Jika kategori kosong/invalid/Lain-lain, paksa scan ulang teks keterangan
        if (!category || category === '-' || category === 'LAIN-LAIN') {
            category = getKeteranganCategory(report.keterangan);
        }

        if (lossTime > 0) {
            // Logika Distribusi Waktu Hilang
            if (category === 'BREAKDOWN') {
                currentData.jam_breakdown += lossTime;
            } else if (category === 'CUACA') {
                currentData.jam_idle_cuaca += lossTime;
            } else if (category === 'IDLE_LAIN') {
                currentData.jam_idle_lain += lossTime;
            } else {
                // Jika masih tidak terdeteksi (LAIN-LAIN), default ke IDLE_LAIN
                // Asumsi: Alat Ready tapi tidak kerja karena alasan tak jelas = Inefisiensi (PA)
                currentData.jam_idle_lain += lossTime; 
            }
        }
        
        currentData.days_reported.add(report.tanggal);
    });

    // 3. Kalkulasi Akhir MA & PA
    return Object.keys(unitsData).map(key => {
        const d = unitsData[key];
        
        // PH (Potential Hours) Total Periode
        const potentialHoursTotal = workingDays * targetHour;

        // Breakdown Total
        const totalBD = d.jam_breakdown;
        
        // Standby Total (Cuaca + Idle Lain)
        const totalStandby = d.jam_idle_cuaca + d.jam_idle_lain;

        // MA = (Jam Operasi + Standby) / PH
        // Breakdown mengurangi MA.
        const numeratorMA = d.jam_operasi + totalStandby;
        const MA = potentialHoursTotal > 0 ? (numeratorMA / potentialHoursTotal) * 100 : 0;
        
        // PA = Jam Operasi / (PH - Breakdown)
        // Breakdown tidak menghukum PA (karena PA mengukur penggunaan saat alat ready).
        const denomPA = potentialHoursTotal - totalBD;
        const PA = denomPA > 0 ? (d.jam_operasi / denomPA) * 100 : 0;
        
        return {
            key: key,
            potential_hours: potentialHoursTotal,
            jam_operasi: d.jam_operasi,
            jam_breakdown: totalBD,
            jam_idle_cuaca: d.jam_idle_cuaca,
            jam_idle_lain: d.jam_idle_lain,
            MA: MA, // Tidak dibulatkan di sini agar sorting akurat
            PA: PA,
            days_reported: d.days_reported.size
        };
    }).sort((a, b) => b.MA - a.MA); // Urutkan dari MA tertinggi
}

// --- FUNGSI BARU: GENERATE ANALISA NARATIF ---
function generateSmartAnalysis(data, totalPotentialHours) {
    const container = document.getElementById('smartAnalysisContainer');
    const content = document.getElementById('smartAnalysisContent');
    
    if (!data || data.length === 0) {
        container.style.display = 'none';
        return;
    }

    // 1. Hitung Rata-rata & Total
    let totalMA = 0, totalPA = 0, totalBD = 0, totalCuaca = 0, totalIdleLain = 0;
    let worstUnitMA = { key: '', val: 100 };
    let worstUnitPA = { key: '', val: 100 };
    
    data.forEach(item => {
        totalMA += item.MA;
        totalPA += item.PA;
        totalBD += item.jam_breakdown;
        totalCuaca += item.jam_idle_cuaca;
        totalIdleLain += item.jam_idle_lain; // Idle (No Op/Tunggu)

        // Cari Unit Terburuk
        if (item.MA < worstUnitMA.val) worstUnitMA = { key: item.key, val: item.MA };
        if (item.PA < worstUnitPA.val) worstUnitPA = { key: item.key, val: item.PA };
    });

    const avgMA = totalMA / data.length;
    const avgPA = totalPA / data.length;
    const grandTotalJam = totalPotentialHours * data.length; // Estimasi total jam tersedia semua unit

    // 2. Susun Kalimat Analisa
    let analysisHTML = "<ul>";

    // --- A. Analisa Kesehatan Armada (MA) ---
    if (avgMA >= 85) {
        analysisHTML += `<li style="margin-bottom: 8px;">‚úÖ <strong>Kesehatan Alat Sangat Prima:</strong> Rata-rata Mechanical Availability (MA) armada mencapai <strong>${Math.round(avgMA)}%</strong>. Tim maintenance bekerja dengan sangat baik menjaga unit tetap siap operasi.</li>`;
    } else if (avgMA >= 70) {
        analysisHTML += `<li style="margin-bottom: 8px;">‚ö†Ô∏è <strong>Perhatian Maintenance:</strong> Rata-rata MA armada berada di angka <strong>${Math.round(avgMA)}%</strong>. Ada beberapa kendala teknis yang mulai mengganggu ketersediaan alat.</li>`;
    } else {
        analysisHTML += `<li style="margin-bottom: 8px; color: #dc3545;">üö® <strong>Kritis - Banyak Kerusakan:</strong> Rata-rata MA sangat rendah (<strong>${Math.round(avgMA)}%</strong>). Fokus utama harus diarahkan pada perbaikan unit dan ketersediaan sparepart.</li>`;
    }

    // --- B. Analisa Unit Bermasalah (Troublemaker) ---
    if (worstUnitMA.val < 80) {
        analysisHTML += `<li style="margin-bottom: 8px;">üîß <strong>Unit Paling Bermasalah:</strong> Unit <strong>${worstUnitMA.key}</strong> memiliki MA terendah yaitu <strong>${Math.round(worstUnitMA.val)}%</strong>. Mohon periksa riwayat kerusakan unit ini, apakah menunggu sparepart atau kerusakan berulang.</li>`;
    }

    // --- C. Analisa Faktor Eksternal (Cuaca) ---
    if (totalCuaca > 0) {
        const persenCuaca = (totalCuaca / grandTotalJam) * 100;
        if (persenCuaca > 15) {
            analysisHTML += `<li style="margin-bottom: 8px;">üåßÔ∏è <strong>Dampak Cuaca Tinggi:</strong> Operasional sangat terganggu oleh cuaca (Hujan/Licin) yang memakan waktu sebanyak <strong>${Math.round(totalCuaca)} Jam</strong> (${Math.round(persenCuaca)}% dari total waktu). Ini faktor alam di luar kendali, namun manajemen jalan (road maintenance) mungkin bisa ditingkatkan.</li>`;
        } else {
            analysisHTML += `<li style="margin-bottom: 8px;">üå§Ô∏è <strong>Cuaca Kondusif:</strong> Hambatan akibat cuaca relatif minim (<strong>${Math.round(totalCuaca)} Jam</strong>).</li>`;
        }
    }

    // --- D. Analisa Efisiensi Operasional (Idle Lain - No Operator/Antri) ---
    if (totalIdleLain > 0) {
        // Cek apakah masalah No Operator lebih parah dari Breakdown
        if (totalIdleLain > totalBD) {
            analysisHTML += `<li style="margin-bottom: 8px; color: #d63384;">üëÆ <strong>Isu Manpower/Standby:</strong> Waktu hilang karena <em>Idle Lain</em> (No Operator/Menunggu) tercatat <strong>${Math.round(totalIdleLain)} Jam</strong>. Ini <u>lebih tinggi</u> daripada waktu kerusakan mesin. Perlu evaluasi jadwal operator atau manajemen antrian.</li>`;
        } else {
            analysisHTML += `<li style="margin-bottom: 8px;">‚è≥ <strong>Waktu Tunggu:</strong> Terdapat <strong>${Math.round(totalIdleLain)} Jam</strong> waktu terbuang karena faktor standby (bukan rusak/cuaca).</li>`;
        }
    }

    // --- E. Kesimpulan Akhir (PA) ---
    if (avgPA < 60) {
        analysisHTML += `<li style="margin-bottom: 8px;">üìâ <strong>Produktivitas Rendah:</strong> Physical Availability (PA) hanya <strong>${Math.round(avgPA)}%</strong>. Artinya unit lebih banyak diam daripada bekerja efektif. Gabungan antara kerusakan dan waktu standby perlu segera diatasi.</li>`;
    }

    analysisHTML += "</ul>";
    
    // Tampilkan
    content.innerHTML = analysisHTML;
    container.style.display = 'block';
}

        // --- FUNGSI RENDER TABEL MA/PA (DIPERBAIKI) ---
function renderAvailabilityTable(data, totalPotentialHours, groupBy) {
    const tbody = document.getElementById('availabilityReportBody');
    const tfoot = document.getElementById('availabilityReportFoot');
    
    // Pastikan elemen ada sebelum lanjut
    if (!tbody || !tfoot) return;

    tbody.innerHTML = '';
    tfoot.innerHTML = '';
    
    // Update Header Label (Unit/Operator)
    const headerCell = document.querySelector('#availabilityReportTable thead tr th:first-child');
    if(headerCell) headerCell.textContent = groupBy === 'unit' ? 'Unit/Alat' : 'Operator';

    // JIKA TIDAK ADA DATA
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Tidak ada data laporan yang valid untuk filter/periode ini.</td></tr>';
        // Sembunyikan kotak analisa jika tidak ada data
        const analysisContainer = document.getElementById('smartAnalysisContainer');
        if(analysisContainer) analysisContainer.style.display = 'none';
        return; 
    }

    let tOp = 0, tBD = 0, tCuaca = 0, tIdle = 0;
    const count = data.length; 
    const totalPH = count * totalPotentialHours;
    
    // LOOP DATA
    data.forEach(item => {
        tOp += item.jam_operasi;
        tBD += item.jam_breakdown;
        tCuaca += item.jam_idle_cuaca;
        tIdle += item.jam_idle_lain;

        const maClass = item.MA >= 85 ? 'MA-high' : 'MA-low';
        const paClass = item.PA >= 75 ? 'PA-high' : 'PA-low';
        
        tbody.innerHTML += `
            <tr>
                <td style="text-align: left; font-weight: bold;">${item.key}</td>
                <td>${item.days_reported} Hari</td>
                <td>${Math.round(item.potential_hours)}</td>
                <td class="cat-breakdown">${Math.round(item.jam_breakdown)}</td>
                <td class="cat-cuaca">${Math.round(item.jam_idle_cuaca)}</td>
                <td class="cat-idle">${Math.round(item.jam_idle_lain)}</td>
                <td style="font-weight:bold;">${Math.round(item.jam_operasi)}</td>
                <td class="${maClass}">${Math.round(item.MA)}%</td>
                <td class="${paClass}">${Math.round(item.PA)}%</td>
            </tr>
        `;
    });

    // Hitung Rata-rata Total
    const tMA = totalPH > 0 ? ((tOp + tCuaca + tIdle) / totalPH) * 100 : 0;
    const denomTPA = totalPH - tBD;
    const tPA = denomTPA > 0 ? (tOp / denomTPA) * 100 : 0;

    const tMAClass = tMA >= 85 ? 'MA-high' : 'MA-low';
    const tPAClass = tPA >= 75 ? 'PA-high' : 'PA-low';

    // RENDER FOOTER
    tfoot.innerHTML = `
        <tr style="font-weight: bold; background: #e9ecef;">
            <td style="text-align: right;">TOTAL RATA-RATA</td>
            <td>-</td>
            <td>${Math.round(totalPH)}</td>
            <td>${Math.round(tBD)}</td>
            <td>${Math.round(tCuaca)}</td>
            <td>${Math.round(tIdle)}</td>
            <td>${Math.round(tOp)}</td>
            <td class="${tMAClass}">${Math.round(tMA)}%</td>
            <td class="${tPAClass}">${Math.round(tPA)}%</td>
        </tr>
    `;

    // --- PEMANGGILAN ANALISA CERDAS (INI YANG KEMARIN HILANG/SALAH POSISI) ---
    generateSmartAnalysis(data, totalPotentialHours);
}

        // ============================================
        // === LOGIKA BARU UNTUK TAB TRIPUTRA ===
        // ============================================

        window.handleTriputraPeriodChange = function() {
            const periodType = document.getElementById('trp_period_select').value;
            updateMonthRange(periodType, 'trp_');
            window.fetchTriputraData();
        }

        window.handleTriputraYearChange = function() {
            const periodType = document.getElementById('trp_period_select').value;
            updateMonthRange(periodType, 'trp_');
            window.fetchTriputraData();
        }

        window.editTriputraSolarStock = function() {
            const newStockStr = prompt("Masukkan jumlah Sisa Solar saat ini (Liter):", Math.round(triputraFuelStock)); // Pembulatan
            if (newStockStr !== null && !isNaN(parseFloat(newStockStr))) {
                const newStock = parseFloat(newStockStr);
                const diff = newStock - triputraFuelStock;
                const reason = diff > 0 ? "Penambahan Manual" : "Pengurangan Manual";
                triputraFuelStock = newStock;
                logStockChange('Update Manual', diff, reason);
                showToast("Sukses", "Stok solar Triputra berhasil diperbarui.", "success");
            }
        }
        
        window.viewStockHistory = function() {
            const tbody = document.getElementById('stockHistoryBody');
            tbody.innerHTML = '';
            if(triputraStockLog.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Belum ada riwayat.</td></tr>';
            } else {
                triputraStockLog.forEach(log => {
                    const color = log.change >= 0 ? 'green' : 'red';
                    // Pembulatan
                    tbody.innerHTML += `
                        <tr>
                            <td>${log.timestamp}</td>
                            <td>${log.type} (${log.reason || '-'})</td>
                            <td style="color:${color}; font-weight:bold;">${log.change > 0 ? '+' : ''}${Math.round(log.change)}</td>
                            <td>${Math.round(log.finalStock)}</td>
                        </tr>
                    `;
                });
            }
            document.getElementById('stockHistoryModal').style.display = 'block';
        }

  window.addTriputraRow = function() {
    trpRowCounter++;
    const rowId = `trp-row-${trpRowCounter}`;
    const tbody = document.getElementById('triputraInputBody');
    const newRow = tbody.insertRow();
    newRow.id = rowId;
    
    // PERUBAHAN ADA DI BAGIAN <select>: onchange="window.updateTriputraUnitChange(this)"
    newRow.innerHTML = `
        <td><button type="button" class="delete-row-btn" onclick="document.getElementById('${rowId}').remove()">‚ùå</button></td>
        <td><input type="date" class="trp-tanggal" required value="${new Date().toISOString().substring(0, 10)}"></td>
        <td>
            <select class="input-unit trp-unit" required onchange="window.updateTriputraUnitChange(this)">
                </select>
        </td>
        <td><input type="text" class="trp-operator" list="operatorDatalist" required placeholder="Operator"></td>
        <td><input type="number" class="trp-pencapaian" min="0" step="1" required placeholder="Jml Titik"></td>
        <td>
            <input type="number" class="trp-hm-awal" min="0" required placeholder="Awal" 
                   style="transition: border-color 0.3s;" title="Pilih Unit dulu">
        </td>
        <td><input type="number" class="trp-hm-akhir" min="0" required placeholder="Akhir"></td>
        <td><input type="number" class="trp-solar" min="0" step="0.1" required placeholder="Liter"></td>
        <td><input type="text" class="trp-keterangan" placeholder="Ket..."></td>
    `;
    
    // Isi dropdown unit dengan data master
    updateUnitDropdown(newRow.querySelector('.trp-unit'));
    newRow.querySelector('.trp-unit').onchange = function() { window.updateOperatorAndSektor(this); };
    }

        document.getElementById('triputraBatchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const rows = document.getElementById('triputraInputBody').querySelectorAll('tr');
            if (rows.length === 0) return alert("Tidak ada data input.");

            const newData = [];
            let totalSolarUsedBatch = 0;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const tanggal = row.querySelector('.trp-tanggal').value;
                const unit = row.querySelector('.trp-unit').value;
                const operator = row.querySelector('.trp-operator').value.toUpperCase();
                const pencapaian = parseFloat(row.querySelector('.trp-pencapaian').value);
                const hmAwal = parseFloat(row.querySelector('.trp-hm-awal').value);
                const hmAkhir = parseFloat(row.querySelector('.trp-hm-akhir').value);
                const solar = parseFloat(row.querySelector('.trp-solar').value);
                const ket = row.querySelector('.trp-keterangan').value;

                if (!tanggal || !unit || isNaN(pencapaian) || isNaN(hmAwal) || isNaN(hmAkhir) || isNaN(solar)) {
                    // Beri highlight error pada baris
                    row.classList.add('row-error');
                    return alert("Data tidak lengkap di baris ke-" + (i+1));
                }
                if (hmAkhir < hmAwal) {
                    row.classList.add('row-error');
                    return alert(`HM Error di baris ${i+1}: Akhir < Awal`);
                }

                newData.push({
                    id: Date.now() + Math.random(), // Unique ID
                    tanggal, unit, operator, pencapaian, hmAwal, hmAkhir, solar, ket,
                    hmTotal: hmAkhir - hmAwal
                });
                totalSolarUsedBatch += solar;
            }

            // Validasi Stok Solar
            if (totalSolarUsedBatch > triputraFuelStock) {
                return alert(`‚ö†Ô∏è Stok Solar tidak mencukupi!\nStok Saat Ini: ${Math.round(triputraFuelStock)} L\nPenggunaan: ${Math.round(totalSolarUsedBatch)} L`); // Pembulatan
            }
            
            // Simpan Data
            triputraData.push(...newData);
            triputraFuelStock -= totalSolarUsedBatch; 
            
            // Log Changes
            logStockChange('Penggunaan Operasional', -totalSolarUsedBatch, 'Input Batch');
            
            document.getElementById('triputraInputBody').innerHTML = ''; // Reset Form
            trpRowCounter = 0;
            window.addTriputraRow(); // Add empty row
            window.fetchTriputraData(); // Refresh View
            showToast("Berhasil", `${newData.length} data disimpan. Stok solar berkurang ${Math.round(totalSolarUsedBatch)} L.`, "success"); // Pembulatan
        });

        // FUNGSI CEK HARI LIBUR / MINGGU (Khusus Triputra)
        function isHolidayOrSundayTriputra(dateString) {
            const date = new Date(dateString);
            const day = date.getDay(); // 0 = Minggu
            
            if (day === 0) return true; // Hari Minggu
            if (holidays.includes(dateString)) return true; // Tanggal Merah
            
            return false;
        }

        // FUNGSI HITUNG HARI KERJA EFEKTIF
        function countWorkingDaysTriputra(startDate, endDate) {
            let count = 0;
            let curDate = new Date(startDate);
            curDate.setHours(12,0,0,0);
            let end = new Date(endDate);
            end.setHours(12,0,0,0);

            while (curDate <= end) {
                const dateStr = curDate.toISOString().split('T')[0];
                if (!isHolidayOrSundayTriputra(dateStr)) {
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        // --- FITUR BARU: AUTO DETEKSI HM AKHIR TERAKHIR (TRIPUTRA) ---
window.updateTriputraUnitChange = function(selectElement) {
    // 1. Jalankan fungsi standar (isi operator default, dll)
    if (typeof window.updateOperatorAndSektor === 'function') {
        window.updateOperatorAndSektor(selectElement);
    }

    const unit = selectElement.value;
    const row = selectElement.closest('tr');
    const hmAwalInput = row.querySelector('.trp-hm-awal');

    // Reset Placeholder
    hmAwalInput.placeholder = "Awal";
    hmAwalInput.title = "";
    hmAwalInput.classList.remove('hm-suggestion'); // Hapus class styling jika ada

    if (!unit) return;

    // 2. Cari History Terakhir di Data Triputra
    // Kita filter data yang unitnya sama
    const history = triputraData.filter(d => d.unit === unit);

    if (history.length > 0) {
        // Sortir: Tanggal Terbaru -> ID Terbesar (jika tanggal sama)
        history.sort((a, b) => {
            const dateA = new Date(a.tanggal);
            const dateB = new Date(b.tanggal);
            return dateB - dateA || b.id - a.id; 
        });

        const lastData = history[0];
        const lastHM = parseFloat(lastData.hmAkhir);

        if (!isNaN(lastHM)) {
            // 3. Update Tampilan Placeholder
            hmAwalInput.placeholder = `Ex: ${lastHM}`; // Teks Samar
            hmAwalInput.title = `HM Akhir Terakhir: ${lastHM} (Tgl: ${formatDate(lastData.tanggal)})`; // Tooltip saat hover
            
            // Opsional: Bisa juga auto-fill value jika diinginkan (tapi user minta text samar)
            // hmAwalInput.value = lastHM; 
            
            // Tambahkan visual cue (border hijau tipis agar user sadar ada saran)
            hmAwalInput.style.borderColor = "#198754";
        }
    }
};

        // FUNGSI FETCH UTAMA UNTUK TRIPUTRA (Handling Filter)
// --- UPDATE: FETCH DATA TRIPUTRA DENGAN FILTER UNIT OPERASIONAL ---
window.fetchTriputraData = function() {
    const periodType = document.getElementById('trp_period_select').value;
    const monthSelect = document.getElementById('trp_filter_month');
    const dataCategory = document.getElementById('trp_data_category').value;
    const targetVal = parseFloat(document.getElementById('trp_target_val').value) || 120;
    const reportView = document.getElementById('trp_report_view').value;
    const chartView = document.getElementById('trp_chart_type').value; 
    
    const operatorFilter = document.getElementById('trp_filter_operator') ? document.getElementById('trp_filter_operator').value : 'all';
    
    // AMBIL STATUS CHECKBOX "SEMBUNYIKAN OPERASIONAL"
    const hideOps = document.getElementById('trp_hide_ops') ? document.getElementById('trp_hide_ops').checked : false;

    document.getElementById('trp_export_format').value = "";
    
    let period;
    if ((periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') && monthSelect.multiple) {
            period = getMultipleReportingPeriod(periodType, 'trp_');
    } else {
            period = getReportingPeriod(periodType, 'trp_');
    }
    
    const workingDays = countWorkingDaysTriputra(new Date(period.start_str), new Date(period.end_str));

    const periodInfoText = `Periode Filter: ${period.text} (${formatDate(period.start_str)} - ${formatDate(period.end_str)}) | Total Hari: ${period.days} | Hari Kerja: ${workingDays}`;
    document.getElementById('trp-periode-info').textContent = periodInfoText;
    document.getElementById('print-periode-info').textContent = periodInfoText;

    // Filter Awal (Tanggal)
    let filteredData = triputraData.filter(d => isDateInPeriod(d.tanggal, period.start_str, period.end_str));

    if (operatorFilter !== 'all') {
        filteredData = filteredData.filter(d => d.operator === operatorFilter);
    }

    // --- LOGIKA FILTER UNIT OPERASIONAL ---
    if (hideOps) {
        // Daftar Kata Kunci Unit Operasional (Case Insensitive)
        const opKeywords = [
            'LV', 'SARANA', 'OPS', 'OPERASIONAL', 'MOBIL', 
            'HILUX', 'TRITON','MUX',, 'STRADA', 'RANGER', 'NAVARA', 
            'FORTUNER', 'PAJERO', 'INNOVA', 'AVANZA', 'XENIA', 
            'GRANMAX', 'MEGA', 'EXPANDER', 'COLORADO', 'D-MAX',
            'AMBULANCE', 'RESCUE', 'MANHAUL', 'FUEL TRUCK', 'SERVICE TRUCK',
            'LUBE TRUCK', 'WATER TRUCK' 
        ];

        filteredData = filteredData.filter(d => {
            const u = d.unit.toUpperCase();
            // Jika nama unit mengandung salah satu kata kunci di atas, sembunyikan
            if (opKeywords.some(k => u.includes(k))) return false;
            
            // Opsional: Sembunyikan juga jika pencapaian titik = 0 (asumsi alat produksi pasti ada target)
            // if (d.pencapaian === 0) return false; 
            
            return true;
        });
    }

    // Update Dropdown Operator (Hanya tampilkan operator dari unit yang tersisa/produksi)
    if(typeof updateTriputraOperatorDropdown === 'function') {
        const opSelect = document.getElementById('trp_filter_operator');
        if(opSelect && opSelect.options.length <= 1) {
             updateTriputraOperatorDropdown();
        }
    }
    
    // Render Tabel & Grafik dengan data yang SUDAH DIFILTER (Unit Produksi Saja)
    renderTriputraAccumulationTable(filteredData);

    const chartsContainer = document.querySelector('#laporan_triputra .triputra-charts-grid');
    chartsContainer.style.display = 'grid'; 

    const triTableSection = document.getElementById('triputraTableSection');
    
    if (reportView === 'list') {
        renderTriputraTable(filteredData, dataCategory);
        if(triTableSection) triTableSection.style.display = 'block'; 
    } else if (reportView === 'landscape') {
        renderTriputraLandscape(filteredData, period, dataCategory);
        if(triTableSection) triTableSection.style.display = 'block'; 
    }

    renderTriputraCharts(filteredData, workingDays, targetVal, chartView); 
    if(typeof window.renderSaranaTable === 'function') {
    window.renderSaranaTable();
    }
}
    function renderTriputraAccumulationTable(data) {
    const tbody = document.querySelector('#triputraAccumulationTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Tidak ada data ditemukan untuk periode ini.</td></tr>';
        return;
    }

    // 1. Aggregate data by unit (Mengelompokkan data)
    const accumulation = data.reduce((acc, item) => { 
        if (!acc[item.unit]) { 
            acc[item.unit] = { 
                days: new Set(), 
                totalHM: 0, 
                totalSolar: 0, 
                totalTitik: 0 
            }; 
        } 
        acc[item.unit].days.add(item.tanggal); 
        acc[item.unit].totalHM += item.hmTotal; 
        acc[item.unit].totalSolar += (Number(item.solar) || 0); 
        acc[item.unit].totalTitik += item.pencapaian; 
        return acc; 
    }, {}); 

    // Variabel untuk menampung Total Keseluruhan
    let grandTotalHari = 0;
    let grandTotalHM = 0;
    let grandTotalSolar = 0;
    let grandTotalTitik = 0;

    // 2. Render rows (Baris per Unit)
    const sortedUnits = Object.keys(accumulation).sort(); 
    sortedUnits.forEach(unit => { 
        const item = accumulation[unit]; 
        
        // Hitung Rasio Unit
        const avgSolarPerHM = item.totalHM > 0 ? (item.totalSolar / item.totalHM).toFixed(2) : 0;
        const avgTitikPerHM = item.totalHM > 0 ? (item.totalTitik / item.totalHM).toFixed(2) : 0; 
        
        const totalSolar = Math.round(item.totalSolar); 
        const totalHM = Math.round(item.totalHM);
        const totalTitik = Math.round(item.totalTitik);

        // Tambahkan ke Grand Total
        grandTotalHari += item.days.size;
        grandTotalHM += item.totalHM;
        grandTotalSolar += item.totalSolar;
        grandTotalTitik += item.totalTitik;

        // Cetak Baris Unit
        tbody.innerHTML += ` 
            <tr> 
                <td style="text-align: left; font-weight: bold;">${unit}</td> 
                <td>${item.days.size} Hari</td> 
                <td>${totalHM} HM</td> 
                <td>${totalSolar} Ltr</td> 
                <td>${totalTitik} Titik</td> 
                <td>${avgSolarPerHM} Ltr/HM</td> 
                <td>${avgTitikPerHM} Titik/HM</td> 
            </tr> 
        `; 
    });

    // 3. Render Grand Total Row (Baris Total Keseluruhan)
    if (sortedUnits.length > 0) {
        // Hitung Rasio Rata-rata Gabungan
        const grandAvgSolar = grandTotalHM > 0 ? (grandTotalSolar / grandTotalHM).toFixed(2) : 0;
        const grandAvgTitik = grandTotalHM > 0 ? (grandTotalTitik / grandTotalHM).toFixed(2) : 0;

        // Cetak Baris Total dengan warna berbeda (Abu-abu muda & Bold)
        tbody.innerHTML += `
            <tr style="background-color: #e9ecef; font-weight: bold; border-top: 2px solid #6f42c1;">
                <td style="text-align: right; color: #6f42c1;">TOTAL GABUNGAN</td>
                <td>${grandTotalHari} Unit-Hari</td>
                <td>${Math.round(grandTotalHM)} HM</td>
                <td>${Math.round(grandTotalSolar)} Ltr</td>
                <td style="background-color: #d1e7dd; color: #0f5132;">${Math.round(grandTotalTitik)} Titik</td>
                <td>${grandAvgSolar} Ltr/HM</td>
                <td>${grandAvgTitik} Titik/HM</td>
            </tr>
        `;
    }
            
    if (sortedUnits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">Tidak ada data unit yang dilaporkan dalam periode ini.</td></tr>';
    }
}        
        function renderTriputraTable(data, category) {
            const table = document.getElementById('triputraReportTable');
            table.classList.remove('landscape-mode');
            
            // Rebuild Header for List View
            let headerHTML = `<thead><tr>
                <th class="triputra-action-column" style="background-color: #6f42c1;">Aksi</th>
                <th style="background-color: #6f42c1;">Tanggal</th>
                <th style="background-color: #6f42c1;">Unit</th>
                <th style="background-color: #6f42c1;">Operator</th>`;
            
            const showHM = category === 'all' || category === 'hm';
            const showSolar = category === 'all' || category === 'solar';
            const showTitik = category === 'all' || category === 'pencapaian';

            if(showHM) headerHTML += `<th style="background-color: #6f42c1;">HM Operasi</th>`;
            if(showSolar) headerHTML += `<th style="background-color: #6f42c1;">Solar (Ltr)</th>`;
            if(showTitik) headerHTML += `<th style="background-color: #6f42c1;">Pencapaian Titik</th>`;
            if(showHM && showSolar) headerHTML += `<th style="background-color: #6f42c1;">Rasio Solar/HM</th>`;
            headerHTML += `</tr></thead><tbody id="triputraReportBody"></tbody><tfoot id="triputraReportFoot" style="font-weight: bold; background: #e9ecef;"></tfoot>`;
            
            table.innerHTML = headerHTML;
            const tbody = document.getElementById('triputraReportBody');
            const tfoot = document.getElementById('triputraReportFoot');
            
            // Urutkan berdasarkan tanggal terbaru
            const sortedData = [...data].sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

            let totalHM = 0, totalSolar = 0, totalPencapaian = 0;

            sortedData.forEach(item => {
                totalHM += item.hmTotal;
                totalSolar += item.solar;
                totalPencapaian += item.pencapaian;
                
                const rasio = item.hmTotal > 0 ? (item.solar / item.hmTotal).toFixed(0) : '0'; // Pembulatan
                
                // Highlight jika tanggal merah
                const isLibur = isHolidayOrSundayTriputra(item.tanggal);
                const rowStyle = isLibur ? 'style="background-color: #fff0f0;"' : '';
                const dateDisplay = isLibur ? `${formatDate(item.tanggal)} <span style="color:red; font-size:10px;">(L)</span>` : formatDate(item.tanggal);

                let rowHtml = `
                    <td class="triputra-action-column">
                        <button class="action-button edit-report-button" onclick="window.editTriputraReport('${item.id}')">‚úèÔ∏è Edit</button>
                        <button class="action-button delete-report-button" onclick="window.deleteTriputraReport('${item.id}')">‚ùå Hapus</button>
                    </td>
                    <td ${rowStyle}>${dateDisplay}</td>
                    <td ${rowStyle} style="text-align:left;">${item.unit}</td>
                    <td ${rowStyle} style="text-align:left;">${item.operator}</td>`;
                
                if(showHM) rowHtml += `<td ${rowStyle}>${Math.round(item.hmTotal)}</td>`; // Pembulatan
                if(showSolar) rowHtml += `<td ${rowStyle}>${Math.round(item.solar)}</td>`; // Pembulatan
                if(showTitik) rowHtml += `<td ${rowStyle}>${item.pencapaian}</td>`;
                if(showHM && showSolar) rowHtml += `<td ${rowStyle}>${rasio} L/HM</td>`;
                
                tbody.innerHTML += `<tr>${rowHtml}</tr>`;
            });

            const avgRasio = totalHM > 0 ? (totalSolar / totalHM).toFixed(0) : 0; // Pembulatan
            
            let footerHtml = `<td colspan="4" style="text-align:right;">TOTAL PERIODE INI:</td>`;
            if(showHM) footerHtml += `<td>${Math.round(totalHM)} HM</td>`; // Pembulatan
            if(showSolar) footerHtml += `<td>${Math.round(totalSolar)} L</td>`; // Pembulatan
            if(showTitik) footerHtml += `<td>${totalPencapaian} Titik</td>`;
            if(showHM && showSolar) footerHtml += `<td>Avg: ${avgRasio} L/HM</td>`;

            tfoot.innerHTML = `<tr>${footerHtml}</tr>`;
        }
        
        // --- FUNGSI BARU: EDIT TRIPUTRA REPORT ---
        window.editTriputraReport = function(id) {
            const report = triputraData.find(r => r.id == id);
            if (!report) return showToast("Error", "Data laporan tidak ditemukan.", "error");

            // Populate unit dropdown for modal
            updateUnitDropdown(document.getElementById('edit_trp_unit'));
            
            // Set Hidden Fields
            document.getElementById('editTriputraId').value = id;
            document.getElementById('originalTriputraSolar').value = report.solar; // Store original solar usage

            // Populate Form Fields
            document.getElementById('edit_trp_tanggal').value = report.tanggal;
            document.getElementById('edit_trp_unit').value = report.unit;
            document.getElementById('edit_trp_operator').value = report.operator;
            document.getElementById('edit_trp_pencapaian').value = report.pencapaian;
            document.getElementById('edit_trp_hm_awal').value = report.hmAwal;
            document.getElementById('edit_trp_hm_akhir').value = report.hmAkhir;
            document.getElementById('edit_trp_solar').value = report.solar;
            document.getElementById('edit_trp_keterangan').value = report.ket;
            
            // Show Modal
            document.getElementById('editTriputraModal').style.display = 'block';
        }
        
        // --- FUNGSI BARU: SAVE EDITED TRIPUTRA REPORT ---
        window.saveEditedTriputraReport = function() {
            const id = document.getElementById('editTriputraId').value;
            const index = triputraData.findIndex(r => r.id == id);
            if (index === -1) return showToast("Error", "Gagal menemukan data untuk disimpan.", "error");
            
            const originalSolar = parseFloat(document.getElementById('originalTriputraSolar').value);
            
            // Ambil data dari modal
            const tanggal = document.getElementById('edit_trp_tanggal').value;
            const unit = document.getElementById('edit_trp_unit').value;
            const operator = document.getElementById('edit_trp_operator').value.trim().toUpperCase();
            const pencapaian = parseFloat(document.getElementById('edit_trp_pencapaian').value);
            const hmAwal = parseFloat(document.getElementById('edit_trp_hm_awal').value);
            const hmAkhir = parseFloat(document.getElementById('edit_trp_hm_akhir').value);
            const solar = parseFloat(document.getElementById('edit_trp_solar').value);
            const ket = document.getElementById('edit_trp_keterangan').value.trim();

            // Validasi
            if (isNaN(hmAkhir) || isNaN(hmAwal) || isNaN(pencapaian) || isNaN(solar)) return alert("HM, Solar, dan Pencapaian harus angka.");
            if (hmAkhir < hmAwal) return alert(`HM Akhir tidak boleh lebih kecil dari HM Awal.`);
            if (!tanggal || !unit || !operator) return alert("Data wajib belum lengkap.");

            // Hitung Perbedaan Solar dan Validasi Stok
            const newSolarUsage = solar;
            const solarDifference = newSolarUsage - originalSolar;
            
            if (solarDifference > 0 && triputraFuelStock - solarDifference < 0) { // Hanya cek stok jika penambahan
                 return alert(`‚ö†Ô∏è Stok Solar tidak mencukupi untuk penyesuaian ini!\nStok Saat Ini: ${Math.round(triputraFuelStock)} L\nKebutuhan Tambahan: ${Math.round(solarDifference)} L`); // Pembulatan
            }

            // Update Stok Solar Global
            triputraFuelStock -= solarDifference;
            logStockChange('Update Edit', -solarDifference, `Perubahan laporan ${unit} tgl ${formatDate(tanggal)}`);

            // Update Data di Array
            triputraData[index] = {
                id: id,
                tanggal, unit, operator, pencapaian, hmAwal, hmAkhir, solar, ket,
                hmTotal: hmAkhir - hmAwal
            };

            saveTriputraData();
            document.getElementById('editTriputraModal').style.display = 'none';
            showToast("Sukses", `Laporan Triputra ${unit} diperbarui. Stok solar disesuaikan ${Math.round(solarDifference)} L.`, "success"); // Pembulatan
            window.fetchTriputraData();
        }

        // --- FUNGSI BARU: DELETE TRIPUTRA REPORT ---
        window.deleteTriputraReport = function(id) {
            if (!confirm("Anda yakin ingin menghapus laporan Triputra ini? Stok Solar akan dikembalikan (refund).")) return;

            const index = triputraData.findIndex(r => r.id == id);
            if (index === -1) return showToast("Error", "Data laporan tidak ditemukan.", "error");
            
            const deletedReport = triputraData[index];
            const solarRefund = deletedReport.solar;
            
            // Refund Solar
            triputraFuelStock += solarRefund;
            logStockChange('Refund Hapus', solarRefund, `Penghapusan laporan ${deletedReport.unit} tgl ${formatDate(deletedReport.tanggal)}`);

            // Hapus Data
            triputraData.splice(index, 1);
            saveTriputraData();
            
            showToast("Dihapus", `Laporan dihapus. Stok solar dikembalikan ${Math.round(solarRefund)} L.`, "success"); // Pembulatan
            window.fetchTriputraData();
        }
        
        // --- FITUR LANDSCAPE KHUSUS TRIPUTRA ---
        function renderTriputraLandscape(reports, period, category) {
            const table = document.getElementById('triputraReportTable');
            table.innerHTML = ''; table.classList.add('landscape-mode');
            
            // Tentukan metrik apa yang ditampilkan
            let metricKey = 'hmTotal';
            let metricLabel = 'HM';
            if (category === 'solar') { metricKey = 'solar'; metricLabel = 'Solar'; }
            if (category === 'pencapaian') { metricKey = 'pencapaian'; metricLabel = 'Titik'; }
            // Jika All, default ke Pencapaian (karena ini key business metric Triputra)
            if (category === 'all') { metricKey = 'pencapaian'; metricLabel = 'Titik'; }

            const uniqueUnits = [...new Set(reports.map(r => r.unit))].sort();
            
            const dates = [];
            let currentDate = new Date(period.start_str);
            currentDate.setHours(12, 0, 0, 0); 
            const endDate = new Date(period.end_str);
            endDate.setHours(12, 0, 0, 0);

            while (currentDate <= endDate) {
                dates.push(currentDate.toISOString().substring(0, 10));
                currentDate.setDate(currentDate.getDate() + 1);
                currentDate.setHours(12, 0, 0, 0); 
            }
            
            // Build Matrix
            const matrix = {}; // { Unit: { Date: Value } }
            const totals = {}; // { Unit: Total }
            
            uniqueUnits.forEach(u => { matrix[u] = {}; totals[u] = 0; });
            
            reports.forEach(r => {
                const val = r[metricKey];
                if (!matrix[r.unit][r.tanggal]) matrix[r.unit][r.tanggal] = 0;
                matrix[r.unit][r.tanggal] += val;
                totals[r.unit] += val;
            });

            // HEADER
            // Hapus kolom Aksi di mode Landscape
            let headerHTML = `<thead><tr><th class="landscape-key-column" style="background-color: #6f42c1;">Unit / Tanggal (${metricLabel})</th>`;
            dates.forEach(date => {
                const d = new Date(date);
                const day = d.getDate();
                const isLibur = isHolidayOrSundayTriputra(date);
                const holidayClass = isLibur ? 'holiday-column' : '';
                headerHTML += `<th class="hm-cell-landscape ${holidayClass}" title="${formatDate(date)}">${day}</th>`;
            });
            headerHTML += `<th class="total-hm-periode-cell">Total</th></tr></thead>`;
            
            // BODY
            let bodyHTML = '<tbody>';
            uniqueUnits.forEach(unit => {
                let row = `<tr><td style="font-weight:bold; text-align:left;">${unit}</td>`;
                dates.forEach(date => {
                    const val = matrix[unit][date];
                    // Pembulatan
                    const display = val !== undefined ? (metricKey === 'pencapaian' ? val : Math.round(val)) : '-';
                    const isLibur = isHolidayOrSundayTriputra(date);
                    const holidayClass = isLibur ? 'holiday-column' : '';
                    row += `<td class="hm-cell-landscape ${holidayClass}">${display}</td>`;
                });
                // Pembulatan Total
                const totalDisplay = metricKey === 'pencapaian' ? totals[unit] : Math.round(totals[unit]);
                row += `<td class="total-hm-periode-cell">${totalDisplay}</td></tr>`;
                bodyHTML += row;
            });
            bodyHTML += '</tbody>';
            
            table.innerHTML = headerHTML + bodyHTML;
        }

        function renderTriputraCharts(data, workingDaysInPeriod, dailyTargetPerUnit, chartView = 'dashboard') {
            // Destroy existing charts to prevent memory leak and drawing issues
            if(chartTarget) chartTarget.destroy(); chartTarget = null;
            if(chartHM) chartHM.destroy(); chartHM = null;
            if(chartSolar) chartSolar.destroy(); chartSolar = null;
            if(chartTrend) chartTrend.destroy(); chartTrend = null;
            
            const boxTarget = document.getElementById('box-target');
            const boxHM = document.getElementById('box-hm');
            const boxSolar = document.getElementById('box-solar');
            const boxTrend = document.getElementById('box-trend');

            // Reset Default: Show All
            boxTarget.style.display = 'block';
            boxHM.style.display = 'block';
            boxSolar.style.display = 'block';
            boxTrend.style.display = 'block';

            if(chartView === 'trend') {
                boxTarget.style.display = 'none';
                boxHM.style.display = 'none';
                boxSolar.style.display = 'none';
            } else if (chartView === 'comparison' || chartView === 'composition') {
                boxTrend.style.display = 'none';
            } else {
                 // Default dashboard view: ensure all are visible
                 boxTarget.style.display = 'block';
                 boxHM.style.display = 'block';
                 boxSolar.style.display = 'block';
                 boxTrend.style.display = 'block';
            }

            // Calculate Data
            const periodTargetPerUnit = workingDaysInPeriod * dailyTargetPerUnit;

            // Agregasi Data per Unit
            const aggHM = {}, aggSolar = {}, aggPencapaian = {};
            // Agregasi Data per Tanggal (For Trend Chart)
            const aggDaily = {}; 

            data.forEach(d => {
                // Per Unit
                if(!aggHM[d.unit]) { aggHM[d.unit] = 0; aggSolar[d.unit] = 0; aggPencapaian[d.unit] = 0; }
                aggHM[d.unit] += d.hmTotal;
                aggSolar[d.unit] += d.solar;
                aggPencapaian[d.unit] += d.pencapaian;

                // Per Tanggal (Trend)
                if(!aggDaily[d.tanggal]) { aggDaily[d.tanggal] = { pencapaian: 0, hm: 0, solar: 0 }; } // FIX: ADD SOLAR
                aggDaily[d.tanggal].pencapaian += d.pencapaian;
                aggDaily[d.tanggal].hm += d.hmTotal;
                aggDaily[d.tanggal].solar += d.solar; // FIX: AGGREGATE SOLAR
            });

            // --- CONFIG GENERATOR ---
            const createConfig = (label, data, color, title, type = 'bar', targetLineVal = null) => {
                const isPie = chartView === 'composition';
                const chartType = isPie ? 'doughnut' : type;
                const colors = isPie ? ['#6f42c1', '#28a745', '#0d6efd', '#ffc107', '#dc3545', '#0dcaf0', '#e83e8c'] : color;

                // Pembulatan data chart
                const roundedData = Object.values(data).map(val => Math.round(val));

                const datasets = [{
                    label: label,
                    data: roundedData,
                    backgroundColor: colors,
                    borderColor: isPie ? '#fff' : color,
                    borderWidth: 1,
                    order: 2
                }];

                if (targetLineVal !== null && !isPie) {
                    datasets.push({
                        label: `Target (${Math.round(targetLineVal)} Titik)`,
                        data: new Array(Object.keys(data).length).fill(Math.round(targetLineVal)), // Pembulatan
                        borderColor: '#dc3545',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        type: 'line',
                        pointRadius: 0,
                        fill: false,
                        order: 1
                    });
                }

                return {
                    type: chartType,
                    data: {
                        labels: Object.keys(data),
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            title: { display: true, text: title },
                            legend: { display: true },
                            datalabels: { // Pastikan datalabels juga dibulatkan
                                formatter: (value) => Math.round(value),
                                color: isPie ? 'white' : 'black', 
                                font: { weight: 'bold', size: 10 }
                            }
                        }
                    }
                };
            };
            
            // Ensure canvas is ready
            document.getElementById('box-target').innerHTML = '<canvas id="triChartTarget"></canvas>';
            document.getElementById('box-hm').innerHTML = '<canvas id="triChartHM"></canvas>';
            document.getElementById('box-solar').innerHTML = '<canvas id="triChartSolar"></canvas>';
            document.getElementById('box-trend').innerHTML = '<canvas id="triChartTrend"></canvas>';
            
            // 1. Chart Pencapaian
            chartTarget = new Chart(
                document.getElementById('triChartTarget'), 
                createConfig('Aktual Pencapaian', aggPencapaian, '#28a745', `Pencapaian vs Target (${workingDaysInPeriod} Hari Kerja)`, 'bar', periodTargetPerUnit)
            );

            // 2. Chart HM
            chartHM = new Chart(document.getElementById('triChartHM'), createConfig('Total HM', aggHM, '#0d6efd', 'Total Hour Meter per Unit'));

            // 3. Chart Solar
            chartSolar = new Chart(document.getElementById('triChartSolar'), createConfig('Total Solar (L)', aggSolar, '#ffc107', 'Total Pemakaian Solar per Unit'));
        
            // 4. Chart Trend (Always Line/Combo)
            const sortedDates = Object.keys(aggDaily).sort();
            const dailyPencapaianData = sortedDates.map(d => aggDaily[d].pencapaian);
            const dailyHMData = sortedDates.map(d => Math.round(aggDaily[d].hm)); // Pembulatan
            const dailySolarData = sortedDates.map(d => Math.round(aggDaily[d].solar)); // NEW DATA

            chartTrend = new Chart(document.getElementById('triChartTrend'), {
                type: 'line',
                data: {
                    labels: sortedDates.map(formatDate), // Format tanggal di label X
                    datasets: [
                        {
                            label: 'Pencapaian Titik (Total Harian)',
                            data: dailyPencapaianData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            yAxisID: 'yA',
                            type: 'line',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Total HM Operasi',
                            data: dailyHMData,
                            backgroundColor: 'rgba(0, 123, 255, 0.6)',
                            yAxisID: 'yB',
                            type: 'bar'
                        },
                        { // FIX: NEW DATASET FOR SOLAR
                            label: 'Konsumsi Solar (Ltr)',
                            data: dailySolarData,
                            backgroundColor: 'rgba(255, 193, 7, 0.6)', // Yellow/Orange
                            yAxisID: 'yB',
                            type: 'bar' // Plot as bar on the right axis
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Grafik Tren Harian: Pencapaian vs HM & Solar' },
                         datalabels: { // Pastikan datalabels juga dibulatkan
                            formatter: (value) => Math.round(value),
                            color: 'black', 
                            font: { weight: 'bold', size: 10 }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Tanggal'}, 
                            grid: { display: false },
                            ticks: {
                                callback: function(value, index, values) {
                                    // Hanya tampilkan 1 dari 7 label jika data banyak
                                    return (values.length > 30 && index % 7 !== 0) ? null : this.getLabelForValue(value);
                                }
                            }
                        },
                        yA: {
                            type: 'linear', position: 'left', title: { display: true, text: 'Jml Titik' }, grid: { display: false }
                        },
                        yB: {
                            type: 'linear', position: 'right', title: { display: true, text: 'HM & Solar' }, grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
// ====================================================================
// FUNGSI HANDLE EXPORT TRIPUTRA (PERBAIKAN SAVE IMAGE JPG)
// ====================================================================
window.handleTriputraExport = function() {
    const dropdown = document.getElementById('trp_export_format');
    const format = dropdown.value;
    
    // Jika tidak memilih apa-apa, berhenti
    if (!format) return;

    // --- 1. AMBIL PERIODE SAAT INI ---
    const periodType = document.getElementById('trp_period_select').value;
    const monthSelect = document.getElementById('trp_filter_month');
    let period;
    
    // Cek logika multi-select vs single select
    if ((periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') && monthSelect.multiple) {
            period = getMultipleReportingPeriod(periodType, 'trp_');
    } else {
            period = getReportingPeriod(periodType, 'trp_');
    }

    // --- 2. LOGIKA EXPORT EXCEL (CSV) ---
    if (format === 'csv') {
        const tableContainer = document.createElement('div');
        const periodInfo = document.createElement('p');
        periodInfo.innerHTML = `Periode: ${period.text}`;
        
        // Clone tabel Akumulasi
        const accumTable = document.getElementById('triputraAccumulationTable').cloneNode(true);
        const accumTitle = document.createElement('h3');
        accumTitle.textContent = "Tabel Akumulasi Per Unit (Periode)";
        tableContainer.appendChild(accumTitle);
        tableContainer.appendChild(accumTable);

        // Clone tabel Detail
        const detailTable = document.getElementById('triputraReportTable').cloneNode(true);
        detailTable.querySelectorAll('.triputra-action-column').forEach(el => el.remove()); // Hapus kolom aksi
        const detailTitle = document.createElement('h3');
        detailTitle.textContent = "Tabel Data Laporan Detail";
        tableContainer.appendChild(detailTitle);
        tableContainer.appendChild(detailTable);

        const html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8">
            <style>table{border-collapse:collapse;} td,th{border:1px solid black; padding:5px; text-align:center; font-size: 11px;} th{background-color:#6f42c1; color: white;} .holiday-column {background-color:#ffebee;} h2, h3, p { text-align: left; } .total-hm-periode-cell{background-color:#6f42c1; color:white; font-weight:bold;}</style>
            </head><body>
            <h2>Laporan Operasional Triputra</h2>
            <h2 style="color: #6f42c1; border-bottom: 3px solid #6f42c1;">üè≠ Laporan Khusus Triputra</h2>
            ${periodInfo.outerHTML}
            ${tableContainer.innerHTML}
            </body></html>`;
        
        const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = `Laporan_Triputra_${new Date().toISOString().slice(0, 10)}.xls`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        showToast("Export Sukses", "Data Triputra diekspor ke Excel.", "success");
    
    // --- 3. LOGIKA CETAK PDF ---
    } else if (format.startsWith('print_')) {
        
        const body = document.body;

        // A. Setup Header Cetak
        document.getElementById('print-header').querySelector('h2').textContent = 'Laporan Operasional Sektor Triputra';
        document.getElementById('print-periode-info').textContent = `Periode: ${period.text}`;

        // B. Pastikan Tab Aktif secara visual
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('laporan_triputra').classList.add('active');

        // C. Tambahkan Kelas CSS ke BODY
        body.classList.add('print-triputra'); 

        if (format === 'print_table') body.classList.add('print-table-only');
        else if (format === 'print_chart') body.classList.add('print-chart-only');

        // D. Eksekusi Print Browser
        window.print();

        // E. Bersihkan Kelas CSS
        setTimeout(() => {
            body.classList.remove('print-triputra', 'print-table-only', 'print-chart-only');
            document.querySelector('.tab-button.triputra-tab').classList.add('active');
        }, 500);

    // --- 4. LOGIKA SIMPAN GAMBAR (JPG) [FIXED] ---
    } else if (format.startsWith('save_img_')) {
        
        // Pastikan Tab Triputra Terlihat Penuh
        const tabContent = document.getElementById('laporan_triputra');
        
        if (format === 'save_img_chart') {
            // [FIX] Hapus pengecekan innerText karena Canvas itu kosong text-nya
            // Cukup cek apakah elemennya ada
            const chartContainer = document.getElementById('triputraChartsContainer');
            if (chartContainer) {
                // Pastikan display grid aktif agar ter-render html2canvas
                chartContainer.style.display = 'grid'; 
                saveDivAsImage('triputraChartsContainer', 'Grafik_Triputra');
            } else {
                alert("Container Grafik tidak ditemukan.");
            }
        } 
        else if (format === 'save_img_table') {
            // Cek apakah tabel ada
            const tableSection = document.getElementById('triputraTableSection');
            if (tableSection) {
                tableSection.style.display = 'block';
                saveDivAsImage('triputraTableSection', 'Tabel_Triputra');
            } else {
                alert("Tabel tidak ditemukan.");
            }
        } 
        else if (format === 'save_img_both') {
            // Capture seluruh tab Laporan Triputra
            if (tabContent) {
                saveDivAsImage('laporan_triputra', 'Laporan_Triputra_Full');
            }
        }
    }
    
    // --- 5. RESET DROPDOWN ---
    dropdown.value = "";
}
        // FUNGSI clearTriputraData DIHILANGKAN SESUAI PERMINTAAN USER

        // ============================================

      document.addEventListener('DOMContentLoaded', async (event) => {
    // A. Tampilkan Pesan Loading
    if(typeof showToast === 'function') showToast("System", "Memuat Database & Konfigurasi...", "info");

    // B. Load Database & Master Data
    // await loadMasterDataFromLocalStorage();
    //if(typeof loadPayrollSettings === 'function') await loadPayrollSettings();
    //if(typeof loadTrackingData === 'function') await loadTrackingData();
    //if(typeof window.updateTrackingUnitDropdown === 'function') window.updateTrackingUnitDropdown();

    // C. [PENTING] Update Dropdown Tahun Terlebih Dahulu!
    updateYearDropdown(); 

    // D. Inisialisasi Filter Bulan per Tab (Setalah Tahun Siap)
    
    // 1. Tab Laporan Harian
    const mainPeriod = document.getElementById('period_select');
    if(mainPeriod) {
        mainPeriod.value = 'custom_monthly_21_20';
        updateMonthRange('custom_monthly_21_20', ''); 
    }

    // 2. Tab Analisa Availability
    const availPeriod = document.getElementById('avail_period_select');
    if(availPeriod) {
        availPeriod.value = 'custom_monthly_21_20';
        updateMonthRange('custom_monthly_21_20', 'avail_');
    }

    // 3. Tab Triputra
    const trpPeriod = document.getElementById('trp_period_select');
    if(trpPeriod) {
        trpPeriod.value = 'custom_monthly_21_20';
        updateMonthRange('custom_monthly_21_20', 'trp_');
        if(typeof updateTriputraOperatorDropdown === 'function') updateTriputraOperatorDropdown();
    }

    // 4. Tab Absensi (FIX UTAMA DI SINI)
    const absPeriod = document.getElementById('abs_period_select');
    if(absPeriod) {
        absPeriod.value = 'custom_monthly_21_20';
        // Paksa update bulan dengan prefix 'abs_'
        // Ini akan membaca tahun dari 'abs_filter_year' yang sudah diisi di langkah C
        updateMonthRange('custom_monthly_21_20', 'abs_'); 
        
        // Panggil fetch data agar tabel tidak kosong saat dibuka
        if(typeof window.fetchAttendanceData === 'function') window.fetchAttendanceData();
    }

    // E. Setup UI Lainnya
    const displayView = document.getElementById('display_view');
    if(displayView) displayView.value = 'both';
    
    const inputBody = document.getElementById('reportInputBody');
    if(inputBody) inputBody.innerHTML = '';
    
    batchImageCache = {}; 
    
    // Tambah baris kosong awal
    if(typeof window.addRow === 'function') window.addRow(); 
    if(typeof window.addTriputraRow === 'function') window.addTriputraRow();

    if(typeof updateOperatorDatalist === 'function') updateOperatorDatalist(); 
    if(typeof handleTabSwitching === 'function') handleTabSwitching();
    
    // Set Tab Aktif Awal (Input Batch)
    const defaultTab = document.querySelector('.tab-button[data-tab="input"]');
    if (defaultTab) {
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        defaultTab.classList.add('active');
        const inputTab = document.getElementById('input');
        if(inputTab) inputTab.classList.add('active');
    }
    
    if(typeof updateFilterUnitDropdown === 'function') updateFilterUnitDropdown(); 
    if(typeof updateFilterSektorDropdown === 'function') updateFilterSektorDropdown(); 
    
    // Fetch Data Laporan Utama
    if(typeof window.fetchReportData === 'function') window.fetchReportData(); 
    
    // Cek Storage
    if(typeof window.checkStorage === 'function') window.checkStorage();

    // Init Datepicker tanggal hari ini untuk form-form
    const setToday = (id) => { const el = document.getElementById(id); if(el) el.value = new Date().toISOString().substring(0, 10); };
    setToday('fast_tanggal');
    setToday('sarana_date');
    setToday('fuel_date');

    // Event Klik Modal (Tutup saat klik luar)
    window.onclick = function(event) {
        const modals = ['imageZoomModal', 'editReportModal', 'masterDataModal', 'stockHistoryModal', 'editTriputraModal', 'trackingDetailModal', 'bulkUploadModal', 'trackingModal', 'editFuelModal', 'payrollExportModal', 'payrollModal', 'manualInputModal', 'longLeaveModal', 'editSaranaModal'];
        modals.forEach(id => {
            const m = document.getElementById(id);
            if (m && event.target == m) m.style.display = "none";
        });
    }
// --- FUNGSI EXPORT LAPORAN TAHUNAN (MA & PA BULANAN) ---
// GANTI SELURUH FUNGSI INI
// GANTI SELURUH FUNGSI INI
window.exportAnnualAvailabilityExcel = function() {
    const year = parseInt(document.getElementById('avail_filter_year').value);
    const targetHour = parseFloat(document.getElementById('avail_target_hour').value) || 12;
    const sektorFilter = document.getElementById('avail_filter_sektor').value;
    
    // Filter laporan tahunan
    let annualReports = reportsData.filter(r => new Date(r.tanggal).getFullYear() === year);

    // Filter Sektor dari Dropdown (Jika user memilih specifik)
    if (sektorFilter !== 'all') {
        annualReports = annualReports.filter(r => r.klasifikasi_sektor === sektorFilter);
    }

    if (annualReports.length === 0) {
        showToast("Data Kosong", `Tidak ada laporan ditemukan untuk tahun ${year}.`, "error");
        return;
    }

    // --- 1. Persiapan Data & Mapping ---
    const unitMap = {};
    const months = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]; 
    const uniqueUnits = [...new Set(annualReports.map(r => r.unit))].sort();

    uniqueUnits.forEach(unit => {
        const sample = annualReports.find(r => r.unit === unit);
        const master = masterUnits[unit] || {};
        
        // AMBIL RAW SEKTOR (Data Asli)
        let rawSektor = master.sektor_default || (sample ? sample.sektor : 'LAIN-LAIN'); // Ambil sektor asli, bukan klasifikasi
        if (!rawSektor) rawSektor = 'LAIN-LAIN';
        rawSektor = rawSektor.toUpperCase().trim();

        // LOGIKA PENGGABUNGAN IHM (Senoni, UK 2, Terunen -> IHM)
        let groupSektor = rawSektor;
        if (['SENONI', 'UK 2', 'TERUNEN', 'IHM', 'TERUNAN'].includes(rawSektor)) {
            groupSektor = 'IHM';
        } 
        // Anda bisa menambahkan else if untuk grup lain jika perlu

        unitMap[unit] = {
            operator: master.operator_default || (sample ? sample.operator : '-'),
            model: master.model_default || (sample ? sample.model : '-'),
            sektor: groupSektor, // Gunakan sektor yang sudah digabung
            monthlyStats: {}
        };
        months.forEach(m => unitMap[unit].monthlyStats[m] = { ma: null, pa: null, hasData: false });
    });

    // Hitung Statistik per Bulan
    months.forEach(month => {
        const monthlyReports = annualReports.filter(r => new Date(r.tanggal).getMonth() === month);
        if (monthlyReports.length > 0) {
            const dates = monthlyReports.map(r => r.tanggal).sort();
            const workingDays = countWorkingDays(new Date(dates[0]), new Date(dates[dates.length - 1]));
            const analysis = AnalisaAvailability(monthlyReports, workingDays, targetHour, 'unit');
            analysis.forEach(res => {
                if (unitMap[res.key]) {
                    unitMap[res.key].monthlyStats[month] = { ma: res.MA, pa: res.PA, hasData: true };
                }
            });
        }
    });

    // --- 2. Definisi Style ---
    const styles = {
        title: { font: { bold: true, sz: 14 }, alignment: { horizontal: "left" } },
        sectorTitle: { 
            fill: { fgColor: { rgb: "0D6EFD" } }, // Biru
            font: { color: { rgb: "FFFFFF" }, bold: true, sz: 12 },
            border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        },
        header: {
            fill: { fgColor: { rgb: "212529" } }, // Hitam
            font: { color: { rgb: "FFFFFF" }, bold: true },
            alignment: { horizontal: "center", vertical: "center" },
            border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        },
        footer: {
            fill: { fgColor: { rgb: "E9ECEF" } }, // Abu-abu
            font: { bold: true },
            border: { top: {style:'double'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} }
        },
        high: { fill: { fgColor: { rgb: "D4EDDA" } }, font: { color: { rgb: "155724" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } },
        medium: { fill: { fgColor: { rgb: "FFF3CD" } }, font: { color: { rgb: "856404" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } },
        low: { fill: { fgColor: { rgb: "F8D7DA" } }, font: { color: { rgb: "721C24" } }, alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } },
        normal: { alignment: { horizontal: "center" }, border: { top: {style:'thin'}, bottom: {style:'thin'}, left: {style:'thin'}, right: {style:'thin'} } }
    };

    const getStyleForValue = (val, type) => {
        if (val === '-' || val === null) return styles.normal;
        const num = typeof val === 'string' ? parseFloat(val) : val;
        if (type === 'ma') {
            if (num >= 85) return styles.high;
            if (num < 70) return styles.low;
            return styles.medium;
        } else {
            if (num >= 75) return styles.high;
            if (num < 60) return styles.low;
            return styles.medium;
        }
    };

    // --- 3. Fungsi Membuat Sheet ---
    const createStyledSheet = (type) => { 
        const tableHeader = [
            'Nama Operator', 'Kode Unit', 'Merk/Model', 'Target',
            'Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun',
            'Jul', 'Agt', 'Sep', 'Okt', 'Nov', 'Des',
            'Rata-Rata'
        ];
        
        const wsData = [
            [`Laporan Tahunan ${type.toUpperCase()} - Tahun ${year}`],
            [`Target Jam Operasi: ${targetHour} Jam/Hari`],
            [] 
        ];

        // Kelompokkan Unit berdasarkan Sektor (YANG SUDAH DIGABUNG KE IHM)
        const unitsBySector = {};
        uniqueUnits.forEach(u => {
            const s = unitMap[u].sektor; // Ini sudah berisi 'IHM' untuk Senoni/UK2/Terunen
            if (!unitsBySector[s]) unitsBySector[s] = [];
            unitsBySector[s].push(u);
        });

        // Loop Setiap Sektor
        Object.keys(unitsBySector).sort().forEach(sectorName => {
            const unitsInSector = unitsBySector[sectorName];
            
            // Header Sektor
            wsData.push([`SEKTOR: ${sectorName}`, '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
            wsData.push(tableHeader);

            const colSums = new Array(12).fill(0);
            const colCounts = new Array(12).fill(0);
            let totalAvgSum = 0; let totalAvgCount = 0;

            unitsInSector.forEach(unit => {
                const d = unitMap[unit];
                const row = [d.operator, unit, d.model, targetHour];
                let rowSum = 0; let rowCount = 0;

                months.forEach(m => {
                    const stat = d.monthlyStats[m];
                    if (stat.hasData) {
                        const val = type === 'ma' ? stat.ma : stat.pa;
                        row.push(Math.round(val) + "%");
                        rowSum += val; rowCount++;
                        colSums[m] += val; colCounts[m]++;
                    } else {
                        row.push('-');
                    }
                });

                const unitAvg = rowCount > 0 ? (rowSum / rowCount) : 0;
                row.push(Math.round(unitAvg) + "%");
                if (rowCount > 0) { totalAvgSum += unitAvg; totalAvgCount++; }
                
                wsData.push(row);
            });

            // Footer Sektor
            const footerRow = [`TOTAL RATA-RATA (${sectorName})`, '', '', targetHour];
            months.forEach(m => {
                footerRow.push(colCounts[m] > 0 ? Math.round(colSums[m] / colCounts[m]) + "%" : '-');
            });
            const grandAvg = totalAvgCount > 0 ? (totalAvgSum / totalAvgCount) : 0;
            footerRow.push(Math.round(grandAvg) + "%");
            wsData.push(footerRow);

            // Pemisah
            wsData.push([]); 
            wsData.push([]); 
        });

        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // --- APLIKASIKAN STYLING ---
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
            const firstCellVal = wsData[R] ? wsData[R][0] : null;

            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cellRef]) continue;
                const val = ws[cellRef].v;

                if (typeof firstCellVal === 'string' && firstCellVal.startsWith('SEKTOR:')) {
                    ws[cellRef].s = styles.sectorTitle;
                } 
                else if (val === 'Nama Operator' || val === 'Kode Unit' || (wsData[R] && wsData[R][0] === 'Nama Operator')) {
                    ws[cellRef].s = styles.header;
                }
                else if (typeof firstCellVal === 'string' && firstCellVal.startsWith('TOTAL RATA-RATA')) {
                    ws[cellRef].s = styles.footer;
                    if (C >= 4 && C <= 16) ws[cellRef].s = { ...styles.footer, ...getStyleForValue(val, type) };
                }
                else if (C >= 4 && C <= 16 && R > 2) {
                    if(firstCellVal !== '' && firstCellVal !== null) {
                         ws[cellRef].s = getStyleForValue(val, type);
                    }
                } 
                else if (R > 2 && firstCellVal !== '' && firstCellVal !== null && !firstCellVal.startsWith('SEKTOR:')) {
                    ws[cellRef].s = styles.normal;
                }
            }
            
            if (typeof firstCellVal === 'string' && firstCellVal.startsWith('SEKTOR:')) {
                if(!ws['!merges']) ws['!merges'] = [];
                ws['!merges'].push({ s: {r:R, c:0}, e: {r:R, c:16} });
            }
            if (typeof firstCellVal === 'string' && firstCellVal.startsWith('TOTAL RATA-RATA')) {
                 if(!ws['!merges']) ws['!merges'] = [];
                 ws['!merges'].push({ s: {r:R, c:0}, e: {r:R, c:2} });
            }
        }
        
        if(!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({ s: {r:0, c:0}, e: {r:0, c:16} }); 
        
        ws['!cols'] = [{wch: 25}, {wch: 15}, {wch: 15}, {wch: 8}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 6}, {wch: 10}];

        return ws;
    };

    // 4. Generate
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, createStyledSheet('ma'), "Annual MA");
    XLSX.utils.book_append_sheet(wb, createStyledSheet('pa'), "Annual PA");
    XLSX.writeFile(wb, `Analisa_Tahunan_${year}_${new Date().toISOString().slice(0, 10)}.xlsx`);
    showToast("Export Sukses", "Laporan Tahunan per Sektor berhasil didownload.", "success");
};         
// --- FUNGSI FORMAT BYTES KE KB/MB/GB ---
function formatBytes(bytes, decimals = 2) {
    if (!+bytes) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
}

// --- FUNGSI CEK KAPASITAS STORAGE ---
window.checkStorage = async function() {
    // Cek apakah browser mendukung fitur ini
    if (navigator.storage && navigator.storage.estimate) {
        try {
            const estimate = await navigator.storage.estimate();
            
            // usage: byte yang terpakai
            // quota: total byte yang diizinkan browser (biasanya tergantung sisa disk space HP/Laptop)
            const used = estimate.usage || 0;
            const quota = estimate.quota || 0;
            
            const percent = quota > 0 ? (used / quota) * 100 : 0;
            
            // Update UI Teks
            const usedStr = formatBytes(used);
            const quotaStr = formatBytes(quota);
            
            document.getElementById('storageUsedDisplay').innerHTML = `Terpakai: <span style="color:#d63384">${usedStr}</span> (${percent.toFixed(2)}%)`;
            document.getElementById('storageQuotaDisplay').textContent = `Kapasitas Browser: ${quotaStr}`;
            
            // Update Progress Bar
            const bar = document.getElementById('storageProgressBar');
            bar.style.width = `${percent}%`;
            
            // Ubah warna bar jika mau penuh (Kuning > 50%, Merah > 80%)
            if (percent > 80) {
                bar.style.background = '#dc3545'; // Merah
            } else if (percent > 50) {
                bar.style.background = '#ffc107'; // Kuning
            } else {
                bar.style.background = 'linear-gradient(90deg, #00bcd4, #006064)'; // Biru Teal
            }

        } catch (error) {
            console.error("Storage Check Error:", error);
            document.getElementById('storageUsedDisplay').textContent = "Gagal memuat info memori.";
        }
    } else {
        document.getElementById('storageUsedDisplay').textContent = "Browser tidak mendukung fitur cek memori.";
    }
};

            window.onclick = function(event) {
                if (event.target == document.getElementById('imageZoomModal')) document.getElementById('imageZoomModal').style.display = "none";
                if (event.target == document.getElementById('editReportModal')) document.getElementById('editReportModal').style.display = "none";
                if (event.target == document.getElementById('masterDataModal')) document.getElementById('masterDataModal').style.display = "none";
                if (event.target == document.getElementById('stockHistoryModal')) document.getElementById('stockHistoryModal').style.display = "none";
                if (event.target == document.getElementById('editTriputraModal')) document.getElementById('editTriputraModal').style.display = "none";
                if (event.target == document.getElementById('trackingDetailModal')) document.getElementById('trackingDetailModal').style.display = "none";
            }
        });// ==========================================
    // === 1. FITUR SAVE AS IMAGE (html2canvas) ===
    // ==========================================
    // ==========================================
    // === 1. FITUR SAVE AS IMAGE (html2canvas) ===
    // ==========================================
    // ============================================================
    // === 1. ENGINE: SAVE AS IMAGE (FULL TABLE SUPPORT) ===
    // ============================================================
    function saveDivAsImage(elementId, fileName) {
        const element = document.getElementById(elementId);
        if (!element) {
            alert("Elemen tidak ditemukan (ID salah) atau data kosong.");
            return;
        }

        // A. PERSIAPAN AGAR TABEL TIDAK TERPOTONG
        // Kita simpan style asli dulu
        const originalOverflow = element.style.overflow;
        const originalMaxHeight = element.style.maxHeight;
        const originalHeight = element.style.height;

        // Kita paksa elemen melebar penuh agar html2canvas bisa baca semua isinya
        // (Ini kunci agar scroll hilang dan semua data terlihat)
        element.style.overflow = 'visible'; 
        element.style.maxHeight = 'none';
        element.style.height = 'auto';
        
        // Tambah class untuk menyembunyikan tombol (Clean UI)
        document.body.classList.add('taking-screenshot');
        
        // Scroll ke posisi elemen agar render lebih akurat
        element.scrollIntoView(); 

        showToast("Memproses Gambar...", "Sedang merender tabel panjang, mohon tunggu...", "info");

        // B. PROSES CAPTURE
        // Tunggu 800ms agar CSS render ulang (re-flow) selesai sebelum difoto
        setTimeout(() => {
            html2canvas(element, {
                scale: 2, // Resolusi Tinggi
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff', // Latar putih bersih
                windowWidth: element.scrollWidth, // Paksa canvas selebar konten asli
                windowHeight: element.scrollHeight // Paksa canvas setinggi konten asli
            }).then(canvas => {
                // C. DOWNLOAD
                const link = document.createElement('a');
                link.download = `${fileName}_${new Date().toISOString().slice(0, 10)}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
                
                // D. CLEANUP (KEMBALIKAN SEPERTI SEMULA)
                document.body.classList.remove('taking-screenshot');
                element.style.overflow = originalOverflow;
                element.style.maxHeight = originalMaxHeight;
                element.style.height = originalHeight;
                
                showToast("Sukses", "Gambar berhasil disimpan.", "success");
            }).catch(err => {
                console.error(err);
                document.body.classList.remove('taking-screenshot');
                // Restore style jika error
                element.style.overflow = originalOverflow;
                element.style.maxHeight = originalMaxHeight;
                element.style.height = originalHeight;
                showToast("Error", "Gagal menyimpan gambar.", "error");
            });
        }, 800); 
    }

    // ============================================================
    // === 2. ENGINE: PRINT PDF HELPER ===
    // ============================================================
// ==========================================
// === FUNGSI EKSEKUSI CETAK (FIXED) ===
// ==========================================
function executePrint(mode, tabId) {
    // 1. Setup Judul Header Cetak (Elemen khusus yang hanya muncul saat print)
    const periodInfoText = document.getElementById('periode-info').textContent;
    const printInfo = document.getElementById('print-periode-info');
    const printHeaderH2 = document.querySelector('#print-header h2');
    
    if(printInfo) printInfo.textContent = periodInfoText;

    // Atur Judul Halaman sesuai Tab
    let title = "Laporan Harian Operasi";
    if(tabId === 'analisa_ketersediaan') title = "Analisa Ketersediaan Alat (MA/PA)";
    if(tabId === 'laporan_triputra') title = "Laporan Operasional Triputra";
    if(printHeaderH2) printHeaderH2.textContent = title;

    // 2. Bersihkan Class Mode Cetak Sebelumnya
    document.body.classList.remove('print-chart-only', 'print-table-only', 'print-both', 'print-ma-pa', 'print-triputra', 'print-pr-mode');

    // 3. Paksa Tab yang mau diprint menjadi AKTIF
    // (Ini penting karena display:none pada tab container induk sering bikin blank)
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); // Hide all manual
    const targetTab = document.getElementById(tabId);
    if(targetTab) {
        targetTab.classList.add('active');
        targetTab.style.display = 'block'; // Force display block
    }

    // 4. Tambahkan Class ke Body (Pemicu CSS @media print)
    if (tabId === 'analisa_ketersediaan') document.body.classList.add('print-ma-pa');
    else if (tabId === 'laporan_triputra') document.body.classList.add('print-triputra');
    else {
        // Default Laporan Harian
        if (mode === 'print_chart') document.body.classList.add('print-chart-only');
        else if (mode === 'print_table') document.body.classList.add('print-table-only');
        else document.body.classList.add('print-both');
    }

    // 5. Eksekusi Print dengan Delay Kecil (Memberi waktu browser render ulang layout)
    setTimeout(() => {
        window.print();
        
        // 6. Cleanup (Kembalikan Tampilan Normal setelah dialog print tutup)
        // Kita beri delay agak lama untuk memastikan print dialog sudah selesai mengambil preview
        setTimeout(() => {
            document.body.classList.remove('print-chart-only', 'print-table-only', 'print-both', 'print-ma-pa', 'print-triputra', 'print-pr-mode');
            
            // Restore Tab Display (Kembalikan ke kontrol CSS normal)
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = ''); 
            
            // Kembalikan Tab Aktif Visual
            document.querySelector(`.tab-button[data-tab="${tabId}"]`)?.click();
        }, 1000);
    }, 500);
}


    // ============================================================
    // === 3. EXPORT HANDLERS (PENGHUBUNG DROPDOWN) ===
    // ============================================================

    // --- HANDLER TAB 1: LAPORAN HARIAN ---
    // Backup fungsi original (untuk CSV)
    const _oriHandleExport = window.handleExport; 
window.handleExport = function() {
    const dropdown = document.getElementById('export_format');
    const val = dropdown.value;
    if (!val) return;

    // --- LOGIKA BARU UNTUK PAYROLL ---
    if (val === 'export_payroll') {
        // Buka modal setting tarif dulu
        document.getElementById('payrollExportModal').style.display = 'block';
        dropdown.value = ""; // Reset dropdown
        return;
    }
    // ---------------------------------

    // Logic Simpan Gambar
    if (val.startsWith('save_img_')) {
        if (val === 'save_img_chart') {
             if(document.getElementById('chartContainer').innerText.includes('Tidak ada')) return alert('Grafik kosong.');
             saveDivAsImage('chartContainer', 'Grafik_Harian');
        }
        else if (val === 'save_img_table') saveDivAsImage('tableSection', 'Tabel_Harian'); 
        else if (val === 'save_img_both') saveDivAsImage('laporan', 'Laporan_Harian_Full');
    } 
    // Logic Cetak PDF
    else if (val.startsWith('print_')) {
        executePrint(val, 'laporan');
    }
    // Logic CSV/Excel Biasa
    else if (val === 'csv') {
         if (typeof _oriHandleExport === 'function') _oriHandleExport.apply(this);
         else {
             // Fallback jika fungsi asli hilang
             const reports = reportsData; // Gunakan data global
             const period = getReportingPeriod(document.getElementById('period_select').value, '');
             const excelHTML = generateExcelTable(reports, 'detailed', `Periode: ${period.text}`);
             const blob = new Blob([excelHTML], { type: "application/vnd.ms-excel;charset=utf-8" });
             const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
             a.download = `Data_Mentah_${new Date().toISOString().slice(0, 10)}.xls`;
             document.body.appendChild(a); a.click(); document.body.removeChild(a);
         }
    }

    if(val !== 'csv') dropdown.value = ""; 
};

// 2. FUNGSI GENERATE EXCEL PAYROLL (SESUAI GAMBAR & REQUEST)
// ==========================================
// ==========================================
// === FUNGSI FORMAT NAMA UNIT (CUSTOM) ===
// ==========================================
function formatSpecificUnitName(unitCode, modelName) {
    if (!unitCode) return "-";
    
    // Normalisasi teks (Huruf besar semua & hilangkan spasi berlebih)
    const u = unitCode.toUpperCase().trim(); // Cth: "AUM 17"
    const m = (modelName || "").toUpperCase().trim();
    
    // Ambil Angka dari Kode Unit (Cth: "17" dari "AUM 17")
    const numMatch = u.match(/\d+/);
    const num = numMatch ? numMatch[0] : "";

    // --- LOGIKA MAPPING SESUAI REQUEST ---
    
    // 1. KOBELCO SK200 (AUM 17)
    if (u.includes("17")) return `KOBELCO SK200 EXC-${num}`;
    
    // 2. KOMATSU PC200 (AUM 29)
    if (u.includes("29")) return `KOMATSU PC 200 EXC-${num}`;
    
    // 3. LIUGONG MOTOR GRADER (AUM 33, 45)
    if (u.includes("33") || u.includes("45")) return `LIUGONG MG-${num}`;
    
    // 4. SEM VIBRO (AUM 63, 64)
    if (u.includes("63") || u.includes("64")) return `SEM VIBRO - ${num}`;
    
    // 5. LIUGONG VIBRO (AUM 32)
    if (u.includes("32")) return `LIUGONG VIBRO - ${num}`;
    
    // 6. NEW HOLLAND BHL (AUM 46)
    if (u.includes("46")) return `NEW HOLLAND BHL - ${num}`;
    
    // 7. SANY VIBRO (AUM 41)
    if (u.includes("41")) return `SANY VIBRO - ${num}`;
    
    // 8. SHANTUI DOZER (AUM 43)
    if (u.includes("43")) return `SHANTUI DOZER DZ - ${num}`;

    // Default Fallback (Jika unit lain tidak ada di daftar khusus)
    // Format: MERK MODEL - NOMOR
    return `${u} ${m}`; 
}

// ==========================================
// === FUNGSI EXPORT PAYROLL (UPDATED) ===
// ==========================================
// ==========================================
window.generatePayrollExcel = function() {
    // 1. Ambil Tarif
    const rateMakan = parseFloat(document.getElementById('pay_rate_makan').value) || 0;
    const rateTransport = parseFloat(document.getElementById('pay_rate_transport').value) || 0;
    const rateLembur = 15000; 
    const rateBonus = 15000;

    // 2. Ambil Periode & Data
    const periodType = document.getElementById('period_select').value;
    let periodInfo;
    if (typeof getMultipleReportingPeriod === 'function') {
         periodInfo = getMultipleReportingPeriod(periodType, '');
    } else {
         periodInfo = getReportingPeriod(periodType, '');
    }

    let finalReports = reportsData.filter(report => isDateInPeriod(report.tanggal, periodInfo.start_str, periodInfo.end_str));
    const selectedSektor = document.getElementById('filter_sektor').value;
    if (selectedSektor !== 'all') {
        finalReports = finalReports.filter(r => r.klasifikasi_sektor === selectedSektor);
    }

    if (finalReports.length === 0) {
        alert("Tidak ada data laporan untuk diexport.");
        return;
    }

    // 3. Grouping
    const groupedByOp = finalReports.reduce((acc, curr) => {
        const opName = curr.operator ? curr.operator.trim().toUpperCase() : "TANPA_NAMA";
        if(!acc[opName]) acc[opName] = [];
        acc[opName].push(curr);
        return acc;
    }, {});

    const wb = XLSX.utils.book_new();

    // Loop Operator
    Object.keys(groupedByOp).sort().forEach(opName => {
        const opData = groupedByOp[opName];
        opData.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

        // Logika Header Unit Utama
        const dailyGroups = {};
        opData.forEach(r => { if (!dailyGroups[r.tanggal]) dailyGroups[r.tanggal] = []; dailyGroups[r.tanggal].push(r); });
        const cleanOpData = []; 
        Object.keys(dailyGroups).sort().forEach(date => {
            const entries = dailyGroups[date];
            entries.sort((a, b) => (parseFloat(b.jam_operasi)||0) - (parseFloat(a.jam_operasi)||0));
            cleanOpData.push(entries[0]);
        });
        const sortedByLatest = [...cleanOpData].sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        let primaryUnitRaw = sortedByLatest[0].unit;
        const workingEntry = sortedByLatest.find(r => (parseFloat(r.jam_operasi) || 0) > 0);
        if (workingEntry) primaryUnitRaw = workingEntry.unit;

        const unitInfo = (typeof getUnitTarget === 'function') ? getUnitTarget(primaryUnitRaw) : { type: "Alat Berat", target: 220 }; 
        const targetHM = unitInfo.target;

        // ==========================================
        // TAHAP 1: DATA UTAMA
        // ==========================================
        
        let no = 1;
        let totalHMReal = 0; 
        let sumMakan = 0, sumTrans = 0, sumLembur = 0;
        let breakdownDays = [];
        const mainRows = [];

        cleanOpData.forEach(r => {
            const hm = parseFloat(r.jam_operasi) || 0;
            const ketUpper = (r.keterangan || "").toUpperCase(); // Ambil keterangan uppercase
            totalHMReal += hm;

            // --- PERBAIKAN LOGIKA GAJI ---
            let uMakan = 0, uTrans = 0, uLembur = 0;

            // 1. Cek Blacklist (Absen / Salah Operator)
            // Jika mengandung kata-kata ini, TIDAK DAPAT UANG MAKAN
            const isAbsen = ["SAKIT", "IJIN", "IZIN", "CUTI", "ALPHA", "MANGKIR", "NO OPERATOR", "NO OP"].some(keyword => ketUpper.includes(keyword));

            if (!isAbsen) {
                // Jika BUKAN absen, baru cek kelayakan
                if (hm >= 1) { 
                    uMakan = rateMakan; 
                    uTrans = rateTransport; 
                } 
                // Cek jika HM 0 tapi ada kata "OP" (misal: "Standby OP", "Service OP")
                // Karena "NO OP" sudah difilter di atas, aman pakai includes("OP")
                else if (hm < 1 && ketUpper.includes("OP")) { 
                    uMakan = rateMakan; 
                }
            }

            // Lembur (HM >= 10)
            if (hm >= 10) { uLembur = rateLembur; }

            sumMakan += uMakan; sumTrans += uTrans; sumLembur += uLembur;

            // Logika Poin
            if (hm < 3) {
                const k = (r.kategori_keterangan || "").toUpperCase();
                const d = ketUpper;
                
                // Cek Kesalahan Operator (Skip Poin)
                if (d.includes("SAKIT") || d.includes("IJIN") || d.includes("IZIN") || d.includes("ALPHA") || d.includes("MANGKIR") || d.includes("CUTI") || d.includes("NO OP")) {
                    // No Point
                }
                // Cek Kendala Teknis/Alam (Dapat Poin)
                else if (k.includes('BREAKDOWN') || k.includes('CUACA') || k.includes('IDLE') || 
                         d.includes('RUSAK') || d.includes('HUJAN') || d.includes('WAITING') || 
                         d.includes('STANDBY') || d.includes('FUEL') || d.includes('SOLAR') || d.includes('LAMBAT')) {
                    
                    breakdownDays.push({ date: r.tanggal, reason: r.keterangan || r.kategori_keterangan });
                }
            }

            const customUnitName = (typeof getCustomUnitName === 'function') ? getCustomUnitName(r.unit) : r.unit;

            mainRows.push([
                no++, 
                getIndonesianDayName(r.tanggal), 
                formatDate(r.tanggal),
                customUnitName, 
                parseFloat(r.hm_awal), parseFloat(r.hm_akhir), 
                hm,
                r.keterangan || '-', 
                uMakan, 
                uTrans, 
                uLembur
            ]);
        });

        const totalGaji = sumMakan + sumTrans + sumLembur;

        // ==========================================
        // TAHAP 2: TABEL ANALISA (KANAN)
        // ==========================================
        
        const analysisRows = [];
        analysisRows.push(["ANALISA PERFORMANCE & BONUS", "", ""]);
        analysisRows.push(["ITEM", "DETAIL / KETERANGAN", "NILAI"]);

        analysisRows.push(["Target Minimum", ":", targetHM + " HM"]);
        analysisRows.push(["HM Aktual", ":", parseFloat(totalHMReal.toFixed(1)) + " HM"]);

        let grandTotalHM = totalHMReal;
        let totalPoin = 0;

        if (totalHMReal >= targetHM) {
            const selisih = totalHMReal - targetHM;
            const bonusRp = selisih * rateBonus;
            
            analysisRows.push(["Status Awal", ":", "MELEBIHI TARGET ‚úÖ"]);
            analysisRows.push(["Kelebihan Jam", ":", parseFloat(selisih.toFixed(1)) + " HM"]);
            analysisRows.push(["Rate Bonus", ":", "Rp " + rateBonus.toLocaleString('id-ID')]);
            analysisRows.push(["Total Bonus", ":", "Rp " + bonusRp.toLocaleString('id-ID')]);
            analysisRows.push(["", "", ""]); 
            analysisRows.push(["TOTAL TAKE HOME PAY", ":", "Rp " + (totalGaji + bonusRp).toLocaleString('id-ID')]);
            
        } else {
            analysisRows.push(["Status Awal", ":", "DI BAWAH TARGET ‚ö†Ô∏è"]);
            analysisRows.push(["", "", ""]);
            analysisRows.push(["RINCIAN POIN KOMPENSASI", "", ""]); 
            
            if (breakdownDays.length > 0) {
                breakdownDays.forEach(bd => {
                    const poinVal = 7.3; 
                    totalPoin += poinVal;
                    analysisRows.push([`${formatDate(bd.date)}`, bd.reason, "7.3 HM"]);
                });
                totalPoin = parseFloat(totalPoin.toFixed(1));
                analysisRows.push(["TOTAL POIN", ":", totalPoin + " HM"]);
            } else {
                analysisRows.push(["Tidak ada kendala sistem/alam", "-", "0 HM"]);
            }

            grandTotalHM = parseFloat((totalHMReal + totalPoin).toFixed(1));
            analysisRows.push(["", "", ""]);
            analysisRows.push(["TOTAL AKHIR (HM + POIN)", ":", grandTotalHM + " HM"]);

            if (grandTotalHM >= targetHM) {
                analysisRows.push(["KESIMPULAN", ":", "TARGET TERCAPAI ‚úÖ"]);
                analysisRows.push(["TINDAKAN", ":", "Gaji Dibayar Penuh"]);
                analysisRows.push(["TOTAL DITERIMA", ":", "Rp " + totalGaji.toLocaleString('id-ID')]);
            } else {
                const kekurangan = targetHM - grandTotalHM;
                analysisRows.push(["KESIMPULAN", ":", "TIDAK TERCAPAI ‚ùå"]);
                analysisRows.push(["KEKURANGAN", ":", parseFloat(kekurangan.toFixed(1)) + " HM"]);
                analysisRows.push(["TINDAKAN", ":", "POTONGAN GAJI BERLAKU"]);
            }
        }

        // ==========================================
        // TAHAP 3: MERGE DATA KE SHEET
        // ==========================================
        const wsData = [];

        wsData.push(["LAPORAN JAM KERJA & PERFORMANCE OPERATOR"]);
        wsData.push(["PERIODE: " + periodInfo.text]);
        wsData.push([]); 
        wsData.push(["NAMA OPERATOR", ": " + opName]);
        wsData.push(["UNIT / ALAT", ": " + getCustomUnitName(primaryUnitRaw)]); 
        wsData.push(["SEKTOR", ": " + (selectedSektor === 'all' ? 'SEMUA' : selectedSektor)]);
        wsData.push([]); 

        const mainHeaderRow = [
            "NO", "HARI", "TANGGAL", "UNIT / ALAT", 
            "AWAL", "AKHIR", "TOTAL", 
            "KETERANGAN", 
            "UANG MAKAN", "TRANSPORT", "LEMBUR"
        ];

        // Header Gabungan
        const combinedHeader = [...mainHeaderRow, "", ...analysisRows[0]]; 
        wsData.push(combinedHeader);

        // Sub-Header Analisa
        const subHeaderRow = ["", "", "", "", "", "", "", "", "", "", "", "", ...analysisRows[1]];
        wsData.push(subHeaderRow);

        // Loop Gabungan
        const analysisDataOnly = analysisRows.slice(2);
        const maxRows = Math.max(mainRows.length, analysisDataOnly.length);

        for (let i = 0; i < maxRows; i++) {
            const leftRow = mainRows[i] || ["", "", "", "", "", "", "", "", "", "", ""]; 
            const rightRow = analysisDataOnly[i] || ["", "", ""]; 
            wsData.push([...leftRow, "", ...rightRow]);
        }

        wsData.push([]); 
        
        // --- BARIS TOTAL ---
        const totalRow = [
            "TOTAL", "", "", "", "", "", totalHMReal, "", sumMakan, sumTrans, sumLembur, 
            "", "", "", "" 
        ];
        wsData.push(totalRow);
        
        // --- BARIS TAKE HOME PAY ---
        const thpRow = [
            "TAKE HOME PAY", "", "", "", "", "", "", "", "Rp " + totalGaji.toLocaleString('id-ID'), "", "",
            "", "", "", ""
        ];
        wsData.push(thpRow);

        wsData.push([]); wsData.push([]);
        wsData.push(["Dibuat Oleh,", "", "", "", "", "Disetujui Oleh,"]);
        wsData.push([]); wsData.push([]); wsData.push([]);
        wsData.push(["( Admin )", "", "", "", "", "( Pimpinan )"]);

        // ==========================================
        // TAHAP 4: STYLING & MERGING FINAL
        // ==========================================
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        if(!ws['!merges']) ws['!merges'] = [];

        ws['!merges'].push({ s: {r:0, c:0}, e: {r:0, c:10} });
        ws['!merges'].push({ s: {r:1, c:0}, e: {r:1, c:10} });

        const range = XLSX.utils.decode_range(ws['!ref']);
        const borderStyle = { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} };
        
        const headerRowIdx = 7; 
        const subHeaderRowIdx = 8;
        const dataStartIdx = 9;
        const dataEndIdx = dataStartIdx + maxRows - 1;

        for(let R = range.s.r; R <= range.e.r; ++R) {
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r:R, c:C});
                if(!ws[addr]) continue;

                // --- STYLING TABEL KIRI (0-10) ---
                if (C <= 10) {
                    if (R === headerRowIdx) {
                        ws[addr].s = { font:{bold:true}, fill:{fgColor:{rgb:"FFFF00"}}, border:borderStyle, alignment:{horizontal:"center"} };
                    }
                    else if (R >= dataStartIdx && R <= dataEndIdx) {
                        if (mainRows[R - dataStartIdx]) {
                            ws[addr].s = { border: borderStyle, alignment:{vertical:"center", wrapText: true} };
                            if ([0,1,4,5,6,8,9,10].includes(C)) ws[addr].s.alignment = {horizontal:"center", vertical:"center"};

                            // --- LOGIKA PEWARNAAN HM (Index 6) ---
                            if (C === 6) {
                                const valHM = parseFloat(ws[addr].v) || 0;
                                if (valHM === 0) {
                                    ws[addr].s.fill = { fgColor: { rgb: "F8D7DA" } }; // Merah Muda
                                    ws[addr].s.font = { color: { rgb: "721C24" }, bold: true };
                                } else if (valHM >= 10) {
                                    ws[addr].s.fill = { fgColor: { rgb: "D4EDDA" } }; // Hijau Muda
                                    ws[addr].s.font = { color: { rgb: "155724" }, bold: true };
                                }
                            }
                        }
                    }
                    // BARIS TOTAL & TAKE HOME PAY
                    else if (wsData[R][0] === "TOTAL" || wsData[R][0] === "TAKE HOME PAY") {
                        ws[addr].s = { font:{bold:true}, fill:{fgColor:{rgb:"E0E0E0"}}, border:borderStyle };
                        
                        if (wsData[R][0] === "TOTAL") {
                            if (C === 0) {
                                ws['!merges'].push({ s: {r:R, c:0}, e: {r:R, c:5} });
                                ws[addr].s.alignment = {horizontal:"right", vertical:"center"}; 
                            }
                        }

                        if (wsData[R][0] === "TAKE HOME PAY") {
                            if (C === 0) {
                                 ws['!merges'].push({ s: {r:R, c:0}, e: {r:R, c:7} });
                                 ws[addr].s.alignment = {horizontal:"right", vertical:"center"};
                            }
                            if (C === 8) {
                                 ws['!merges'].push({ s: {r:R, c:8}, e: {r:R, c:10} });
                                 ws[addr].s.alignment = {horizontal:"right", vertical:"center", indent:1}; 
                                 ws[addr].s.font = {bold:true, sz:11}; 
                            }
                        }
                    }
                }

                // --- STYLING TABEL KANAN (12-14) ---
                if (C >= 12 && C <= 14) {
                    if (R === headerRowIdx) {
                        ws[addr].s = { font:{bold:true, color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"0D6EFD"}}, border:borderStyle, alignment:{horizontal:"center"} };
                        if (C === 12) ws['!merges'].push({ s: {r:R, c:12}, e: {r:R, c:14} });
                    }
                    else if (R === subHeaderRowIdx) {
                        ws[addr].s = { font:{bold:true}, fill:{fgColor:{rgb:"B0E0E6"}}, border:borderStyle, alignment:{horizontal:"center"} };
                    }
                    else if (R >= dataStartIdx && R <= dataEndIdx) {
                        if (analysisDataOnly[R - dataStartIdx]) {
                            ws[addr].s = { border: borderStyle, alignment: { vertical: "top", wrapText: true } };
                            
                            const txt = String(ws[addr].v);
                            if (txt.includes("TOTAL") || txt.includes("KESIMPULAN")) {
                                ws[addr].s = { font:{bold:true}, fill:{fgColor:{rgb:"FFFACD"}}, border:borderStyle };
                            }
                            if (txt.includes("‚úÖ")) ws[addr].s.font = { color:{rgb:"008000"}, bold:true };
                            if (txt.includes("‚ùå")) ws[addr].s.font = { color:{rgb:"FF0000"}, bold:true };
                        }
                    }
                }
            }
        }

        ws['!cols'] = [
            {wch:5},  // 0: No
            {wch:12}, // 1: Hari
            {wch:12}, // 2: Tgl
            {wch:35}, // 3: UNIT
            {wch:8},  // 4: Awal
            {wch:8},  // 5: Akhir
            {wch:8},  // 6: Total
            {wch:35}, // 7: Keterangan
            {wch:12}, // 8: Makan
            {wch:12}, // 9: Trans
            {wch:12}, // 10: Lembur
            {wch:3},  // 11: Spacer
            {wch:22}, // 12: ITEM
            {wch:45}, // 13: DETAIL
            {wch:15}  // 14: NILAI
        ];

        const sheetName = opName.replace(/[\/\?\*\[\]\\]/g, '').substring(0, 30);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    XLSX.writeFile(wb, `Payroll_SideBySide_${selectedSektor}_${periodInfo.text.replace(/[\/\s]/g, '_')}.xlsx`);
    document.getElementById('payrollExportModal').style.display = 'none';
    if (typeof showToast === 'function') showToast("Export Selesai", "Laporan berhasil didownload.", "success");
}
// 1. FUNGSI SIMPAN KE DATABASE
window.savePayrollSettings = async function() {
    const settings = {
        limit1: document.getElementById('pay_limit_1').value,
        limit2: document.getElementById('pay_limit_2').value,
        rate1: document.getElementById('pay_rate_1').value,
        rate2: document.getElementById('pay_rate_2').value,
        rate3: document.getElementById('pay_rate_3').value
    };

    try {
        await idb.set('DOR_PayrollSettings', settings);
        showToast("Sukses", "Setting Gaji berhasil disimpan permanen.", "success");
    } catch (e) {
        console.error(e);
        showToast("Error", "Gagal menyimpan setting.", "error");
    }
};

// 2. FUNGSI LOAD DARI DATABASE (Dipanggil saat start)
async function loadPayrollSettings() {
    try {
        const settings = await idb.get('DOR_PayrollSettings');
        if (settings) {
            if(settings.limit1) document.getElementById('pay_limit_1').value = settings.limit1;
            if(settings.limit2) document.getElementById('pay_limit_2').value = settings.limit2;
            if(settings.rate1) document.getElementById('pay_rate_1').value = settings.rate1;
            if(settings.rate2) document.getElementById('pay_rate_2').value = settings.rate2;
            if(settings.rate3) document.getElementById('pay_rate_3').value = settings.rate3;
        }
    } catch (e) {
        console.error("Gagal load setting gaji", e);
    }
}

// --- FUNGSI EXPORT EXCEL PAYROLL ---
// --- [UPDATE] EXPORT EXCEL PAYROLL (FORMAT RAPI + BORDER + JUDUL) ---
// --- [UPDATE FINAL] EXPORT EXCEL PAYROLL + KETERANGAN DI BAWAH ---
// ==========================================================================
// 1. SINGLE SHEET EXPORT (HTML BASE) - DENGAN WARNA PER KATA
// ==========================================================================
window.exportPayrollExcel = function() {
    const table = document.getElementById('payrollTable');
    if (!table || table.rows.length <= 2) {
        return alert("Tabel kosong. Silakan hitung gaji terlebih dahulu.");
    }

    // 1. Ambil Info
    let periodTextRaw = document.getElementById('trp-periode-info').textContent || "";
    let periodText = periodTextRaw.split('|')[0].replace('Periode Filter:', '').trim(); 

    // 2. Ambil Setting Tarif & Limit
    const l1 = document.getElementById('pay_limit_1').value;
    const l2 = document.getElementById('pay_limit_2').value;
    const r1 = parseFloat(document.getElementById('pay_rate_1').value).toLocaleString('id-ID');
    const r2 = parseFloat(document.getElementById('pay_rate_2').value).toLocaleString('id-ID');
    const r3 = parseFloat(document.getElementById('pay_rate_3').value).toLocaleString('id-ID');

    // 3. Header HTML
    let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: Arial, sans-serif; }
            table { border-collapse: collapse; width: 100%; }
            td, th { border: 1px solid #000000; padding: 6px; font-size: 11px; vertical-align: middle; }
            
            .title-header { font-size: 16px; font-weight: bold; text-align: center; height: 30px; border: none; }
            .period-header { font-size: 12px; text-align: center; margin-bottom: 10px; border: none; }
            .thead-green { background-color: #198754; color: #ffffff; font-weight: bold; text-align: center; }
            .tfoot-gray { background-color: #e9ecef; font-weight: bold; }
            .legend-title { background-color: #f8f9fa; font-weight: bold; text-align: left; border: 1px solid #000; }
            .legend-item { text-align: left; border: 1px solid #000; color: #555; }
            
            /* WARNA TIER DI TABEL */
            .tier-1 { color: #198754; font-weight: bold; } /* Hijau */
            .tier-2 { color: #d63384; font-weight: bold; } /* Pink/Ungu */
            .tier-3 { color: #0d6efd; font-weight: bold; } /* Biru */

            .text-center { text-align: center; }
            .text-right { text-align: right; }
            .text-left { text-align: left; }
            .text-bold { font-weight: bold; }
        </style>
    </head>
    <body>
        <table>
            <tr><td colspan="6" class="title-header">Laporan Perhitungan Gaji Triputra</td></tr>
            <tr><td colspan="6" class="period-header">Periode: ${periodText}</td></tr>
            <tr><td colspan="6" style="border:none;"></td></tr> 

            <thead>
                <tr class="thead-green">
                    <th>Tanggal</th>
                    <th>Unit</th>
                    <th>Operator</th>
                    <th>Total Titik</th>
                    <th>Rincian Perhitungan</th>
                    <th>Total Pendapatan (Rp)</th>
                </tr>
            </thead>
            
            <tbody>
    `;

    // 4. Loop Data (Mengambil InnerHTML agar span warna terbawa)
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(tr => {
        html += '<tr>';
        const cells = tr.querySelectorAll('td');
        cells.forEach((td, index) => {
            let styleClass = 'text-left';
            // Gunakan innerHTML untuk kolom Rincian (index 4) agar warna TIER tetap ada
            let content = index === 4 ? td.innerHTML : td.innerText; 
            
            if (index === 0) styleClass = 'text-center'; 
            if (index === 3) styleClass = 'text-center text-bold'; 
            if (index === 5) styleClass = 'text-right text-bold'; 
            
            html += `<td class="${styleClass}">${content}</td>`;
        });
        html += '</tr>';
    });

    html += `</tbody>`;

    // 5. Footer Total
    const tfoot = table.querySelector('tfoot tr');
    if (tfoot) {
        html += `<tfoot class="tfoot-gray"><tr>`;
        const cells = tfoot.querySelectorAll('td');
        cells.forEach((td, index) => {
            const colspan = td.getAttribute('colspan') || 1;
            let align = 'text-center';
            if (index === 0 || td.innerText.includes('Rp')) align = 'text-right';
            html += `<td class="${align}" colspan="${colspan}">${td.innerText}</td>`;
        });
        html += `</tr></tfoot>`;
    }

    // 6. LEGENDA (Keterangan Rumus & Warna)
    html += `
        <tr><td colspan="6" style="border:none; height:15px;"></td></tr>
        <tr><td colspan="6" class="legend-title">KETERANGAN & RUMUS:</td></tr>
        <tr>
            <td colspan="6" class="legend-item">
                <span class="tier-1">‚Ä¢ Tier 1 (Dasar):</span> 
                Pencapaian 0 s/d ${l1} titik dikali <b>Rp ${r1}</b>
            </td>
        </tr>
        <tr>
            <td colspan="6" class="legend-item">
                <span class="tier-2">‚Ä¢ Tier 2 (Menengah):</span> 
                Kelebihan di atas ${l1} s/d ${l2} dikali <b>Rp ${r2}</b>
            </td>
        </tr>
        <tr>
            <td colspan="6" class="legend-item">
                <span class="tier-3">‚Ä¢ Tier 3 (Atas):</span> 
                Sisa kelebihan di atas ${l2} dikali <b>Rp ${r3}</b>
            </td>
        </tr>
        <tr>
            <td colspan="6" class="legend-item" style="font-style:italic;">
                *Total Pendapatan adalah penjumlahan hasil perkalian dari setiap Tier yang dicapai.
            </td>
        </tr>
    `;

    html += `</table></body></html>`;

    const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Laporan_Gaji_Triputra_${new Date().toISOString().slice(0,10)}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showToast("Export Sukses", "File Excel Single Sheet berhasil diunduh.", "success");
}
window.renderReportTable = function(groupedData, isGrouped, groupingKey) {
    const table = document.getElementById('dailyReportTable');
    table.innerHTML = ''; 
    table.classList.remove('landscape-mode'); 
    
    // --- PERBAIKAN: HAPUS CAPTION (JUDUL DALAM TABEL) ---
    if (table.caption) table.removeChild(table.caption);
    
    // --- PERBAIKAN: UPDATE JUDUL DI HEADER CETAK (LUAR TABEL) ---
    const periodInfoText = document.getElementById('periode-info').textContent;
    const printInfo = document.getElementById('print-periode-info');
    
    // Update teks Header Cetak agar sesuai dengan filter saat ini
    if (printInfo) {
        // Format: "Tabel Data Laporan - Periode: ..."
        printInfo.textContent = `Tabel Data Laporan - ${periodInfoText.replace('Periode: ', '')}`;
    }

    const headerRow = table.createTHead();
    let headerHTML = '';

    // Cek apakah filter kolom foto aktif
    const showPhotos = document.getElementById('show_photos').value === 'show';
    const photoDisplay = showPhotos ? '' : 'display:none;';

    if (isGrouped) {
         headerHTML += `<tr><th style="width: 250px;" class="text-left">${(groupingKey === 'unit') ? 'Unit/Alat' : 'Operator'}</th><th>Total Hari</th><th>Total HM</th><th>Total Jam</th><th>Total Solar</th></tr>`;
    } else {
        headerHTML += `<tr>
            <th rowspan="2" class="action-column" style="width:80px;">Aksi</th>
            <th rowspan="2" class="col-date-report">Tanggal</th>
            <th rowspan="2" class="col-unit-report">Unit/Alat</th>
            <th rowspan="2" class="col-op-report">Operator</th>
            <th rowspan="2" class="col-sektor-report">Sektor</th>
            <th colspan="3">HM</th><th colspan="3">Jam Kerja</th>
            <th rowspan="2" class="col-solar-report">Solar</th>
            <th rowspan="2">Kategori</th>
            <th rowspan="2" class="photo-column-header" style="${photoDisplay}; width:130px;">Dokumentasi</th>
            <th rowspan="2" class="keterangan-column-header">Keterangan</th>
        </tr>
        <tr>
            <th>Awal</th><th>Akhir</th><th>Total</th>
            <th>In</th><th>Out</th><th>Total</th>
        </tr>`;
    }
    headerRow.innerHTML = headerHTML;
    
    let tbodyHTML = '<tbody>';
    const sortedKeys = Object.keys(groupedData).sort((a, b) => new Date(b) - new Date(a));
    
    sortedKeys.forEach(key => {
        const group = groupedData[key];
        if (isGrouped) {
            let tHM=0, tSolar=0, tWork=0;
            group.forEach(r=>{tHM+=r.jam_operasi; tSolar+=r.total_solar; tWork+=r.work_hours;});
            tbodyHTML += `<tr class="group-total-row"><td>${key}</td><td>${group.length}</td><td>${Math.round(tHM)}</td><td>${Math.round(tWork)}</td><td>${Math.round(tSolar)}</td></tr>`;
        } else {
            group.forEach(r => {
                const idx = reportsData.indexOf(r);
                const hmClass = r.jam_operasi >= 8 ? 'hm-high' : 'hm-low';
                const catStyle = r.kategori_keterangan === 'BREAKDOWN' ? 'style="background-color:#f8d7da;color:#721c24;font-weight:bold;"' : '';
                
                let photoHTML = '<span style="color:#ccc;">-</span>';
                if (r.foto_timesheet || r.foto_awal || r.foto_akhir) {
                    photoHTML = `<div class="photo-grid">`;
                    if(r.foto_timesheet && r.foto_timesheet.length > 50) photoHTML += `<img src="${r.foto_timesheet}" title="Timesheet" onclick="window.zoomImage(this.src)">`;
                    if(r.foto_awal && r.foto_awal.length > 50) photoHTML += `<img src="${r.foto_awal}" title="HM Awal" onclick="window.zoomImage(this.src)">`;
                    if(r.foto_akhir && r.foto_akhir.length > 50) photoHTML += `<img src="${r.foto_akhir}" title="HM Akhir" onclick="window.zoomImage(this.src)">`;
                    photoHTML += `</div>`;
                }

                tbodyHTML += `<tr>
                    <td class="action-column">
                        <div style="display:flex; justify-content:center; gap:5px;">
                            <input type="checkbox" class="report-checkbox" value="${idx}">
                            <button class="action-button edit-report-button" onclick="window.editReport(${idx})">‚úèÔ∏è</button>
                        </div>
                    </td>
                    <td>${formatDate(r.tanggal)}</td>
                    <td class="text-left">${r.unit}</td>
                    <td class="text-left">${r.operator}</td>
                    <td class="text-left">${r.sektor}</td>
                    <td>${r.hm_awal}</td><td>${r.hm_akhir}</td>
                    <td class="${hmClass}">${Math.round(r.jam_operasi)}</td>
                    <td>${r.time_in}</td><td>${r.time_out}</td><td>${Math.round(r.work_hours)}</td>
                    <td>${Math.round(r.total_solar)}</td>
                    <td ${catStyle}>${r.kategori_keterangan}</td>
                    <td class="report-photo-cell" style="${photoDisplay}">
                       ${photoHTML}
                    </td>
                    <td class="text-left">${r.keterangan || '-'}</td>
                </tr>`;
            });
        }
    });
    tbodyHTML += '</tbody>';
    table.innerHTML += tbodyHTML;
}
    window.toggleSelectAllReports = function(s) {
        document.querySelectorAll('.report-checkbox').forEach(c => c.checked = s.checked);
    }

    window.deleteSelectedReports = function() {
        const checkboxes = document.querySelectorAll('.report-checkbox:checked');
        if (checkboxes.length === 0) return alert("Pilih data dulu.");
        if (!confirm(`Hapus ${checkboxes.length} data laporan permanen?`)) return;

        // Ambil index dan urutkan descending (wajib agar tidak geser)
        const indexes = Array.from(checkboxes).map(c => parseInt(c.value)).sort((a,b) => b - a);
        
        indexes.forEach(idx => {
            if(reportsData[idx]) reportsData.splice(idx, 1);
        });

        saveReportsDataToLocalStorage();
        window.fetchReportData();
        window.fetchAvailabilityData();
        showToast("Sukses", `${indexes.length} data dihapus.`, "success");
    }// ============================================
    // === MODUL ABSENSI KARYAWAN (OTOMATIS) ===
    // ============================================

    // 1. Logic Utama Penentuan Kode
    // ==========================================
// === LOGIKA ABSENSI & EXPORT EXCEL ===
// ==========================================

// 1. Logika Cerdas Menentukan Kode Absen
// GANTI FUNGSI INI SEPENUHNYA
// ==========================================
// === LOGIKA PENENTUAN KODE ABSENSI (UPDATE FUEL = SBD) ===
// ==========================================
function determineAttendanceCode(reports) {
    if (!reports || reports.length === 0) return 'A';

    // Hitung Jam Kerja
    const totalHM = reports.reduce((sum, r) => sum + (parseFloat(r.jam_operasi) || 0), 0);
    const totalTimesheet = reports.reduce((sum, r) => sum + (parseFloat(r.work_hours) || 0), 0);

    // Gabungkan semua keterangan menjadi satu string huruf kecil
    const combinedKet = reports.map(r => (r.keterangan || "").toLowerCase()).join(" ");
    const combinedCat = reports.map(r => (r.kategori_keterangan || "").toUpperCase()).join(" ");

    // --- PRIORITAS 1: AKTIVITAS PRODUKTIF (Hadir) ---
    // Jika ada HM (meskipun sedikit), tetap dihitung Hadir
    if (totalHM > 0 || totalTimesheet > 0) {
        if (combinedKet.includes('pulang cepat') || combinedKet.includes('pc ')) return 'PC'; 
        return 'H'; 
    }

    // --- PRIORITAS 2: NON-PRODUKTIF (Cek Keterangan) ---

    // A. Status Permanen (Putih)
    if (combinedKet.includes('resign') || combinedKet.includes('keluar') || combinedKet.includes('berhenti')) return 'X';

    // B. Cuti & Off (Orange)
    if (combinedKet.includes('cuti')) return 'CT';
    if (combinedKet.includes('off') || combinedKet.includes('libur') || combinedKet.includes('roster')) return 'OFF';

    // C. Sakit & Izin (Pink)
    if (combinedKet.includes('sakit')) return 'S';
    if (combinedKet.includes('izin') || combinedKet.includes('ijin')) return 'I';

    // D. Service, Breakdown, & MASALAH FUEL (Kuning - SBD)
    // Cek Standby Service (SS)
    if (combinedKet.includes('service') || combinedKet.includes('servis') || combinedKet.includes('maintenance')) return 'SS';
    
    // Cek Breakdown (SBD) - TERMASUK MENUNGGU SPAREPART & FUEL
    if (combinedCat.includes('BREAKDOWN') || 
        combinedKet.includes('breakdown') || 
        combinedKet.includes('rusak') || 
        combinedKet.includes('tunggu mekanik') || 
        combinedKet.includes('menunggu mekanik') || 
        combinedKet.includes('sparepart') || 
        combinedKet.includes('tunggu part') ||
        combinedKet.includes('sarana') ||
        combinedKet.includes('menunggu part') ||
        combinedKet.includes('tunggu alat') ||
        // --- TAMBAHAN KHUSUS FUEL/SOLAR (SBD) ---
        combinedKet.includes('fuel') ||       // Cth: Standby Fuel, Waiting Fuel
        combinedKet.includes('solar') ||      // Cth: Tunggu Solar, Solar Habis
        combinedKet.includes('bbm') ||        // Cth: Tunggu BBM
        combinedKet.includes('minyak') ||
        combinedKet.includes('telat') ||      // Cth: Fuel Telat
        combinedKet.includes('lambat')) {     // Cth: Solar Terlambat
        return 'SBD';
    }

    // E. Cuaca & Standby Lain (Hijau Pucat)
    // Jika mengandung kata "Standby" TAPI TIDAK mengandung kata Fuel/Solar/Rusak (karena sudah dicek diatas),
    // maka masuk ke sini.
    if (combinedCat.includes('CUACA') || combinedKet.includes('hujan')) return 'SH';
    if (combinedKet.includes('standby') || combinedKet.includes('stb') || combinedKet.includes('pengantaran') || combinedKet.includes('tidak ada sarana') || combinedKet.includes('no operator')) return 'Stb';

    // F. Sisanya Alpha (Merah)
    return 'A'; 
}
// --- HELPER BARU: DETEKSI SEKTOR OPERATOR ---
function getOperatorDominantSector(operatorName, reportsInPeriod) {
    // 1. Cari sektor dari laporan yang ada di periode ini
    const opReports = reportsInPeriod.filter(r => r.operator === operatorName);
    
    if (opReports.length > 0) {
        // Ambil sektor terakhir yang dia kerjakan
        // (Atau bisa logika 'most frequent', tapi terakhir biasanya cukup akurat)
        return opReports[opReports.length - 1].klasifikasi_sektor; 
    }

    // 2. Jika tidak ada laporan (Alpha terus), cek di Master Unit
    // Cari unit dimana operator ini menjadi default
    for (const unitKey in masterUnits) {
        if (masterUnits[unitKey].operator_default === operatorName) {
            // Gunakan fungsi klasifikasi yang sudah ada untuk standarisasi
            return getSektorClassification(masterUnits[unitKey].sektor_default);
        }
    }

    return 'TRIPUTRA'; // Default jika tidak diketahui (anggap Libur Minggu)
}

// --- HELPER BARU: CEK LIBUR BERDASARKAN SEKTOR ---
function isHolidayBySector(dateString, sektorKlasifikasi) {
    const date = new Date(dateString);
    const day = date.getDay(); // 0 = Minggu
    const isNational = holidays.includes(dateString); // Cek array global 'holidays'

    // 1. Libur Nasional berlaku untuk SEMUA Sektor
    if (isNational) return true;

    // 2. Cek Hari Minggu
    if (day === 0) {
        // Normalisasi teks
        const sec = (sektorKlasifikasi || '').toUpperCase();

        // KWL dan IHM (termasuk Terunen/Senoni) = TETAP MASUK (Bukan Libur)
        if (sec === 'KWL' || sec === 'IHM') {
            return false; 
        }
        
        // Triputra dan Lainnya = LIBUR
        return true; 
    }

    return false; // Hari Biasa (Senin-Sabtu) = Masuk
}
// 2. Fungsi Fetch & Render Tabel Absensi
// GANTI SELURUH FUNGSI fetchAttendanceData DENGAN INI
// UPDATE LOGIKA UTAMA ABSENSI DENGAN FILTER SEKTOR
// ====================================================================
// FUNGSI FETCH ABSENSI (GABUNGAN DATA UMUM + TRIPUTRA)
// ====================================================================
window.fetchAttendanceData = function() {
    const periodType = document.getElementById('abs_period_select').value;
    const monthSelect = document.getElementById('abs_filter_month');
    const selectedSektorFilter = document.getElementById('abs_filter_sektor').value;

    if (monthSelect.options.length === 0) { window.updateMonthRange(periodType, 'abs_'); }

    let period;
    if ((periodType === 'calendar_monthly' || periodType === 'custom_monthly_21_20') && monthSelect.multiple) {
            period = getMultipleReportingPeriod(periodType, 'abs_');
    } else {
            period = getReportingPeriod(periodType, 'abs_');
    }

    // Generate Tanggal
    const dates = [];
    let currentDate = new Date(period.start_str);
    currentDate.setHours(12, 0, 0, 0);
    const endDate = new Date(period.end_str);
    endDate.setHours(12, 0, 0, 0);

    while (currentDate <= endDate) {
        dates.push(currentDate.toISOString().substring(0, 10));
        currentDate.setDate(currentDate.getDate() + 1);
        currentDate.setHours(12, 0, 0, 0);
    }

    // --- [UPDATE: PENGGABUNGAN SUMBER DATA] ---
    
    // 1. Ambil Data dari Laporan Harian Umum
    const generalReports = reportsData.filter(r => isDateInPeriod(r.tanggal, period.start_str, period.end_str));

    // 2. Ambil Data dari Laporan Khusus Triputra & Normalisasi Format
    const triputraReports = triputraData
        .filter(r => isDateInPeriod(r.tanggal, period.start_str, period.end_str))
        .map(t => {
            // Kita petakan field Triputra agar sesuai dengan struktur General Reports
            const jamOp = parseFloat(t.hmTotal) || 0;
            const ket = t.ket || "";
            
            return {
                tanggal: t.tanggal,
                unit: t.unit,
                operator: t.operator,
                sektor: "TRIPUTRA",           // Paksa Sektor jadi Triputra
                klasifikasi_sektor: "TRIPUTRA",
                jam_operasi: jamOp,
                work_hours: 0,                // Triputra biasanya tidak pakai jam masuk/keluar
                keterangan: ket,
                // PENTING: Auto-detect kategori (Breakdown/Hujan) agar kode absen SBD/SH muncul
                kategori_keterangan: getKeteranganCategory(ket, jamOp), 
                hm_awal: t.hmAwal,
                hm_akhir: t.hmAkhir,
                total_solar: t.solar
            };
        });

    // 3. Gabungkan Kedua Data
    const activeReports = [...generalReports, ...triputraReports];
    // ------------------------------------------

    const reportOps = activeReports.map(r => r.operator);
    let allOperators = [...new Set([...masterOperators, ...reportOps])].sort();
    allOperators = allOperators.filter(op => op && op.trim() !== ""); 

    // Render Header
    const table = document.getElementById('attendanceTable');
    const thead = table.querySelector('thead');
    const tbody = document.getElementById('attendanceBody');

    // Header Nama & Sektor
    let headerHTML = `<tr>
        <th style="background-color: #6f42c1; color: white; min-width: 150px; z-index: 20;">Nama Karyawan</th>
        <th style="background-color: #6f42c1; color: white; min-width: 80px;">Sektor</th>`;
        
    // Header Tanggal
    dates.forEach(date => {
        const d = new Date(date);
        const day = d.getDay();
        const isVisualRed = (day === 0 || holidays.includes(date)); 
        const bg = isVisualRed ? '#dc3545' : '#f8f9fa';
        const color = isVisualRed ? 'white' : 'black';
        headerHTML += `<th style="background-color: ${bg}; color: ${color}; min-width: 30px;">${d.getDate()}</th>`;
    });
    
    // Header Summary
    headerHTML += `<th style="background-color:#e3f2fd; color:#0d47a1; border-left:3px solid #ccc;">H</th>
                   <th style="background-color:#fff3cd; color:#856404;">SBD</th>
                   <th style="background-color:#fff3cd; color:#856404;">SS</th>
                   <th style="background-color:#f8d7da; color:#721c24;">S</th>
                   <th style="background-color:#f8d7da; color:#721c24;">I</th>
                   <th style="background-color:#f8d7da; color:#721c24;">PC</th>
                   <th style="background-color:#fd7e14; color:white;">OFF</th>
                   <th style="background-color:#fd7e14; color:white;">CT</th>
                   <th style="background-color:#dc3545; color:white;">A</th>
                   <th style="background-color:#212529; color:white; border-left:3px solid #ccc;">%</th></tr>`;
    thead.innerHTML = headerHTML;

    tbody.innerHTML = '';
    
    if (allOperators.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${dates.length + 12}" style="text-align:center; padding:20px;">Belum ada data.</td></tr>`;
        return;
    }

    let displayedCount = 0;

    allOperators.forEach(op => {
        // Cek Sektor Dominan (Sekarang sudah termasuk data Triputra)
        const opSector = getOperatorDominantSector(op, activeReports);
        
        if (selectedSektorFilter !== 'all' && opSector !== selectedSektorFilter) return;

        displayedCount++;

        let rowHTML = `<tr>
            <td style="font-weight:bold; text-align:left; position:sticky; left:0; background:#fff; z-index:10;">${op}</td>
            <td style="font-size:10px; color:#666;">${opSector}</td>`;
        
        let counts = { H:0, SBD:0, SS:0, S:0, I:0, PC:0, OFF:0, CT:0, A:0 };

        dates.forEach(date => {
            // Filter dari Data Gabungan (General + Triputra)
            const dailyReports = activeReports.filter(r => r.operator === op && r.tanggal === date);
            
            let code = 'A'; 
            let cellClass = 'st-a';
            let tooltip = 'Alpha';

            if (dailyReports.length > 0) {
                // Fungsi ini akan bekerja normal karena struktur data Triputra sudah disamakan di atas
                code = determineAttendanceCode(dailyReports);
                tooltip = dailyReports.map(r => `${r.unit}: ${r.keterangan||'-'}`).join('\n');
            }

            const isSectorHoliday = isHolidayBySector(date, opSector);

            if (isSectorHoliday && code === 'A') {
                code = ''; cellClass = ''; tooltip = `Libur (${opSector})`;
            } else if (!isSectorHoliday && code === 'A') {
                code = 'A'; cellClass = 'st-a';
            }

            if (code === 'H') cellClass = 'st-h'; 
            else if (code === 'SBD') cellClass = 'st-sbd';
            else if (code === 'SS') cellClass = 'st-ss'; 
            else if (code === 'S') cellClass = 'st-s'; 
            else if (code === 'I') cellClass = 'st-i'; 
            else if (code === 'PC') cellClass = 'st-pc'; 
            else if (code === 'OFF') cellClass = 'st-off'; 
            else if (code === 'CT') cellClass = 'st-ct'; 
            else if (code === 'X') cellClass = 'st-x'; 
            else if (code === 'SH' || code === 'Stb') cellClass = 'st-stb'; 

            if (counts.hasOwnProperty(code)) {
                counts[code]++;
            }

            const bgStyle = (code === '') ? 'background-color: #f8f9fa;' : '';
            rowHTML += `<td class="${cellClass}" style="${bgStyle} cursor:help;" title="${tooltip}">${code}</td>`;
        });

        // Hitung Persentase
        const totalDaysInPeriod = dates.length; 
        const deduction = counts.S + counts.I + counts.A; 
        
        let percentage = 0;
        if (totalDaysInPeriod > 0) {
            percentage = ((totalDaysInPeriod - deduction) / totalDaysInPeriod) * 100;
        }

        let pctClass = '';
        if (percentage >= 100) { percentage = 100; pctClass = 'pct-high'; } 
        else if (percentage >= 95) { pctClass = 'pct-med'; } 
        else { pctClass = 'pct-low'; }

        rowHTML += `<td style="font-weight:bold; background-color:#f0f8ff; border-left:3px solid #ccc;">${counts.H}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.SBD}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.SS}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.S}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.I}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.PC}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.OFF}</td>`;
        rowHTML += `<td style="font-weight:bold;">${counts.CT}</td>`;
        rowHTML += `<td style="font-weight:bold; color:red;">${counts.A}</td>`;
        
        rowHTML += `<td class="${pctClass}" style="border-left:3px solid #ccc;">${percentage.toFixed(1)}%</td>`;
        
        rowHTML += `</tr>`;
        tbody.innerHTML += rowHTML;
    });

    if (displayedCount === 0) {
        tbody.innerHTML = `<tr><td colspan="${dates.length + 12}" style="text-align:center; padding:20px; color:#dc3545;">Tidak ada karyawan ditemukan di sektor <strong>${selectedSektorFilter}</strong>.</td></tr>`;
    }
}// 3. Fungsi Export Excel yang Berfungsi
window.exportAttendanceExcel = function() {
    const table = document.getElementById('attendanceTable');
    if (!table || table.rows.length <= 1) {
        alert("Tabel kosong. Silakan tampilkan data terlebih dahulu.");
        return;
    }

    // Ambil teks periode untuk nama file
    const monthSelect = document.getElementById('abs_filter_month');
    let periodText = "Periode_Custom";
    if (monthSelect.selectedIndex >= 0) {
        periodText = monthSelect.options[monthSelect.selectedIndex].text;
    }

    // Gunakan SheetJS untuk konversi Table HTML ke Excel
    // raw: true penting agar kode '0' atau tanggal tidak terformat aneh
    const wb = XLSX.utils.table_to_book(table, {sheet: "Absensi", raw: true});
    
    // Download File
    XLSX.writeFile(wb, `Absensi_Karyawan_${periodText}.xlsx`);
    
    // Tampilkan notifikasi sukses
    const container = document.getElementById('toast-container'); // Pastikan Anda punya toast container
    if(container) {
         // Gunakan fungsi showToast yang sudah ada di kode Anda
         showToast("Export Berhasil", "Data absensi berhasil didownload.", "success");
    } else {
         alert("Export Berhasil!");
    }
}

// --- UPDATE HANDLE TAB SWITCHING ---
// Copy paste bagian ini untuk menggantikan/menambahkan logika tab absensi
// Pastikan ini ada di dalam document.addEventListener('DOMContentLoaded', ...)

/* CARI FUNGSI handleTabSwitching DI KODE LAMA ANDA, 
   LALU TAMBAHKAN BLOK 'ELSE IF' DI BAWAH INI:
*/

/*
if (tabId === 'laporan') { 
    // ...
} else if (tabId === 'absensi') { // <--- TAMBAHAN INI
    // Update dropdown bulan (pakai logic existing yg ada di tab lain)
    if(document.getElementById('abs_filter_month').options.length === 0) {
         window.updateMonthRange(document.getElementById('abs_period_select').value, 'abs_');
    }
    window.fetchAttendanceData();
}
*/// --- FUNGSI 1: ISI DROPDOWN DENGAN SEMUA NAMA YANG ADA ---
function populateNameCorrectionDropdown() {
    const select = document.getElementById('fix_old_name');
    if (!select) return;

    // 1. Kumpulkan semua nama unik dari berbagai sumber
    const allNames = new Set();

    // Dari Laporan Harian
    reportsData.forEach(r => { if(r.operator) allNames.add(r.operator.trim()); });
    
    // Dari Laporan Triputra
    triputraData.forEach(r => { if(r.operator) allNames.add(r.operator.trim()); });
    
    // Dari Master Unit (Operator Default)
    Object.values(masterUnits).forEach(u => { if(u.operator_default) allNames.add(u.operator_default.trim()); });

    // 2. Sortir Abjad
    const sortedNames = Array.from(allNames).sort();

    // 3. Render ke Dropdown
    select.innerHTML = '<option value="">-- Pilih Nama Operator --</option>';
    sortedNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });
}

// --- FUNGSI 2: EKSEKUSI PENGGANTIAN NAMA ---
window.executeNameCorrection = function() {
    const oldName = document.getElementById('fix_old_name').value;
    const newName = document.getElementById('fix_new_name').value.trim().toUpperCase();

    if (!oldName) return alert("Pilih nama lama yang ingin diganti!");
    if (!newName) return alert("Masukkan nama baru!");
    if (oldName === newName) return alert("Nama baru tidak boleh sama dengan nama lama.");

    if (!confirm(`Yakin ingin mengubah nama operator:\n"${oldName}"\n\nMenjadi:\n"${newName}"\n\nPerubahan ini akan diterapkan di SEMUA data laporan?`)) return;

    let count = 0;

    // 1. Update Laporan Harian
    reportsData.forEach(r => {
        if (r.operator && r.operator.trim() === oldName) {
            r.operator = newName;
            count++;
        }
    });

    // 2. Update Laporan Triputra
    triputraData.forEach(r => {
        if (r.operator && r.operator.trim() === oldName) {
            r.operator = newName;
            count++;
        }
    });

    // 3. Update Master Unit (Default Operator)
    let masterCount = 0;
    Object.keys(masterUnits).forEach(key => {
        if (masterUnits[key].operator_default === oldName) {
            masterUnits[key].operator_default = newName;
            masterCount++;
        }
    });

    if (count > 0 || masterCount > 0) {
        // Simpan Semua Perubahan
        saveReportsDataToLocalStorage();
        saveTriputraData();
        saveMasterDataToLocalStorage();

        // Refresh Semua Tampilan
        window.fetchReportData();
        window.fetchAttendanceData();
        window.fetchTriputraData();
        
        // Refresh Datalist & Dropdown Koreksi itu sendiri
        populateNameCorrectionDropdown();
        updateOperatorDatalist();

        // Reset Input
        document.getElementById('fix_new_name').value = '';
        
        showToast("Sukses", `Berhasil mengubah nama di ${count} laporan dan ${masterCount} data master unit.`, "success");
    } else {
        showToast("Info", "Tidak ditemukan data dengan nama tersebut.", "info");
    }
}

// ==========================================
// === MODUL TRACKING BA & INVOICE (FINAL v2) ===
// ==========================================

// 1. DEFINISI VARIABEL GLOBAL (Wajib di luar fungsi)
const TRACKING_STEPS = [
    { id: 10, label: "Informasi Awal Diterima", class: "st-proses" },
    { id: 11, label: "Informasi Lanjutan", class: "st-proses" },
    { id: 12, label: "Lagi di Accounting", class: "st-proses" },
    { id: 0, label: "BA Fisik Diterima", class: "st-proses" },
    { id: 1, label: "Pemeriksaan Kembali", class: "st-warn" },
    { id: 2, label: "Dokumen Bermasalah", class: "st-danger" },
    { id: 3, label: "Reject", class: "st-danger" },
    { id: 4, label: "Retur", class: "st-retur" },
    { id: 5, label: "On Process HO", class: "st-ho" },
    { id: 6, label: "Dokumen Proses Kirim", class: "st-kirim" },
    { id: 7, label: "Ready Kirim (Ada Jadwal)", class: "st-ready" },
    { id: 8, label: "Siap Invoice", class: "st-ready" },
    { id: 9, label: "Diterima Oleh Vendor", class: "st-done" }
];

let trackingData = [];

// 2. FUNGSI LOAD DATA (Reset Memori)
async function loadTrackingData() {
    const stored = await idb.get('DOR_TrackingData');
    if (stored) {
        trackingData = stored;
    } else {
        trackingData = [];
    }
}
async function saveTrackingData() {
    try {
        await idb.set('DOR_TrackingData', trackingData);
    } catch (e) {
        console.error("Gagal simpan Tracking", e);
    }
}
// 3. INIT VIEW (Dipanggil saat tab diklik)
window.loadTrackingView = function() {
    loadTrackingData();
    window.updateTrackingUnitDropdown();
    populateStatusDropdowns();
    window.renderTrackingTable(); // Ini akan otomatis update KPI juga
}

// 4. PREVIEW SEKTOR (Saat pilih unit di dropdown)
window.previewSector = function(selectElem) {
    const unitKey = selectElem.value;
    const sektorInput = document.getElementById('track_sektor');
    
    // Isi otomatis sektor jika ada di master data
    if (typeof masterUnits !== 'undefined' && masterUnits[unitKey]) {
        sektorInput.value = masterUnits[unitKey].sektor_default || '-';
    } else {
        sektorInput.value = '';
    }
}

// 5. HELPER TAMBAH UNIT
window.addUnitToField = function() {
    const select = document.getElementById('track_unit_select');
    const input = document.getElementById('track_unit_final');
    const selectedUnit = select.value;

    if (!selectedUnit) return alert("Pilih unit terlebih dahulu!");

    // Jika sektor masih kosong, isi paksa sekarang
    if (document.getElementById('track_sektor').value === '') {
        window.previewSector(select);
    }

    let currentVal = input.value;
    if (currentVal.length > 0) {
        if (currentVal.includes(selectedUnit)) return alert("Unit ini sudah ditambahkan.");
        input.value = currentVal + ", " + selectedUnit;
    } else {
        input.value = selectedUnit;
    }
}

// 6. HELPER DROPDOWN UNIT & STATUS
window.updateTrackingUnitDropdown = function() {
    const select = document.getElementById('track_unit_select');
    if(!select) return;
    select.innerHTML = '<option value="">-- Pilih Unit --</option>';
    if (typeof masterUnits !== 'undefined') {
        Object.keys(masterUnits).sort().forEach(unitKey => {
            const option = document.createElement('option');
            option.value = unitKey;
            option.textContent = unitKey;
            select.appendChild(option);
        });
    }
}

function populateStatusDropdowns() {
    const filterSel = document.getElementById('filter_status_ba');
    const editSel = document.getElementById('edit_track_status');
    
    if(!filterSel || !editSel) return;

    filterSel.innerHTML = '<option value="all">-- Semua Status --</option>';
    editSel.innerHTML = ''; 

    TRACKING_STEPS.forEach(step => {
        const opt = document.createElement('option');
        opt.value = step.id;
        opt.textContent = `${step.id}. ${step.label}`;
        filterSel.appendChild(opt);
        
        const opt2 = document.createElement('option');
        opt2.value = step.id;
        opt2.textContent = `${step.id}. ${step.label}`;
        editSel.appendChild(opt2);
    });
}

// 7. FUNGSI SIMPAN BARU (FIX: SINGLE SUBMIT & REALTIME REFRESH)
window.handleTrackingSubmit = function(e) {
    e.preventDefault(); // Mencegah reload halaman
    
    // Validasi
    const unitFinal = document.getElementById('track_unit_final').value;
    if (!unitFinal) return alert("Harap isi/tambah Unit terlebih dahulu!");

    // Buat Data
    const newItem = {
        id: Date.now().toString(),
        period: document.getElementById('track_period').value,
        noBA: document.getElementById('track_no_ba').value,
        unit: unitFinal,
        sektor: document.getElementById('track_sektor').value,
        date: document.getElementById('track_date').value,
        amount: parseFloat(document.getElementById('track_amount').value) || 0,
        status: 10,
        notes: 'Input Awal',
        history: []
    };

    newItem.history.push({
        id: Date.now().toString(),
        status: 10,
        date: newItem.date,
        notes: 'Data baru diinput'
    });

    // Simpan ke Storage
    loadTrackingData(); // Baca dulu data terbaru dari storage (prevent overwrite race condition)
    trackingData.unshift(newItem); // Tambah data baru di paling atas
    saveTrackingData(); // Simpan balik ke storage

    // Reset Form
    document.getElementById('track_no_ba').value = '';
    document.getElementById('track_amount').value = '';
    document.getElementById('track_unit_final').value = '';
    
    // Reset Filter agar data baru terlihat
    document.getElementById('filter_status_ba').value = 'all';
    document.getElementById('search_ba').value = '';

    // Render Ulang (Realtime)
    window.renderTrackingTable();
    
    showToast("Sukses", "Data berhasil disimpan.", "success");
}

// 8. FUNGSI RENDER TABEL (FIX TOTAL DANA & FILTER)
window.renderTrackingTable = function() {
    const tbody = document.getElementById('trackingBody');
    const tfoot = document.getElementById('trackingFooter');
    
    const filterStatus = document.getElementById('filter_status_ba').value;
    const searchText = (document.getElementById('search_ba').value || '').toLowerCase();
    
    tbody.innerHTML = '';

    // --- 1. FILTERING ---
    let filtered = trackingData.filter(item => {
        let currentStatus = item.status;
        if (item.history && item.history.length > 0) currentStatus = item.history[0].status;

        const matchStatus = (filterStatus === 'all') || (parseInt(currentStatus) == parseInt(filterStatus));
        const matchSearch = (item.noBA || '').toLowerCase().includes(searchText) || 
                            (item.unit || '').toLowerCase().includes(searchText) ||
                            (item.period || '').toLowerCase().includes(searchText);
                            
        return matchStatus && matchSearch;
    });

    // --- 2. SORTING ---
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

    // --- 3. VARIABEL TOTAL ---
    let calcTotalAmount = 0;
    let calcTotalCount = 0;
    let calcReadyCount = 0;

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding: 20px;">Tidak ada data ditemukan.</td></tr>';
        tfoot.innerHTML = '';
        updateTrackingKPI(0, 0, 0);
        return;
    }

    filtered.forEach(item => {
        let latestHistory = (item.history && item.history.length > 0) ? item.history[0] : { status: item.status, notes: item.notes };
        const statusObj = TRACKING_STEPS.find(s => s.id == latestHistory.status) || TRACKING_STEPS[0];
        
        // Akumulasi Total Dana
        const amount = parseFloat(item.amount) || 0;
        calcTotalAmount += amount;
        calcTotalCount++;
        
        if (parseInt(latestHistory.status) === 8) calcReadyCount++;

        const diffTime = Math.abs(new Date() - new Date(item.date));
        const durationDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let rowStyle = "";
        const statCode = parseInt(latestHistory.status);
        if ([2, 3, 4].includes(statCode)) rowStyle = "background-color: #fff0f0; border-left: 3px solid #dc3545;";
        if (statCode === 9) rowStyle = "background-color: #f0fff4; border-left: 3px solid #198754;";

        tbody.innerHTML += `
            <tr style="${rowStyle}">
                <td class="action-column" style="white-space:nowrap; text-align:center;">
                    <button class="action-button" style="background:#0d6efd; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;" onclick="window.openTrackingDetail('${item.id}')">üìú</button>
                    <button class="action-button" style="background:#ffc107; color:#000; border:none; padding:4px 8px; border-radius:4px;" onclick="window.openTrackingModal('${item.id}')">‚úèÔ∏è</button>
                    <button class="action-button" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:4px;" onclick="window.deleteTrackingItem('${item.id}')">üóëÔ∏è</button>
                </td>
                <td style="font-weight:bold; color:#0d6efd;">${item.period || '-'}</td>
                <td style="font-weight:bold;">${item.noBA}</td>
                <td style="font-size:11px; max-width:180px; word-wrap:break-word;">${item.unit}</td>
                <td style="font-size:11px;">${item.sektor}</td>
                <td style="text-align:right; font-family:monospace; font-weight:bold;">Rp ${amount.toLocaleString('id-ID')}</td>
                <td>${formatDate(item.date)}</td>
                <td style="color:${durationDays > 14 ? 'red' : 'green'}; font-weight:bold;">${durationDays} Hari</td>
                <td><span class="badge-status ${statusObj.class}">${statusObj.label}</span></td>
                <td style="font-size:10px; text-align:left;">${latestHistory.notes || '-'}</td>
            </tr>
        `;
    });

    tfoot.innerHTML = `
        <tr style="background-color: #eee; font-weight: bold; border-top: 2px solid #333;">
            <td colspan="5" style="text-align: right;">TOTAL ESTIMASI DANA (FILTERED):</td>
            <td style="text-align: right; color: #d63384; font-size: 13px;">Rp ${calcTotalAmount.toLocaleString('id-ID')}</td>
            <td colspan="4"></td>
        </tr>
    `;

    // UPDATE KPI SECARA REALTIME
    updateTrackingKPI(calcTotalCount, calcReadyCount, calcTotalAmount);
}

// ============================================================
// === PERBAIKAN: FUNGSI UPDATE KPI (AGAR TOTAL DANA MUNCUL) ===
// ============================================================
function updateTrackingKPI(totalCount, readyCount, totalAmount) {
    // 1. Update Total Dokumen
    const totalEl = document.getElementById('track_total_active');
    if(totalEl) totalEl.textContent = totalCount;

    // 2. Update Status Siap Invoice (Ready)
    const readyEl = document.getElementById('track_ready');
    if(readyEl) readyEl.textContent = readyCount;

    // 3. Update Total Estimasi Dana (Format Rupiah)
    const amountEl = document.getElementById('track_total_amount');
    if(amountEl) {
        // Pastikan amount adalah angka, jika tidak 0
        const safeAmount = parseFloat(totalAmount) || 0;
        amountEl.textContent = `Rp ${safeAmount.toLocaleString('id-ID')}`;
    }
}    
   
// 9. FUNGSI HAPUS (REALTIME FIX)
window.deleteTrackingItem = function(id) {
    if(!confirm("Hapus data ini?")) return;
    
    // Paksa reload dari storage untuk memastikan kita memanipulasi data terbaru
    loadTrackingData(); 
    trackingData = trackingData.filter(d => d.id !== id);
    saveTrackingData();
    
    window.renderTrackingTable(); // Gambar ulang tabel seketika
    showToast("Dihapus", "Data dihapus.", "success");
}

// 10. FUNGSI SIMPAN EDIT (REALTIME FIX)
window.saveTrackingUpdate = function() {
    const id = document.getElementById('edit_track_id').value;
    
    loadTrackingData(); // Baca data terbaru
    const item = trackingData.find(d => d.id === id);
    
    if (item) {
        item.noBA = document.getElementById('edit_track_no_ba').value;
        item.period = document.getElementById('edit_track_period').value;
        item.amount = parseFloat(document.getElementById('edit_track_amount').value) || 0;
        
        const newStatus = parseInt(document.getElementById('edit_track_status').value);
        const newDate = document.getElementById('edit_track_date_update').value;
        const newNote = document.getElementById('edit_track_notes').value;

        item.history.unshift({
            id: Date.now().toString(),
            status: newStatus,
            date: newDate,
            notes: newNote
        });

        item.status = newStatus;
        item.lastUpdate = newDate;
        item.notes = newNote;

        saveTrackingData();
        window.renderTrackingTable(); // Gambar ulang tabel seketika
        
        document.getElementById('trackingModal').style.display = 'none';
        showToast("Updated", "Data diperbarui.", "success");
    }
}

// 11. Buka Modal Edit
window.openTrackingModal = function(id) {
    loadTrackingData(); // Baca data terbaru
    const item = trackingData.find(d => d.id === id);
    if (!item) return;
    
    document.getElementById('edit_track_id').value = id;
    document.getElementById('edit_track_no_ba').value = item.noBA;
    document.getElementById('edit_track_period').value = item.period || '';
    document.getElementById('edit_track_amount').value = item.amount || 0;
    
    const currentStatus = (item.history && item.history.length > 0) ? item.history[0].status : item.status;
    document.getElementById('edit_track_status').value = currentStatus;
    document.getElementById('edit_track_date_update').value = new Date().toISOString().substring(0, 10);
    document.getElementById('trackingModal').style.display = 'block';
}

// 12. Modal Detail
window.openTrackingDetail = function(id) {
    loadTrackingData();
    const item = trackingData.find(d => d.id === id);
    if (!item) return;

    document.getElementById('detail_parent_id').value = id;
    const statusSelect = document.getElementById('new_history_status');
    statusSelect.innerHTML = '';
    TRACKING_STEPS.forEach(step => {
        const opt = document.createElement('option');
        opt.value = step.id;
        opt.textContent = `${step.id}. ${step.label}`;
        statusSelect.appendChild(opt);
    });
    
    document.getElementById('new_history_date').value = new Date().toISOString().substring(0, 10);
    document.getElementById('new_history_note').value = '';
    
    // Asumsi fungsi renderModernTrackingUI ada di kode sebelumnya (timeline)
    if(typeof renderModernTrackingUI === 'function') {
        renderModernTrackingUI(item);
    }
    document.getElementById('trackingDetailModal').style.display = 'block';
}

// 2. Fungsi Render Utama (Horizontal Stepper)
// 2. UPDATE LOGIKA UI MODAL (Agar Status Baru Terbaca)
function renderModernTrackingUI(item) {
    const container = document.getElementById('timelineContainer');
    
    // Pastikan history ada & urutkan
    if (!item.history) item.history = [];
    item.history.sort((a, b) => new Date(b.date) - new Date(a.date));

    const currentStatus = parseInt(item.status);
    let errorMode = false;
    let percent = 0;

    // Cek Error
    if ([2, 3, 4].includes(currentStatus)) { errorMode = true; }

    // --- LOGIKA PROGRESS BAR (Updated) ---
    if (currentStatus >= 9) percent = 100;
    else if (currentStatus >= 6 && currentStatus <= 8) percent = 75; // Siap Kirim
    else if (currentStatus >= 1 && currentStatus <= 5) percent = 50; // Verifikasi
    else if (currentStatus === 0) percent = 25; // Fisik Diterima
    else if (currentStatus === 10) percent = 10; // Informasi Awal (Baru Mulai)

    if(errorMode && percent > 50) percent = 50; 

    let html = `
        <div class="tracking-modal-body">
            <div class="doc-info-card">
                <div>
                    <h3 class="doc-id">${item.noBA}</h3>
                    <div class="doc-meta">Unit: <strong>${item.unit}</strong> | Sektor: ${item.sektor}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:10px; color:#64748b;">Durasi</div>
                    <div style="font-size:14px; font-weight:bold; color:#334155;">
                        ${Math.ceil(Math.abs(new Date() - new Date(item.date)) / (86400000))} Hari
                    </div>
                </div>
            </div>

            <div class="stepper-wrapper">
                <div class="progress-line-fill" style="width: ${percent}%;"></div>
                
                ${renderStepHTML(1, 'Diterima (Awal)', getHistoryDate(item, [10, 0]), (currentStatus === 10 || currentStatus >= 0), false, 'üì•')}
                
                ${renderStepHTML(2, 'Verifikasi', getHistoryDate(item, [1,2,3,4,5]), (currentStatus >= 1 && currentStatus <= 9), (errorMode && currentStatus <= 5), '‚öôÔ∏è')}
                
                ${renderStepHTML(3, 'Siap Invoice', getHistoryDate(item, [6,7,8]), (currentStatus >= 6 && currentStatus <= 9), (errorMode && currentStatus > 5), 'üöö')}
                
                ${renderStepHTML(4, 'Diterima Vendor', getHistoryDate(item, [9]), currentStatus === 9, false, '‚úÖ')}
            </div>

            ${getFinalStatusText(currentStatus, errorMode)}

            <div class="history-log-section">
                <div class="history-title">Riwayat Aktivitas</div>
                <div style="max-height: 250px; overflow-y: auto;">
    `;
    

    // History List
    item.history.forEach(h => {
        const sObj = TRACKING_STEPS.find(s => s.id == h.status) || {};
        html += `
            <div class="history-row">
                <div style="flex:1;">
                    <span style="font-weight:600; color:#334155;">${sObj.label}</span>
                    <br><span style="color:#94a3b8; font-size:10px;">${h.notes || '-'}</span>
                </div>
                <div style="text-align:right;">
                    <span style="font-weight:600; color:#10b981;">${formatDate(h.date)}</span>
                    <div style="margin-top:2px;">
                        <button class="btn-icon-small" onclick="window.deleteHistoryStep('${item.id}', '${h.id}')" style="color:#ef4444;">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `;
    });

    html += `</div></div></div>`;
    container.innerHTML = html;
}




// Helper: Render HTML per Step
function renderStepHTML(stepNum, label, dateStr, isActive, isError, icon) {
    let statusClass = '';
    let iconContent = icon;

    if (isError) {
        statusClass = 'error';
        iconContent = '‚úï'; // X Mark
    } else if (isActive) {
        // Cek apakah ini tahap terakhir yang aktif (Current) atau sudah lewat (Completed)
        // Disini kita buat simple: Jika ada tanggalnya, berarti completed/active
        statusClass = 'completed'; 
        iconContent = '‚úì';
        
        // Jika ini step terakhir (4) dan aktif, iconnya centang
        if(stepNum === 4 && isActive) iconContent = '‚úì';
    }

    // Tanggal tampil hanya jika sudah lewat tahap ini
    const dateDisplay = isActive ? dateStr : '-';

    return `
        <div class="step-item ${statusClass}">
            <div class="step-circle">${iconContent}</div>
            <div class="step-label">${label}</div>
            <div class="step-date">${dateDisplay}</div>
        </div>
    `;
}

// Helper: Ambil tanggal history berdasarkan grup status
function getHistoryDate(item, statusArray) {
    // Cari history yang statusnya cocok dengan array input
    const found = item.history.find(h => statusArray.includes(parseInt(h.status)));
    return found ? formatDate(found.date) : '';
}

// Helper: Teks Status Bawah
function getFinalStatusText(status, isError) {
    if (status === 9) {
        return `<div class="final-status-text status-success">üéâ Dokumen Invoice Telah Diterima Vendor</div>`;
    }
    if (isError) {
        return `<div class="final-status-text status-danger">‚ö†Ô∏è Dokumen Bermasalah / Dikembalikan</div>`;
    }
    return `<div class="final-status-text status-process">‚è≥ Invoice Sedang Dalam Proses</div>`;
}

// 3. Tambah History Baru
// 3. PERBAIKAN FUNGSI ADD (Refresh Otomatis)
window.addTrackingHistoryStep = function() {
    const parentId = document.getElementById('detail_parent_id').value;
    const status = parseInt(document.getElementById('new_history_status').value);
    const date = document.getElementById('new_history_date').value;
    const notes = document.getElementById('new_history_note').value;

    if (!date) return alert("Tanggal wajib diisi.");

    const item = trackingData.find(d => d.id === parentId);
    if (item) {
        if (!item.history) item.history = [];
        
        // Tambah ke Array
        item.history.unshift({
            id: Date.now().toString(),
            status: status,
            date: date,
            notes: notes
        });

        // Update Parent Status (Agar sinkron dengan tabel utama)
        item.status = status;
        item.lastUpdate = date;
        item.notes = notes;

        saveTrackingData();
        
        // --- FIX DISINI: Render ulang Modal & Tabel Utama ---
        renderModernTrackingUI(item); // Refresh tampilan Modal saat itu juga!
        window.renderTrackingTable(); // Refresh tabel belakang
        
        showToast("Update", "Status berhasil ditambahkan.", "success");
        document.getElementById('new_history_note').value = '';
    }
}

// 4. PERBAIKAN FUNGSI DELETE (Refresh Otomatis)
window.deleteHistoryStep = function(parentId, historyId) {
    if (!confirm("Hapus status ini dari riwayat?")) return;

    const item = trackingData.find(d => d.id === parentId);
    if (item && item.history) {
        // Hapus dari Array
        item.history = item.history.filter(h => h.id != historyId);
        
        // Fallback jika kosong
        if (item.history.length === 0) {
            item.history.push({
                id: Date.now().toString(),
                status: 10, // Default ke Informasi Awal
                date: item.date,
                notes: 'Reset Awal'
            });
        }

        // Sinkronisasi status parent dengan history teratas
        item.history.sort((a, b) => new Date(b.date) - new Date(a.date));
        const latest = item.history[0];
        
        item.status = latest.status;
        item.lastUpdate = latest.date;
        item.notes = latest.notes;

        saveTrackingData();

        // --- FIX DISINI: Render ulang Modal & Tabel Utama ---
        renderModernTrackingUI(item); // Refresh tampilan Modal saat itu juga!
        window.renderTrackingTable(); // Refresh tabel belakang
    }
}

// 5. Edit Step History (Simple Prompt)
window.editHistoryStep = function(parentId, historyId) {
    const item = trackingData.find(d => d.id === parentId);
    const hist = item.history.find(h => h.id == historyId);
    
    if (hist) {
        const newNote = prompt("Edit Keterangan:", hist.notes);
        if (newNote !== null) {
            hist.notes = newNote;
            
            // Jika ini yang terbaru, update parent juga
            if (item.history[0].id == historyId) {
                item.notes = newNote;
            }
            
            saveTrackingData();
            window.renderTimeline(item);
            window.renderTrackingTable();
        }
    }
}

// 6. Hapus Data Induk (BA)
// GANTI FUNGSI HAPUS INI
window.deleteTrackingItem = function(id) {
    if(!confirm("Yakin ingin menghapus data Tracking ini secara permanen?")) return;
    
    // Hapus dari memori
    trackingData = trackingData.filter(d => d.id !== id);
    
    // Simpan ke storage
    saveTrackingData();
    
    // Force Load ulang agar sinkron
    loadTrackingData(); 

    // Render ulang tabel
    window.renderTrackingTable(); 
    
    showToast("Dihapus", "Data berhasil dihapus.", "success");
}
function generateTrackingExcel() {
    const filterStatus = document.getElementById('filter_status_ba').value;
    let dataToExport = trackingData;
    
    if (filterStatus !== 'all') {
        dataToExport = trackingData.filter(item => item.status == filterStatus);
    }

    if (dataToExport.length === 0) return alert("Tidak ada data untuk diexport.");

    // Header Excel
    let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head><meta charset="UTF-8">
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #000; padding: 5px; text-align: center; font-size: 11px; }
        th { background-color: #d63384; color: white; }
    </style>
    </head><body>
    <h3>Laporan Tracking BA & Invoice</h3>
    <table>
    <thead>
        <tr>
            <th>No</th>
            <th>Periode (Bln/Thn)</th>
            <th>No BA/Invoice</th>
            <th>Unit</th>
            <th>Sektor</th>
            <th>Tanggal Awal Terima</th>
            <th>Status Terakhir</th>
            <th>Tanggal Update Terakhir</th>
            <th>Durasi (Hari)</th>
            <th>Keterangan / Jadwal</th>
        </tr>
    </thead>
    <tbody>`;

    const today = new Date();

    dataToExport.forEach((item, index) => {
        const startDate = new Date(item.date);
        const periode = startDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        const diffTime = Math.abs(today - startDate);
        const duration = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        const statusLabel = TRACKING_STEPS.find(s => s.id == item.status)?.label || '-';
        const lastUp = item.lastUpdate ? formatDate(item.lastUpdate) : '-';

        html += `
        <tr>
            <td>${index + 1}</td>
            <td>${periode}</td>
            <td style="text-align:left;">${item.noBA}</td>
            <td>${item.unit}</td>
            <td>${item.sektor}</td>
            <td>${formatDate(item.date)}</td>
            <td>${statusLabel}</td>
            <td>${lastUp}</td>
            <td>${duration}</td>
            <td style="text-align:left;">${item.notes || '-'}</td>
        </tr>`;
    });

    html += `</tbody></table></body></html>`;

    const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Tracking_BA_${new Date().toISOString().slice(0, 10)}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast("Export Selesai", "File Excel Tracking berhasil diunduh.", "success");
}

function updateTrackingKPI() {
    const total = trackingData.length;
    const pending = trackingData.filter(d => d.status < 8).length; 
    const ready = trackingData.filter(d => d.status === 8).length; 
    document.getElementById('track_total_active').textContent = total;
    document.getElementById('track_pending').textContent = pending;
    document.getElementById('track_ready').textContent = ready;
}
// ============================================================
// === PERBAIKAN: FUNGSI CETAK PDF TRACKING BA ===
// ============================================================
window.handleTrackingPrint = function() {
    // 1. Pastikan tab Tracking aktif agar CSS @media print bisa mendeteksinya
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tracking_ba').classList.add('active');
    
    // 2. Update Header Cetak (Opsional, untuk memastikan tanggal/judul benar)
    // CSS @media print Anda sudah menangani visibility header #tracking-print-header
    
    // 3. Eksekusi Print Browser
    window.print();

    // 4. (Opsional) Kembalikan UI setelah dialog print tertutup
    // Tidak wajib karena CSS print Anda bekerja berdasarkan visibility, bukan manipulasi DOM destruktif.
    setTimeout(() => {
        // Pastikan tab tetap aktif
        document.getElementById('tracking_ba').classList.add('active');
    }, 500);
}
// ==========================================
// === LOGIKA INPUT CEPAT (FAST ENTRY) ===
// ==========================================

// 1. Inisialisasi Tanggal Hari Ini saat Load
document.addEventListener('DOMContentLoaded', async (event) => {
    // Tampilkan indikator loading
    showToast("Memuat Data...", "Sedang menyiapkan database...", "info");

    // 1. Load Data (Tunggu sampai selesai dengan await)
    // INI KUNCINYA: Kita tunggu sampai data benar-benar ada di memori
    await loadMasterDataFromLocalStorage(); 
    await loadPayrollSettings();
    
    // --- [PERBAIKAN DIMULAI DISINI] ---
    // Update Dropdown 'Input Cepat' secara eksplisit setelah data siap
    const fastUnitSelect = document.getElementById('fast_unit');
    if (fastUnitSelect) {
        updateUnitDropdown(fastUnitSelect); 
        // Set tanggal default hari ini untuk Input Cepat
        const fastDateInput = document.getElementById('fast_tanggal');
        if (fastDateInput) fastDateInput.value = new Date().toISOString().substring(0, 10);
    }
    // --- [PERBAIKAN SELESAI] ---

    // 2. Setup Dropdowns & UI setelah data siap
    updateYearDropdown();
    
    // Initialize filter
    document.getElementById('period_select').value = 'custom_monthly_21_20';
    updateMonthRange('custom_monthly_21_20', ''); 
    
    document.getElementById('avail_period_select').value = 'custom_monthly_21_20';
    updateMonthRange('custom_monthly_21_20', 'avail_');
    
    document.getElementById('trp_period_select').value = 'custom_monthly_21_20';
    updateMonthRange('custom_monthly_21_20', 'trp_');
    
    document.getElementById('display_view').value = 'both';
    document.getElementById('reportInputBody').innerHTML = '';
    batchImageCache = {}; 
    
    // Inisialisasi baris input tabel biasa
    window.addRow(); 
    window.addTriputraRow();

    updateOperatorDatalist(); 
    handleTabSwitching();
    
    // Set Default Tab
    const defaultTab = document.querySelector('.tab-button[data-tab="input"]');
    if (defaultTab) {
        defaultTab.classList.add('active');
        document.getElementById('input').classList.add('active');
    }
    
    updateFilterUnitDropdown(); 
    updateFilterSektorDropdown(); 
    
    // Fetch Data Laporan ke Tabel
    window.fetchReportData(); 
    
    // Init Tracking Data
    await loadTrackingData();
    window.updateTrackingUnitDropdown();
    
    // Cek Storage (jika fitur ini sudah ditambahkan)
    if(typeof window.checkStorage === 'function') window.checkStorage();

    showToast("Siap", "Aplikasi siap digunakan.", "success");

    // Event Listener Klik Modal (Agar bisa ditutup)
    window.onclick = function(event) {
        if (event.target == document.getElementById('imageZoomModal')) document.getElementById('imageZoomModal').style.display = "none";
        if (event.target == document.getElementById('editReportModal')) document.getElementById('editReportModal').style.display = "none";
        if (event.target == document.getElementById('masterDataModal')) document.getElementById('masterDataModal').style.display = "none";
        if (event.target == document.getElementById('stockHistoryModal')) document.getElementById('stockHistoryModal').style.display = "none";
        if (event.target == document.getElementById('editTriputraModal')) document.getElementById('editTriputraModal').style.display = "none";
        if (event.target == document.getElementById('trackingDetailModal')) document.getElementById('trackingDetailModal').style.display = "none";
        if (event.target == document.getElementById('bulkUploadModal')) document.getElementById('bulkUploadModal').style.display = 'none';
        if (event.target == document.getElementById('trackingModal')) document.getElementById('trackingModal').style.display = 'none';
    }
});

// 3. Proses Input Cepat ke Tabel Utama
// 3. Proses Input Cepat ke Tabel Utama (Versi Multi-Foto)
window.processFastEntry = function() {
    // A. Ambil Value Data Utama
    const tanggal = document.getElementById('fast_tanggal').value;
    const unit = document.getElementById('fast_unit').value;
    const hmAkhir = parseFloat(document.getElementById('fast_hm_akhir').value);
    const predictedStartHM = parseFloat(document.getElementById('fast_hm_akhir').getAttribute('data-predicted-start')) || 0;

    // B. Validasi Dasar
    if (!tanggal) return showToast("Error", "Tanggal wajib diisi!", "error");
    if (!unit) return showToast("Error", "Pilih Unit terlebih dahulu!", "error");
    if (isNaN(hmAkhir)) return showToast("Error", "HM Akhir wajib angka!", "error");
    
    if (hmAkhir < predictedStartHM) {
        if(!confirm(`PERINGATAN: HM Akhir (${hmAkhir}) lebih kecil dari Prediksi HM Awal (${predictedStartHM}). Lanjutkan?`)) return;
    }

    // C. Ambil Data Master (Operator & Sektor Default)
    let operator = "";
    let model = "";
    let sektor = "";
    
    if (masterUnits[unit]) {
        operator = masterUnits[unit].operator_default || "";
        model = masterUnits[unit].model_default || "";
        sektor = masterUnits[unit].sektor_default || "";
    }

    // D. Persiapkan Data untuk Baris Baru
    const rowData = {
        tanggal: tanggal,
        unit: unit,
        operator: operator,
        model: model,
        sektor: sektor,
        hm_awal: predictedStartHM,
        hm_akhir: hmAkhir,
        total_solar: "",
        keterangan: ""
    };

    // E. Buat Baris Baru di Tabel
    window.addRow(rowData);

    // F. Handle 3 Jenis Foto (Helper Function)
    const lastRowIndex = rowIndexCounter; 
    const rowId = `row-${lastRowIndex}`;

    // Fungsi kecil untuk memproses upload per kolom
    const processFastImage = (inputId, fieldName) => {
        const fileInput = document.getElementById(inputId);
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Tampilkan text loading di baris tabel
            const labelSpan = document.getElementById(`label-${rowId}-${fieldName}`);
            if(labelSpan) labelSpan.textContent = "...";

            compressImage(file, function(base64String) {
                if (!batchImageCache[rowId]) batchImageCache[rowId] = {};
                
                // Simpan ke cache
                batchImageCache[rowId][fieldName] = base64String;

                // Update Preview di Baris Tabel
                const previewImg = document.getElementById(`preview-${rowId}-${fieldName}`);
                const previewWrapper = document.getElementById(`wrapper-${rowId}-${fieldName}`);
                
                if (previewImg) {
                    previewImg.src = base64String;
                    previewImg.style.display = 'block';
                }
                if (previewWrapper) {
                    previewWrapper.style.display = 'flex';
                }
                if (labelSpan) {
                    labelSpan.textContent = "OK";
                    labelSpan.style.color = "#198754";
                }
            });
        }
    };

    // Jalankan untuk ke-3 input (Timesheet, Awal, Akhir)
    processFastImage('fast_foto_timesheet', 'foto_timesheet');
    processFastImage('fast_foto_awal', 'foto_awal');
    processFastImage('fast_foto_akhir', 'foto_akhir');

    // G. Reset Form Input Cepat (Kecuali Tanggal)
    document.getElementById('fast_unit').value = "";
    document.getElementById('fast_hm_akhir').value = "";
    document.getElementById('fast_hm_info').textContent = "";
    
    // Reset file inputs
    document.getElementById('fast_foto_timesheet').value = "";
    document.getElementById('fast_foto_awal').value = "";
    document.getElementById('fast_foto_akhir').value = "";
    
    showToast("Berhasil", `Data ${unit} ditambahkan.`, "success");
    
    // Fokus kembali ke Unit
    document.getElementById('fast_unit').focus();
}// ==========================================================
// === FITUR SMART INPUT: AUTO MERGE PHOTO & CREATE NEW ===
// ==========================================================

// 1. Helper: Wrapper Promise untuk Kompresi Gambar
function compressImagePromise(file) {
    return new Promise((resolve, reject) => {
        if (!file) {
            resolve(null);
            return;
        }
        compressImage(file, (base64) => {
            if (base64) resolve(base64);
            else reject("Gagal kompresi gambar");
        });
    });
}

// 2. Fungsi Utama: Proses Smart Input
// --- FIX: INPUT CEPAT (Tambahkan definisi totalJam) ---
window.processSmartFastEntry = async function() {
    // A. Ambil Inputan User
    const tanggal = document.getElementById('fast_tanggal').value;
    const unit = document.getElementById('fast_unit').value;
    const hmAkhirUser = parseFloat(document.getElementById('fast_hm_akhir').value);
    const keteranganUser = document.getElementById('fast_keterangan').value.trim();
    
    // B. Validasi Dasar
    if (!tanggal) return showToast("Error", "Tanggal belum diisi!", "error");
    if (!unit) return showToast("Error", "Unit belum dipilih!", "error");
    if (isNaN(hmAkhirUser)) return showToast("Error", "HM Akhir harus diisi angka!", "error");

    // C. Logika HM Awal
    let hmAwalOtomatis = parseFloat(document.getElementById('fast_hm_akhir').getAttribute('data-start-hm'));

    // Jika 0 atau error, cari ulang dari database
    if (!hmAwalOtomatis || isNaN(hmAwalOtomatis) || hmAwalOtomatis === 0) {
        const historyCheck = reportsData.filter(r => r.unit === unit);
        if (historyCheck.length > 0) {
            historyCheck.sort((a, b) => {
                const dateA = new Date(a.tanggal);
                const dateB = new Date(b.tanggal);
                return dateB - dateA || parseFloat(b.hm_akhir) - parseFloat(a.hm_akhir);
            });
            hmAwalOtomatis = parseFloat(historyCheck[0].hm_akhir) || 0;
        } else {
            hmAwalOtomatis = 0; 
        }
    }

    // [FIX UTAMA DI SINI] Definisikan totalJam sebelum dipakai
    const totalJam = hmAkhirUser - hmAwalOtomatis;

    // D. Hitung Kategori (Sekarang aman karena totalJam sudah ada)
    const kategoriOtomatis = getKeteranganCategory(keteranganUser, totalJam);

    // E. Validasi Logika
    if (hmAkhirUser < hmAwalOtomatis) {
        alert(`‚ùå ERROR HM:\nHM Akhir inputan (${hmAkhirUser}) lebih KECIL dari HM Awal history (${hmAwalOtomatis}).`);
        return;
    }

    // F. Konfirmasi
    const pesanKonfirmasi = 
        `----------------------------------------\n` +
        `‚úÖ KONFIRMASI DATA\n` +
        `----------------------------------------\n` +
        `Unit       : ${unit}\n` +
        `Tanggal    : ${formatDate(tanggal)}\n` +
        `\n` +
        `HM Awal    : ${hmAwalOtomatis}\n` +
        `HM Akhir   : ${hmAkhirUser}\n` +
        `----------------------------------------\n` +
        `TOTAL JAM  : ${parseFloat(totalJam.toFixed(1))} HM\n` +
        `Ket        : ${keteranganUser || '-'}\n` +
        `----------------------------------------\n` +
        `Data akan langsung disimpan. Lanjutkan?`;

    if (!confirm(pesanKonfirmasi)) return;

    // --- MULAI SIMPAN ---
    showToast("Processing", "Menyimpan...", "info");

    try {
        const fileTS = document.getElementById('fast_foto_timesheet').files[0];
        const fileStart = document.getElementById('fast_foto_awal').files[0];
        const fileEnd = document.getElementById('fast_foto_akhir').files[0];

        const [base64TS, base64Start, base64End] = await Promise.all([
            compressImagePromise(fileTS),
            compressImagePromise(fileStart),
            compressImagePromise(fileEnd)
        ]);

        let operator = masterUnits[unit]?.operator_default || "";
        let model = masterUnits[unit]?.model_default || "";
        let sektor = masterUnits[unit]?.sektor_default || "";

        const newReport = {
            tanggal: tanggal,
            unit: unit,
            operator: operator,
            model: model,
            sektor: sektor,
            klasifikasi_sektor: getSektorClassification(sektor),
            hm_awal: hmAwalOtomatis, 
            hm_akhir: hmAkhirUser,   
            jam_operasi: totalJam, // Menggunakan variabel yang sudah didefinisikan
            total_solar: 0, 
            work_hours: 0,
            time_in: '-', time_out: '-',
            keterangan: keteranganUser, 
            kategori_keterangan: kategoriOtomatis,
            foto_timesheet: base64TS || 'N/A',
            foto_awal: base64Start || 'N/A',
            foto_akhir: base64End || 'N/A'
        };

        const existingIndex = reportsData.findIndex(r => r.tanggal === tanggal && r.unit === unit);

        if (existingIndex !== -1) {
            const oldData = reportsData[existingIndex];
            newReport.foto_timesheet = base64TS || oldData.foto_timesheet;
            newReport.foto_awal = base64Start || oldData.foto_awal;
            newReport.foto_akhir = base64End || oldData.foto_akhir;
            
            reportsData[existingIndex] = { ...oldData, ...newReport };
            showToast("Update", "Data diperbarui.", "success");
        } else {
            reportsData.push(newReport);
            showToast("Sukses", "Laporan baru tersimpan.", "success");
        }

        saveReportsDataToLocalStorage(); 
        window.fetchReportData(); 

        // Reset
        document.getElementById('fast_unit').value = "";
        document.getElementById('fast_hm_akhir').value = "";
        document.getElementById('fast_hm_info').innerText = "";
        document.getElementById('fast_keterangan').value = "";
        document.getElementById('fast_foto_timesheet').value = "";
        document.getElementById('fast_foto_awal').value = "";
        document.getElementById('fast_foto_akhir').value = "";
        document.getElementById('fast_unit').focus();

    } catch (e) {
        console.error(e);
        alert("Gagal memproses: " + e.message);
    }
};
// === FITUR BULK UPLOAD FOTO VIA FILENAME ===
// ==========================================

let selectedBulkFiles = [];

window.handleBulkFilesSelect = function(input) {
    selectedBulkFiles = Array.from(input.files);
    const count = selectedBulkFiles.length;
    const info = document.getElementById('bulkFileCount');
    const btn = document.getElementById('btnProcessBulk');
    const log = document.getElementById('bulkLogConsole');

    if (count > 0) {
        info.textContent = `${count} Foto Dipilih`;
        btn.style.display = 'block';
        log.innerHTML = `> ${count} file siap diproses.<br>> Klik tombol hijau untuk memulai.`;
    } else {
        info.textContent = "";
        btn.style.display = 'none';
    }
};

window.processBulkPhotos = async function() {
    const log = document.getElementById('bulkLogConsole');
    log.innerHTML = "> Memulai proses scan...<br>";
    
    let successCount = 0;
    let failCount = 0;

    // Loop semua file
    for (let i = 0; i < selectedBulkFiles.length; i++) {
        const file = selectedBulkFiles[i];
        const fileName = file.name.toUpperCase(); // Case insensitive
        const nameWithoutExt = fileName.substring(0, fileName.lastIndexOf('.'));
        
        // 1. Parsing Nama File (Split by underscore)
        const parts = nameWithoutExt.split('_');
        
        if (parts.length < 3) {
            log.innerHTML += `<span style="color:red;">[SKIP] ${file.name}: Format nama salah (Gunakan: UNIT_TGL_TIPE)</span><br>`;
            failCount++;
            continue;
        }

        // Asumsi format: UNIT_TANGGAL_TIPE (Urutan bisa fleksibel, kita deteksi pola)
        let unit = parts[0]; 
        let dateRaw = parts[1];
        let typeRaw = parts[2];

        // Validasi Tipe Foto
        let targetField = '';
        if (typeRaw.includes('AWAL')) targetField = 'foto_awal';
        else if (typeRaw.includes('AKHIR')) targetField = 'foto_akhir';
        else if (typeRaw.includes('TS') || typeRaw.includes('TIME')) targetField = 'foto_timesheet';
        
        if (!targetField) {
            log.innerHTML += `<span style="color:orange;">[SKIP] ${file.name}: Tipe foto tidak dikenal (Gunakan: AWAL, AKHIR, TS)</span><br>`;
            failCount++;
            continue;
        }

        // Validasi & Parsing Tanggal
        let formattedDate = null;
        
        // Cek format DDMMYYYY (8 digit angka)
        if (/^\d{8}$/.test(dateRaw)) {
            const d = dateRaw.substring(0, 2);
            const m = dateRaw.substring(2, 4);
            const y = dateRaw.substring(4, 8);
            formattedDate = `${y}-${m}-${d}`;
        } 
        // Cek format YYYY-MM-DD atau DD-MM-YYYY
        else if (dateRaw.includes('-')) {
            const dateParts = dateRaw.split('-');
            if (dateParts[0].length === 4) formattedDate = dateRaw; // YYYY-MM-DD
            else formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // DD-MM-YYYY -> YYYY-MM-DD
        }

        if (!formattedDate) {
            log.innerHTML += `<span style="color:orange;">[SKIP] ${file.name}: Format tanggal salah.</span><br>`;
            failCount++;
            continue;
        }

        // 2. Cari Data di Reports Database
        // Kita cari laporan yang Unit dan Tanggalnya COCOK
        const reportIndex = reportsData.findIndex(r => r.unit === unit && r.tanggal === formattedDate);

        if (reportIndex !== -1) {
            // DATA DITEMUKAN -> UPDATE FOTO
            try {
                log.innerHTML += `> Memproses ${file.name}... `;
                // Scroll log ke bawah
                log.scrollTop = log.scrollHeight;

                const base64 = await compressImagePromise(file); // Reuse fungsi kompresi yang ada
                reportsData[reportIndex][targetField] = base64;
                
                log.innerHTML += `<span style="color:#0f0;">[OK] Updated data lama.</span><br>`;
                successCount++;
            } catch (e) {
                log.innerHTML += `<span style="color:red;">[ERR] Gagal kompresi.</span><br>`;
                failCount++;
            }
        } else {
            // DATA TIDAK DITEMUKAN -> INI OPTIONAL
            // Sesuai request: "semisal data sudah ada maka foto otomatis masuk"
            // Jika data belum ada, kita bisa skip atau buat draft. 
            // Untuk keamanan, kita log saja bahwa data induk belum ada.
            log.innerHTML += `<span style="color:yellow;">[404] ${unit} tgl ${formattedDate} belum ada laporan. Foto dilewati.</span><br>`;
            failCount++;
        }
    }

    log.innerHTML += `<br><strong>=== SELESAI ===</strong><br>`;
    log.innerHTML += `Berhasil Update: ${successCount} Foto<br>`;
    log.innerHTML += `Gagal/Skip: ${failCount} Foto<br>`;
    
    if (successCount > 0) {
        saveReportsDataToLocalStorage();
        window.fetchReportData(); // Refresh UI
        showToast("Bulk Upload", `${successCount} foto berhasil ditempel ke laporan.`, "success");
    }
};
// ==========================================================
// === FITUR SMART FOLDER UPLOAD (UNIT DARI NAMA FOLDER) ===
// ==========================================================

// 1. Mapping Bulan Indonesia ke Angka (0-11)
const indonesianMonths = {
    'jan': 0, 'januari': 0,
    'feb': 1, 'februari': 1, 'peb': 1, 'pebruari': 1,
    'mar': 2, 'maret': 2,
    'apr': 3, 'april': 3,
    'mei': 4, 'may': 4,
    'jun': 5, 'juni': 5,
    'jul': 6, 'juli': 6,
    'agu': 7, 'agustus': 7, 'agt': 7, 'aug': 7,
    'sep': 8, 'september': 8,
    'okt': 9, 'oktober': 9, 'oct': 9,
    'nov': 10, 'november': 10,
    'des': 11, 'desember': 11, 'dec': 11
};

window.processSmartFolderUpload = async function(input) {
    const files = Array.from(input.files);
    const logDiv = document.getElementById('folderUploadLog');
    logDiv.style.display = 'block';
    logDiv.innerHTML = `> Memindai ${files.length} file...<br>`;

    if (files.length === 0) return;

    let successCount = 0;
    let failCount = 0;
    const currentYear = new Date().getFullYear(); // Asumsi tahun ini (bisa diubah logicnya jika perlu)

    // Loop File
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // 1. Ambil Nama Folder sebagai UNIT (webkitRelativePath: "AUM 17/1 Nov HM Awal.jpg")
        const pathParts = file.webkitRelativePath.split('/');
        
        // Validasi: File harus berada di dalam folder (minimal ada 2 part: Folder/File)
        if (pathParts.length < 2) {
            continue; // Skip file di root tanpa folder parent
        }

        // Unit Name = Nama Folder Parent (langsung di atas file)
        // .trim().toUpperCase() agar "aum 17" terbaca "AUM 17"
        let unitName = pathParts[pathParts.length - 2].trim().toUpperCase(); 
        
        // Nama File (untuk parsing Tanggal & Tipe)
        const fileName = file.name.toLowerCase(); // Case insensitive

        // 2. Deteksi Tipe Foto
        let targetField = '';
        if (fileName.includes('awal')) targetField = 'foto_awal';
        else if (fileName.includes('akhir')) targetField = 'foto_akhir';
        else if (fileName.includes('ts') || fileName.includes('time') || fileName.includes('sheet')) targetField = 'foto_timesheet';

        if (!targetField) {
            logDiv.innerHTML += `<span style="color:orange;">[SKIP] ${file.name}: Tipe tidak dikenal (Gunakan: Awal, Akhir, TS)</span><br>`;
            failCount++;
            continue;
        }

        // 3. Deteksi Tanggal (Format: "1 Nov", "05 Desember", dll)
        // Regex mencari: Angka(1-2 digit) spasi Huruf(3+ digit)
        const dateRegex = /(\d{1,2})\s+([a-z]{3,})/i;
        const match = fileName.match(dateRegex);

        let formattedDate = null;

        if (match) {
            const day = parseInt(match[1]);
            const monthStr = match[2].toLowerCase(); // contoh: "nov"

            // Cari index bulan di mapping
            let monthIndex = -1;
            // Cek exact match atau startsWith
            for (const [key, val] of Object.entries(indonesianMonths)) {
                if (monthStr.startsWith(key)) {
                    monthIndex = val;
                    break;
                }
            }

            if (monthIndex !== -1) {
                // Buat tanggal YYYY-MM-DD
                // Perhatian: new Date(year, monthIndex, day)
                // Kita format manual stringnya
                const mm = String(monthIndex + 1).padStart(2, '0');
                const dd = String(day).padStart(2, '0');
                formattedDate = `${currentYear}-${mm}-${dd}`;
            }
        }

        if (!formattedDate) {
            logDiv.innerHTML += `<span style="color:red;">[ERR] ${file.name}: Tanggal tidak terbaca (Format contoh: '1 Nov')</span><br>`;
            failCount++;
            continue;
        }

        // 4. Pencocokan & Update Data
        const reportIndex = reportsData.findIndex(r => r.unit === unitName && r.tanggal === formattedDate);

        if (reportIndex !== -1) {
            try {
                // Kompresi & Simpan
                const base64 = await compressImagePromise(file);
                reportsData[reportIndex][targetField] = base64;
                
                logDiv.innerHTML += `<span style="color:green;">[OK] ${unitName} (${formattedDate}) updated.</span><br>`;
                successCount++;
                
                // Scroll log ke bawah
                logDiv.scrollTop = logDiv.scrollHeight;

            } catch (e) {
                console.error(e);
            }
        } else {
            // Opsional: Handle jika data belum ada (di sini kita skip dulu sesuai request "jika data sudah ada")
            logDiv.innerHTML += `<span style="color:#666;">[404] Data ${unitName} tgl ${formattedDate} belum ada. Foto dilewati.</span><br>`;
            failCount++;
        }
    }

    // Finalisasi
    if (successCount > 0) {
        saveReportsDataToLocalStorage();
        window.fetchReportData(); // Refresh Tabel
        showToast("Selesai", `${successCount} foto berhasil dimasukkan ke unit masing-masing.`, "success");
    } else {
        alert("Proses selesai. Tidak ada data yang cocok untuk diupdate.");
    }
    
    // Reset input agar bisa upload folder yang sama lagi jika perlu
    input.value = ''; 
};
// --- [SCRIPT BARU] POPULATE FILTER OPERATOR (AUM 24, 25, 26 ONLY) ---
function updateTriputraOperatorDropdown() {
    const opSelect = document.getElementById('trp_filter_operator');
    if (!opSelect) return;

    // Simpan nilai yang sedang dipilih
    const currentVal = opSelect.value;

    // Unit target yang diminta user
    const targetUnits = ['AUM 24', 'AUM 25', 'AUM 65'];

    // Cari operator unik yang pernah bekerja di unit target tersebut (berdasarkan data triputraData)
    // ATAU bisa juga berdasarkan masterUnits jika sudah didefinisikan defaultnya
    const specificOperators = new Set();

    // 1. Cek Master Data (Default Operator)
    targetUnits.forEach(u => {
        if (masterUnits[u] && masterUnits[u].operator_default) {
            specificOperators.add(masterUnits[u].operator_default.trim().toUpperCase());
        }
    });

    // 2. Cek Data Historis Laporan Triputra
    triputraData.forEach(d => {
        // Normalisasi nama unit (hapus spasi berlebih)
        const unitClean = d.unit.trim().toUpperCase();
        // Cek apakah unit termasuk dalam target (pencocokan parsial agar AUM 24 cocok dengan AUM 24)
        const isTarget = targetUnits.some(t => unitClean.includes(t.replace(' ', ''))); 
        
        // Atau pencocokan string direct jika format konsisten
        if (targetUnits.includes(unitClean)) {
            specificOperators.add(d.operator.trim().toUpperCase());
        }
    });

    // Render Ulang Dropdown
    opSelect.innerHTML = '<option value="all">-- Semua Operator --</option>';
    
    // Konversi Set ke Array, Sort, lalu Loop
    Array.from(specificOperators).sort().forEach(op => {
        if (op) {
            const option = document.createElement('option');
            option.value = op;
            option.textContent = op;
            opSelect.appendChild(option);
        }
    });

    // Kembalikan nilai terpilih jika masih ada di list
    opSelect.value = currentVal;
}
// ===============================================
// ===============================================
// === LOGIKA FUEL CONTROL (SMART CALCULATION) ===
// ===============================================

let fuelData = [];
let fuelChartInstance = null;

// 1. HELPER: SIMPAN KE DATABASE
async function saveFuelToStorage() {
    try {
        await idb.set('DOR_FuelData', fuelData);
    } catch (e) {
        console.error("Gagal simpan Fuel Data", e);
        showToast("Error", "Gagal menyimpan ke database.", "error");
    }
}

// 2. HELPER: ISI DROPDOWN TAHUN
function populateFuelYears() {
    const yearSelect = document.getElementById('fuel_filter_year');
    if (!yearSelect) return;
    const oldVal = yearSelect.value;
    yearSelect.innerHTML = '<option value="all">-- Semua Data (All Time) --</option>';
    const currentYear = new Date().getFullYear();
    for (let y = currentYear + 1; y >= currentYear - 3; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
    }
    if (oldVal && oldVal !== '') yearSelect.value = oldVal;
    else yearSelect.value = currentYear;
}

// 3. FUNGSI HITUNG METRIK CERDAS (Sequential Calculation)
// Ini inti perbaikan: Menghitung berdasarkan riwayat sebelumnya
function calculateFuelMetrics(allData) {
    // 1. Urutkan data dari TERLAMA ke TERBARU untuk perhitungan urut
    const sortedData = [...allData].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const metricsMap = {}; // Menyimpan hasil perhitungan per ID { dist: 50, ratio: 0.5 }
    const lastOdoMap = {}; // Menyimpan HM Akhir terakhir per Unit { "AUM 01": 15000 }

    sortedData.forEach(item => {
        const unit = item.unit;
        // Kita gunakan KM AKHIR sebagai patokan Odometer saat pengisian
        const currentOdo = parseFloat(item.kmEnd);
        const qty = parseFloat(item.qty) || 0;

        if (!isNaN(currentOdo)) {
            // Cek apakah ada data history sebelumnya untuk unit ini
            if (lastOdoMap[unit] !== undefined) {
                const prevOdo = lastOdoMap[unit];
                const distance = currentOdo - prevOdo;

                // Hitung Rasio hanya jika jarak positif dan ada pengisian solar
                if (distance > 0 && qty > 0) {
                    const ratio = qty / distance; // Liter per KM/HM
                    metricsMap[item.id] = {
                        dist: distance,
                        ratio: ratio.toFixed(2),
                        isValid: true
                    };
                } else {
                    // Jarak 0 atau negatif (mungkin salah input atau reset odometer)
                    metricsMap[item.id] = { 
                        dist: distance, 
                        ratio: '-', 
                        isValid: false 
                    };
                }
            } else {
                // Data Pertama (Initial Record) - Belum bisa hitung rasio
                metricsMap[item.id] = { dist: '-', ratio: '-', isValid: false, isFirst: true };
            }
            
            // Simpan Odometer ini sebagai referensi untuk data berikutnya
            lastOdoMap[unit] = currentOdo;
        } else {
            // Jika KM Akhir kosong/invalid
            metricsMap[item.id] = { dist: '-', ratio: '-', isValid: false };
        }
    });

    return metricsMap;
}

// 4. LOAD DATA
async function loadFuelData() {
    const stored = await idb.get('DOR_FuelData');
    fuelData = stored || [];
    
    // UI Default
    const dateInput = document.getElementById('fuel_date');
    if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().slice(0, 10);

    // Populate Datalist
    const dataList = document.getElementById('masterUnitListFuel');
    if (dataList && typeof masterUnits !== 'undefined') {
        dataList.innerHTML = '';
        Object.keys(masterUnits).sort().forEach(unitKey => {
            const option = document.createElement('option');
            option.value = unitKey;
            dataList.appendChild(option);
        });
    }

    populateFuelYears(); 
    const today = new Date();
    document.getElementById('fuel_filter_year').value = today.getFullYear();
    document.getElementById('fuel_filter_month_start').value = today.getMonth();
    document.getElementById('fuel_filter_month_end').value = today.getMonth();

    window.renderFuelTable();
}

// 5. SIMPAN TRANSAKSI
window.saveFuelTransaction = async function(e) {
    e.preventDefault();
    showToast("Processing", "Menyimpan data...", "info");

    const date = document.getElementById('fuel_date').value;
    const unit = document.getElementById('fuel_unit').value.toUpperCase(); 
    const nopol = document.getElementById('fuel_nopol').value.toUpperCase(); 
    const pic = document.getElementById('fuel_pic').value.toUpperCase();
    const loc = document.getElementById('fuel_location').value;
    const qty = parseFloat(document.getElementById('fuel_qty').value);

    // Input KM (Opsional)
    const rawKmStart = document.getElementById('fuel_km_awal').value;
    const rawKmEnd = document.getElementById('fuel_km_akhir').value;
    const kmStart = rawKmStart === "" ? null : parseFloat(rawKmStart);
    const kmEnd = rawKmEnd === "" ? null : parseFloat(rawKmEnd);

    if (kmStart !== null && kmEnd !== null && kmEnd < kmStart) {
        if(!confirm(`PERINGATAN: KM Akhir (${kmEnd}) lebih kecil dari KM Awal (${kmStart}). Lanjutkan?`)) return;
    }

    const file1 = document.getElementById('img_km_start').files[0];
    const file2 = document.getElementById('img_km_end').files[0];
    const file3 = document.getElementById('img_receipt').files[0];

    try {
        const compressPromise = (file) => (typeof compressImagePromise === 'function') ? compressImagePromise(file) : Promise.resolve(null);
        const [p1, p2, p3] = await Promise.all([compressPromise(file1), compressPromise(file2), compressPromise(file3)]);

        const newItem = {
            id: Date.now().toString(),
            date, unit, nopol, pic, loc, 
            kmStart: kmStart, kmEnd: kmEnd,
            qty,
            photos: { start: p1, end: p2, receipt: p3 }
        };

        fuelData.unshift(newItem);
        await saveFuelToStorage();
        
        window.renderFuelTable();
        document.getElementById('fuelForm').reset();
        document.getElementById('fuel_date').value = new Date().toISOString().slice(0, 10);
        showToast("Sukses", "Data BBM tersimpan.", "success");
    } catch (err) {
        console.error(err);
        showToast("Error", "Gagal menyimpan: " + err.message, "error");
    }
};

// 6. RENDER TABEL (MENGGUNAKAN LOGIKA PERHITUNGAN BARU)
window.renderFuelTable = function() {
    const tableHead = document.querySelector('#fuelTable thead tr');
    if(tableHead) {
        tableHead.innerHTML = `
            <th class="action-column" style="width: 100px;">Aksi</th>
            <th>Tanggal</th>
            <th>Unit & Nopol</th>
            <th>Driver/PIC</th>
            <th>Lokasi</th>
            <th>Odometer (Akhir)</th>
            <th>Jarak (Sejak Isi Terakhir)</th>
            <th>Volume</th>
            <th>Rasio (L/Km)</th>
            <th>Foto</th>
        `;
    }

    const tbody = document.getElementById('fuelBody');
    tbody.innerHTML = '';
    
    // 1. Hitung Metrik Dulu (Berdasarkan SEMUA data untuk akurasi history)
    const metrics = calculateFuelMetrics(fuelData);

    // 2. Filter Data untuk Tampilan
    const fYear = document.getElementById('fuel_filter_year').value;
    const fStart = parseInt(document.getElementById('fuel_filter_month_start').value);
    const fEnd = parseInt(document.getElementById('fuel_filter_month_end').value);
    const search = (document.getElementById('fuel_search').value || '').toLowerCase();

    const boxBulan = document.getElementById('fuel_month_box');
    if (fYear === 'all') { boxBulan.style.opacity = '0.4'; boxBulan.style.pointerEvents = 'none'; } 
    else { boxBulan.style.opacity = '1'; boxBulan.style.pointerEvents = 'auto'; }

    let filtered = fuelData.filter(item => {
        const d = new Date(item.date);
        const y = d.getFullYear();
        const m = d.getMonth();

        let dateMatch = true;
        if (fYear !== 'all') {
            if (y !== parseInt(fYear)) dateMatch = false;
            else {
                const rS = Math.min(fStart, fEnd);
                const rE = Math.max(fStart, fEnd);
                if (m < rS || m > rE) dateMatch = false;
            }
        }
        const textMatch = item.unit.toLowerCase().includes(search) || 
                          item.pic.toLowerCase().includes(search) ||
                          (item.nopol && item.nopol.toLowerCase().includes(search));
        return dateMatch && textMatch;
    });

    // Sort Tampilan: Terbaru di atas
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

    // KPI Calc
    const totalLiter = filtered.reduce((sum, i) => sum + (i.qty || 0), 0);
    document.getElementById('kpi_fuel_total').textContent = `${totalLiter.toLocaleString()} L`;
    document.getElementById('kpi_fuel_count').textContent = filtered.length;
    
    const unitStats = {}; 
    filtered.forEach(i => { unitStats[i.unit] = (unitStats[i.unit] || 0) + i.qty; });
    const topUnit = Object.keys(unitStats).length > 0 ? Object.keys(unitStats).reduce((a, b) => unitStats[a] > unitStats[b] ? a : b) : '-';
    document.getElementById('kpi_fuel_top_unit').textContent = topUnit;

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px; color:#666;">Tidak ada data.</td></tr>';
        if(fuelChartInstance) { fuelChartInstance.destroy(); fuelChartInstance = null; }
        return;
    }

    // 3. Render Baris
    filtered.forEach(item => {
        let photosHtml = '';
        if(item.photos.start) photosHtml += `<img src="${item.photos.start}" onclick="window.zoomImage(this.src)" style="width:25px; height:25px; object-fit:cover; border:1px solid #ccc; margin:1px;">`;
        if(item.photos.receipt) photosHtml += `<img src="${item.photos.receipt}" onclick="window.zoomImage(this.src)" style="width:25px; height:25px; object-fit:cover; border:1px solid #ccc; margin:1px;">`;

        // Ambil hasil perhitungan dari map
        const metric = metrics[item.id] || { dist: '-', ratio: '-' };
        
        let rasioClass = "";
        let distDisplay = metric.dist;
        
        // Formatting Tampilan
        if (metric.isValid) {
            distDisplay = Math.round(metric.dist) + " km";
            if (parseFloat(metric.ratio) > 1.5) rasioClass = "color:#dc3545; font-weight:bold;"; // Merah jika boros
            else rasioClass = "color:#198754; font-weight:bold;"; // Hijau jika irit
        } else if (metric.isFirst) {
            distDisplay = "<span style='color:#999; font-size:10px;'>(Data Awal)</span>";
        }

        const displayNopol = item.nopol ? `<br><span style="font-size:9px; color:#0d6efd;">${item.nopol}</span>` : '';
        const kmEndDisplay = (item.kmEnd !== null && item.kmEnd !== "") ? item.kmEnd : "-";

        const row = `
            <tr>
                <td class="action-column">
                    <div style="display: flex; gap: 5px; justify-content: center;">
                        <button onclick="window.openFuelEditModal('${item.id}')" title="Edit Data" style="background:#ffc107; color:#000; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">‚úèÔ∏è</button>
                        <button onclick="window.deleteFuelItem('${item.id}')" title="Hapus Data" style="background:#dc3545; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </td>
                <td>${formatDate(item.date)}</td>
                <td style="font-weight:bold;">${item.unit}${displayNopol}</td>
                <td>${item.pic}</td>
                <td>${item.loc || '-'}</td>
                <td style="font-weight:bold;">${kmEndDisplay}</td>
                <td>${distDisplay}</td>
                <td style="font-weight:bold; color:#fd7e14;">${item.qty} L</td>
                <td style="${rasioClass}">${metric.ratio}</td>
                <td><div style="display:flex; justify-content:center;">${photosHtml || '-'}</div></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    updateFuelChart(filtered, metrics);
};

// 7. CHART ANALISA (MENGGUNAKAN DATA METRIK BARU)
function updateFuelChart(data, metrics) {
    const ctx = document.getElementById('fuelMainChart');
    if (!ctx) return;
    if (fuelChartInstance) fuelChartInstance.destroy();

    const chartType = document.getElementById('fuel_chart_type').value; 
    const labels = [];
    const values = [];
    let labelText = "";
    let bgColor = "";

    if (chartType === 'total') {
        const grp = {};
        data.forEach(d => { grp[d.unit] = (grp[d.unit] || 0) + d.qty; });
        const sorted = Object.entries(grp).sort((a,b) => b[1] - a[1]);
        sorted.forEach(([k,v]) => { labels.push(k); values.push(v); });
        labelText = "Total Volume Solar (Liter)";
        bgColor = "rgba(253, 126, 20, 0.7)"; 

    } else if (chartType === 'ratio') {
        // Rata-rata Rasio per Unit
        const grp = {}; 
        data.forEach(d => {
            const m = metrics[d.id];
            if (m && m.isValid) {
                const r = parseFloat(m.ratio);
                if(!grp[d.unit]) grp[d.unit] = { sum:0, count:0 };
                grp[d.unit].sum += r;
                grp[d.unit].count++;
            }
        });
        const sorted = Object.entries(grp).map(([k,v]) => [k, v.sum/v.count]).sort((a,b) => b[1] - a[1]);
        sorted.forEach(([k,v]) => { labels.push(k); values.push(v.toFixed(2)); });
        labelText = "Rata-rata Pemakaian (Liter/Km)";
        bgColor = "rgba(220, 53, 69, 0.7)";

    } else if (chartType === 'trend') {
        const grp = {};
        data.forEach(d => {
            const dateStr = d.date.split('T')[0]; 
            grp[dateStr] = (grp[dateStr] || 0) + d.qty;
        });
        const sorted = Object.entries(grp).sort((a,b) => new Date(a[0]) - new Date(b[0]));
        sorted.forEach(([k,v]) => { labels.push(formatDate(k)); values.push(v); });
        labelText = "Tren Pemakaian Harian (Liter)";
        bgColor = "rgba(13, 110, 253, 0.5)";
    }

    fuelChartInstance = new Chart(ctx, {
        type: chartType === 'trend' ? 'line' : 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: labelText,
                data: values,
                backgroundColor: bgColor,
                borderColor: bgColor.replace('0.5', '1').replace('0.7', '1'),
                borderWidth: 1,
                fill: chartType === 'trend'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                datalabels: {
                    color: '#000',
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold', size: 10 },
                    formatter: (val) => val
                }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// 8. HAPUS & EDIT
window.deleteFuelItem = async function(id) {
    if(!confirm("Yakin ingin menghapus data BBM ini secara permanen?")) return;
    const initialLen = fuelData.length;
    fuelData = fuelData.filter(i => i.id !== id);
    if(fuelData.length === initialLen) fuelData = fuelData.filter(i => i.id != id); 
    await saveFuelToStorage();
    window.renderFuelTable();
    showToast("Dihapus", "Data berhasil dihapus.", "success");
};

window.openFuelEditModal = function(id) {
    const item = fuelData.find(i => i.id === id);
    if (!item) return alert("Data tidak ditemukan.");
    document.getElementById('edit_fuel_id').value = id;
    document.getElementById('edit_fuel_date').value = item.date;
    document.getElementById('edit_fuel_unit').value = item.unit;
    document.getElementById('edit_fuel_nopol').value = item.nopol || '';
    document.getElementById('edit_fuel_pic').value = item.pic;
    document.getElementById('edit_fuel_location').value = item.loc || '';
    document.getElementById('edit_fuel_km_awal').value = (item.kmStart !== null) ? item.kmStart : '';
    document.getElementById('edit_fuel_km_akhir').value = (item.kmEnd !== null) ? item.kmEnd : '';
    document.getElementById('edit_fuel_qty').value = item.qty;

    const setPrev = (imgId, src) => { document.getElementById(imgId).src = src || ''; document.getElementById(imgId).style.display = src ? 'block' : 'none'; };
    setPrev('prev_edit_start', item.photos?.start);
    setPrev('prev_edit_end', item.photos?.end);
    setPrev('prev_edit_receipt', item.photos?.receipt);

    document.getElementById('edit_img_start').value = '';
    document.getElementById('edit_img_end').value = '';
    document.getElementById('edit_img_receipt').value = '';
    document.getElementById('editFuelModal').style.display = 'block';
};

window.saveFuelEdit = async function() {
    const id = document.getElementById('edit_fuel_id').value;
    const index = fuelData.findIndex(i => i.id === id);
    if (index === -1) return alert("Data sumber hilang.");
    const oldItem = fuelData[index];

    const date = document.getElementById('edit_fuel_date').value;
    const unit = document.getElementById('edit_fuel_unit').value.toUpperCase();
    const nopol = document.getElementById('edit_fuel_nopol').value.toUpperCase();
    const pic = document.getElementById('edit_fuel_pic').value.toUpperCase();
    const loc = document.getElementById('edit_fuel_location').value;
    const qty = parseFloat(document.getElementById('edit_fuel_qty').value);
    
    const rawKmStart = document.getElementById('edit_fuel_km_awal').value;
    const rawKmEnd = document.getElementById('edit_fuel_km_akhir').value;
    const kmStart = rawKmStart === "" ? null : parseFloat(rawKmStart);
    const kmEnd = rawKmEnd === "" ? null : parseFloat(rawKmEnd);

    const file1 = document.getElementById('edit_img_start').files[0];
    const file2 = document.getElementById('edit_img_end').files[0];
    const file3 = document.getElementById('edit_img_receipt').files[0];

    showToast("Menyimpan...", "Mengupdate data...", "info");

    try {
        const compressPromise = (file) => (typeof compressImagePromise === 'function') ? compressImagePromise(file) : Promise.resolve(null);
        const p1 = file1 ? await compressPromise(file1) : oldItem.photos.start;
        const p2 = file2 ? await compressPromise(file2) : oldItem.photos.end;
        const p3 = file3 ? await compressPromise(file3) : oldItem.photos.receipt;

        fuelData[index] = {
            ...oldItem,
            date, unit, nopol, pic, loc, qty,
            kmStart, kmEnd,
            photos: { start: p1, end: p2, receipt: p3 }
        };

        await saveFuelToStorage();
        window.renderFuelTable();
        document.getElementById('editFuelModal').style.display = 'none';
        showToast("Updated", "Data BBM berhasil diperbarui.", "success");
    } catch (err) {
        console.error(err);
        showToast("Error", "Gagal update: " + err.message, "error");
    }
};

// 9. PRINT PDF (Update Kolom)
// ===============================================
// === 10. PRINT PDF PROFESIONAL (CORPORATE BLUE) ===
// ===============================================
// ========================================================
// === FITUR PRINT PDF PROFESIONAL (CORPORATE BLUE THEME) ===
// ========================================================
// ========================================================
// === 10. PRINT PDF PROFESIONAL (PREMIUM CORPORATE STYLE) ===
// ========================================================
window.printFuelReport = function() {
    // 1. Ambil Data & Filter (Sama seperti logika tabel utama)
    const fYear = document.getElementById('fuel_filter_year').value;
    const mStart = document.getElementById('fuel_filter_month_start');
    const mEnd = document.getElementById('fuel_filter_month_end');
    const search = (document.getElementById('fuel_search').value || '').toLowerCase();
    
    // Label Periode
    let labelPeriode = "SEMUA DATA (ALL TIME)";
    if (fYear !== 'all') {
        const txtStart = mStart.options[mStart.selectedIndex].text;
        const txtEnd = mEnd.options[mEnd.selectedIndex].text;
        if (mStart.value === mEnd.value) labelPeriode = `${txtStart} ${fYear}`;
        else labelPeriode = `${txtStart} s/d ${txtEnd} ${fYear}`;
    }

    // Filter Data
    const fStart = parseInt(mStart.value);
    const fEnd = parseInt(mEnd.value);

    let filtered = fuelData.filter(item => {
        const d = new Date(item.date);
        const y = d.getFullYear();
        const m = d.getMonth();
        let dateMatch = true;
        if (fYear !== 'all') {
            if (y !== parseInt(fYear)) dateMatch = false;
            else {
                const rS = Math.min(fStart, fEnd);
                const rE = Math.max(fStart, fEnd);
                if (m < rS || m > rE) dateMatch = false;
            }
        }
        const textMatch = item.unit.toLowerCase().includes(search) || 
                          item.pic.toLowerCase().includes(search) ||
                          (item.nopol && item.nopol.toLowerCase().includes(search));
        return dateMatch && textMatch;
    });

    // Urutkan Kronologis
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

    // Hitung Metrik untuk Laporan (Total & Avg)
    let totalVolume = 0;
    let totalJarak = 0;
    let totalTransactions = filtered.length;
    
    // Kita hitung dulu metrik per item untuk ditampilkan
    const metrics = calculateFuelMetrics(fuelData); // Pastikan fungsi ini ada

    filtered.forEach(item => {
        totalVolume += parseFloat(item.qty) || 0;
        const m = metrics[item.id];
        if (m && m.isValid) totalJarak += m.dist;
    });

    const avgRasioGlobal = totalJarak > 0 ? (totalVolume / totalJarak).toFixed(2) : "-";

    // 2. BUILD HTML STRUKTUR (CSS INLINE UNTUK PRINT PERFECT)
    let html = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; color: #333; padding: 0; font-size: 10px;">
        
        <table style="width: 100%; border-bottom: 2px solid #0056b3; margin-bottom: 15px; padding-bottom: 10px;">
            <tr>
                <td style="width: 60%; vertical-align: top;">
                    <div style="font-size: 20px; font-weight: 800; color: #0056b3; letter-spacing: 1px;">PT ADHIE USAHA MANDIRI</div>
                    <div style="font-size: 11px; color: #555; margin-top: 4px;">
                        Mining & Construction Services<br>
                        Site Project: Kalimantan Timur
                    </div>
                </td>
                <td style="width: 40%; text-align: right; vertical-align: top;">
                    <div style="font-size: 16px; font-weight: bold; color: #333;">FUEL CONSUMPTION REPORT</div>
                    <div style="font-size: 11px; margin-top: 5px;">Periode: <span style="font-weight:bold;">${labelPeriode.toUpperCase()}</span></div>
                    <div style="font-size: 9px; color: #777;">Printed: ${new Date().toLocaleString('id-ID')}</div>
                </td>
            </tr>
        </table>

        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <div style="flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f8f9fa;">
                <div style="font-size: 9px; color: #666; text-transform: uppercase;">Total Transaksi</div>
                <div style="font-size: 14px; font-weight: bold; color: #333;">${totalTransactions} <span style="font-size:10px; font-weight:normal;">Kali</span></div>
            </div>
            <div style="flex: 1; border: 1px solid #0056b3; padding: 10px; border-radius: 4px; background: #e6f0ff;">
                <div style="font-size: 9px; color: #0056b3; text-transform: uppercase;">Total Volume Solar</div>
                <div style="font-size: 14px; font-weight: bold; color: #0056b3;">${totalVolume.toLocaleString('id-ID')} <span style="font-size:10px; font-weight:normal;">Liter</span></div>
            </div>
            <div style="flex: 1; border: 1px solid #ccc; padding: 10px; border-radius: 4px; background: #f8f9fa;">
                <div style="font-size: 9px; color: #666; text-transform: uppercase;">Rata-rata Efisiensi</div>
                <div style="font-size: 14px; font-weight: bold; color: ${avgRasioGlobal > 1.5 ? '#dc3545' : '#198754'};">
                    ${avgRasioGlobal} <span style="font-size:10px; font-weight:normal;">L/Km</span>
                </div>
            </div>
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
            <thead>
                <tr style="background-color: #0056b3; color: white;">
                    <th style="border: 1px solid #004494; padding: 8px; width: 3%;">NO</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 10%;">TANGGAL</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 12%;">UNIT / NOPOL</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 12%;">DRIVER / PIC</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 10%;">LOKASI</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 13%;">ODOMETER (START-END)</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 7%;">JARAK (KM)</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 10%;">VOLUME (L)</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 8%;">RASIO (L/KM)</th>
                    <th style="border: 1px solid #004494; padding: 8px; width: 15%;">BUKTI FOTO</th>
                </tr>
            </thead>
            <tbody>
    `;

    filtered.forEach((item, index) => {
        // Ambil metrik per item
        const metric = metrics[item.id] || { dist: '-', ratio: '-' };
        let distStr = metric.isValid ? Math.round(metric.dist) : '-';
        let rasioStr = metric.isValid ? metric.ratio : '-';
        
        const kmDisplay = (item.kmStart !== null && item.kmEnd !== null) ? `${item.kmStart} - ${item.kmEnd}` : "-";
        
        // Foto Thumbnail (Lebih kecil dan rapi)
        let photosHtml = '<div style="display:flex; justify-content:center; gap:3px;">';
        if(item.photos.start) photosHtml += `<img src="${item.photos.start}" style="width:25px; height:25px; object-fit:cover; border:1px solid #999;">`;
        if(item.photos.end) photosHtml += `<img src="${item.photos.end}" style="width:25px; height:25px; object-fit:cover; border:1px solid #999;">`;
        if(item.photos.receipt) photosHtml += `<img src="${item.photos.receipt}" style="width:25px; height:25px; object-fit:cover; border:1px solid #999;">`;
        photosHtml += '</div>';

        // Zebra Striping Row Color
        const bgRow = index % 2 === 0 ? '#ffffff' : '#f4f8fb';
        
        // Indikator Warna Rasio (Jika terlalu boros)
        const rasioStyle = (metric.isValid && parseFloat(metric.ratio) > 1.5) ? "color: red; font-weight: bold;" : "";

        html += `
            <tr style="background-color: ${bgRow};">
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center;">${index + 1}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center;">${formatDate(item.date)}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px;">
                    <div style="font-weight:bold;">${item.unit}</div>
                    <div style="font-size:8px; color:#666;">${item.nopol || ''}</div>
                </td>
                <td style="border: 1px solid #d1d9e6; padding: 5px;">${item.pic}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px;">${item.loc || '-'}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center;">${kmDisplay}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center;">${distStr}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center; font-weight: bold;">${item.qty.toLocaleString('id-ID')}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center; ${rasioStyle}">${rasioStr}</td>
                <td style="border: 1px solid #d1d9e6; padding: 5px; text-align: center;">${photosHtml}</td>
            </tr>
        `;
    });

    // Baris Total di Bawah Tabel
    html += `
            <tr style="background-color: #e6f0ff; font-weight: bold; border-top: 2px solid #0056b3;">
                <td colspan="7" style="border: 1px solid #d1d9e6; padding: 8px; text-align: right; color: #0056b3;">TOTAL VOLUME:</td>
                <td style="border: 1px solid #d1d9e6; padding: 8px; text-align: center; color: #0056b3;">${totalVolume.toLocaleString('id-ID')} Liter</td>
                <td colspan="2" style="border: 1px solid #d1d9e6; background-color: #e6f0ff;"></td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid;">
        <div style="width: 30%; text-align: center;">
            <p style="font-size: 10px; margin-bottom: 50px; color:#555;">Dibuat Oleh,</p>
            <p style="border-top: 1px solid #333; display: inline-block; width: 70%; padding-top: 5px; font-size: 10px; font-weight: bold;">
                Admin Logistik
            </p>
        </div>
        <div style="width: 30%; text-align: center;">
            <p style="font-size: 10px; margin-bottom: 50px; color:#555;">Diperiksa Oleh,</p>
            <p style="border-top: 1px solid #333; display: inline-block; width: 70%; padding-top: 5px; font-size: 10px; font-weight: bold;">
                Pengawas / Foreman
            </p>
        </div>
        <div style="width: 30%; text-align: center;">
            <p style="font-size: 10px; margin-bottom: 50px; color:#555;">Disetujui Oleh,</p>
            <p style="border-top: 1px solid #333; display: inline-block; width: 70%; padding-top: 5px; font-size: 10px; font-weight: bold;">
                Project Manager
            </p>
        </div>
    </div>
    
    <div style="margin-top: 20px; text-align: center; font-size: 8px; color: #999; border-top: 1px solid #eee; padding-top: 5px;">
        Dokumen ini digenerate secara otomatis oleh Sistem Daily Operator Report (DOR).
    </div>

    </div>`;

    // 3. INJECT & PRINT
    const printArea = document.getElementById('fuel-print-area');
    if (printArea) {
        printArea.innerHTML = html;
        document.body.classList.add('print-fuel-mode'); // Trigger CSS khusus print
        
        // Delay sedikit agar gambar termuat sebelum dialog print muncul
        setTimeout(() => {
            window.print();
        }, 500);

        // Hapus class setelah selesai
        const cleanup = () => {
            document.body.classList.remove('print-fuel-mode');
            window.removeEventListener('afterprint', cleanup);
        };
        window.addEventListener('afterprint', cleanup);
    } else {
        alert("Area print tidak ditemukan. Mohon refresh halaman.");
    }
};// ===============================================
// === 11. EXPORT EXCEL (FORMAT BARU: SESUAI GAMBAR) ===
// ===============================================
window.exportFuelExcel = function() {
    // 1. Ambil Filter
    const fYear = document.getElementById('fuel_filter_year').value;
    const mStart = document.getElementById('fuel_filter_month_start');
    const mEnd = document.getElementById('fuel_filter_month_end');
    const search = (document.getElementById('fuel_search').value || '').toLowerCase();

    // Label Periode untuk Judul Excel
    let labelPeriode = "SEMUA DATA (ALL TIME)";
    if (fYear !== 'all') {
        const txtStart = mStart.options[mStart.selectedIndex].text;
        const txtEnd = mEnd.options[mEnd.selectedIndex].text;
        if (mStart.value === mEnd.value) labelPeriode = `${txtStart} ${fYear}`;
        else labelPeriode = `${txtStart} s/d ${txtEnd} ${fYear}`;
    }

    // 2. Filter Data & Sort
    const fStart = parseInt(mStart.value);
    const fEnd = parseInt(mEnd.value);
    
    let filtered = fuelData.filter(item => {
        const d = new Date(item.date);
        const y = d.getFullYear();
        const m = d.getMonth();
        let dateMatch = true;
        if (fYear !== 'all') {
            if (y !== parseInt(fYear)) dateMatch = false;
            else {
                const rS = Math.min(fStart, fEnd);
                const rE = Math.max(fStart, fEnd);
                if (m < rS || m > rE) dateMatch = false;
            }
        }
        const textMatch = item.unit.toLowerCase().includes(search) || 
                          item.pic.toLowerCase().includes(search) ||
                          (item.nopol && item.nopol.toLowerCase().includes(search));
        return dateMatch && textMatch;
    });
    
    // Sort berdasarkan Unit lalu Tanggal (Agar data kendaraan yang sama berkumpul)
    filtered.sort((a, b) => {
        if (a.unit < b.unit) return -1;
        if (a.unit > b.unit) return 1;
        return new Date(a.date) - new Date(b.date);
    });

    if (filtered.length === 0) return alert("Tidak ada data untuk diexport.");

    // 3. Buat String HTML untuk Excel
    // Kita set colspan=9 karena sekarang ada 9 kolom
    const colCount = 9; 

    let html = `
    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
    <head>
        <meta charset="UTF-8">
        <style>
            table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
            th, td { border: 1px solid #000000; padding: 6px; font-size: 11px; vertical-align: middle; }
            
            /* Header Biru Corporate */
            .header-blue { 
                background-color: #0056b3; 
                color: #ffffff; 
                font-weight: bold; 
                text-align: center; 
                height: 35px;
                vertical-align: middle;
            }
            
            /* Judul Besar */
            .title-row {
                font-size: 16px;
                font-weight: bold;
                text-align: center;
                background-color: #e6f0ff; /* Biru sangat muda */
                color: #0056b3;
                height: 40px;
                border: 1px solid #000;
            }
            .period-row {
                font-size: 12px;
                font-weight: bold;
                text-align: center;
                background-color: #ffffff;
                height: 25px;
                border: 1px solid #000;
            }
            
            /* Helper Alignment */
            .text-center { text-align: center; }
            .text-right { text-align: right; }
            .text-left { text-align: left; }
            .bg-total { background-color: #e6f0ff; font-weight: bold; color: #0056b3; }
        </style>
    </head>
    <body>
        <table>
            <tr>
                <td colspan="${colCount}" class="title-row">LAPORAN PEMAKAIAN BAHAN BAKAR (FUEL CONSUMPTION)</td>
            </tr>
            <tr>
                <td colspan="${colCount}" class="period-row">PERIODE: ${labelPeriode.toUpperCase()}</td>
            </tr>
            <tr><td colspan="${colCount}" style="height:10px; border:none;"></td></tr>

            <thead>
                <tr>
                    <th class="header-blue" style="width:40px;">No</th>
                    <th class="header-blue" style="width:100px;">Tanggal</th>
                    <th class="header-blue" style="width:150px;">Driver</th>
                    <th class="header-blue" style="width:120px;">No Polisi / Unit</th>
                    
                    <th class="header-blue" style="width:80px;">KM Awal</th>
                    <th class="header-blue" style="width:80px;">KM Akhir</th>
                    <th class="header-blue" style="width:80px;">Total KM</th>
                    
                    <th class="header-blue" style="width:100px;">BBM (Liter)</th>
                    <th class="header-blue" style="width:100px;">Konsumsi (Km/Liter)</th>
                </tr>
            </thead>
            <tbody>
    `;

    let totalVol = 0;
    
    filtered.forEach((item, index) => {
        const qty = parseFloat(item.qty) || 0;
        totalVol += qty;
        
        // Perhitungan Jarak & Rasio
        const start = parseFloat(item.kmStart);
        const end = parseFloat(item.kmEnd);
        let dist = 0;
        let kmAwalStr = "-";
        let kmAkhirStr = "-";
        let distStr = "-";
        let rasioStr = "-";

        if (!isNaN(start) && !isNaN(end)) {
            kmAwalStr = start;
            kmAkhirStr = end;
            dist = end - start;
            
            if (dist > 0) {
                distStr = Math.round(dist);
                if (qty > 0) {
                    // Rumus Gambar: Jarak / Liter (Km per Liter) -> Makin besar makin irit
                    // Rumus Lama: Liter / Jarak -> Makin kecil makin irit
                    // Kita pakai Rumus Gambar (Km/Liter)
                    const val = dist / qty; 
                    rasioStr = val.toFixed(2).replace('.', ','); 
                }
            }
        } else {
            // Tampilkan apa adanya jika bukan angka (misal strip)
            kmAwalStr = item.kmStart || '-';
            kmAkhirStr = item.kmEnd || '-';
        }

        // Format Nopol gabung unit jika perlu, atau nopol saja
        let unitDisplay = item.nopol ? `${item.nopol}` : item.unit;
        if (item.nopol && item.unit && item.nopol !== item.unit) {
            unitDisplay = `${item.nopol} (${item.unit})`;
        }

        html += `
            <tr>
                <td class="text-center">${index + 1}</td>
                <td class="text-center">${formatDate(item.date)}</td>
                <td class="text-left">${item.pic}</td>
                <td class="text-center" style="font-weight:bold;">${unitDisplay}</td>
                
                <td class="text-center" style="mso-number-format:'0';">${kmAwalStr}</td>
                <td class="text-center" style="mso-number-format:'0';">${kmAkhirStr}</td>
                <td class="text-center">${distStr}</td>
                
                <td class="text-center">${qty.toString().replace('.', ',')}</td>
                <td class="text-center">${rasioStr}</td>
            </tr>
        `;
    });

    // Footer Total
    html += `
            <tr>
                <td colspan="7" class="text-right bg-total">TOTAL VOLUME BBM:</td>
                <td class="text-center bg-total">${totalVol.toLocaleString('id-ID')}</td>
                <td class="bg-total"></td>
            </tr>
        </tbody>
        </table>
    </body>
    </html>
    `;

    // 4. Download Process
    const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Laporan_Fuel_${labelPeriode.replace(/\s+/g, '_')}.xls`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    showToast("Download", "Excel (Format Baru) berhasil diunduh.", "success");
};
// --- UPDATE LOGIC 2: MAINTENANCE FASILITAS (STANDARD WORK ORDER) ---

window.saveGAMaint = async function(e) {
    e.preventDefault();
    
    // Ambil data form baru
    const category = document.getElementById('ga_maint_cat').value;
    const priority = document.getElementById('ga_maint_prio').value;
    
    gaData.maintenance.unshift({
        id: Date.now().toString(),
        date: new Date().toISOString().substring(0,10),
        cat: category,      // Baru
        prio: priority,     // Baru
        loc: document.getElementById('ga_maint_loc').value,
        desc: document.getElementById('ga_maint_desc').value,
        pelapor: document.getElementById('ga_maint_pelapor').value,
        status: 'Open',     // Default status
        finishDate: '-'
    });

    await saveGAData();
    renderGAMaintTable();
    e.target.reset();
    
    // Reset default select
    document.getElementById('ga_maint_prio').value = "Medium";
    document.getElementById('ga_maint_cat').value = "Listrik/Elektrikal";
    
    showToast("Work Order", "Tiket perbaikan berhasil dibuat.", "success");
}

function renderGAMaintTable() {
    const tbody = document.getElementById('gaMaintBody');
    tbody.innerHTML = '';
    
    // Sort: Status Open/Proses paling atas, lalu berdasarkan Prioritas (Critical > High > Medium > Low)
    const priorityMap = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
    
    gaData.maintenance.sort((a,b) => {
        // Jika status beda (Open vs Selesai)
        if (a.status !== 'Selesai' && b.status === 'Selesai') return -1;
        if (a.status === 'Selesai' && b.status !== 'Selesai') return 1;
        
        // Jika status sama, urutkan prioritas
        const prioA = priorityMap[a.prio] || 0;
        const prioB = priorityMap[b.prio] || 0;
        return prioB - prioA; // Descending (Critical dulu)
    });

    gaData.maintenance.forEach(item => {
        // Style Status Badge
        let badgeClass = 'ga-open';
        if(item.status === 'Proses') badgeClass = 'ga-process';
        if(item.status === 'Selesai') badgeClass = 'ga-done';

        // Style Priority Badge
        let prioColor = '#6c757d'; // Low (Grey)
        let prioBg = '#e2e3e5';
        
        if (item.prio === 'Medium') { prioColor = '#856404'; prioBg = '#fff3cd'; }
        if (item.prio === 'High') { prioColor = '#721c24'; prioBg = '#f8d7da'; }
        if (item.prio === 'Critical') { prioColor = 'white'; prioBg = '#dc3545'; }

        const prioBadge = `<span style="background:${prioBg}; color:${prioColor}; padding:3px 8px; border-radius:4px; font-weight:bold; font-size:10px;">${item.prio}</span>`;

        tbody.innerHTML += `
            <tr>
                <td class="action-column">
                    <div style="display:flex; gap:3px; justify-content:center;">
                        <button onclick="window.updateGAStatus('maintenance', '${item.id}', 'Proses')" title="Kerjakan" style="background:#ffc107; border:none; border-radius:3px; cursor:pointer;">üî®</button>
                        <button onclick="window.updateGAStatus('maintenance', '${item.id}', 'Selesai')" title="Selesai" style="background:#198754; color:white; border:none; border-radius:3px; cursor:pointer;">‚úÖ</button>
                        <button onclick="window.deleteGAItem('maintenance', '${item.id}')" title="Hapus" style="background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </td>
                <td>${formatDate(item.date)}</td>
                <td>${prioBadge}</td>
                <td><span style="font-weight:bold; color:#555;">${item.cat || '-'}</span></td>
                <td style="text-align:left;">
                    <div style="font-weight:bold;">${item.loc}</div>
                    <div style="font-size:11px; color:#666;">Isi: ${item.desc}</div>
                </td>
                <td>${item.pelapor}</td>
                <td><span class="ga-status-badge ${badgeClass}">${item.status}</span></td>
                <td style="font-size:11px;">${item.finishDate}</td>
            </tr>
        `;
    });
    
    // Update dashboard counter
    updateGAKPI();
}
// --- LOGIKA NAVIGASI SUB-TAB GENERAL AFFAIR ---
window.switchGATab = function(tabName) {
    // 1. Reset Style Tombol (Hapus class 'active' dari semua tombol)
    document.querySelectorAll('.ga-sub-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // 2. Tambahkan class 'active' ke tombol yang diklik saat ini
    // (Mencari tombol berdasarkan onclick yang cocok)
    const activeBtn = document.querySelector(`.ga-sub-tab-btn[onclick*="${tabName}"]`);
    if(activeBtn) activeBtn.classList.add('active');

    // 3. Sembunyikan SEMUA Section GA
    document.getElementById('ga_section_docs').style.display = 'none';
    document.getElementById('ga_section_maint').style.display = 'none';
    document.getElementById('ga_section_req').style.display = 'none';

    // 4. Tampilkan Section yang dipilih
    const targetSection = document.getElementById(`ga_section_${tabName}`);
    if (targetSection) {
        targetSection.style.display = 'block';
        
        // Render ulang tabel agar data terbaru muncul saat tab dibuka
        if (tabName === 'docs') renderGADocsTable();
        if (tabName === 'maint') renderGAMaintTable();
        if (tabName === 'req') renderGAReqTable();
    } else {
        console.error(`Section ga_section_${tabName} tidak ditemukan di HTML!`);
    }
}
// ================================================================
// === MODUL GENERAL AFFAIR (GA) - VERSI PERBAIKAN (STABIL) ===
// ================================================================

// 1. Inisialisasi Struktur Data Awal (Mencegah Error "Undefined")
let gaData = {
    documents: [],
    maintenance: [],
    requests: []
};

// 2. Helper Khusus: Wrapper Kompresi Foto (Wajib ada agar tombol simpan tidak macet)
function compressImagePromise(file) {
    return new Promise((resolve, reject) => {
        if (!file) {
            resolve(null);
            return;
        }
        // Memanggil fungsi compressImage global yang sudah ada di sistem utama
        if (typeof compressImage === 'function') {
            compressImage(file, (base64) => {
                if (base64) resolve(base64);
                else resolve(null); // Resolves null jika gagal, bukan reject (biar tidak crash)
            });
        } else {
            // Fallback jika fungsi kompresi utama tidak ditemukan
            console.warn("Fungsi compressImage tidak ditemukan, upload tanpa kompresi.");
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsDataURL(file);
        }
    });
}

// 3. Load Data dari Database
window.loadGAView = async function() {
    try {
        const stored = await idb.get('DOR_GA_Data');
        if (stored) {
            gaData = stored;
            // Validasi struktur array (jika data lama korup/kosong)
            if (!Array.isArray(gaData.documents)) gaData.documents = [];
            if (!Array.isArray(gaData.maintenance)) gaData.maintenance = [];
            if (!Array.isArray(gaData.requests)) gaData.requests = [];
        }
        
        // Update Tampilan
        updateGAKPI();
        window.switchGATab('docs'); // Default buka tab dokumen
        console.log("GA Data Loaded:", gaData); // Debugging
    } catch (e) {
        console.error("Gagal load GA:", e);
        alert("Gagal memuat data GA. Cek console browser.");
    }
}

// 4. Navigasi Tab GA
window.switchGATab = function(tabName) {
    // Reset Style Tombol
    document.querySelectorAll('.ga-sub-tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Highlight Tombol Aktif (Cari berdasarkan onclick text)
    const activeBtn = document.querySelector(`.ga-sub-tab-btn[onclick*="${tabName}"]`);
    if(activeBtn) activeBtn.classList.add('active');

    // Sembunyikan Semua Section
    const sections = ['docs', 'maint', 'req'];
    sections.forEach(sec => {
        const el = document.getElementById(`ga_section_${sec}`);
        if(el) el.style.display = 'none';
    });

    // Tampilkan Section Target
    const target = document.getElementById(`ga_section_${tabName}`);
    if (target) {
        target.style.display = 'block';
        // Render tabel sesuai tab
        if (tabName === 'docs') renderGADocsTable();
        if (tabName === 'maint') renderGAMaintTable();
        if (tabName === 'req') renderGAReqTable();
    }
}

// 5. Simpan Data ke Database
async function saveGAData() {
    try {
        await idb.set('DOR_GA_Data', gaData);
        updateGAKPI();
    } catch (e) {
        console.error("Save Error:", e);
        alert("Gagal menyimpan ke database!");
    }
}

// ============================================
// === FITUR 1: LEGALITAS DOKUMEN (STNK/KIR) ===
// ============================================
window.saveGADoc = async function(e) {
    e.preventDefault(); // Mencegah reload halaman
    
    try {
        const unit = document.getElementById('ga_doc_unit').value.toUpperCase();
        const type = document.getElementById('ga_doc_type').value;
        const date = document.getElementById('ga_doc_date').value;
        const fileInput = document.getElementById('ga_doc_photo');

        if (!unit || !date) return alert("Unit dan Tanggal Expired wajib diisi!");

        // Proses Foto
        const photo = fileInput.files[0] ? await compressImagePromise(fileInput.files[0]) : null;

        // Push Data
        gaData.documents.push({
            id: Date.now().toString(),
            unit, type, date, photo
        });

        await saveGAData();
        renderGADocsTable();
        
        // Reset Form
        document.getElementById('ga_doc_unit').value = '';
        document.getElementById('ga_doc_date').value = '';
        document.getElementById('ga_doc_photo').value = '';
        
        showToast("Sukses", "Data Legalitas Disimpan", "success");
    } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat menyimpan dokumen: " + err.message);
    }
}

function renderGADocsTable() {
    const tbody = document.getElementById('gaDocsBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const today = new Date();

    gaData.documents.sort((a,b) => new Date(a.date) - new Date(b.date));

    gaData.documents.forEach(item => {
        const expDate = new Date(item.date);
        const diffTime = expDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        let statusClass = "exp-safe";
        let statusText = "Aktif";
        if (diffDays < 0) { statusClass = "exp-danger"; statusText = "EXPIRED"; }
        else if (diffDays <= 30) { statusClass = "exp-warn"; statusText = "SEGERA PERPANJANG"; }

        const photoHtml = item.photo ? `<button onclick="window.zoomImage('${item.photo}')" style="cursor:pointer; border:1px solid #ccc; background:#fff; padding:2px 5px; border-radius:4px;">üì∏ Lihat</button>` : '-';

        tbody.innerHTML += `
            <tr>
                <td class="action-column">
                    <button onclick="window.deleteGAItem('documents', '${item.id}')" style="background:#dc3545; border:none; color:white; border-radius:4px; padding:5px 10px; cursor:pointer;">üóëÔ∏è</button>
                </td>
                <td style="font-weight:bold;">${item.unit}</td>
                <td>${item.type}</td>
                <td>${formatDate(item.date)}</td>
                <td style="font-weight:bold; color:${diffDays < 0 ? 'red' : 'black'}">${diffDays} Hari</td>
                <td><span class="${statusClass}">${statusText}</span></td>
                <td>${photoHtml}</td>
            </tr>
        `;
    });
}

// ============================================
// === FITUR 2: MAINTENANCE FASILITAS (WO) ===
// ============================================
window.saveGAMaint = async function(e) {
    e.preventDefault();
    
    try {
        const cat = document.getElementById('ga_maint_cat').value;
        const prio = document.getElementById('ga_maint_prio').value;
        const loc = document.getElementById('ga_maint_loc').value;
        const desc = document.getElementById('ga_maint_desc').value;
        const pelapor = document.getElementById('ga_maint_pelapor').value;

        if (!loc || !desc) return alert("Lokasi dan Deskripsi wajib diisi!");

        gaData.maintenance.unshift({
            id: Date.now().toString(),
            date: new Date().toISOString().substring(0,10),
            cat: cat,
            prio: prio,
            loc: loc,
            desc: desc,
            pelapor: pelapor,
            status: 'Open',
            finishDate: '-'
        });

        await saveGAData();
        renderGAMaintTable();
        
        // Reset Form manual agar select kembali ke default
        document.getElementById('ga_maint_loc').value = '';
        document.getElementById('ga_maint_desc').value = '';
        document.getElementById('ga_maint_pelapor').value = '';
        
        showToast("Sukses", "Tiket Maintenance Dibuat", "success");
    } catch (err) {
        console.error(err);
        alert("Gagal membuat tiket: " + err.message);
    }
}

function renderGAMaintTable() {
    const tbody = document.getElementById('gaMaintBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    
    const priorityMap = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1 };
    
    // Sorting: Open/Proses di atas, lalu urut Prioritas
    gaData.maintenance.sort((a,b) => {
        if (a.status !== 'Selesai' && b.status === 'Selesai') return -1;
        if (a.status === 'Selesai' && b.status !== 'Selesai') return 1;
        const prioA = priorityMap[a.prio] || 0;
        const prioB = priorityMap[b.prio] || 0;
        return prioB - prioA;
    });

    gaData.maintenance.forEach(item => {
        let badgeClass = 'ga-open';
        if(item.status === 'Proses') badgeClass = 'ga-process';
        if(item.status === 'Selesai') badgeClass = 'ga-done';

        // Warna Prioritas
        let prioColor = '#6c757d'; let prioBg = '#e2e3e5';
        if (item.prio === 'Medium') { prioColor = '#856404'; prioBg = '#fff3cd'; }
        if (item.prio === 'High') { prioColor = '#721c24'; prioBg = '#f8d7da'; }
        if (item.prio === 'Critical') { prioColor = 'white'; prioBg = '#dc3545'; }

        const prioBadge = `<span style="background:${prioBg}; color:${prioColor}; padding:3px 8px; border-radius:4px; font-weight:bold; font-size:10px;">${item.prio}</span>`;

        tbody.innerHTML += `
            <tr>
                <td class="action-column">
                    <div style="display:flex; gap:3px; justify-content:center;">
                        <button onclick="window.updateGAStatus('maintenance', '${item.id}', 'Proses')" title="Kerjakan" style="background:#ffc107; border:none; border-radius:3px; cursor:pointer; padding:2px 6px;">üî®</button>
                        <button onclick="window.updateGAStatus('maintenance', '${item.id}', 'Selesai')" title="Selesai" style="background:#198754; color:white; border:none; border-radius:3px; cursor:pointer; padding:2px 6px;">‚úÖ</button>
                        <button onclick="window.deleteGAItem('maintenance', '${item.id}')" title="Hapus" style="background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer; padding:2px 6px;">üóëÔ∏è</button>
                    </div>
                </td>
                <td>${formatDate(item.date)}</td>
                <td>${prioBadge}</td>
                <td><span style="font-weight:bold; color:#555;">${item.cat || '-'}</span></td>
                <td style="text-align:left;">
                    <div style="font-weight:bold;">${item.loc}</div>
                    <div style="font-size:11px; color:#666;">${item.desc}</div>
                </td>
                <td>${item.pelapor}</td>
                <td><span class="ga-status-badge ${badgeClass}">${item.status}</span></td>
                <td style="font-size:11px;">${item.finishDate}</td>
            </tr>
        `;
    });
}

// ============================================
// === FITUR 3: PURCHASE REQUEST (PR) ===
// ============================================
// ============================================
// === FITUR 3: PURCHASE REQUEST (PR) - FIXED ===
// ============================================

// 1. Simpan Request (Sesuai ID HTML Baru: pr_*)
window.saveGAReq = async function(e) {
    e.preventDefault();
    
    // Debugging: Cek apakah elemen ditemukan
    const elDate = document.getElementById('pr_date');
    const elItem = document.getElementById('pr_item_name');
    
    if (!elDate || !elItem) {
        alert("Error System: ID HTML tidak ditemukan. Pastikan kode HTML sudah diupdate sepenuhnya.");
        return;
    }

    try {
        // Ambil Value dari ID yang BENAR (pr_...)
        const date = document.getElementById('pr_date').value;
        const requester = document.getElementById('pr_requester').value;
        const category = document.getElementById('pr_category').value;
        const priority = document.getElementById('pr_priority').value;
        const itemName = document.getElementById('pr_item_name').value;
        const qty = document.getElementById('pr_qty').value;
        const unit = document.getElementById('pr_unit').value; // Satuan
        const price = document.getElementById('pr_price').value; // Estimasi Harga
        const specs = document.getElementById('pr_specs').value; // Spesifikasi
        const photoInput = document.getElementById('pr_photo');

        // Validasi Sederhana
        if (!itemName || !qty) return alert("Nama Barang dan Jumlah wajib diisi!");

        // Proses Foto (Jika ada)
        const photo = photoInput.files[0] ? await compressImagePromise(photoInput.files[0]) : null;

        // Gabungkan Nama Barang dengan Spesifikasi untuk tampilan ringkas
        // Format simpan: "Nama Barang (Spesifikasi)"
        let fullItemDesc = itemName;
        if(specs) fullItemDesc += ` (${specs})`;

        // Simpan ke Array Global
        gaData.requests.unshift({
            id: Date.now().toString(),
            date: date,
            requester: requester,
            category: category,
            item: fullItemDesc, // Simpan gabungan nama & specs
            qty: qty,
            unit: unit,         // Simpan satuan
            prio: priority,
            price: price,
            photo: photo,
            status: 'Diajukan',
            note: '-'
        });

        await saveGAData();
        renderGAReqTable();
        
        // Reset Form
        e.target.reset(); 
        
        // Kembalikan tanggal ke hari ini
        document.getElementById('pr_date').value = new Date().toISOString().substring(0,10);
        
        showToast("Sukses", "Request Barang Berhasil Disimpan", "success");

    } catch(err) {
        console.error(err);
        alert("Gagal request: " + err.message);
    }
}

// 2. Render Tabel Request (Update Kolom Aksi & Tampilan)
// --- RENDER TABEL RIWAYAT PR (FIX TOMBOL CETAK) ---
window.renderGAReqTable = function() {
    const tbody = document.getElementById('gaReqBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Sort data terbaru di atas
    // Pastikan gaData.requests ada isinya
    const requests = gaData.requests || [];
    requests.sort((a,b) => new Date(b.date) - new Date(a.date));

    if(requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:15px; color:#999;">Belum ada riwayat permintaan.</td></tr>';
        return;
    }

    requests.forEach(pr => {
        // 1. Handle Tampilan Item (Cek Multi Item atau Single)
        let itemsCount = 0;
        let firstItemName = "-";
        
        if (pr.items && Array.isArray(pr.items)) {
            itemsCount = pr.items.length;
            if(itemsCount > 0) {
                firstItemName = pr.items[0].name;
                if(itemsCount > 1) firstItemName += ` <span style="color:#666; font-size:10px;">(+${itemsCount-1} lainnya)</span>`;
            }
        } else {
            // Fallback data lama
            itemsCount = 1;
            firstItemName = pr.item || "-";
        }

        // 2. Hitung Total Estimasi
        let totalEst = 0;
        if(pr.grandTotal) {
            totalEst = pr.grandTotal;
        } else {
            // Fallback hitung manual
            totalEst = (parseFloat(pr.qty||0) * parseFloat(pr.price||0));
        }

        const prID = `PR-${new Date(pr.date).getFullYear()}-${String(pr.id).substr(-4)}`;
        
        // 3. Badge Status
        let statusBadge = `<span style="background:#eee; padding:3px 8px; border-radius:10px;">${pr.status}</span>`;
        if (pr.status === 'Disetujui') statusBadge = `<span style="background:#d1e7dd; color:#0f5132; font-weight:bold; padding:3px 8px; border-radius:10px;">Disetujui</span>`;
        if (pr.status === 'Ditolak') statusBadge = `<span style="background:#f8d7da; color:#842029; font-weight:bold; padding:3px 8px; border-radius:10px;">Ditolak</span>`;

        // 4. Tanggal Disetujui
        let approvalDateDisplay = "-";
        if (pr.status === 'Disetujui' && pr.approvalDate) {
            approvalDateDisplay = `<span style="color:#198754; font-weight:bold;">${formatDate(pr.approvalDate)}</span>`;
        }

        // 5. MEMBUAT BARIS TABEL (FIXED ONCLICK)
        const tr = document.createElement('tr');
        tr.style.borderBottom = "1px solid #eee";
        
        // Perhatikan bagian onclick="window.printPR('${pr.id}')"
        tr.innerHTML = `
            <td class="action-column" style="text-align:center; white-space:nowrap; padding: 8px;">
                <button onclick="window.updateGAStatus('requests', '${pr.id}', 'Disetujui')" title="Setujui" style="background:#198754; color:white; border:none; border-radius:3px; cursor:pointer; padding:4px 8px; margin-right:2px;">‚úî</button>
                <button onclick="window.updateGAStatus('requests', '${pr.id}', 'Ditolak')" title="Tolak" style="background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer; padding:4px 8px; margin-right:2px;">‚úò</button>
                <button onclick="window.printPR('${pr.id}')" title="Cetak PR" style="background:#343a40; color:white; border:none; border-radius:3px; cursor:pointer; padding:4px 8px; margin-right:2px;">üñ®Ô∏è</button>
                <button onclick="window.deleteGAItem('requests', '${pr.id}')" title="Hapus" style="background:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer; padding:4px 8px;">üóëÔ∏è</button>
            </td>
            <td style="font-weight:bold; color:#055160;">${prID}</td>
            <td>${formatDate(pr.date)}</td>
            <td>${pr.requester}</td>
            <td style="font-size:11px;">${firstItemName}</td>
            <td style="text-align:right; font-weight:bold;">Rp ${totalEst.toLocaleString('id-ID')}</td>
            <td style="text-align:center; color:${pr.priority === 'Urgent' ? 'red' : 'black'}; font-weight:bold;">${pr.priority}</td>
            <td style="text-align:center;">${statusBadge}</td>
            <td style="text-align:center;">${approvalDateDisplay}</td>
        `;
        tbody.appendChild(tr);
    });
}
// ============================================
// === HELPER FUNCTIONS GLOBAL GA ===
// ============================================

window.deleteGAItem = async function(category, id) {
    if(!confirm("Yakin ingin menghapus data ini?")) return;
    gaData[category] = gaData[category].filter(i => i.id !== id);
    await saveGAData();
    // Refresh tabel terkait
    if(category === 'documents') renderGADocsTable();
    if(category === 'maintenance') renderGAMaintTable();
    if(category === 'requests') renderGAReqTable();
    showToast("Dihapus", "Data berhasil dihapus", "info");
}

// --- UPDATE LOGIC STATUS & SIMPAN TANGGAL APPROVAL ---
window.updateGAStatus = async function(category, id, newStatus) {
    const item = gaData[category].find(i => i.id === id);
    if(item) {
        item.status = newStatus;
        
        // LOGIKA BARU: Catat tanggal jika status berubah jadi 'Disetujui'
        if (newStatus === 'Disetujui') {
            item.approvalDate = new Date().toISOString().substring(0, 10);
        } else if (newStatus === 'Diajukan') {
            // Reset jika dikembalikan ke draft
            item.approvalDate = null; 
        }

        // Simpan
        await saveGAData();
        
        // Refresh Tabel sesuai kategori
        if(category === 'maintenance') renderGAMaintTable();
        if(category === 'requests') renderGAReqTable();
        
        showToast("Update", `Status diubah menjadi: ${newStatus}`, "success");
    }
}

window.editGANote = async function(id) {
    const item = gaData.requests.find(i => i.id === id);
    if(item) {
        const note = prompt("Tambahkan Keterangan / Alasan:", item.note === '-' ? '' : item.note);
        if(note !== null) {
            item.note = note || '-';
            await saveGAData();
            renderGAReqTable();
        }
    }
}

function updateGAKPI() {
    const today = new Date();
    // KPI 1: Expired < 30 Hari
    const expCount = (gaData.documents || []).filter(d => {
        const diff = Math.ceil((new Date(d.date) - today) / (1000 * 60 * 60 * 24));
        return diff <= 30;
    }).length;
    
    // KPI 2: Tiket Open/Proses
    const maintCount = (gaData.maintenance || []).filter(m => m.status !== 'Selesai').length;

    // KPI 3: Request Baru
    const reqCount = (gaData.requests || []).filter(r => r.status === 'Diajukan').length;

    const el1 = document.getElementById('ga_kpi_expired');
    const el2 = document.getElementById('ga_kpi_maintenance');
    const el3 = document.getElementById('ga_kpi_request');

    if(el1) el1.textContent = expCount;
    if(el2) el2.textContent = maintCount;
    if(el3) el3.textContent = reqCount;
}


// ==========================================
// === MODULE GA: PURCHASE PAYMENT (RESMI) ===
// ==========================================

// Inisialisasi Storage jika belum ada
if (!gaData.payments) gaData.payments = [];

// 1. Fungsi Hitung Otomatis Total
window.calcPayTotal = function() {
    const amounts = document.querySelectorAll('.amount-input');
    let total = 0;
    amounts.forEach(inp => {
        total += parseFloat(inp.value) || 0;
    });
    document.getElementById('pay_display_total').textContent = total.toLocaleString('id-ID');
}

// 2. Simpan Data Formulir
// ==========================================
// === MODULE GA: PURCHASE PAYMENT (V2 FIXED) ===
// ==========================================

// Inisialisasi Storage jika belum ada
if (!gaData.payments) gaData.payments = [];

// 1. LOGO UPLOAD HANDLER (PERMANEN via LocalStorage)
window.handleLogoUpload = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            // Simpan ke LocalStorage agar permanen
            localStorage.setItem('ga_payment_logo', base64);
            // Tampilkan
            displayLogo(base64);
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function displayLogo(src) {
    const img = document.getElementById('img_logo_preview');
    const txt = document.getElementById('txt_logo_placeholder');
    if (src) {
        img.src = src;
        img.style.display = 'block';
        txt.style.display = 'none';
    } else {
        img.style.display = 'none';
        txt.style.display = 'block';
    }
}

// Load Logo saat halaman dibuka
function loadLogo() {
    const savedLogo = localStorage.getItem('ga_payment_logo');
    if (savedLogo) displayLogo(savedLogo);
}

// 2. Fungsi Hitung Otomatis Total
window.calcPayTotal = function() {
    const amounts = document.querySelectorAll('.amount-input');
    let total = 0;
    amounts.forEach(inp => {
        total += parseFloat(inp.value) || 0;
    });
    document.getElementById('pay_display_total').textContent = total.toLocaleString('id-ID');
}

// 3. Simpan Data Formulir
window.saveGAPayment = async function() {
    const id = document.getElementById('pay_id').value || Date.now().toString();
    
    const formData = {
        id: id,
        tanggal: document.getElementById('pay_tanggal').value,
        pengaju: document.getElementById('pay_pengaju').value,
        project: document.getElementById('pay_project').value,
        penerima: document.getElementById('pay_penerima').value,
        bank: document.getElementById('pay_bank').value,
        norek: document.getElementById('pay_norek').value,
        tujuan: document.getElementById('pay_tujuan').value,
        nilaiTxt: document.getElementById('pay_nilai_text').value,
        divisi: document.getElementById('pay_divisi').value,
        
        // Simpan Tanda Tangan (Editable Text)
        signatures: [
            document.getElementById('sig_1').value,
            document.getElementById('sig_2').value,
            document.getElementById('sig_3').value,
            document.getElementById('sig_4').value,
            document.getElementById('sig_5').value
        ],

        // Data Pajak
        tax: {
            ppn: { chk: document.getElementById('chk_ppn').checked, val: document.getElementById('val_ppn').value },
            pph21: { chk: document.getElementById('chk_pph21').checked, val: document.getElementById('val_pph21').value },
            pph23_2: { chk: document.getElementById('chk_pph23_2').checked, val: document.getElementById('val_pph23_2').value },
            pph23_4: { chk: document.getElementById('chk_pph23_4').checked, val: document.getElementById('val_pph23_4').value },
            pph42: { chk: document.getElementById('chk_pph42').checked, val: document.getElementById('val_pph42').value }
        },

        // Data Item Table
        items: [],
        
        // Data Checkbox Bank
        banks: {
            rental: document.getElementById('b_rental').checked,
            part: document.getElementById('b_part').checked,
            petty: document.getElementById('b_petty').checked,
            maam: document.getElementById('b_maam').checked,
            mproj: document.getElementById('b_mproj').checked,
            mkaltim: document.getElementById('b_mkaltim').checked
        },

        // Data Dokumen
        docs: {
            po: document.getElementById('doc_po').checked,
            sj: document.getElementById('doc_sj').checked,
            inv: document.getElementById('doc_inv').checked,
            fp: document.getElementById('doc_fp').checked
        }
    };

    // Ambil Data Tabel (6 Baris)
    const tableRows = document.querySelectorAll('.payment-table tbody tr');
    tableRows.forEach((tr, index) => {
        if(index < 6) {
            const desc = tr.querySelector('.desc-input')?.value || "";
            const amt = tr.querySelector('.amount-input')?.value || "";
            const type = tr.querySelector('.type-input')?.value || "";
            if(desc || amt) {
                formData.items.push({ desc, amt, type });
            }
        }
    });

    // Simpan ke Array Global
    const idx = gaData.payments.findIndex(p => p.id === id);
    if (idx !== -1) gaData.payments[idx] = formData;
    else gaData.payments.unshift(formData);

    await saveGAData();
    renderGAPaymentHistory();
    document.getElementById('pay_id').value = id; // Set ID agar mode edit aktif
    showToast("Tersimpan", "Formulir Payment berhasil disimpan.", "success");
}

// 4. Render Riwayat
function renderGAPaymentHistory() {
    const tbody = document.getElementById('gaPaymentHistoryBody');
    if(!tbody) return;
    tbody.innerHTML = '';

    if(!gaData.payments || gaData.payments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Belum ada riwayat.</td></tr>';
        return;
    }

    gaData.payments.forEach(item => {
        const total = item.items.reduce((sum, i) => sum + (parseFloat(i.amt)||0), 0);
        tbody.innerHTML += `
            <tr>
                <td class="action-column">
                    <button onclick="window.loadGAPayment('${item.id}')" style="background:#ffc107; border:none; border-radius:3px; cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="window.deleteGAItem('payments', '${item.id}')" style="background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer;">üóëÔ∏è</button>
                </td>
                <td>${item.tanggal}</td>
                <td>${item.id.substr(-6)}</td>
                <td>${item.pengaju}</td>
                <td>${item.penerima}</td>
                <td style="font-weight:bold;">Rp ${total.toLocaleString('id-ID')}</td>
            </tr>
        `;
    });
}

// 5. Load Data (Edit)
window.loadGAPayment = function(id) {
    const item = gaData.payments.find(p => p.id === id);
    if(!item) return;

    // Load Header
    document.getElementById('pay_id').value = item.id;
    document.getElementById('pay_tanggal').value = item.tanggal;
    document.getElementById('pay_pengaju').value = item.pengaju;
    document.getElementById('pay_project').value = item.project;
    document.getElementById('pay_penerima').value = item.penerima;
    document.getElementById('pay_bank').value = item.bank;
    document.getElementById('pay_norek').value = item.norek;
    document.getElementById('pay_tujuan').value = item.tujuan;
    document.getElementById('pay_nilai_text').value = item.nilaiTxt;
    document.getElementById('pay_divisi').value = item.divisi;

    // Load Tanda Tangan
    if(item.signatures) {
        document.getElementById('sig_1').value = item.signatures[0] || '';
        document.getElementById('sig_2').value = item.signatures[1] || '';
        document.getElementById('sig_3').value = item.signatures[2] || '';
        document.getElementById('sig_4').value = item.signatures[3] || '';
        document.getElementById('sig_5').value = item.signatures[4] || '';
    }

    // Load Tax, Banks, Docs (Checkboxes)
    const setChk = (id, val) => { if(document.getElementById(id)) document.getElementById(id).checked = val; };
    const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val; };

    setChk('chk_ppn', item.tax.ppn.chk); setVal('val_ppn', item.tax.ppn.val);
    setChk('chk_pph21', item.tax.pph21.chk); setVal('val_pph21', item.tax.pph21.val);
    setChk('chk_pph23_2', item.tax.pph23_2.chk); setVal('val_pph23_2', item.tax.pph23_2.val);
    setChk('chk_pph23_4', item.tax.pph23_4.chk); setVal('val_pph23_4', item.tax.pph23_4.val);
    setChk('chk_pph42', item.tax.pph42.chk); setVal('val_pph42', item.tax.pph42.val);

    setChk('b_rental', item.banks.rental);
    setChk('b_part', item.banks.part);
    setChk('b_petty', item.banks.petty);
    setChk('b_maam', item.banks.maam);
    setChk('b_mproj', item.banks.mproj);
    setChk('b_mkaltim', item.banks.mkaltim);

    setChk('doc_po', item.docs.po);
    setChk('doc_sj', item.docs.sj);
    setChk('doc_inv', item.docs.inv);
    setChk('doc_fp', item.docs.fp);

    // Reset Table & Fill
    const rows = document.querySelectorAll('.payment-table tbody tr');
    rows.forEach((tr, i) => {
        if(i < 6) {
            tr.querySelectorAll('input[type="text"], input[type="number"]').forEach(inpt => inpt.value = '');
        }
    });

    item.items.forEach((rowItem, idx) => {
        if(idx < 6) {
            const tr = rows[idx];
            tr.querySelector('.desc-input').value = rowItem.desc;
            tr.querySelector('.amount-input').value = rowItem.amt;
            tr.querySelector('.type-input').value = rowItem.type;
        }
    });

    window.calcPayTotal();
    document.querySelector('.payment-paper-container').scrollIntoView({behavior: 'smooth'});
}

// 6. Reset Form (Tombol Buat Baru)
window.resetPaymentForm = function() {
    // Reset ID
    document.getElementById('pay_id').value = '';
    
    // Reset Semua Input Text & Number
    const container = document.getElementById('paymentPrintArea');
    container.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(el => {
        // Jangan reset nama perusahaan
        if (!el.classList.contains('company-name-input')) el.value = ''; 
    });

    // Reset Checkboxes
    container.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);

    // Reset Tanda Tangan ke Default
    document.getElementById('sig_1').value = "ADMINISTRASI";
    document.getElementById('sig_2').value = "BM KALTIM";
    document.getElementById('sig_3').value = "";
    document.getElementById('sig_4').value = "";
    document.getElementById('sig_5').value = "";

    window.calcPayTotal();
    showToast("Reset", "Formulir siap untuk data baru.", "info");
}

window.printGAPayment = function() {
    window.print();
}

// Hook Navigasi Tab (Memastikan Logo di-load saat tab dibuka)
const _gaSwitchV2 = window.switchGATab;
window.switchGATab = function(tabName) {
    // Logic nav standar
    document.querySelectorAll('.ga-sub-tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.ga-sub-tab-btn[onclick*="${tabName}"]`);
    if(activeBtn) activeBtn.classList.add('active');

    document.querySelectorAll('.ga-section').forEach(sec => sec.style.display = 'none');
    
    const target = document.getElementById(`ga_section_${tabName}`);
    if(target) {
        target.style.display = 'block';
        if (tabName === 'payment') {
            renderGAPaymentHistory();
            loadLogo(); // LOAD LOGO SAAT TAB DIBUKA
        } else if (tabName === 'docs') renderGADocsTable();
        else if (tabName === 'maint') renderGAMaintTable();
        else if (tabName === 'req') renderGAReqTable();
    }
}

// 5. Reset Form
window.resetPaymentForm = function() {
    document.getElementById('pay_id').value = '';
    // Kosongkan semua input text, number, date
    document.querySelectorAll('#paymentPrintArea input[type="text"], #paymentPrintArea input[type="number"], #paymentPrintArea input[type="date"]').forEach(el => el.value = '');
    // Uncheck checkboxes
    document.querySelectorAll('#paymentPrintArea input[type="checkbox"]').forEach(el => el.checked = false);
    window.calcPayTotal();
}

// 6. Fungsi Print Spesifik
window.printGAPayment = function() {
    window.print(); // CSS @media print akan menangani sisanya
}

// Hook ke Fungsi Load GA Utama (Agar history muncul saat tab dibuka)
const _originalSwitchGATab = window.switchGATab;
window.switchGATab = function(tabName) {
    // Panggil fungsi asli
    document.querySelectorAll('.ga-sub-tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.querySelector(`.ga-sub-tab-btn[onclick*="${tabName}"]`);
    if(activeBtn) activeBtn.classList.add('active');

    document.getElementById('ga_section_docs').style.display = 'none';
    document.getElementById('ga_section_maint').style.display = 'none';
    document.getElementById('ga_section_req').style.display = 'none';
    document.getElementById('ga_section_payment').style.display = 'none'; // Sembunyikan payment

    if (tabName === 'payment') {
        document.getElementById('ga_section_payment').style.display = 'block';
        renderGAPaymentHistory();
    } else {
        // Fallback ke logic lama
        const target = document.getElementById(`ga_section_${tabName}`);
        if(target) {
            target.style.display = 'block';
            if (tabName === 'docs') renderGADocsTable();
            if (tabName === 'maint') renderGAMaintTable();
            if (tabName === 'req') renderGAReqTable();
        }
    }
}
// ========================================================
// === MODULE GA: SMART PDF PAYMENT TRACKING (FIXED v3) ===
// ========================================================

let paymentTrackerData = [];

// 1. INIT (Load Data)
window.initPaymentModule = async function() {
    try {
        const stored = await idb.get('DOR_PaymentTracking');
        paymentTrackerData = stored || [];
        window.renderPaymentTable(); // Render awal
    } catch (e) {
        console.error("Gagal load data:", e);
    }
}

// 2. PROSES PDF (LOGIKA EKSTRAKSI YANG DITINGKATKAN)
// ===============================================
// === MODULE GA: SMART PDF PARSER (FIXED V4) ===
// ===============================================

// ... (Pastikan initPaymentModule dan fungsi render lainnya tetap ada, hanya ganti processPaymentPDF)

// 2. PROSES SMART PDF (TEXT PATTERN MATCHING)
// ===============================================
// === MODULE GA: PDF PARSER V5 (FINAL FIX) ===
// ===============================================

window.processPaymentPDF = async function(input) {
    const file = input.files[0];
    if (!file) return;

    showToast("Analisa PDF...", "Mencoba mengekstrak data...", "info");

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            
            // --- A. BACA TEXT (HALAMAN 1) ---
            const page1 = await pdf.getPage(1);
            const textContent = await page1.getTextContent();
            
            // 1. Gabungkan text item dengan " | " sebagai pemisah visual sementara
            // Ini membantu kita melihat urutan teks di console
            let rawItems = textContent.items.map(item => item.str).filter(s => s.trim() !== "");
            
            // 2. Gabungkan jadi satu string panjang dengan Baris Baru (\n) yang tegas
            // Kita gunakan logic Y-coordinate (transform[5]) untuk menebak baris baru jika perlu,
            // tapi untuk form standar, penggabungan sederhana biasanya cukup.
            let fullText = rawItems.join("\n"); 

            console.log("--- DEBUG PDF TEXT ---");
            console.log(fullText); 
            console.log("----------------------");

            // --- B. EXTRACTION LOGIC (REGEX LEBIH KUAT) ---
            
            let data = {
                penerima: "-",
                bank: "-",
                rek: "-",
                tujuan: "-",
                nominal: 0,
                tanggal: new Date().toISOString().substring(0, 10)
            };

            // Helper: Fungsi cari text setelah kata kunci tertentu
            // Mencari pola:  KEYWORD ..... : HASIL
            const findValue = (keywords) => {
                // Regex: (Salah satu keyword) -> (karakter apapun sampai ketemu :) -> : -> (AMBIL SISA BARIS)
                const regex = new RegExp(`(?:${keywords.join('|')}).*?[:;]\\s*([^\\n]+)`, 'i');
                const match = fullText.match(regex);
                return match ? match[1].trim() : null;
            };

            // 1. Cari PENERIMA (Keyword: Nama Penerima, Nama, Penerima)
            const resPenerima = findValue(['Nama Penerima', 'Penerima', 'Nama']);
            if (resPenerima) data.penerima = resPenerima.replace(/[\(\)]/g, ''); // Hapus kurung jika ada

            // 2. Cari BANK (Keyword: Bank Penerima, Bank)
            const resBank = findValue(['Bank Penerima', 'Bank']);
            if (resBank) data.bank = resBank.replace(/[\(\)]/g, '');

            // 3. Cari REKENING (Keyword: No Rekening, Rekening, No. Rek)
            const resRek = findValue(['No\\. Rekening', 'No Rekening', 'Rekening', 'No\\.Rek']);
            if (resRek) data.rek = resRek.replace(/[^\d\-\. ]/g, ''); // Hanya ambil angka, titik, strip

            // Gabung Bank & Rekening
            let bankDetail = (data.bank !== '-' || data.rek !== '-') ? `${data.bank} - ${data.rek}` : "-";

            // 4. Cari TUJUAN (Keyword: Tujuan Payment, Keterangan, Perihal)
            const resTujuan = findValue(['Tujuan Payment', 'Tujuan', 'Keterangan', 'Untuk']);
            if (resTujuan) data.tujuan = resTujuan;

            // 5. Cari NOMINAL / NILAI (Keyword: Nilai yg dibayar, Jumlah, Total)
            // Khusus ini kita cari Label -> : -> Rp -> Angka
            const rxNominal = /(?:Nilai\s+yg\s+dibayar|Jumlah|Total).*?[:]\s*(?:Rp\.?)?\s*([\d\.,]+)/i;
            const matchNominal = fullText.match(rxNominal);
            
            if (matchNominal) {
                // Bersihkan: Hapus titik ribuan, ganti koma desimal jadi titik
                // Contoh: 300.000 -> 300000 | 13.800.000 -> 13800000
                let clean = matchNominal[1].replace(/\./g, '').replace(/,/g, '.');
                data.nominal = parseFloat(clean);
            } else {
                // Fallback: Cari angka terbesar di dokumen jika label tidak ketemu
                const allNumbers = fullText.match(/[0-9]{1,3}(?:\.[0-9]{3})+(?:,[0-9]{2})?/g);
                if (allNumbers) {
                    const values = allNumbers.map(n => parseFloat(n.replace(/\./g, '').replace(',', '.')));
                    data.nominal = Math.max(...values);
                }
            }

            // 6. Cari TANGGAL (Format XX-XX-XXXX atau XX/XX/XXXX)
            const rxTgl = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{4})/;
            const matchTgl = fullText.match(rxTgl);
            if (matchTgl) {
                const parts = matchTgl[1].split(/[\/\-]/); // Split by / or -
                // Asumsi format Indonesia DD-MM-YYYY, ubah ke YYYY-MM-DD
                if (parts.length === 3) {
                    data.tanggal = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                }
            }

            // --- C. AMBIL BUKTI (HALAMAN 2 dst) ---
            let evidenceImages = [];
            for (let i = 2; i <= Math.min(pdf.numPages, 6); i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                evidenceImages.push(canvas.toDataURL('image/jpeg', 0.8));
            }

            // --- D. SIMPAN HASIL ---
            const newRecord = {
                id: Date.now().toString(),
                created_at: new Date().toISOString(),
                file_name: file.name,
                
                tanggal: data.tanggal,
                due_date: "", 
                penerima: data.penerima,
                bank_detail: bankDetail,
                tujuan: data.tujuan,
                nominal: data.nominal,
                
                evidence: evidenceImages,
                status: 'Pending'
            };

            paymentTrackerData.unshift(newRecord);
            await idb.set('DOR_PaymentTracking', paymentTrackerData);
            
            window.renderPaymentTable(); 
            showToast("Berhasil", `Data terbaca: ${data.penerima} (Rp ${data.nominal.toLocaleString()})`, "success");
            input.value = ''; 

        } catch (err) {
            console.error("PDF Error:", err);
            alert("Gagal proses PDF. Cek Console (F12) untuk detail.");
        }
    };
    reader.readAsArrayBuffer(file);
}

// 3. FUNGSI RENDER TABEL (VISUALISASI)
window.renderPaymentTable = function() {
    const tbody = document.getElementById('trackingPaymentBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const filterStat = document.getElementById('filter_payment_status') ? document.getElementById('filter_payment_status').value : 'all';
    const search = document.getElementById('search_payment') ? document.getElementById('search_payment').value.toLowerCase() : '';

    const filtered = paymentTrackerData.filter(i => {
        const txt = (i.penerima + i.bank_detail + i.tujuan).toLowerCase();
        const statMatch = filterStat === 'all' || i.status === filterStat;
        return txt.includes(search) && statMatch;
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:15px;">Belum ada data. Upload PDF Request Payment.</td></tr>';
        return;
    }

    filtered.forEach(item => {
        // Badge Warna Status
        let badgeClass = 'background-color:#fff3cd; color:#856404;'; // Pending
        if(item.status === 'Proses') badgeClass = 'background-color:#cff4fc; color:#055160;';
        if(item.status === 'Paid') badgeClass = 'background-color:#d1e7dd; color:#0f5132;';

        // Tombol Lihat Bukti (Jika ada)
        const btnEvidence = (item.evidence && item.evidence.length > 0) 
            ? `<button onclick="window.showEvidence('${item.id}')" style="font-size:10px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:4px; padding:2px 5px;">üëÅÔ∏è Foto (${item.evidence.length})</button>` 
            : '<span style="color:#ccc;">-</span>';

        tbody.innerHTML += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:8px;">${item.tanggal}</td>
                <td><input type="date" value="${item.due_date}" onchange="window.updatePayDate('${item.id}', this.value)" style="border:1px solid #ddd; font-size:10px;"></td>
                <td style="font-weight:bold;">${item.penerima}</td>
                <td style="font-size:10px;">${item.bank_detail}</td>
                <td style="font-size:10px; max-width:200px;">${item.tujuan}</td>
                <td style="text-align:center;">${btnEvidence}</td>
                <td style="text-align:right; font-family:monospace; font-weight:bold;">Rp ${(item.nominal||0).toLocaleString('id-ID')}</td>
                <td style="text-align:center;">
                    <span onclick="window.cyclePaymentStatus('${item.id}')" style="${badgeClass} padding:4px 8px; border-radius:10px; font-size:10px; font-weight:bold; cursor:pointer; border:1px solid rgba(0,0,0,0.1);">${item.status}</span>
                </td>
                <td style="text-align:center;">
                    <button onclick="window.deletePaymentItem('${item.id}')" style="background:#dc3545; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer;">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    });
    
    // Update KPI (Opsional jika elemen ada)
    updatePaymentKPI(filtered);
}

// 4. FUNGSI TOMBOL (WAJIB GLOBAL WINDOW)
window.cyclePaymentStatus = async function(id) {
    const item = paymentTrackerData.find(i => i.id === id);
    if (item) {
        // Rotasi: Pending -> Proses -> Paid -> Pending
        if (item.status === 'Pending') item.status = 'Proses';
        else if (item.status === 'Proses') item.status = 'Paid';
        else item.status = 'Pending';

        await idb.set('DOR_PaymentTracking', paymentTrackerData);
        window.renderPaymentTable(); // Refresh tabel
    }
}

window.deletePaymentItem = async function(id) {
    if (!confirm("Hapus data tracking ini?")) return;
    paymentTrackerData = paymentTrackerData.filter(i => i.id !== id);
    await idb.set('DOR_PaymentTracking', paymentTrackerData);
    window.renderPaymentTable();
    showToast("Dihapus", "Data berhasil dihapus.", "info");
}

window.updatePayDate = async function(id, val) {
    const item = paymentTrackerData.find(i => i.id === id);
    if(item) {
        item.due_date = val;
        await idb.set('DOR_PaymentTracking', paymentTrackerData);
    }
}

window.showEvidence = function(id) {
    const item = paymentTrackerData.find(i => i.id === id);
    if(!item || !item.evidence) return;

    const container = document.getElementById('evidenceContainer');
    container.innerHTML = '';
    
    item.evidence.forEach((src, idx) => {
        container.innerHTML += `
            <div style="margin-bottom:15px; border:1px solid #ddd; padding:5px;">
                <div style="font-weight:bold; font-size:10px; margin-bottom:5px;">Halaman ${idx+2}</div>
                <img src="${src}" style="width:100%; height:auto;">
            </div>`;
    });
    document.getElementById('pdfEvidenceModal').style.display = 'block';
}

// 5. HELPER KPI
function updatePaymentKPI(data) {
    let unpaid = 0; let paid = 0; let due = 0;
    const today = new Date();
    
    data.forEach(i => {
        if(i.status === 'Paid') paid += (i.nominal||0);
        else {
            unpaid += (i.nominal||0);
            if(i.due_date) {
                const diff = (new Date(i.due_date) - today) / (1000*60*60*24);
                if(diff <= 3) due++;
            }
        }
    });

    const elUnpaid = document.getElementById('pay_kpi_unpaid');
    const elPaid = document.getElementById('pay_kpi_paid');
    const elDue = document.getElementById('pay_kpi_due');

    if(elUnpaid) elUnpaid.textContent = `Rp ${unpaid.toLocaleString('id-ID')}`;
    if(elPaid) elPaid.textContent = `Rp ${paid.toLocaleString('id-ID')}`;
    if(elDue) {
        elDue.textContent = due;
        elDue.style.color = due > 0 ? 'red' : 'black';
    }
}

// 6. HOOK TAB SWITCH (Agar data ter-load saat tab dibuka)
// Timpa fungsi switchGATab yang lama
const _prevSwitchGA = window.switchGATab;
window.switchGATab = function(tabName) {
    // Reset Navigasi
    document.querySelectorAll('.ga-sub-tab-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`.ga-sub-tab-btn[onclick*="${tabName}"]`);
    if(btn) btn.classList.add('active');

    // Sembunyikan Semua Section
    document.querySelectorAll('.ga-section').forEach(s => s.style.display='none');
    
    // Tampilkan Section Target
    const target = document.getElementById(`ga_section_${tabName}`);
    if(target) {
        target.style.display = 'block';
        if(tabName === 'payment') {
            window.initPaymentModule(); // Load Data Payment
        } else if (tabName === 'docs' && typeof renderGADocsTable === 'function') {
            renderGADocsTable();
        } else if (tabName === 'maint' && typeof renderGAMaintTable === 'function') {
            renderGAMaintTable();
        } else if (tabName === 'req' && typeof renderGAReqTable === 'function') {
            renderGAReqTable();
        }
    }
}
// ===============================================
// === MODULE GA: MANUAL INPUT & PDF HELPER ===
// ===============================================

// 1. INPUT MANUAL MURNI (Tanpa PDF)
window.openManualEntry = function() {
    // Reset Form
    document.getElementById('inp_date').value = new Date().toISOString().substring(0, 10);
    document.getElementById('inp_vendor').value = "";
    
    // FIX: Reset Bank Terpisah
    document.getElementById('inp_bank_name').value = "";
    document.getElementById('inp_rek_no').value = "";
    
    document.getElementById('inp_desc').value = "";
    document.getElementById('inp_nominal').value = "";
    
    // Reset Hidden Data
    document.getElementById('temp_evidence_data').value = ""; 
    document.getElementById('temp_filename').value = "Input Manual";
    document.getElementById('evidence_status').style.display = 'none';

    // Buka Modal
    document.getElementById('manualInputModal').style.display = 'flex';
}

// 2. PROSES PDF -> LALU BUKA FORM MANUAL (AUTO-FILL)
window.processPaymentPDF = async function(input) {
    const file = input.files[0];
    if (!file) return;

    showToast("Membaca PDF...", "Silakan verifikasi data di form...", "info");

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            
            // --- A. BACA TEXT (AUTO FILL) ---
            const page1 = await pdf.getPage(1);
            const textContent = await page1.getTextContent();
            const fullText = textContent.items.map(item => item.str).join("  ");

            // Logic Regex Sederhana (Helper)
            const findVal = (rx) => { const m = fullText.match(rx); return m ? m[1].trim() : ""; };

            // Coba ambil data (Kalau gagal, string kosong)
            let penerima = findVal(/(?:Penerima|Nama)\s*[:]\s*([^\n\r]+)/i) || "";
            let bank = findVal(/Bank.*[:]\s*([^\n\r]+)/i) || "";
            let rek = findVal(/Rekening.*[:]\s*([\d\-\. ]+)/i) || "";
            let tujuan = findVal(/(?:Tujuan|Keterangan).*[:]\s*([^\n\r]+)/i) || "";
            
            // Coba ambil nominal
            let nominal = "";
            const matchNominal = fullText.match(/(?:Nilai|Jumlah|Total).*[:]\s*(?:Rp\.?)?\s*([\d\.,]+)/i);
            if (matchNominal) {
                // Hapus titik, ganti koma desimal (Format Indo)
                let clean = matchNominal[1].replace(/\./g, '').replace(/,/g, '.');
                if(!isNaN(clean)) nominal = clean;
            }

            // Gabung Bank
            let bankDetail = bank;
            if(rek) bankDetail += ` - ${rek}`;

            // --- B. AMBIL GAMBAR (EVIDENCE) ---
            let evidenceImages = [];
            for (let i = 2; i <= Math.min(pdf.numPages, 6); i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: context, viewport: viewport }).promise;
                evidenceImages.push(canvas.toDataURL('image/jpeg', 0.7));
            }

            // --- C. ISI FORM MODAL ---
            document.getElementById('inp_date').value = data.tanggal || new Date().toISOString().substring(0, 10);
            document.getElementById('inp_vendor').value = data.penerima || "";
            document.getElementById('inp_bank_name').value = data.bank || ""; 
            document.getElementById('inp_rek_no').value = data.rek || "";
            document.getElementById('inp_desc').value = data.tujuan || "";
            
            // Format Rupiah di Input
            const inpNominal = document.getElementById('inp_nominal');
            inpNominal.value = data.nominal ? parseFloat(data.nominal).toLocaleString('id-ID') : "";
            
            // Simpan Evidence di Hidden Field (String JSON)
            document.getElementById('temp_evidence_data').value = JSON.stringify(evidenceImages);
            document.getElementById('temp_filename').value = file.name;

            // Tampilkan indikator ada bukti
            const evStatus = document.getElementById('evidence_status');
            if (evidenceImages.length > 0) {
                evStatus.style.display = 'block';
                evStatus.textContent = `‚úÖ Berhasil mengambil ${evidenceImages.length} halaman lampiran dari PDF.`;
            } else {
                evStatus.style.display = 'none';
            }

            // Buka Modal
            document.getElementById('manualInputModal').style.display = 'flex';
            input.value = ''; // Reset file input

        } catch (err) {
            console.error(err);
            alert("Gagal baca PDF. Silakan input manual.");
            window.openManualEntry(); // Fallback ke manual kosong
        }
    };
    reader.readAsArrayBuffer(file);
}


    window.closeManualModal = function() {
    const modal = document.getElementById('manualInputModal');
    if (modal) {
        modal.style.display = 'none';
        // Reset form saat ditutup agar bersih saat dibuka lagi
        document.getElementById('inp_date').value = '';
        document.getElementById('inp_vendor').value = '';
        document.getElementById('inp_bank').value = '';
        document.getElementById('inp_desc').value = '';
        document.getElementById('inp_nominal').value = '';
    }
}

// 2. Fungsi Format Rupiah (Otomatis Titik)
window.formatRupiahInput = function(input) {
    // Ambil value dan buang semua karakter selain angka
    let value = input.value.replace(/[^0-9]/g, '');
    
    // Jika ada isinya, format dengan titik ribuan
    if (value) {
        // Regex untuk menambah titik setiap 3 digit dari belakang
        let formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        input.value = formatted;
    } else {
        input.value = "";
    }
}

// 3. Fungsi Simpan Manual (Update logic untuk membaca angka bertitik)
window.saveManualInput = async function(e) {
    e.preventDefault();

    // Ambil Data
    const date = document.getElementById('inp_date').value;
    const vendor = document.getElementById('inp_vendor').value;
    const bank = document.getElementById('inp_bank').value;
    const desc = document.getElementById('inp_desc').value;
    const rawNominal = document.getElementById('inp_nominal').value; // Masih ada titik (Ex: 10.000.000)
    
    const fileName = document.getElementById('temp_filename').value || "Manual Input";
    const rawEvidence = document.getElementById('temp_evidence_data').value;

    // PENTING: Bersihkan titik sebelum disimpan ke database agar jadi angka murni
    const nominal = parseFloat(rawNominal.replace(/\./g, '')) || 0;

    let evidence = [];
    try { if(rawEvidence) evidence = JSON.parse(rawEvidence); } catch(e) {}

    const newRecord = {
        id: Date.now().toString(),
        created_at: new Date().toISOString(),
        file_name: fileName,
        tanggal: date,
        due_date: "",
        penerima: vendor,
        bank_detail: bank,
        tujuan: desc,
        nominal: nominal, // Simpan angka murni (integer/float)
        evidence: evidence,
        status: 'Pending'
    };

    // Simpan ke Array & DB
    paymentTrackerData.unshift(newRecord);
    await idb.set('DOR_PaymentTracking', paymentTrackerData);
    
    // Refresh Table & Tutup Modal
    window.renderPaymentTable();
    window.closeManualModal();
    showToast("Tersimpan", "Data berhasil ditambahkan.", "success");
}

// =========================================================
// === MODUL CETAK PR & LOGO (STANDAR CORPORATE/UT) ===
// =========================================================

// 1. Fungsi Load Logo (Dipanggil saat halaman dibuka)
// Mengecek apakah ada logo tersimpan di memori browser
window.loadPRLogo = function() {
    const savedLogo = localStorage.getItem('DOR_PR_LOGO');
    const imgPreview = document.getElementById('pr_logo_preview');
    const imgPrint = document.getElementById('pr_print_logo');
    const txtPlaceholder = document.getElementById('pr_print_logo_placeholder');
    
    if (savedLogo) {
        // Tampilkan di panel setting
        if(imgPreview) { 
            imgPreview.src = savedLogo; 
            imgPreview.style.display = 'inline-block'; 
        }
        // Tampilkan di kertas cetak
        if(imgPrint) { 
            imgPrint.src = savedLogo; 
            imgPrint.style.display = 'block'; 
        }
        // Sembunyikan tulisan placeholder [LOGO]
        if(txtPlaceholder) txtPlaceholder.style.display = 'none';
    }
}

// 2. Fungsi Handle Upload Logo (Saat tombol "Set Logo" diklik)
window.handlePRLogoUpload = function(input) {
    if (input.files && input.files[0]) {
        // Cek ukuran file (max 500KB agar browser tidak berat)
        if(input.files[0].size > 500000) {
            alert("Ukuran logo terlalu besar! Gunakan file di bawah 500KB.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            try {
                // Simpan permanen di LocalStorage
                localStorage.setItem('DOR_PR_LOGO', base64);
                window.loadPRLogo(); // Refresh tampilan logo
                showToast("Sukses", "Logo berhasil disimpan.", "success");
            } catch (err) {
                alert("Storage Penuh. Hapus cache browser atau gunakan logo yang lebih kecil.");
            }
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 3. Fungsi Utama: CETAK PR (Dipanggil saat tombol printer diklik)
// --- FUNGSI CETAK PR (DEBUGGED) ---
window.printPR = function(id) {
    console.log("Mencoba mencetak ID:", id); // Cek Console browser (F12)

    // 1. CEK DATA
    const item = gaData.requests.find(i => String(i.id) === String(id));
    if (!item) {
        alert("‚ùå ERROR: Data request dengan ID tersebut tidak ditemukan di database.");
        return;
    }

    // 2. CEK TEMPLATE CETAK
    const printArea = document.getElementById('pr-print-area');
    if (!printArea) {
        alert("‚ùå CRITICAL ERROR: Elemen <div id='pr-print-area'> tidak ditemukan di HTML.\nPastikan Anda sudah memindahkan kode HTML Cetak ke bagian paling bawah <body>.");
        return;
    }

    // 3. ISI DATA HEADER
    const setText = (elId, val) => {
        const el = document.getElementById(elId);
        if(el) el.innerText = val || '-';
    };

    setText('print_pr_id', `PR-${new Date(item.date).getFullYear()}-${String(item.id).substr(-4)}`);
    setText('print_pr_date', formatDate(item.date));
    setText('print_pr_dept', "General Affair / Logistik");
    setText('print_pr_prio', item.priority);
    setText('print_pr_user', item.requester);
    setText('print_pr_category', item.category);
    setText('sig_requester_name', item.requester);
    
    // Justifikasi / Note
    setText('print_pr_desc', item.note && item.note !== '-' ? item.note : 'Sesuai kebutuhan operasional.');

    // 4. ISI TABEL ITEM
    const tbody = document.getElementById('print_pr_body');
    const tfoot = document.getElementById('print_pr_footer');
    const grandTotalEl = document.getElementById('print_pr_grand_total');
    
    if(tbody) {
        tbody.innerHTML = '';

        // Normalisasi Data (Array)
        let itemsToPrint = item.items;
        if (!itemsToPrint || !Array.isArray(itemsToPrint)) {
            // Konversi data lama (single object) ke array
            itemsToPrint = [{
                name: item.item,
                spec: '-',
                qty: item.qty,
                unit: item.unit,
                price: item.price,
                total: (parseFloat(item.qty) * parseFloat(item.price))
            }];
        }

        let grandTotal = 0;

        itemsToPrint.forEach((it, idx) => {
            const price = parseFloat(it.price) || 0;
            const total = parseFloat(it.total) || (it.qty * price);
            grandTotal += total;

            // Baris Item
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:center;">${idx + 1}</td>
                <td><strong>${it.name}</strong></td>
                <td style="text-align:center;">${it.spec || '-'}</td>
                <td style="text-align:center;">${it.qty}</td>
                <td style="text-align:center;">${it.unit || 'Pcs'}</td>
                <td style="text-align:right;">${price > 0 ? price.toLocaleString('id-ID') : '-'}</td>
                <td style="text-align:right;">${total > 0 ? total.toLocaleString('id-ID') : '-'}</td>
            `;
            tbody.appendChild(tr);
        });

        // Baris Kosong Pelengkap (Agar tampilan penuh A4)
        const sisaBaris = 10 - itemsToPrint.length;
        if(sisaBaris > 0) {
            for(let i=0; i<sisaBaris; i++) {
                const trEmpty = document.createElement('tr');
                trEmpty.innerHTML = `<td style="height:25px;"></td><td></td><td></td><td></td><td></td><td></td><td></td>`;
                tbody.appendChild(trEmpty);
            }
        }

        // 5. UPDATE FOOTER GRAND TOTAL
        if (grandTotal > 0 && tfoot) {
            tfoot.style.display = 'table-footer-group';
            if(grandTotalEl) grandTotalEl.innerText = "Rp " + grandTotal.toLocaleString('id-ID');
        }
    }

    // 6. EKSEKUSI PRINT (Mode Overlay)
    document.body.classList.add('print-pr-mode');
    
    // Gunakan timeout agar DOM selesai render
    setTimeout(() => {
        window.print();
        
        // Cleanup setelah print dialog tutup
        setTimeout(() => {
            document.body.classList.remove('print-pr-mode');
        }, 500);
    }, 500);
}
// Jalankan load logo saat script ini dimuat
loadPRLogo();
// ==========================================
// === LOGIKA MULTI-ITEM PURCHASE REQUEST ===
// ==========================================

// 1. Inisialisasi Variable Global (PENTING)
var tempPRItems = []; 

// 2. Fungsi Tambah Barang ke Tabel Sementara
window.addItemToTempPR = function() {
    // Ambil value dari input
    const name = document.getElementById('temp_item_name').value;
    const spec = document.getElementById('temp_item_spec').value;
    const qty = parseFloat(document.getElementById('temp_item_qty').value);
    const unit = document.getElementById('temp_item_unit').value;
    const price = parseFloat(document.getElementById('temp_item_price').value) || 0;

    // Validasi
    if (!name || !qty) {
        alert("Mohon isi Nama Barang dan Jumlah (Qty)!");
        return;
    }

    // Masukkan ke array sementara
    tempPRItems.push({
        id: Date.now(), // ID unik per item
        name: name,
        spec: spec || '-',
        qty: qty,
        unit: unit || 'Pcs',
        price: price,
        total: qty * price
    });

    // Reset Form Input Barang (Agar bisa isi lagi)
    document.getElementById('temp_item_name').value = '';
    document.getElementById('temp_item_spec').value = '';
    document.getElementById('temp_item_qty').value = '';
    document.getElementById('temp_item_price').value = '';
    
    // Fokus kembali ke nama barang
    document.getElementById('temp_item_name').focus();

    // Render ulang tabel sementara
    renderTempPRTable();
}

// 3. Fungsi Render Tabel Sementara
function renderTempPRTable() {
    const tbody = document.getElementById('tempPRBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (tempPRItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:15px; color:#999;">Belum ada barang. Silakan tambah barang diatas.</td></tr>';
        return;
    }

    let grandTotalTemp = 0;

    tempPRItems.forEach((item, index) => {
        grandTotalTemp += item.total;
        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="text-align:center;">${index + 1}</td>
                <td style="font-weight:bold;">${item.name}</td>
                <td>${item.spec}</td>
                <td style="text-align:center;">${item.qty} ${item.unit}</td>
                <td style="text-align:right;">Rp ${item.price.toLocaleString('id-ID')}</td>
                <td style="text-align:right;">Rp ${item.total.toLocaleString('id-ID')}</td>
                <td style="text-align:center;">
                    <button type="button" onclick="window.removeTempItem(${index})" style="background:#dc3545; color:white; border:none; border-radius:3px; cursor:pointer; padding:3px 8px;">Hapus</button>
                </td>
            </tr>
        `;
    });

    // Baris Total Sementara
    tbody.innerHTML += `
        <tr style="background-color:#f8f9fa; font-weight:bold;">
            <td colspan="5" style="text-align:right;">Total Estimasi:</td>
            <td style="text-align:right; color:#055160;">Rp ${grandTotalTemp.toLocaleString('id-ID')}</td>
            <td></td>
        </tr>
    `;
}

// 4. Hapus Item Sementara
window.removeTempItem = function(index) {
    tempPRItems.splice(index, 1);
    renderTempPRTable();
}

// 5. SIMPAN FINAL (BUAT DOKUMEN PR)
window.saveGAReqMulti = async function() {
    // Validasi
    if (tempPRItems.length === 0) return alert("Daftar barang masih kosong! Tambahkan barang minimal satu.");
    
    const date = document.getElementById('pr_date').value;
    const requester = document.getElementById('pr_requester').value;
    
    if (!date || !requester) return alert("Tanggal dan Pemohon (Header) wajib diisi!");

    // Hitung Grand Total Akhir
    const grandTotal = tempPRItems.reduce((sum, item) => sum + item.total, 0);

    // Buat Object PR Tunggal (Berisi Array Items)
    const newPR = {
        id: Date.now().toString(),
        date: date,
        requester: requester,
        category: document.getElementById('pr_category').value,
        priority: document.getElementById('pr_priority').value,
        note: document.getElementById('pr_global_note').value || '-', // Keterangan Global
        items: [...tempPRItems], // Copy semua item dari temp
        grandTotal: grandTotal,
        status: 'Diajukan'
    };

    // Simpan ke Database
    gaData.requests.unshift(newPR);
    await saveGAData();

    // Bersihkan State
    tempPRItems = []; // Kosongkan array temp
    renderTempPRTable(); // Kosongkan tabel temp
    document.getElementById('pr_global_note').value = '';
    
    // Refresh Tabel Utama
    renderGAReqTable(); 
    
    showToast("Sukses", "PR berhasil dibuat dengan " + newPR.items.length + " item.", "success");
}

// 6. Render Tabel Riwayat Utama
// --- RENDER TABEL PR DENGAN TOMBOL YANG DIPERBAIKI ---
function renderGAReqTable() {
    const tbody = document.getElementById('gaReqBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Sort data terbaru di atas
    gaData.requests.sort((a,b) => new Date(b.date) - new Date(a.date));

    gaData.requests.forEach(pr => {
        // 1. Handle Tampilan Item
        let itemsCount = 0;
        let firstItemName = "-";
        
        if (pr.items && Array.isArray(pr.items)) {
            itemsCount = pr.items.length;
            if(itemsCount > 0) {
                firstItemName = pr.items[0].name;
                if(itemsCount > 1) firstItemName += ` <span style="color:#666; font-size:10px;">(+${itemsCount-1} lainnya)</span>`;
            }
        } else {
            // Fallback data lama
            itemsCount = 1;
            firstItemName = pr.item || "-";
        }

        // 2. Format Data Lain
        const totalEst = pr.grandTotal ? pr.grandTotal : (parseFloat(pr.qty||0) * parseFloat(pr.price||0));
        const prID = `PR-${new Date(pr.date).getFullYear()}-${pr.id.substr(-4)}`;
        
        // 3. Badge Status
        let statusBadge = `<span style="background:#eee; padding:3px 8px; border-radius:10px;">${pr.status}</span>`;
        if (pr.status === 'Disetujui') statusBadge = `<span style="background:#d1e7dd; color:#0f5132; font-weight:bold; padding:3px 8px; border-radius:10px;">Disetujui</span>`;
        if (pr.status === 'Ditolak') statusBadge = `<span style="background:#f8d7da; color:#842029; font-weight:bold; padding:3px 8px; border-radius:10px;">Ditolak</span>`;

        // 4. KOLOM BARU: TANGGAL DISETUJUI
        let approvalDateDisplay = "-";
        if (pr.status === 'Disetujui' && pr.approvalDate) {
            approvalDateDisplay = `<span style="color:#198754; font-weight:bold;">${formatDate(pr.approvalDate)}</span>`;
        }

        // 5. MEMBUAT ROW HTML (PERBAIKAN TOMBOL AKSI)
        // Kita gunakan onclick langsung dengan ID yang aman
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="action-column" style="text-align:center; white-space:nowrap;">
                <button onclick="window.updateGAStatus('requests', '${pr.id}', 'Disetujui')" title="Setujui" style="background:#198754; color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 8px; margin-right:2px;">‚úî</button>
                
                <button onclick="window.updateGAStatus('requests', '${pr.id}', 'Ditolak')" title="Tolak" style="background:#ffc107; color:black; border:none; border-radius:4px; cursor:pointer; padding:5px 8px; margin-right:2px;">‚úò</button>
                
                <button onclick="window.printPR('${pr.id}')" title="Cetak PR" style="background:#343a40; color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 8px; margin-right:2px;">üñ®Ô∏è</button>
                
                <button onclick="window.deleteGAItem('requests', '${pr.id}')" title="Hapus" style="background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 8px;">üóëÔ∏è</button>
            </td>
            <td style="font-weight:bold; color:#055160;">${prID}</td>
            <td>${formatDate(pr.date)}</td>
            <td>${pr.requester}</td>
            <td style="font-size:11px;">${firstItemName}</td>
            <td style="text-align:right; font-weight:bold;">Rp ${totalEst.toLocaleString('id-ID')}</td>
            <td style="text-align:center; color:${pr.priority === 'Urgent' ? 'red' : 'black'}; font-weight:bold;">${pr.priority}</td>
            <td style="text-align:center;">${statusBadge}</td>
            <td style="text-align:center;">${approvalDateDisplay}</td> `;
        
        tbody.appendChild(row);
    });
    
    if(gaData.requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:15px; color:#999;">Belum ada riwayat permintaan.</td></tr>';
    }
}

// =================================================================
// === FITUR: REFRESH & AUTO-FIX DATA (KATEGORI & FORMAT) ===
// =================================================================
// =================================================================
// === FITUR: REFRESH & AUTO-FIX DATA (VERSI STABIL / ANTI-ERROR) ===
// =================================================================
// ==========================================
// 3. TOMBOL PERBAIKI DATA (DEEP FIX)
// ==========================================
window.refreshAndFixData = async function(btnElement) {
    // 1. Efek Visual Loading
    const originalText = btnElement.innerHTML;
    btnElement.innerHTML = '‚è≥ Sedang Memindai, Menghitung Ulang & Memperbaiki...';
    btnElement.disabled = true; 
    btnElement.style.cursor = 'wait';
    btnElement.style.opacity = '0.7';

    setTimeout(async () => {
        try {
            let fixedCount = 0;
            let updated = false;

            // 2. Loop Semua Data Laporan
            reportsData.forEach(report => {
                let isModified = false;
                
                // --- A. DATA MENTAH (UPPERCASE & TRIM) ---
                if (report.operator) {
                    const cleanOp = report.operator.trim().toUpperCase();
                    if (report.operator !== cleanOp) { report.operator = cleanOp; isModified = true; }
                }
                if (report.unit) {
                    const cleanUnit = report.unit.trim().toUpperCase();
                    if (report.unit !== cleanUnit) { report.unit = cleanUnit; isModified = true; }
                }

                // --- B. FIX SEKTOR & KLASIFIKASI ---
                const oldClass = report.klasifikasi_sektor;
                const newClass = getSektorClassification(report.sektor); // Hitung ulang klasifikasi
                if (oldClass !== newClass) {
                    report.klasifikasi_sektor = newClass;
                    isModified = true;
                }

                // --- C. FIX JAM OPERASI (HM) ---
                const hmAwal = parseFloat(report.hm_awal) || 0;
                const hmAkhir = parseFloat(report.hm_akhir) || 0;
                const calculatedHM = hmAkhir - hmAwal;
                
                // Perbaiki jika jam_operasi salah/NaN atau beda dengan HM Akhir - HM Awal
                // (Toleransi floating point 0.01)
                if (isNaN(parseFloat(report.jam_operasi)) || Math.abs(report.jam_operasi - calculatedHM) > 0.01) {
                    report.jam_operasi = calculatedHM;
                    isModified = true;
                }

                // --- D. FIX JAM KERJA (TIMESHEET) ---
                if (report.time_in && report.time_out && report.time_in !== '-' && report.time_out !== '-') {
                    const [hIn, mIn] = report.time_in.split(':').map(Number);
                    const [hOut, mOut] = report.time_out.split(':').map(Number);
                    
                    if (!isNaN(hIn) && !isNaN(hOut)) {
                        let start = new Date(0, 0, 0, hIn, mIn);
                        let end = new Date(0, 0, 0, hOut, mOut);
                        if (end < start) end.setDate(end.getDate() + 1); // Lintas hari
                        
                        const calcWorkHours = (end - start) / (1000 * 60 * 60);
                        
                        // Perbaiki jika work_hours kosong/salah
                        if (isNaN(parseFloat(report.work_hours)) || Math.abs(report.work_hours - calcWorkHours) > 0.01) {
                            report.work_hours = calcWorkHours;
                            isModified = true;
                        }
                    }
                }

                // --- E. FIX KATEGORI (INTI PERMASALAHAN) ---
                const currentCat = report.kategori_keterangan;
                const ketText = report.keterangan || "";
                
                // Panggil fungsi deteksi kategori TERBARU
                const correctCat = getKeteranganCategory(ketText, report.jam_operasi);

                if (currentCat !== correctCat) {
                    report.kategori_keterangan = correctCat;
                    isModified = true;
                }

                // --- F. FIX SOLAR ---
                if (isNaN(parseFloat(report.total_solar))) {
                    report.total_solar = 0;
                    isModified = true;
                }

                if (isModified) {
                    fixedCount++;
                    updated = true;
                }
            });

            // 3. Simpan & Render
            if (updated) {
                await saveReportsDataToLocalStorage();
            }

            // Refresh UI
            window.fetchReportData();
            
            // Refresh Analisa Tab jika aktif
            if(document.getElementById('analisa_ketersediaan').classList.contains('active')) {
                window.fetchAvailabilityData();
            }

            // 4. Feedback User
            if (fixedCount > 0) {
                showToast("Selesai", `Berhasil merevisi <b>${fixedCount}</b> baris data (Kategori, HM, Sektor diperbaiki).`, "success");
            } else {
                showToast("Selesai", "Data sudah valid. Tidak ada perbaikan yang diperlukan.", "info");
            }

        } catch (error) {
            console.error("Refresh Error:", error);
            alert("Terjadi kesalahan: " + error.message);
        } finally {
            // Reset Tombol
            btnElement.innerHTML = originalText;
            btnElement.disabled = false;
            btnElement.style.cursor = 'pointer';
            btnElement.style.opacity = '1';
        }
    }, 500); 
}
// --- KONFIGURASI RATE (Ubah nilai ini sesuai standar perusahaan Anda) ---
const RATE_UANG_MAKAN = 50000;     // Contoh: 50.000
const RATE_UANG_TRANSPORT = 12000; // Contoh: 12.000
const RATE_UANG_LEMBUR = 15000;    // FIX: 15.000 (Sesuai Request jika HM >= 10)

// Helper: Mendapatkan Nama Hari Indonesia
function getIndonesianDayName(dateStr) {
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    return days[new Date(dateStr).getDay()];
}

// FUNGSI UTAMA: EXPORT PAYROLL PER OPERATOR
function exportPayrollMultiSheet() {
    // 1. Ambil Periode yang Sedang Dipilih di Filter
    const periodType = document.getElementById('period_select').value;
    // Gunakan fungsi helper yang sudah ada di kode Anda
    const period = getMultipleReportingPeriod ? getMultipleReportingPeriod(periodType, '') : getReportingPeriod(periodType, ''); 
    
    // 2. Filter Data Berdasarkan Tanggal Periode
    let filteredReports = reportsData.filter(report => isDateInPeriod(report.tanggal, period.start_str, period.end_str));
    
    // Filter juga berdasarkan Sektor jika user memilih sektor tertentu
    const selectedSektor = document.getElementById('filter_sektor').value;
    if (selectedSektor !== 'all') {
        filteredReports = filteredReports.filter(r => r.klasifikasi_sektor === selectedSektor);
    }

    if (filteredReports.length === 0) {
        showToast("Error", "Tidak ada data laporan di periode ini untuk diexport.", "error");
        return;
    }

    // 3. Kelompokkan Data per Operator (Agar jadi Sheet terpisah)
    const groupedByOp = filteredReports.reduce((acc, curr) => {
        // Normalisasi nama operator
        const opName = curr.operator ? curr.operator.trim().toUpperCase() : "TANPA NAMA";
        if (!acc[opName]) acc[opName] = [];
        acc[opName].push(curr);
        return acc;
    }, {});

    // 4. Siapkan Workbook Excel
    const wb = XLSX.utils.book_new();
    
    // Definisi Style Border (Hacky way untuk SheetJS versi basic)
    const borderStyle = {
        top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" }
    };
    
    // Style Header (Kuning)
    const headerStyle = {
        fill: { fgColor: { rgb: "FFFF00" } }, // Kuning
        font: { bold: true, color: { rgb: "000000" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: borderStyle
    };

    let hasData = false;

    // 5. Loop Setiap Operator -> Buat Sheet Baru
    Object.keys(groupedByOp).sort().forEach(opName => {
        const opReports = groupedByOp[opName];
        
        // Sortir laporan berdasarkan tanggal
        opReports.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));

        // Header Table
        const headers = [
            "No", "Hari", "Tanggal", "Unit", "HM Awal", "HM Akhir", 
            "Total HM", "Ket.", "Uang Makan", "Uang Transport", "Uang Lembur", "Total", "Tanda Tangan"
        ];

        // Siapkan Array Data untuk Sheet ini
        const wsData = [];
        
        // Judul di dalam Sheet (Baris 1-3)
        wsData.push([`LAPORAN KERJA OPERATOR / SLIP GAJI`]);
        wsData.push([`Nama Operator: ${opName}`]);
        wsData.push([`Periode: ${period.text}`]);
        wsData.push([]); // Baris kosong
        wsData.push(headers); // Baris 5 adalah Header Tabel

        let no = 1;
        let grandTotalHM = 0;
        let grandTotalUang = 0;

        opReports.forEach(r => {
            const hmTotal = parseFloat(r.jam_operasi) || 0;
            
            // --- LOGIKA HITUNGAN GAJI (Sesuai Request) ---
            let uMakan = 0;
            let uTrans = 0;
            let uLembur = 0;

            // Jika HM >= 1, Uang Makan & Transport Cair
            if (hmTotal >= 1) {
                uMakan = RATE_UANG_MAKAN;
                uTrans = RATE_UANG_TRANSPORT;
            }
            
            // Jika HM >= 10, Dapat Lembur 15rb
            if (hmTotal >= 10) {
                uLembur = RATE_UANG_LEMBUR;
            }

            // Jika HM = 0, otomatis semua 0 (karena inisialisasi variabel 0 di atas)

            const subTotal = uMakan + uTrans + uLembur;
            grandTotalHM += hmTotal;
            grandTotalUang += subTotal;

            // Masukkan Baris Data
            wsData.push([
                no++, 
                getIndonesianDayName(r.tanggal),
                formatDate(r.tanggal),
                r.unit,
                r.hm_awal,
                r.hm_akhir,
                hmTotal,
                r.keterangan || '-', // Kolom Ket. diambil dari inputan keterangan
                uMakan > 0 ? uMakan : '', // Kosongkan jika 0 agar tampilan bersih
                uTrans > 0 ? uTrans : '',
                uLembur > 0 ? uLembur : '',
                subTotal > 0 ? subTotal : '',
                '' // Kolom Tanda Tangan kosong
            ]);
        });

        // Baris Total di Bawah
        wsData.push([
            "TOTAL", "", "", "", "", "", 
            grandTotalHM, "", "", "", "", 
            grandTotalUang, ""
        ]);

        // Buat Worksheet dari Array Data
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // --- STYLING (Warna & Border) ---
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // Merge Judul (Baris 1)
        if(!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({ s: {r:0, c:0}, e: {r:0, c:12} }); 

        // Loop Cells untuk Styling Border & Header
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cellRef]) continue;

                // Style Header Tabel (Baris ke-5, index 4)
                if (R === 4) {
                    ws[cellRef].s = headerStyle;
                }
                // Style Data & Total (Border All)
                else if (R > 4) {
                    ws[cellRef].s = { border: borderStyle };
                    
                    // Format Angka Rupiah (Kolom index 8,9,10,11)
                    if (C >= 8 && C <= 11 && typeof ws[cellRef].v === 'number') {
                        ws[cellRef].z = '#,##0'; // Format ribuan Excel
                    }
                    
                    // Style Baris Total (Paling Bawah)
                    if (R === range.e.r) {
                        ws[cellRef].s = {
                            fill: { fgColor: { rgb: "E0E0E0" } }, // Abu-abu
                            font: { bold: true },
                            border: borderStyle
                        };
                    }
                }
            }
        }

        // Atur Lebar Kolom (Width)
        ws['!cols'] = [
            {wch: 5},  // No
            {wch: 10}, // Hari
            {wch: 12}, // Tanggal
            {wch: 10}, // Unit
            {wch: 8},  // HMA
            {wch: 8},  // HMB
            {wch: 8},  // Tot HM
            {wch: 25}, // Ket
            {wch: 12}, // Makan
            {wch: 12}, // Trans
            {wch: 12}, // Lembur
            {wch: 15}, // Total
            {wch: 15}  // Ttd
        ];

        // Tambah Sheet ke Workbook
        // Nama sheet max 31 karakter, hapus karakter ilegal
        const sheetName = opName.substring(0, 30).replace(/[\*\?\/\\\[\]]/g, ''); 
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        hasData = true;
    });

    if (hasData) {
        // Download File
        XLSX.writeFile(wb, `Laporan_Gaji_Operator_${period.text.replace(/[\/\\]/g,'-')}.xlsx`);
        showToast("Sukses", "File Excel Gaji berhasil didownload.", "success");
    }
}
// 2. Fungsi Utama Generate Excel Gaji
// =======================================================
// 1. HELPER: DETEKSI TARGET MINIMUM CHARGE (210 vs 220)
// =======================================================

// ==========================================================================
// 2. FUNGSI UTAMA EXPORT EXCEL GAJI + ANALISA BONUS (REVISI TOTAL)
// ==========================================================================
window.processPayrollExport = function() {
    // 1. Ambil Setting Tarif
    const rateMakan = parseFloat(document.getElementById('rate_uang_makan').value) || 0;
    const rateTransport = parseFloat(document.getElementById('rate_uang_transport').value) || 0;
    const rateLembur = 15000;
    const rateBonus = 15000; // Bonus per HM

    // 2. Ambil Data Sesuai Filter
    const periodType = document.getElementById('period_select').value;
    let periodInfo;
    if (typeof getMultipleReportingPeriod === 'function') {
         periodInfo = getMultipleReportingPeriod(periodType, '');
    } else {
         periodInfo = getReportingPeriod(periodType, '');
    }

    const filteredReports = reportsData.filter(report => isDateInPeriod(report.tanggal, periodInfo.start_str, periodInfo.end_str));

    if (filteredReports.length === 0) {
        alert("Tidak ada data laporan pada periode ini.");
        return;
    }

    // 3. Grouping Data Per Operator
    const groupedByOp = filteredReports.reduce((acc, curr) => {
        const opName = curr.operator ? curr.operator.trim().toUpperCase() : "TANPA_NAMA";
        if(!acc[opName]) acc[opName] = [];
        acc[opName].push(curr);
        return acc;
    }, {});

    // 4. Buat Workbook
    const wb = XLSX.utils.book_new();

    // Loop Operator -> Buat Sheet
    Object.keys(groupedByOp).sort().forEach(opName => {
        const opData = groupedByOp[opName];
        opData.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

        // Ambil Info Unit & Target dari data pertama
        const unitName = opData[0].unit;
        const unitInfo = getUnitTarget(unitName); 
        const targetHM = unitInfo.target;

        // --- A. HEADER LAPORAN ---
        const wsData = [];
        wsData.push(["LAPORAN JAM KERJA & PERFORMANCE OPERATOR"]);
        wsData.push(["PERIODE: " + periodInfo.text]);
        wsData.push([]); 
        wsData.push(["NAMA OPERATOR", ": " + opName]);
        wsData.push(["UNIT / ALAT", ": " + unitName + ` (${unitInfo.type})`]);
        wsData.push(["TARGET MIN. CHARGE", ": " + targetHM + " HM"]);
        wsData.push([]); 

        // --- B. HEADER TABEL (Kolom Paraf DIHAPUS) ---
        wsData.push([
            "NO", "HARI", "TANGGAL", 
            "AWAL", "AKHIR", "TOTAL (HM)", 
            "KETERANGAN", 
            "UANG MAKAN", "UANG TRANSPORT", "UANG LEMBUR"
        ]);

        let no = 1;
        let totalHMReal = 0; 
        let sumMakan = 0, sumTrans = 0, sumLembur = 0;
        let breakdownDays = []; // Penampung hari breakdown/cuaca

        // --- C. ISI DATA ---
        opData.forEach(r => {
            const hm = parseFloat(r.jam_operasi) || 0;
            totalHMReal += hm;

            // Hitung Gaji
            let uMakan = 0, uTrans = 0, uLembur = 0;
            if (hm >= 1) { uMakan = rateMakan; uTrans = rateTransport; }
            else if (hm < 1 && (r.keterangan||"").toUpperCase().includes("OP")) { uMakan = rateMakan; }
            
            if (hm >= 10) { uLembur = rateLembur; }

            sumMakan += uMakan; sumTrans += uTrans; sumLembur += uLembur;

            // Logika Deteksi Poin (Jika HM Rendah < 3 jam)
            if (hm < 3) {
                const k = (r.kategori_keterangan || "").toUpperCase();
                const d = (r.keterangan || "").toUpperCase();
                if (k.includes('BREAKDOWN') || k.includes('CUACA') || k.includes('IDLE') || 
                    d.includes('RUSAK') || d.includes('HUJAN') || d.includes('WAITING') || d.includes('STANDBY')) {
                    
                    breakdownDays.push({
                        date: r.tanggal,
                        reason: r.keterangan || r.kategori_keterangan,
                        hm_actual: hm
                    });
                }
            }

            wsData.push([
                no++, 
                getIndonesianDayName(r.tanggal), 
                formatDate(r.tanggal),
                parseFloat(r.hm_awal), parseFloat(r.hm_akhir), 
                hm,
                r.keterangan || '-', 
                uMakan, uTrans, uLembur
            ]);
        });

        // --- D. SUBTOTAL GAJI ---
        const totalGaji = sumMakan + sumTrans + sumLembur;
        wsData.push([]);
        wsData.push(["", "", "TOTAL JAM OPERASI", "", "", totalHMReal, "TOTAL GAJI:", sumMakan, sumTrans, sumLembur]);
        wsData.push(["", "", "", "", "", "", "", "", "TAKE HOME PAY:", "Rp " + totalGaji.toLocaleString('id-ID')]);
        
        wsData.push([]); 
        wsData.push([]); 

        // ---------------------------------------------------------
        // --- E. BAGIAN ANALISA BONUS & PERFORMANCE (BARU) ---
        // ---------------------------------------------------------
        
        wsData.push(["=== ANALISA PERFORMANCE & BONUS MINIMUM CHARGE ==="]);
        wsData.push(["TARGET MINIMUM", ": " + targetHM + " HM"]);
        wsData.push(["HM AKTUAL", ": " + parseFloat(totalHMReal.toFixed(1)) + " HM"]);
        wsData.push([]);

        let grandTotalHM = totalHMReal;
        let totalPoin = 0;

        if (totalHMReal >= targetHM) {
            // KASUS 1: DAPAT BONUS
            const selisih = totalHMReal - targetHM;
            const bonusRp = selisih * rateBonus;

            wsData.push(["STATUS", ": MELEBIHI TARGET (BONUS) ‚úÖ"]);
            wsData.push(["KELEBIHAN JAM", ": " + parseFloat(selisih.toFixed(1)) + " HM"]);
            wsData.push(["RATE BONUS", ": Rp 15.000 / HM"]);
            wsData.push(["TOTAL BONUS", ": Rp " + bonusRp.toLocaleString('id-ID')]);
            wsData.push([]);
            wsData.push(["TOTAL DITERIMA (GAJI + BONUS)", ": Rp " + (totalGaji + bonusRp).toLocaleString('id-ID')]);

        } else {
            // KASUS 2: DI BAWAH TARGET (HITUNG POIN)
            wsData.push(["STATUS AWAL", ": DI BAWAH TARGET ‚ö†Ô∏è"]);
            wsData.push([]);
            wsData.push(["RINCIAN POIN KOMPENSASI (BREAKDOWN/CUACA):"]);
            wsData.push(["TANGGAL", "ALASAN", "POIN TAMBAHAN"]);
            
            if (breakdownDays.length > 0) {
                breakdownDays.forEach(bd => {
                    const point = 7; // Fix 7 poin
                    totalPoin += point;
                    wsData.push([formatDate(bd.date), bd.reason, point + " HM"]);
                });
                wsData.push(["", "TOTAL POIN", totalPoin + " HM"]);
            } else {
                wsData.push(["-", "Tidak ada kendala tercatat.", "0 HM"]);
            }
            
            wsData.push([]);
            grandTotalHM = totalHMReal + totalPoin;
            wsData.push(["TOTAL HM + POIN", ": " + parseFloat(grandTotalHM.toFixed(1)) + " HM"]);

            if (grandTotalHM >= targetHM) {
                wsData.push(["KESIMPULAN", ": AMAN (Mencapai Minimum Charge setelah poin) ‚úÖ"]);
                wsData.push(["TINDAKAN", ": Gaji Dibayar Penuh (Tidak Ada Pemotongan)"]);
                wsData.push(["TOTAL DITERIMA", ": Rp " + totalGaji.toLocaleString('id-ID')]);
            } else {
                const kekurangan = targetHM - grandTotalHM;
                wsData.push(["KESIMPULAN", ": MASIH DI BAWAH TARGET ‚ùå"]);
                wsData.push(["KEKURANGAN", ": " + parseFloat(kekurangan.toFixed(1)) + " HM"]);
                wsData.push(["TINDAKAN", ": BERLAKU PEMOTONGAN GAJI"]);
            }
        }

        // Tanda Tangan
        wsData.push([]);
        wsData.push([]);
        wsData.push(["Dibuat Oleh,", "", "", "", "Disetujui Oleh,"]);
        wsData.push([]);
        wsData.push([]);
        wsData.push(["( Admin )", "", "", "", "( Pimpinan )"]);

        // Buat Sheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        // Styling Header Kuning
        const range = XLSX.utils.decode_range(ws['!ref']);
        for(let C = range.s.c; C <= range.e.c; ++C) {
            const addr = XLSX.utils.encode_cell({r:7, c:C}); // Baris ke-8 (index 7)
            if(!ws[addr]) continue;
            ws[addr].s = { 
                font: { bold: true }, 
                fill: { fgColor: { rgb: "FFFF00" } },
                border: { top:{style:"thin"}, bottom:{style:"thin"}, left:{style:"thin"}, right:{style:"thin"} }
            };
        }

        // Lebar Kolom (Tanpa Paraf)
        ws['!cols'] = [
            {wch:5}, {wch:12}, {wch:12}, 
            {wch:8}, {wch:8}, {wch:10}, 
            {wch:35}, 
            {wch:15}, {wch:15}, {wch:15}
        ];

        const sheetName = opName.replace(/[\/\?\*\[\]\\]/g, '').substring(0, 30);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });

    // Download
    XLSX.writeFile(wb, `Payroll_Bonus_Performance_${periodInfo.start_str}.xlsx`);
    
    // Tutup Modal
    document.getElementById('payrollModal').style.display = 'none';
    document.getElementById('payrollExportModal').style.display = 'none';
    
    if (typeof showToast === 'function') {
        showToast("Export Selesai", "Laporan Gaji & Bonus berhasil didownload.", "success");
    } else {
        alert("Laporan Gaji & Bonus berhasil didownload.");
    }
}
// Helper Hari Indonesia (Jika belum ada)
function getIndonesianDayName(dateStr) {
    const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    return days[new Date(dateStr).getDay()];
}
// --- INIT TANGGAL DEFAULT SAAT LOAD ---
document.addEventListener('DOMContentLoaded', () => {
    const saranaDate = document.getElementById('sarana_date');
    if(saranaDate) saranaDate.value = new Date().toISOString().substring(0, 10);
});

// --- FUNGSI SIMPAN SOLAR SARANA/OPERASIONAL ---
window.saveSaranaFuel = function(e) {
    e.preventDefault();

    // 1. Ambil Nilai
    const date = document.getElementById('sarana_date').value;
    const unit = document.getElementById('sarana_unit').value.toUpperCase();
    const pic = document.getElementById('sarana_pic').value.toUpperCase();
    const liter = parseFloat(document.getElementById('sarana_liter').value);

    // 2. Validasi
    if (isNaN(liter) || liter <= 0) return alert("Jumlah liter harus diisi dengan benar.");
    if (!date || !unit) return alert("Tanggal dan Nama Unit wajib diisi.");

    // 3. Cek Stok Cukup atau Tidak
    if (liter > triputraFuelStock) {
        return alert(`‚ö†Ô∏è Stok Solar TIDAK CUKUP!\nStok Saat Ini: ${Math.round(triputraFuelStock)} L\nPermintaan: ${liter} L`);
    }

    // 4. Konfirmasi
    if (!confirm(`Kurangi stok solar sebanyak ${liter} Liter untuk unit operasional "${unit}"?`)) return;
    window.renderSaranaTable();

    // 5. Kurangi Stok Global
    triputraFuelStock -= liter;

    // 6. Catat ke Log Riwayat Stok (Penting agar terlacak di tombol "Riwayat")
    logStockChange(
        'Pemakaian Sarana/LV', 
        -liter, 
        `${unit} (${pic}) - Tgl ${formatDate(date)}`
    );

    // 7. (Opsional) Masukkan ke Tabel Data tapi tandai sebagai Non-Produksi
    // Kita masukkan agar tercatat di export Excel, tapi HM/Titik kita nol-kan.
    const newRecord = {
        id: Date.now() + Math.random(),
        tanggal: date,
        unit: unit,
        operator: pic,
        pencapaian: 0,   // Tidak ada titik
        hmAwal: 0,       // Tidak ada HM
        hmAkhir: 0,      // Tidak ada HM
        hmTotal: 0,      // Tidak ada HM
        solar: liter,    // HANYA SOLAR
        ket: "UNIT OPERASIONAL / SARANA"
    };
    
    triputraData.push(newRecord);
    saveTriputraData(); // Simpan ke storage

    // 8. Refresh UI
    const displayStock = document.getElementById('triputra_stock_display');
    if(displayStock) displayStock.textContent = Math.round(triputraFuelStock).toLocaleString('id-ID');

    // Refresh Tabel (Agar muncul di list bawah, tapi HM 0)
    window.fetchTriputraData();

    // Reset Form
    document.getElementById('sarana_unit').value = '';
    document.getElementById('sarana_liter').value = '';
    // document.getElementById('sarana_pic').value = ''; // Opsional: biarkan nama driver tetap ada jika input banyak mobil

    showToast("Berhasil", `Stok berkurang ${liter} Liter untuk ${unit}.`, "success");
};
// --- 1. RENDER TABEL SARANA ---
window.renderSaranaTable = function() {
    const tbody = document.getElementById('saranaReportBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Ambil periode filter dari Triputra Main Filter
    const periodType = document.getElementById('trp_period_select').value;
    let period;
    // Cek apakah fungsi helper multi-select tersedia
    if (typeof getMultipleReportingPeriod === 'function') {
         period = getMultipleReportingPeriod(periodType, 'trp_');
    } else {
         period = getReportingPeriod(periodType, 'trp_');
    }

    // Filter Data: Hanya yang tandanya "UNIT OPERASIONAL / SARANA" & Sesuai Periode
    const saranaData = triputraData.filter(d => 
        d.ket === "UNIT OPERASIONAL / SARANA" && 
        isDateInPeriod(d.tanggal, period.start_str, period.end_str)
    );

    // Sortir: Terbaru di atas
    saranaData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

    if (saranaData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:15px;">Belum ada penggunaan solar sarana di periode ini.</td></tr>';
        return;
    }

    saranaData.forEach(item => {
        tbody.innerHTML += `
            <tr>
                <td style="text-align:center;">
                    <button onclick="window.openEditSarana('${item.id}')" style="background:#ffc107; border:none; padding:3px 6px; border-radius:4px; cursor:pointer;" title="Edit">‚úèÔ∏è</button>
                    <button onclick="window.deleteSarana('${item.id}')" style="background:#dc3545; color:white; border:none; padding:3px 6px; border-radius:4px; cursor:pointer;" title="Hapus">üóëÔ∏è</button>
                </td>
                <td>${formatDate(item.tanggal)}</td>
                <td style="text-align:left; font-weight:bold;">${item.unit}</td>
                <td style="text-align:left;">${item.operator}</td>
                <td style="font-weight:bold; color:#d63384;">${item.solar} L</td>
            </tr>
        `;
    });
};

// --- 2. HAPUS DATA SARANA (REFUND STOK) ---
window.deleteSarana = function(id) {
    if (!confirm("Hapus data ini? Stok solar akan dikembalikan.")) return;

    const index = triputraData.findIndex(d => d.id == id);
    if (index === -1) return;

    const item = triputraData[index];
    const solarRefund = parseFloat(item.solar);

    // Kembalikan Stok
    triputraFuelStock += solarRefund;
    
    // Hapus Data
    triputraData.splice(index, 1);

    // Log & Save
    logStockChange('Refund Sarana', solarRefund, `Hapus: ${item.unit} (${formatDate(item.tanggal)})`);
    saveTriputraData();
    
    // Refresh UI
    window.renderSaranaTable();
    window.fetchTriputraData(); // Update tabel utama juga
    
    // Update Tampilan Stok Angka
    const displayStock = document.getElementById('triputra_stock_display');
    if(displayStock) displayStock.textContent = Math.round(triputraFuelStock).toLocaleString('id-ID');

    showToast("Dihapus", `Data dihapus. Stok bertambah ${solarRefund} L.`, "success");
};

// --- 3. BUKA MODAL EDIT ---
window.openEditSarana = function(id) {
    const item = triputraData.find(d => d.id == id);
    if (!item) return;

    document.getElementById('edit_sarana_id').value = id;
    document.getElementById('edit_sarana_old_solar').value = item.solar;
    
    document.getElementById('edit_sarana_date').value = item.tanggal;
    document.getElementById('edit_sarana_unit').value = item.unit;
    document.getElementById('edit_sarana_pic').value = item.operator;
    document.getElementById('edit_sarana_solar').value = item.solar;

    document.getElementById('editSaranaModal').style.display = 'block';
};

// --- 4. SIMPAN EDIT SARANA (ADJUST STOK) ---
window.saveSaranaEdit = function() {
    const id = document.getElementById('edit_sarana_id').value;
    const oldSolar = parseFloat(document.getElementById('edit_sarana_old_solar').value);
    
    const newDate = document.getElementById('edit_sarana_date').value;
    const newUnit = document.getElementById('edit_sarana_unit').value.toUpperCase();
    const newPic = document.getElementById('edit_sarana_pic').value.toUpperCase();
    const newSolar = parseFloat(document.getElementById('edit_sarana_solar').value);

    if (isNaN(newSolar) || newSolar <= 0) return alert("Jumlah solar tidak valid.");
    if (!newDate || !newUnit) return alert("Data wajib diisi.");

    // Hitung Selisih untuk Stok
    const diff = newSolar - oldSolar; // Jika positif berarti nambah ambil, jika negatif berarti balikin stok

    // Cek stok jika nambah
    if (diff > 0 && diff > triputraFuelStock) {
        return alert(`Stok tidak cukup untuk penambahan ${diff} Liter.`);
    }

    // Update Data Array Global
    const index = triputraData.findIndex(d => d.id == id);
    if (index !== -1) {
        triputraData[index].tanggal = newDate;
        triputraData[index].unit = newUnit;
        triputraData[index].operator = newPic;
        triputraData[index].solar = newSolar;
    }

    // Update Stok Global
    triputraFuelStock -= diff;

    // Log & Save
    if (diff !== 0) {
        logStockChange('Koreksi Sarana', -diff, `Edit: ${newUnit}`);
    }
    saveTriputraData();

    // Refresh UI
    document.getElementById('editSaranaModal').style.display = 'none';
    window.renderSaranaTable();
    window.fetchTriputraData(); // Refresh tabel utama
    
    const displayStock = document.getElementById('triputra_stock_display');
    if(displayStock) displayStock.textContent = Math.round(triputraFuelStock).toLocaleString('id-ID');

    showToast("Update Berhasil", "Data sarana diperbarui.", "success");
};

// ==========================================
// === FITUR INPUT IJIN/SAKIT PANJANG ===
// ==========================================
// ==========================================
// === FITUR INPUT IJIN/SAKIT PANJANG (AUTO DETEKSI SEKTOR) ===
// ==========================================
window.processLongLeave = function() {
    const operator = document.getElementById('leave_operator').value.trim().toUpperCase();
    const startDate = document.getElementById('leave_start_date').value;
    const endDate = document.getElementById('leave_end_date').value;
    const reason = document.getElementById('leave_reason').value;

    // A. Validasi
    if (!operator) return alert("Nama Operator harus diisi!");
    if (!startDate || !endDate) return alert("Rentang tanggal harus diisi!");
    if (new Date(startDate) > new Date(endDate)) return alert("Tanggal Akhir tidak boleh lebih kecil dari Tanggal Awal.");

    // --- [LOGIKA BARU] DETEKSI SEKTOR OTOMATIS ---
    let detectedSektor = "LAIN-LAIN";
    let detectedKlasifikasi = "LAIN-LAIN";

    // 1. Cek Riwayat Laporan Terakhir (Prioritas Utama)
    // Cari laporan terbaru atas nama operator ini
    const lastReport = reportsData
        .filter(r => r.operator === operator)
        .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))[0];

    if (lastReport) {
        detectedSektor = lastReport.sektor;
        detectedKlasifikasi = lastReport.klasifikasi_sektor;
    } else {
        // 2. Jika tidak ada history, Cek Master Unit (Operator Default di Unit mana?)
        const unitKey = Object.keys(masterUnits).find(key => masterUnits[key].operator_default === operator);
        if (unitKey) {
            detectedSektor = masterUnits[unitKey].sektor_default;
            // Gunakan fungsi helper untuk mendapatkan klasifikasi (IHM/KWL/TRIPUTRA)
            detectedKlasifikasi = getSektorClassification(detectedSektor);
        }
    }
    // ---------------------------------------------

    // B. Konfirmasi
    if(!confirm(`Buat status "${reason}" untuk ${operator} (Sektor: ${detectedSektor})?\nDari: ${startDate}\nSampai: ${endDate}`)) return;

    // C. Loop Tanggal
    let current = new Date(startDate);
    current.setHours(12, 0, 0, 0);
    
    const end = new Date(endDate);
    end.setHours(12, 0, 0, 0);
    
    let count = 0;
    const newReports = [];

    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        
        // Cek apakah di tanggal ini operator SUDAH punya data?
        const existing = reportsData.find(r => r.tanggal === dateStr && r.operator === operator);
        
        if (!existing) {
            // Buat Data Dummy dengan SEKTOR YANG SUDAH DIDETEKSI
            newReports.push({
                id: Date.now() + Math.random(), 
                tanggal: dateStr,
                unit: "STATUS",       
                operator: operator,
                model: "-",
                
                // --- UPDATE DISINI ---
                sektor: detectedSektor, 
                klasifikasi_sektor: detectedKlasifikasi,
                // ---------------------

                hm_awal: 0,
                hm_akhir: 0,
                jam_operasi: 0,
                total_solar: 0,
                work_hours: 0,
                time_in: "-",
                time_out: "-",
                keterangan: reason,          
                kategori_keterangan: "IDLE_LAIN", 
                foto_timesheet: "N/A",
                foto_awal: "N/A",
                foto_akhir: "N/A"
            });
            count++;
        }
        
        // Lanjut ke hari berikutnya
        current.setDate(current.getDate() + 1);
    }

    // D. Simpan & Refresh
    if (count > 0) {
        reportsData.push(...newReports);
        saveReportsDataToLocalStorage();
        
        document.getElementById('longLeaveModal').style.display = 'none';
        
        if (typeof window.fetchAttendanceData === 'function') {
            window.fetchAttendanceData(); 
        }

        if (typeof showToast === 'function') {
            showToast("Sukses", `Berhasil input ${reason} (${count} hari) di sektor ${detectedSektor}.`, "success");
        } else {
            alert(`Berhasil input status.`);
        }
    } else {
        alert("Tidak ada data yang ditambahkan.\nMungkin tanggal tersebut sudah terisi laporan kerja untuk operator ini.");
    }
}

// ====================================================================
// FUNGSI HITUNG GAJI TRIPUTRA (FIXED: DROPDOWN & CALCULATION)
// ====================================================================
// ====================================================================
// 1. UPDATE: HITUNG GAJI (FILTER OUT UNIT OPERASIONAL/SARANA)
// ====================================================================
window.calculateTriputraPayroll = function() {
    // 1. Ambil Setting Batas & Rate
    const limit1 = parseFloat(document.getElementById('pay_limit_1').value) || 89;
    const limit2 = parseFloat(document.getElementById('pay_limit_2').value) || 120;
    
    const rate1 = parseFloat(document.getElementById('pay_rate_1').value) || 1000;
    const rate2 = parseFloat(document.getElementById('pay_rate_2').value) || 2000;
    const rate3 = parseFloat(document.getElementById('pay_rate_3').value) || 2500;

    // 2. Ambil Periode
    const periodType = document.getElementById('trp_period_select').value;
    const monthSelect = document.getElementById('trp_filter_month');
    let period;
    
    if (typeof getMultipleReportingPeriod === 'function') {
         period = getMultipleReportingPeriod(periodType, 'trp_');
    } else {
         period = getReportingPeriod(periodType, 'trp_');
    }

    // 3. Ambil Data & FILTER TANGGAL
    let rawData = triputraData.filter(d => isDateInPeriod(d.tanggal, period.start_str, period.end_str));

    // --- [BARU] FILTER DATA SARANA/OPERASIONAL ---
    // Daftar kata kunci unit yang TIDAK DAPAT GAJI TITIK
    const excludeKeywords = [
        'LV', 'SARANA', 'OPS', 'OPERASIONAL', 'MOBIL', 
        'HILUX', 'TRITON', 'STRADA', 'RANGER', 'NAVARA', 
        'FORTUNER', 'PAJERO', 'INNOVA', 'AVANZA', 'XENIA', 
        'GRANMAX', 'MEGA', 'EXPANDER', 'COLORADO', 'D-MAX',
        'AMBULANCE', 'RESCUE', 'MANHAUL', 'FUEL', 'SERVICE', 
        'LUBE', 'WATER', 'GENSET'
    ];

    rawData = rawData.filter(d => {
        const u = d.unit.toUpperCase();
        // Return FALSE jika unit mengandung kata kunci di atas (dibuang)
        return !excludeKeywords.some(k => u.includes(k));
    });
    // ---------------------------------------------

    if (rawData.length === 0) {
        document.getElementById('payrollBody').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:15px; color:red;">Tidak ada data produksi (Unit Operasional disembunyikan).</td></tr>';
        document.getElementById('pay_filter_name').innerHTML = '<option value="all">-- Data Kosong --</option>';
        return;
    }

    // 4. Update Dropdown Filter Nama (Populate)
    const payFilterSelect = document.getElementById('pay_filter_name');
    const currentSelection = payFilterSelect.value; 

    const uniqueOperators = [...new Set(rawData.map(d => d.operator ? d.operator.trim().toUpperCase() : "TANPA NAMA"))].sort();

    payFilterSelect.innerHTML = '<option value="all">-- Tampilkan Semua Operator --</option>';
    uniqueOperators.forEach(op => {
        const opt = document.createElement('option');
        opt.value = op;
        opt.textContent = op;
        payFilterSelect.appendChild(opt);
    });

    if (uniqueOperators.includes(currentSelection)) {
        payFilterSelect.value = currentSelection;
    } else {
        payFilterSelect.value = "all";
    }

    // 5. Terapkan Filter Nama (Jika ada yang dipilih)
    let finalData = [...rawData];
    const selectedOp = payFilterSelect.value;
    
    if (selectedOp !== 'all') {
        finalData = finalData.filter(d => (d.operator ? d.operator.trim().toUpperCase() : "TANPA NAMA") === selectedOp);
    }

    // 6. Render Tabel
    const tbody = document.getElementById('payrollBody');
    const tfoot = document.getElementById('payrollFoot');
    tbody.innerHTML = '';
    
    // Sort: Nama dulu, baru Tanggal
    finalData.sort((a,b) => {
        const nameA = a.operator || "";
        const nameB = b.operator || "";
        return nameA.localeCompare(nameB) || new Date(a.tanggal) - new Date(b.tanggal);
    });

    let grandTotalRp = 0;
    let grandTotalTitik = 0;

    finalData.forEach(item => {
        const titik = parseFloat(item.pencapaian) || 0;
        let totalRp = 0;
        let breakdownText = [];

        // --- LOGIKA HITUNG TIER ---
        let remaining = titik;

        // Tier 3 (> Limit 2)
        if (titik > limit2) {
            const tier3Qty = titik - limit2;
            const tier3Val = tier3Qty * rate3;
            totalRp += tier3Val;
            remaining = limit2; 
            breakdownText.push(`<span style="color:#0d6efd; font-weight:bold;">Tier 3 (${tier3Qty} x ${rate3})</span>`);
        }

        // Tier 2 (> Limit 1 s/d Limit 2)
        if (remaining > limit1) {
            const tier2Qty = remaining - limit1;
            const tier2Val = tier2Qty * rate2;
            totalRp += tier2Val;
            remaining = limit1; 
            breakdownText.push(`<span style="color:#d63384; font-weight:bold;">Tier 2 (${tier2Qty} x ${rate2})</span>`);
        }

        // Tier 1 (0 s/d Limit 1)
        if (remaining > 0) {
            const tier1Qty = remaining;
            const tier1Val = tier1Qty * rate1;
            totalRp += tier1Val;
            breakdownText.push(`<span style="color:#198754;">Tier 1 (${tier1Qty} x ${rate1})</span>`);
        }

        grandTotalRp += totalRp;
        grandTotalTitik += titik;

        tbody.innerHTML += `
            <tr>
                <td>${formatDate(item.tanggal)}</td>
                <td>${item.unit}</td>
                <td style="font-weight:bold;">${item.operator}</td>
                <td style="text-align:center; font-weight:bold;">${titik}</td>
                <td style="font-size:11px;">${breakdownText.join(' + ') || '-'}</td>
                <td style="text-align:right; font-weight:bold;">Rp ${totalRp.toLocaleString('id-ID')}</td>
            </tr>
        `;
    });

    tfoot.innerHTML = `
        <tr>
            <td colspan="3" style="text-align:right; font-weight:bold;">TOTAL (${selectedOp === 'all' ? 'SEMUA' : selectedOp}):</td>
            <td style="text-align:center; font-weight:bold;">${grandTotalTitik}</td>
            <td></td>
            <td style="text-align:right; font-size:14px; background-color:#d1e7dd; font-weight:bold;">Rp ${grandTotalRp.toLocaleString('id-ID')}</td>
        </tr>
    `;
    
    // Auto-update notifikasi
    if(document.getElementById('payrollModal') && document.getElementById('payrollModal').style.display === 'none') {
        showToast("Selesai", "Data pendapatan (Non-Sarana) berhasil dihitung.", "success");
    }
}

// ====================================================================
// 2. FITUR BARU: EXPORT MULTI SHEET (PER OPERATOR)
// ====================================================================
// ====================================================================
// 2. FITUR BARU: EXPORT MULTI SHEET (PER OPERATOR) + KETERANGAN RUMUS
// ====================================================================
// ====================================================================
// 2. MULTI SHEET EXPORT (XLSX) - DENGAN WARNA TIER OTOMATIS
// ====================================================================
window.exportTriputraPayrollAllSheets = function() {
    // A. Ambil Setting Tarif
    const limit1 = parseFloat(document.getElementById('pay_limit_1').value) || 89;
    const limit2 = parseFloat(document.getElementById('pay_limit_2').value) || 120;
    const rate1 = parseFloat(document.getElementById('pay_rate_1').value) || 1000;
    const rate2 = parseFloat(document.getElementById('pay_rate_2').value) || 2000;
    const rate3 = parseFloat(document.getElementById('pay_rate_3').value) || 2500;

    // B. Ambil Periode
    const periodType = document.getElementById('trp_period_select').value;
    let period;
    if (typeof getMultipleReportingPeriod === 'function') {
         period = getMultipleReportingPeriod(periodType, 'trp_');
    } else {
         period = getReportingPeriod(periodType, 'trp_');
    }

    // C. Filter Data
    let rawData = triputraData.filter(d => isDateInPeriod(d.tanggal, period.start_str, period.end_str));
    
    const excludeKeywords = [
        'LV', 'SARANA', 'OPS', 'OPERASIONAL', 'MOBIL', 'HILUX', 'TRITON', 'STRADA', 'RANGER', 
        'NAVARA', 'FORTUNER', 'PAJERO', 'INNOVA', 'AVANZA', 'XENIA', 'GRANMAX', 'MEGA', 
        'EXPANDER', 'COLORADO', 'D-MAX', 'AMBULANCE', 'RESCUE', 'MANHAUL', 'FUEL', 'SERVICE', 
        'LUBE', 'WATER', 'GENSET'
    ];

    rawData = rawData.filter(d => {
        const u = d.unit.toUpperCase();
        return !excludeKeywords.some(k => u.includes(k));
    });

    if (rawData.length === 0) return alert("Tidak ada data produksi untuk diexport.");

    // D. Grouping
    const groupedByOp = rawData.reduce((acc, curr) => {
        const opName = curr.operator ? curr.operator.trim().toUpperCase() : "TANPA_NAMA";
        if(!acc[opName]) acc[opName] = [];
        acc[opName].push(curr);
        return acc;
    }, {});

    const wb = XLSX.utils.book_new();
    
    // --- Style Definisi ---
    const borderStyle = { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} };
    const headerStyle = { 
        fill: { fgColor: { rgb: "198754" } }, 
        font: { bold: true, color: { rgb: "FFFFFF" } },
        alignment: { horizontal: "center", vertical: "center" },
        border: borderStyle
    };
    const totalStyle = { fill: { fgColor: { rgb: "E9ECEF" } }, font: { bold: true }, border: borderStyle };
    const legendTitleStyle = { fill: { fgColor: { rgb: "F8F9FA" } }, font: { bold: true }, border: borderStyle, alignment: { horizontal: "left" } };

    // --- Warna Font per Tier ---
    const colorTier1 = { rgb: "198754" }; // Hijau
    const colorTier2 = { rgb: "D63384" }; // Pink
    const colorTier3 = { rgb: "0D6EFD" }; // Biru

    let hasData = false;

    // F. Loop Setiap Operator
    Object.keys(groupedByOp).sort().forEach(opName => {
        const opData = groupedByOp[opName];
        opData.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

        const wsData = [];
        // Simpan Highest Tier per baris untuk pewarnaan nanti
        // Format: [maxTierVal (1/2/3), ... ]
        const rowMaxTiers = {}; 

        // Judul
        wsData.push([`LAPORAN PENDAPATAN TITIK OPERATOR`]);
        wsData.push([`NAMA: ${opName}`]);
        wsData.push([`PERIODE: ${period.text}`]);
        wsData.push([]); 

        // Header
        wsData.push(["NO", "TANGGAL", "UNIT", "TOTAL TITIK", "PERHITUNGAN (TIER)", "PENDAPATAN (RP)"]);

        let no = 1;
        let totalTitikOp = 0;
        let totalRpOp = 0;
        // Index baris data dimulai dari 5 (karena header di index 4)
        let currentRowIdx = 5; 

        opData.forEach(item => {
            const titik = parseFloat(item.pencapaian) || 0;
            let totalRp = 0;
            let detailCalc = [];
            let maxTier = 1; // Default Tier 1

            let remaining = titik;

            // Tier 3
            if (titik > limit2) {
                const qty = titik - limit2;
                totalRp += (qty * rate3);
                remaining = limit2;
                detailCalc.push(`T3: ${qty}x${rate3}`);
                maxTier = 3; // Mencapai Tier 3
            }
            // Tier 2
            if (remaining > limit1) {
                const qty = remaining - limit1;
                totalRp += (qty * rate2);
                remaining = limit1;
                detailCalc.push(`T2: ${qty}x${rate2}`);
                if(maxTier < 2) maxTier = 2; // Mencapai Tier 2
            }
            // Tier 1
            if (remaining > 0) {
                const qty = remaining;
                totalRp += (qty * rate1);
                detailCalc.push(`T1: ${qty}x${rate1}`);
            }

            totalTitikOp += titik;
            totalRpOp += totalRp;

            wsData.push([
                no++,
                formatDate(item.tanggal),
                item.unit,
                titik,
                detailCalc.join(' + '),
                totalRp
            ]);
            
            // Simpan Tier Tertinggi untuk baris ini
            rowMaxTiers[currentRowIdx] = maxTier;
            currentRowIdx++;
        });

        // Baris Total
        wsData.push(["TOTAL", "", "", totalTitikOp, "", totalRpOp]);

        // Footer Legenda
        wsData.push([]); 
        const legendStartIdx = wsData.length; 
        wsData.push(["KETERANGAN & RUMUS PERHITUNGAN:"]);
        wsData.push([`‚Ä¢ Tier 1 (Dasar): Pencapaian 0 s/d ${limit1} titik dikali Rp ${rate1.toLocaleString('id-ID')}`]);
        wsData.push([`‚Ä¢ Tier 2 (Menengah): Kelebihan titik di atas ${limit1} s/d ${limit2} dikali Rp ${rate2.toLocaleString('id-ID')}`]);
        wsData.push([`‚Ä¢ Tier 3 (Atas): Sisa kelebihan titik di atas ${limit2} dikali Rp ${rate3.toLocaleString('id-ID')}`]);
        wsData.push(["*Total Pendapatan adalah penjumlahan hasil perkalian dari setiap Tier yang dicapai."]);

        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // --- STYLING LOOP ---
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // Merge Judul & Footer
        if(!ws['!merges']) ws['!merges'] = [];
        ws['!merges'].push({ s:{r:0,c:0}, e:{r:0,c:5} });
        for (let i = 0; i < 5; i++) {
            ws['!merges'].push({ s:{r:legendStartIdx + i, c:0}, e:{r:legendStartIdx + i, c:5} });
        }

        for(let R = range.s.r; R <= range.e.r; ++R) {
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const addr = XLSX.utils.encode_cell({r:R, c:C});
                if(!ws[addr]) continue;

                // Header
                if(R === 4) {
                    ws[addr].s = headerStyle;
                }
                // Baris Data (Row 5 s/d Sebelum Total)
                else if(R > 4 && R < legendStartIdx - 1) { 
                    ws[addr].s = { border: borderStyle, alignment: { vertical: "center" } };
                    
                    if(C === 0 || C === 3) ws[addr].s.alignment.horizontal = "center";
                    if(C === 5) {
                        ws[addr].z = '#,##0'; 
                        ws[addr].s.alignment.horizontal = "right";
                    }

                    // --- LOGIKA PEWARNAAN KOLOM "PERHITUNGAN" (Index 4) ---
                    if (C === 4) {
                        const tierLevel = rowMaxTiers[R];
                        if (tierLevel === 3) ws[addr].s.font = { color: colorTier3, bold: true };
                        else if (tierLevel === 2) ws[addr].s.font = { color: colorTier2, bold: true };
                        else ws[addr].s.font = { color: colorTier1, bold: true };
                    }
                }
                // Total Row
                else if (R === legendStartIdx - 2) {
                    ws[addr].s = totalStyle;
                    if(C === 5) {
                        ws[addr].z = '"Rp "#,##0';
                        ws[addr].s.alignment = { horizontal: "right" };
                    }
                }
                // Footer Legenda (Pewarnaan Teks Footer)
                else if (R >= legendStartIdx) {
                    if (R === legendStartIdx) ws[addr].s = legendTitleStyle;
                    else {
                        ws[addr].s = { border: borderStyle, alignment: { horizontal: "left" } };
                        // Warnai teks keterangan sesuai Tier
                        if (R === legendStartIdx + 1) ws[addr].s.font = { color: colorTier1 }; // Tier 1 Hijau
                        if (R === legendStartIdx + 2) ws[addr].s.font = { color: colorTier2 }; // Tier 2 Pink
                        if (R === legendStartIdx + 3) ws[addr].s.font = { color: colorTier3 }; // Tier 3 Biru
                        if (R === legendStartIdx + 4) ws[addr].s.font = { italic: true, color: { rgb: "666666" } };
                    }
                }
            }
        }

        ws['!cols'] = [{wch: 5}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 35}, {wch: 18}];
        
        const sheetName = opName.replace(/[\/\?\*\[\]\\]/g, '').substring(0, 30);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        hasData = true;
    });

    if (hasData) {
        XLSX.writeFile(wb, `Gaji_Triputra_All_Operators_${new Date().toISOString().slice(0,10)}.xlsx`);
        showToast("Export Selesai", "File Excel Multi-Sheet berhasil dibuat.", "success");
    }
}

// ========================================================
// === MODUL PENILAIAN KEBERSIHAN (CLEANLINESS SCORE) ===
// ========================================================

// ========================================================
// === MODUL PENILAIAN KEBERSIHAN (UPDATED: SEKTOR FILTER) ===
// ========================================================

// ========================================================
// === MODUL PENILAIAN KEBERSIHAN (V3: QUICK INPUT & REALTIME) ===
// ========================================================

let cleanlinessScores = {}; // Cache Data Nilai

// 1. Load Data
window.loadCleanlinessView = async function() {
    // Populate Dropdown Tahun
    if(document.getElementById('clean_filter_year').options.length === 0) {
        populateFuelYears(); 
        const srcYear = document.getElementById('fuel_filter_year');
        const destYear = document.getElementById('clean_filter_year');
        destYear.innerHTML = srcYear.innerHTML; 
        destYear.value = new Date().getFullYear();
        updateMonthRange('custom_monthly_21_20', 'clean_');
    }

    // Populate Dropdown Sektor
    const cleanSektor = document.getElementById('clean_filter_sektor');
    const sourceSektor = document.getElementById('filter_sektor');
    if (cleanSektor.options.length <= 1 && sourceSektor && sourceSektor.options.length > 1) {
        cleanSektor.innerHTML = sourceSektor.innerHTML;
        cleanSektor.value = 'all';
    }

    // Load DB
    const storedScores = await idb.get('DOR_CleanlinessScores');
    if (storedScores) cleanlinessScores = storedScores;

    renderCleanlinessTable();
}

// 2. Render Tabel Utama
function renderCleanlinessTable() {
    const table = document.getElementById('cleanlinessTable');
    const thead = table.querySelector('thead');
    const tbody = document.getElementById('cleanlinessBody');
    tbody.innerHTML = '';

    // Setup Periode
    const periodInfo = getReportingPeriod('custom_monthly_21_20', 'clean_');
    const dates = [];
    let curr = new Date(periodInfo.start_str);
    const end = new Date(periodInfo.end_str);
    curr.setHours(12,0,0,0); end.setHours(12,0,0,0);

    while(curr <= end) {
        dates.push(curr.toISOString().substring(0, 10));
        curr.setDate(curr.getDate() + 1);
    }

    // Header
    let headerHTML = `
        <tr style="background-color: #212529; color: white;">
            <th rowspan="2" style="width:30px;">NO</th>
            <th rowspan="2" style="width:150px; text-align:left;">NAMA OPERATOR</th>
            <th rowspan="2" style="width:80px;">UNIT</th>
            <th rowspan="2" style="width:100px;">ASPEK</th>
            <th rowspan="2" style="width:60px; background-color:#ffc107; color:black;">INPUT CEPAT</th> <th colspan="${dates.length}">TANGGAL PENILAIAN</th>
            <th rowspan="2" style="width:60px;">TOTAL</th>
            <th rowspan="2" style="width:100px;">BONUS (Rp)</th>
        </tr>
        <tr style="background-color: #343a40; color: white;">`;
    
    dates.forEach(d => {
        const dateObj = new Date(d);
        headerHTML += `<th style="width:25px; font-size:10px;">${dateObj.getDate()}</th>`;
    });
    headerHTML += `</tr>`;
    thead.innerHTML = headerHTML;

    // Filter Data
    let reports = reportsData.filter(r => isDateInPeriod(r.tanggal, periodInfo.start_str, periodInfo.end_str));
    const selectedSektor = document.getElementById('clean_filter_sektor').value;
    if (selectedSektor !== 'all') {
        reports = reports.filter(r => r.klasifikasi_sektor === selectedSektor);
    }
    
    // Grouping
    const grouped = {};
    reports.forEach(r => {
        if(!r.operator) return;
        if(!grouped[r.operator]) grouped[r.operator] = { unit: r.unit, dailyHM: {} };
        const currentHM = grouped[r.operator].dailyHM[r.tanggal] || 0;
        grouped[r.operator].dailyHM[r.tanggal] = Math.max(currentHM, r.jam_operasi);
        grouped[r.operator].unit = r.unit; 
    });

    const operators = Object.keys(grouped).sort();
    let no = 1;

    // Render Rows
    operators.forEach(op => {
        const data = grouped[op];
        const aspects = ['KEBERSIHAN', 'PERAWATAN', 'KEDISIPLINAN'];
        // ID unik untuk operator ini (tanpa spasi) untuk keperluan kalkulasi total
        const opId = op.replace(/[^a-zA-Z0-9]/g,''); 

        aspects.forEach((aspect, idx) => {
            let rowHTML = `<tr style="border-bottom: 1px solid #eee;">`;
            
            // Merge Cells (No, Nama, Unit)
            if(idx === 0) {
                rowHTML += `
                    <td rowspan="3" style="text-align:center; font-weight:bold; background:#fff;">${no++}</td>
                    <td rowspan="3" style="font-weight:bold; background:#fff;">${op}</td>
                    <td rowspan="3" style="text-align:center; background:#fff;">${data.unit}</td>
                `;
            }

            // Aspek
            rowHTML += `<td style="font-weight:bold; font-size:10px;">${aspect}</td>`;

            // --- KOLOM INPUT CEPAT ---
            // Input ini akan menimpa semua tanggal yang valid (HM >= 1)
            rowHTML += `
                <td style="background-color:#fff3cd; padding:2px;">
                    <input type="number" min="0" max="5" placeholder="All"
                    onchange="window.applyQuickInput('${op}', '${opId}', '${aspect}', this.value)"
                    style="width:100%; text-align:center; font-weight:bold; border:1px solid #ccc;">
                </td>
            `;

            // Data Harian
            dates.forEach(date => {
                const hm = data.dailyHM[date] || 0;
                let val = 0;
                let bgClass = "background-color: #f8d7da;"; // Pink (Default 0 / Libur)
                let isDisabled = "disabled style='background:transparent; border:none; width:100%; text-align:center; color:#dc3545;'";

                if (hm >= 1) {
                    const key = `${op}_${date}_${aspect}`;
                    // Ambil dari cache atau default 5
                    val = (cleanlinessScores[key] !== undefined) ? cleanlinessScores[key] : 5;
                    bgClass = ""; // Putih (Valid)
                    
                    // Input aktif untuk tanggal kerja
                    isDisabled = `
                        class="score-input-${opId}" 
                        data-op="${op}" data-date="${date}" data-aspect="${aspect}"
                        oninput="window.handleScoreChange('${opId}')"
                        style="width:100%; border:none; text-align:center; background:transparent; font-size:11px; height:25px; font-weight:bold;"
                    `;
                }

                rowHTML += `
                    <td style="padding:0; ${bgClass}">
                        <input type="number" value="${val}" min="0" max="5" ${isDisabled}>
                    </td>
                `;
            });

            // Merge Cells (Total & Bonus)
            if(idx === 0) {
                rowHTML += `<td rowspan="3" id="total_${opId}" style="text-align:center; font-weight:bold; font-size:14px;">0</td>`;
                rowHTML += `<td rowspan="3" id="bonus_${opId}" style="text-align:center; font-weight:bold; color:#198754;">Rp 0</td>`;
            }
            
            rowHTML += `</tr>`;
            tbody.innerHTML += rowHTML;
        });

        // Hitung total awal setelah render
        setTimeout(() => window.recalcOperatorTotal(opId), 0);
    });

    if(operators.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${dates.length + 7}" style="text-align:center; padding:20px;">Tidak ada data operator (HM >= 1) pada periode ini.</td></tr>`;
    }
}

// 3. Logic Input Cepat (Batch Update)
window.applyQuickInput = function(op, opId, aspect, val) {
    if (val === "" || val < 0 || val > 5) return;
    
    // Cari semua input di baris ini yang aktif (HM >= 1)
    // Kita cari berdasarkan atribut data-op dan data-aspect
    const inputs = document.querySelectorAll(`input[data-op="${op}"][data-aspect="${aspect}"]`);
    
    inputs.forEach(input => {
        input.value = val; // Ubah nilai visual
        // Kita tidak langsung simpan ke DB agar cepat, simpan nanti pas tombol Save diklik
        // Tapi kita update cache local agar Total terhitung
        const date = input.getAttribute('data-date');
        const key = `${op}_${date}_${aspect}`;
        cleanlinessScores[key] = parseInt(val);
    });

    // Hitung ulang total
    window.recalcOperatorTotal(opId);
    showToast("Update Cepat", `Nilai ${aspect} diubah jadi ${val} untuk hari aktif.`, "info");
}

// 4. Logic Perubahan Manual Harian (Trigger Total Realtime)
window.handleScoreChange = function(opId) {
    // Fungsi ini dipanggil saat oninput (ketik manual)
    // Kita beri delay sedikit agar tidak berat
    if(window.scoreTimeout) clearTimeout(window.scoreTimeout);
    window.scoreTimeout = setTimeout(() => {
        window.recalcOperatorTotal(opId);
    }, 300);
}

// 5. Fungsi Hitung Total & Bonus (DOM Based - Cepat)
window.recalcOperatorTotal = function(opId) {
    const inputs = document.querySelectorAll(`.score-input-${opId}`);
    let total = 0;

    inputs.forEach(inp => {
        const val = parseInt(inp.value) || 0;
        total += val;
        
        // Update cache data sekalian agar sinkron saat save
        const op = inp.getAttribute('data-op');
        const date = inp.getAttribute('data-date');
        const aspect = inp.getAttribute('data-aspect');
        const key = `${op}_${date}_${aspect}`;
        cleanlinessScores[key] = val;
    });

    // Update UI Total
    document.getElementById(`total_${opId}`).textContent = total;

    // Update UI Bonus
    let bonus = 0;
    if (total > 350) bonus = 250000;
    else if (total > 300) bonus = 200000;
    else if (total > 250) bonus = 150000;
    else if (total > 150) bonus = 100000;

    document.getElementById(`bonus_${opId}`).textContent = "Rp " + bonus.toLocaleString('id-ID');
}

// 6. TOMBOL SIMPAN PERUBAHAN
window.saveCleanlinessDataManual = async function() {
    try {
        await idb.set('DOR_CleanlinessScores', cleanlinessScores);
        showToast("Tersimpan", "Semua perubahan penilaian berhasil disimpan.", "success");
    } catch (e) {
        alert("Gagal menyimpan: " + e.message);
    }
}

// 7. Export Excel (Update: Tambah Footer Keterangan)
window.exportCleanlinessExcel = function() {
    const periodInfo = getReportingPeriod('custom_monthly_21_20', 'clean_');
    const selectedSektor = document.getElementById('clean_filter_sektor').value;
    const sektorLabel = selectedSektor === 'all' ? 'SEMUA SEKTOR' : selectedSektor;

    const dates = [];
    let curr = new Date(periodInfo.start_str);
    const end = new Date(periodInfo.end_str);
    curr.setHours(12,0,0,0); end.setHours(12,0,0,0);

    while(curr <= end) {
        dates.push(curr.toISOString().substring(0, 10));
        curr.setDate(curr.getDate() + 1);
    }

    const wsData = [];
    
    // Judul
    wsData.push(["PENILAIAN KEBERSIHAN OPERATOR"]);
    wsData.push(["PROJECT IHM KALTIM"]);
    wsData.push([`PERIODE: ${periodInfo.text}`]);
    wsData.push([`SEKTOR: ${sektorLabel}`]);
    wsData.push([]);

    // Header Table
    const headerRow = ["NO", "NAMA OPERATOR", "UNIT", "ASPEK PENILAIAN"];
    dates.forEach(d => headerRow.push(new Date(d).getDate())); 
    headerRow.push("TOTAL NILAI");
    headerRow.push("BONUS (Rp)");
    wsData.push(headerRow);

    // Filter Data Logic
    let reports = reportsData.filter(r => isDateInPeriod(r.tanggal, periodInfo.start_str, periodInfo.end_str));
    if (selectedSektor !== 'all') {
        reports = reports.filter(r => r.klasifikasi_sektor === selectedSektor);
    }

    const grouped = {};
    reports.forEach(r => {
        if(!r.operator) return;
        if(!grouped[r.operator]) grouped[r.operator] = { unit: r.unit, dailyHM: {} };
        const currentHM = grouped[r.operator].dailyHM[r.tanggal] || 0;
        grouped[r.operator].dailyHM[r.tanggal] = Math.max(currentHM, r.jam_operasi);
        grouped[r.operator].unit = r.unit; 
    });

    const aspects = ['KEBERSIHAN', 'PERAWATAN', 'KEDISIPLINAN'];
    let no = 1;

    Object.keys(grouped).sort().forEach(op => {
        const data = grouped[op];
        let totalScoreOp = 0;
        let opScores = []; 
        
        aspects.forEach(aspect => {
            const rowScores = [];
            dates.forEach(date => {
                const hm = data.dailyHM[date] || 0;
                let val = 0;
                if (hm >= 1) {
                    const key = `${op}_${date}_${aspect}`;
                    val = (cleanlinessScores[key] !== undefined) ? cleanlinessScores[key] : 5;
                }
                rowScores.push(val);
                totalScoreOp += val;
            });
            opScores.push(rowScores);
        });

        let bonus = 0;
        if (totalScoreOp > 350) bonus = 250000;
        else if (totalScoreOp > 300) bonus = 200000;
        else if (totalScoreOp > 250) bonus = 150000;
        else if (totalScoreOp > 150) bonus = 100000;

        aspects.forEach((aspect, idx) => {
            const row = [];
            if(idx === 0) { row.push(no++); row.push(op); row.push(data.unit); } 
            else { row.push(""); row.push(""); row.push(""); }
            
            row.push(aspect);
            row.push(...opScores[idx]); 

            if(idx === 0) { row.push(totalScoreOp); row.push(bonus); } 
            else { row.push(""); row.push(""); }
            
            wsData.push(row);
        });
    });

    // --- TAMBAHAN: FOOTER KETERANGAN ---
    const lastRowIdx = wsData.length;
    wsData.push([]); 
    wsData.push([]); 
    wsData.push(["KETERANGAN & ATURAN BONUS:"]);
    wsData.push(["1. Nilai diberikan rentang 0 - 5 (0 = Tidak Masuk/Buruk, 5 = Sangat Baik)."]);
    wsData.push(["2. Jika unit tidak beroperasi (HM=0), nilai otomatis 0."]);
    wsData.push(["SKEMA BONUS:"]);
    wsData.push(["‚Ä¢ < 150 Poin", ": Rp 0"]);
    wsData.push(["‚Ä¢ 151 - 250 Poin", ": Rp 100.000"]);
    wsData.push(["‚Ä¢ 251 - 300 Poin", ": Rp 150.000"]);
    wsData.push(["‚Ä¢ 301 - 350 Poin", ": Rp 200.000"]);
    wsData.push(["‚Ä¢ > 350 Poin", ": Rp 250.000"]);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Styling & Merging
    const range = XLSX.utils.decode_range(ws['!ref']);
    const borderStyle = { top: {style:"thin"}, bottom: {style:"thin"}, left: {style:"thin"}, right: {style:"thin"} };
    
    if(!ws['!merges']) ws['!merges'] = [];
    // Merge Header & Judul
    ws['!merges'].push({ s:{r:0,c:0}, e:{r:0,c:dates.length+5} }); 
    ws['!merges'].push({ s:{r:1,c:0}, e:{r:1,c:dates.length+5} });
    ws['!merges'].push({ s:{r:2,c:0}, e:{r:2,c:dates.length+5} });
    ws['!merges'].push({ s:{r:3,c:0}, e:{r:3,c:dates.length+5} });

    // Loop data rows (Main Table)
    for (let r = 6; r < lastRowIdx; r += 3) {
        [0, 1, 2, dates.length + 4, dates.length + 5].forEach(col => {
            ws['!merges'].push({ s: {r:r, c:col}, e: {r:r+2, c:col} });
        });
    }

    // Styling Loop
    for(let R = range.s.r; R <= range.e.r; ++R) {
        for(let C = range.s.c; C <= range.e.c; ++C) {
            const addr = XLSX.utils.encode_cell({r:R, c:C});
            if(!ws[addr]) continue;

            // Judul
            if(R <= 3) {
                ws[addr].s = { font: { bold: true, sz: 14 }, alignment: { horizontal: "center" } };
            }
            // Header Tabel
            else if(R === 5) { 
                ws[addr].s = { 
                    fill: { fgColor: { rgb: "D63384" } }, 
                    font: { color: { rgb: "FFFFFF" }, bold: true },
                    border: borderStyle,
                    alignment: { horizontal: "center", vertical: "center" }
                };
            }
            // Data Tabel
            else if (R < lastRowIdx) {
                const val = ws[addr].v;
                let cellStyle = { border: borderStyle, alignment: { horizontal: "center", vertical: "center" } };
                
                if (C >= 4 && C < dates.length + 4 && val === 0) {
                    cellStyle.fill = { fgColor: { rgb: "F8D7DA" } };
                }
                
                if (C === range.e.c && typeof val === 'number') {
                    ws[addr].z = '"Rp "#,##0';
                    cellStyle.font = { bold: true, color: { rgb: "198754" } };
                }

                if (C === range.e.c - 1) cellStyle.font = { bold: true };
                ws[addr].s = cellStyle;
            }
            // Footer Keterangan
            else {
                ws[addr].s = { font: { italic: true }, alignment: { horizontal: "left" } };
                if (wsData[R][0] === "SKEMA BONUS:" || wsData[R][0] === "KETERANGAN & ATURAN BONUS:") {
                    ws[addr].s.font = { bold: true };
                }
            }
        }
    }

    XLSX.utils.book_append_sheet(wb, ws, "Penilaian Kebersihan");
    XLSX.writeFile(wb, `Penilaian_Kebersihan_${sektorLabel}_${periodInfo.text}.xlsx`);
}
</script>

            <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  // --- CONFIG FIREBASE ANDA ---
  const firebaseConfig = {
    apiKey: "AIzaSyBE1KuGWLKwUfgAO54kDzcQBYUReEBXVVY",
    authDomain: "planning-with-ai-52b33.firebaseapp.com",
    databaseURL: "https://planning-with-ai-52b33-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "planning-with-ai-52b33",
    storageBucket: "planning-with-ai-52b33.firebasestorage.app",
    messagingSenderId: "69750485588",
    appId: "1:69750485588:web:5f73609e227bfa4622b3c1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  console.log("üî• Sistem Online Aktif");

  // ============================================================
  // A. MENERIMA DATA DARI CLOUD (LISTENER)
  // ============================================================

  // 1. Laporan Harian
  onValue(ref(db, 'laporan_harian'), (snapshot) => {
      window.reportsData = snapshot.val() || [];
      if(typeof window.fetchReportData === 'function') window.fetchReportData();
      console.log("Sync: Laporan Harian Updated");
  });

  // 2. Master Unit & Operator
  onValue(ref(db, 'master_units'), (snapshot) => {
      window.masterUnits = snapshot.val() || {};
      window.masterOperators = [...new Set(Object.values(window.masterUnits).map(u => u.operator_default).filter(op => op))].sort();
      if(typeof window.updateFilterUnitDropdown === 'function') window.updateFilterUnitDropdown();
      if(typeof window.updateOperatorDatalist === 'function') window.updateOperatorDatalist();
  });

  // 3. Triputra
  onValue(ref(db, 'triputra_data'), (snapshot) => {
      const data = snapshot.val();
      if(data) {
          window.triputraData = data.laporan || [];
          window.triputraFuelStock = parseFloat(data.stok || 0);
          window.triputraStockLog = data.log || [];
          const elStock = document.getElementById('triputra_stock_display');
          if(elStock) elStock.textContent = Math.round(window.triputraFuelStock).toLocaleString('id-ID');
          if(typeof window.fetchTriputraData === 'function') window.fetchTriputraData();
      }
  });

  // 4. Tracking BA
  onValue(ref(db, 'tracking_ba'), (snapshot) => {
      window.trackingData = snapshot.val() || [];
      if(typeof window.renderTrackingTable === 'function') window.renderTrackingTable();
  });

  // 5. Fuel Control
  onValue(ref(db, 'fuel_data'), (snapshot) => {
      window.fuelData = snapshot.val() || [];
      if(typeof window.renderFuelTable === 'function') window.renderFuelTable();
  });

  // 6. General Affair
  onValue(ref(db, 'ga_data'), (snapshot) => {
      window.gaData = snapshot.val() || { documents: [], maintenance: [], requests: [], payments: [] };
      if(typeof window.updateGAKPI === 'function') window.updateGAKPI();
      const activeBtn = document.querySelector('.ga-sub-tab-btn.active');
      if (activeBtn && typeof window.renderGADocsTable === 'function') {
          if(activeBtn.innerText.includes('Legalitas')) window.renderGADocsTable();
          if(activeBtn.innerText.includes('Maintenance')) window.renderGAMaintTable();
          if(activeBtn.innerText.includes('Purchase')) window.renderGAReqTable();
          if(activeBtn.innerText.includes('Payment')) window.renderGAPaymentHistory();
      }
  });

  // 7. Kebersihan
  onValue(ref(db, 'cleanliness_data'), (snapshot) => {
      window.cleanlinessScores = snapshot.val() || {};
      if(typeof window.renderCleanlinessTable === 'function') window.renderCleanlinessTable();
  });

  // ============================================================
  // B. MENGIRIM DATA KE CLOUD (OVERRIDE)
  // ============================================================

  window.saveReportsDataToLocalStorage = function() {
      set(ref(db, 'laporan_harian'), window.reportsData)
      .then(() => showToast("Online", "Laporan Tersimpan ‚úÖ", "success"))
      .catch((e) => alert("Gagal Sync: " + e.message));
  };

  window.saveMasterDataToLocalStorage = function() {
      set(ref(db, 'master_units'), window.masterUnits)
      .then(() => showToast("Online", "Master Unit Tersimpan ‚úÖ", "success"));
  };

  window.saveTriputraData = function() {
      update(ref(db, 'triputra_data'), {
          laporan: window.triputraData,
          stok: window.triputraFuelStock,
          log: window.triputraStockLog
      }).then(() => {
           const elStock = document.getElementById('triputra_stock_display');
           if(elStock) elStock.textContent = Math.round(window.triputraFuelStock).toLocaleString('id-ID');
           showToast("Online", "Triputra Tersimpan ‚úÖ", "success");
      });
  };

  window.saveTrackingData = async function() {
      set(ref(db, 'tracking_ba'), window.trackingData);
  };

  window.saveFuelToStorage = async function() {
      set(ref(db, 'fuel_data'), window.fuelData);
  };

  window.saveGAData = async function() {
      set(ref(db, 'ga_data'), window.gaData)
      .then(() => { if(typeof updateGAKPI === 'function') updateGAKPI(); });
  };

  window.saveCleanlinessDataManual = async function() {
      set(ref(db, 'cleanliness_data'), window.cleanlinessScores)
      .then(() => showToast("Online", "Nilai Tersimpan ‚úÖ", "success"));
  };

  setTimeout(() => {
      if(typeof showToast === 'function') showToast("Koneksi", "Terhubung ke Database AUM ‚úÖ", "success");
  }, 2000);

</script>
</body>
</html>
